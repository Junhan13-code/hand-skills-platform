<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skill Tracker</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f0f4f8;
            color: #333;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 250px;
            background: linear-gradient(135deg, #2c3e50, #1a2530);
            color: white;
            padding: 1.5rem 1rem;
            position: fixed;
            height: 100%;
            overflow-y: auto;
        }

        .logo {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .nav-links {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.8rem 1rem;
            color: #ecf0f1;
            text-decoration: none;
            border-radius: 5px;
            transition: background 0.3s;
            cursor: pointer;
        }

        .nav-link:hover, .nav-link.active {
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-link i {
            margin-right: 10px;
            font-size: 1.1rem;
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            margin-left: 250px; /* Match sidebar width */
            padding: 1.5rem;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e0e6ed;
        }

        .header h2 {
            color: #2c3e50;
        }

        .user-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary { background: #3498db; color: white; }
        .btn-primary:hover { background: #2980b9; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-warning:hover { background: #e67e22; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-danger:hover { background: #c0392b; }

        /* Section Styles */
        .section {
            display: none;
        }

        .active-section {
            display: block;
        }

        /* Login Popup */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .login-popup {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            position: relative;
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #777;
        }

        .login-popup h2 {
            margin-bottom: 1.5rem;
            color: #2c3e50;
            text-align: center;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 0.7rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .form-row {
            display: flex;
            gap: 1rem;
        }

        .form-row .form-group {
            flex: 1;
        }

        .auth-buttons {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .google-btn {
            background: #4285F4;
            color: white;
            padding: 0.7rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-weight: 500;
        }

        .google-btn:hover {
            background: #357ae8;
        }

        .forgot-password {
            text-align: center;
            margin-top: 0.5rem;
        }

        .forgot-password a {
            color: #3498db;
            text-decoration: none;
            font-size: 0.9rem;
        }

        .signup-prompt {
            text-align: center;
            margin-top: 1rem;
            font-size: 0.9rem;
            color: #666;
        }

        .signup-prompt a {
            color: #3498db;
            text-decoration: none;
            font-weight: 500;
        }

        /* Profile Popup */
        .profile-popup {
            position: absolute;
            top: 60px;
            right: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            width: 300px;
            z-index: 100;
            display: none; /* Hidden by default */
        }

        .profile-header {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 1rem;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
            text-align: center;
        }

        .profile-details {
            padding: 1rem;
        }

        .profile-details p {
            margin: 0.5rem 0;
        }

        .profile-actions {
            padding: 0 1rem 1rem;
            display: flex;
            gap: 0.5rem;
        }

        .profile-actions button {
            flex: 1;
        }

        /* Skills Grid */
        .skill-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .skill-card-ui {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: transform 0.3s;
            cursor: pointer;
        }

        .skill-card-ui:hover {
            transform: translateY(-5px);
        }

        .skill-icon {
            height: 100px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
        }

        .skill-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .skill-content {
            padding: 1rem;
        }

        .skill-name {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
            color: #2c3e50;
        }

        .skill-desc {
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .skill-btn {
            width: 100%;
            padding: 0.6rem;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
        }

        .skill-btn:hover {
            background: #2980b9;
        }

        /* Skill Detail */
        .skill-detail {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            padding: 1.5rem;
        }

        .skill-header {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #eee;
        }

        .skill-header img {
            width: 2.5rem;
            height: 2.5rem;
            margin-right: 1rem;
            object-fit: contain; /* Adjust as needed */
        }

        .skill-header h2 {
            color: #2c3e50;
        }

        .skill-section {
            margin-bottom: 2rem;
        }

        .section-title-ui {
            font-size: 1.3rem;
            color: #2c3e50;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #3498db;
        }

        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
        }

        .tool-item {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border: 1px solid #eee;
        }

        .tool-item i {
            color: #3498db;
        }

        .steps-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .step-card {
            display: flex;
            gap: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #eee;
        }

        .step-image {
            width: 150px;
            height: 100px;
            object-fit: cover;
        }

        .step-content {
            padding: 1rem;
            flex: 1;
        }

        .step-title {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: #2c3e50;
        }

        .theory-content p {
            line-height: 1.6;
            color: #555;
        }

        /* Quiz Styles */
        .question {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .question-text {
            font-weight: 500;
            margin-bottom: 1rem;
            color: #2c3e50;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .option {
            padding: 0.7rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .option:hover {
            background: #eef7ff;
        }

        .option.selected {
            background: #e1f0fa;
            border-color: #3498db;
        }

        .option input[type="radio"] {
            display: none; /* Hide original radio */
        }

        .option label {
            cursor: pointer;
            display: block;
        }

        .quiz-result {
            margin-top: 0.5rem;
            padding: 0.5rem;
            border-radius: 5px;
            font-weight: 500;
        }

        .quiz-result.correct {
            background: #d4edda;
            color: #155724;
        }

        .quiz-result.incorrect {
            background: #f8d7da;
            color: #721c24;
        }

        .quiz-nav {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
        }

        .back-btn {
            padding: 0.6rem 1.2rem;
            background: #95a5a6;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .back-btn:hover {
            background: #7f8c8d;
        }

        /* Admin Panel Specific Styles */
        .admin-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .admin-section {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .form-col {
            display: flex;
            flex-direction: column;
        }

        .form-col.full-width {
            grid-column: span 2;
        }

        .form-col label {
            margin-bottom: 0.5rem;
            color: #555;
            font-weight: 500;
        }

        .form-col input, .form-col textarea, .form-col select {
            padding: 0.7rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .form-col textarea {
            min-height: 100px;
            resize: vertical;
        }

        .step-item, .question-item {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid #eee;
        }

        .step-controls, .question-controls {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.9rem;
        }

        .status-bar {
            padding: 0.5rem 1rem;
            border-radius: 5px;
            margin: 0.5rem 0;
            display: inline-block;
        }

        .status-present {
            background: #d4edda;
            color: #155724;
        }

        .status-absent {
            background: #f8d7da;
            color: #721c24;
        }

        .status-excused {
            background: #fff3cd;
            color: #856404;
        }

        .status-late {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-duty {
            background: #cce7ff;
            color: #004085;
        }

        .status-pass {
            background: #e2e3e5;
            color: #383d41;
        }

        .status-extended-absence {
            background: #f0e6f5;
            color: #6a4a7a;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
            }
            .sidebar .nav-link span {
                display: none;
            }
            .sidebar .nav-link i {
                margin-right: 0;
                font-size: 1.3rem;
            }
            .main-content {
                margin-left: 70px;
            }
            .form-grid {
                grid-template-columns: 1fr; /* Stack form columns on small screens */
            }
            .form-col.full-width {
                grid-column: span 1;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <h1><i class="fas fa-cogs"></i> Admin Panel</h1>
            </div>
            <div class="nav-links">
                <div class="nav-link active" onclick="showSection('dashboard')" id="nav-dashboard">
                    <i class="fas fa-tachometer-alt"></i> <span>Dashboard</span>
                </div>
                <div class="nav-link" onclick="showSection('users')" id="nav-users">
                    <i class="fas fa-users"></i> <span>Users</span>
                </div>
                <div class="nav-link" onclick="showSection('skills')" id="nav-skills">
                    <i class="fas fa-book"></i> <span>Skills</span>
                </div>
                <div class="nav-link" onclick="showSection('attendance')" id="nav-attendance">
                    <i class="fas fa-calendar-check"></i> <span>Attendance</span>
                </div>
                 <div class="nav-link" onclick="showSection('settings')" id="nav-settings">
                    <i class="fas fa-cog"></i> <span>Settings</span>
                </div>
                <div class="nav-link" onclick="switchToUserView()" id="nav-user-view">
                    <i class="fas fa-user"></i> <span>User View</span>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h2 id="page-title">Dashboard</h2>
                <div class="user-actions">
                    <button class="btn btn-primary" onclick="toggleProfilePopup()">
                        <i class="fas fa-user-circle"></i> <span id="user-display-name">Guest</span>
                    </button>
                    <button class="btn btn-danger" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>

            <!-- Profile Popup -->
            <div class="profile-popup" id="profile-popup">
                <div class="profile-header">
                    <h3>My Profile</h3>
                </div>
                <div class="profile-details">
                    <p><strong>Name:</strong> <span id="profile-name">-</span></p>
                    <p><strong>Rank:</strong> <span id="profile-rank">-</span></p>
                    <p><strong>Course:</strong> <span id="profile-course">-</span></p>
                    <p><strong>Email:</strong> <span id="profile-email">-</span></p>
                </div>
                <div class="profile-actions">
                    <button class="btn btn-warning" onclick="editProfile()">Edit</button>
                    <button class="btn btn-danger" onclick="closeProfilePopup()">Close</button>
                </div>
            </div>

            <!-- Sections -->
            <div id="dashboard-section" class="section active-section">
                <div class="admin-section">
                    <h3>Welcome, Administrator</h3>
                    <p>Manage users, skills, and attendance from the sidebar.</p>
                    <!-- Add dashboard stats/cards here if needed -->
                </div>
            </div>

            <div id="users-section" class="section">
                <div class="admin-controls">
                    <button class="btn btn-primary" onclick="loadUsersList()">Refresh Users</button>
                </div>
                <div class="admin-section">
                    <div id="usersList"></div>
                </div>
            </div>

            <div id="skills-section" class="section">
                <div class="admin-controls">
                    <button class="btn btn-primary" onclick="createNewSkill()">+ Add New Skill</button>
                    <button class="btn btn-primary" onclick="loadSkillsList()">Refresh Skills</button>
                </div>
                <div class="admin-section">
                    <div id="skillsList"></div>
                </div>
            </div>

            <div id="attendance-section" class="section">
                <div class="admin-controls">
                    <button class="btn btn-primary" onclick="loadAttendance()">Load Attendance</button>
                </div>
                <div class="admin-section">
                    <div id="attendance-data"></div>
                </div>
            </div>

             <div id="settings-section" class="section">
                <div class="admin-section">
                    <h3>System Settings</h3>
                    <div class="form-grid">
                        <div class="form-col">
                            <label>Signup Settings</label>
                             <button class="btn btn-primary" onclick="showSignupSettings()">Configure Signup</button>
                        </div>
                         <div class="form-col full-width">
                            <label>Grant Admin Access</label>
                            <input type="email" id="admin-email-input" placeholder="Enter email address">
                            <button class="btn btn-primary" onclick="grantAdminAccess()" style="margin-top: 0.5rem;">Grant Access</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Edit Skill Form (Initially Hidden) -->
            <div id="edit-skill-form" class="section" style="display: none;">
                <div class="admin-section">
                    <h3 id="edit-skill-title">Edit Skill</h3>
                    <div class="form-grid">
                        <div class="form-col">
                            <label for="edit-skill-name">Skill Name</label>
                            <input type="text" id="edit-skill-name" required>
                        </div>
                        <!-- NEW: Icon Image Section -->
                        <div class="form-col">
                            <label for="edit-skill-icon-url">Icon Image URL</label>
                            <input type="url" id="edit-skill-icon-url" placeholder="Paste image URL here...">
                        </div>
                        <div class="form-col">
                            <label for="edit-skill-icon-upload">Or Upload Icon Image</label>
                            <input type="file" id="edit-skill-icon-upload" accept="image/*">
                            <div id="upload-preview-container" style="margin-top: 10px; display: none;">
                                <p>Preview:</p>
                                <img id="upload-preview" src="" alt="Preview" style="max-width: 100px; max-height: 100px; border: 1px solid #ccc;">
                            </div>
                        </div>
                        <div class="form-col full-width">
                            <label for="edit-skill-description">Description</label>
                            <textarea id="edit-skill-description"></textarea>
                        </div>
                        <div class="form-col full-width">
                            <label>Steps</label>
                            <div id="steps-container"></div>
                            <button class="btn btn-primary" onclick="addEmptyStep()">+ Add Step</button>
                        </div>
                        <div class="form-col full-width">
                            <label>Quiz Questions</label>
                            <div id="quiz-container"></div>
                            <button class="btn btn-primary" onclick="addEmptyQuizQuestion()">+ Add Question</button>
                        </div>
                        <div class="form-col">
                            <label for="edit-tools">Tools (comma separated)</label>
                            <input type="text" id="edit-tools">
                        </div>
                        <div class="form-col full-width">
                            <label for="edit-theory">Theory</label>
                            <textarea id="edit-theory"></textarea>
                        </div>
                    </div>
                    <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
                        <button class="btn btn-primary" onclick="saveSkill()">Save Skill</button>
                        <button class="btn btn-warning" onclick="cancelEditSkill()">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- Signup Settings Form (Initially Hidden) -->
            <div id="signup-settings-form" class="section" style="display: none;">
                <div class="admin-section">
                    <h3>Signup Settings</h3>
                     <div class="form-grid">
                        <div class="form-col full-width">
                            <label>Ranks</label>
                            <div id="ranks-list"></div>
                            <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                                <input type="text" id="new-rank-input" placeholder="New Rank">
                                <button class="btn btn-primary" onclick="addRank()">Add Rank</button>
                            </div>
                        </div>
                        <div class="form-col full-width">
                            <label>Courses</label>
                            <div id="courses-list"></div>
                            <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                                <input type="text" id="new-course-input" placeholder="New Course (e.g., 56th Mech)">
                                <button class="btn btn-primary" onclick="addCourse()">Add Course</button>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 1.5rem;">
                        <button class="btn btn-warning" onclick="cancelSignupSettings()">Close</button>
                    </div>
                </div>
            </div>

            <!-- User View Sections (Initially Hidden) -->
            <div id="user-skills-section" class="section">
                <div class="skill-grid" id="skill-grid"></div>
                <div id="skill-detail" class="skill-detail" style="display: none;"></div>
            </div>

        </div>
    </div>

    <!-- Login Popup (Initially Hidden) -->
    <div class="popup-overlay" id="login-popup" style="display: none;">
        <div class="login-popup">
            <button class="close-btn" onclick="closeLoginPopup()">&times;</button>
            <h2>Login</h2>
            <form id="login-form">
                <div class="form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" required>
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
            </form>
            <div class="auth-buttons">
                <button class="google-btn" onclick="signInWithGoogle()">
                    <i class="fab fa-google"></i> Sign in with Google
                </button>
            </div>
            <div class="forgot-password">
                <a href="#" onclick="resetPassword()">Forgot Password?</a>
            </div>
            <div class="signup-prompt">
                Don't have an account? <a href="#" onclick="showSignupForm()">Sign Up</a>
            </div>
        </div>
    </div>

    <!-- Signup Popup (Initially Hidden) -->
    <div class="popup-overlay" id="signup-popup" style="display: none;">
        <div class="login-popup">
            <button class="close-btn" onclick="closeSignupPopup()">&times;</button>
            <h2>Sign Up</h2>
            <form id="signup-form">
                <div class="form-group">
                    <label for="signup-name">Full Name</label>
                    <input type="text" id="signup-name" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="signup-rank">Rank</label>
                        <select id="signup-rank" required>
                            <!-- Populated by JS -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="signup-course">Course</label>
                        <select id="signup-course" required>
                            <!-- Populated by JS -->
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="signup-email">Email</label>
                    <input type="email" id="signup-email" required>
                </div>
                <div class="form-group">
                    <label for="signup-password">Password</label>
                    <input type="password" id="signup-password" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Sign Up</button>
            </form>
            <div class="auth-buttons">
                <button class="google-btn" onclick="signInWithGoogle(true)"> <!-- Pass true for signup -->
                    <i class="fab fa-google"></i> Sign up with Google
                </button>
            </div>
            <div class="signup-prompt">
                Already have an account? <a href="#" onclick="showLoginForm()">Log In</a>
            </div>
        </div>
    </div>

    <!-- Edit Profile Popup (Initially Hidden) -->
     <div class="popup-overlay" id="edit-profile-popup" style="display: none;">
        <div class="login-popup">
            <button class="close-btn" onclick="closeEditProfilePopup()">&times;</button>
            <h2>Edit Profile</h2>
            <div class="form-group">
                <label for="edit-profile-name">Name</label>
                <input type="text" id="edit-profile-name" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="edit-profile-rank">Rank</label>
                    <select id="edit-profile-rank" required>
                        <!-- Populated by JS -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-profile-course">Course</label>
                    <select id="edit-profile-course" required>
                        <!-- Populated by JS -->
                    </select>
                </div>
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                <button class="btn btn-primary" onclick="saveProfileChanges()">Save Changes</button>
                <button class="btn btn-warning" onclick="closeEditProfilePopup()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script> <!-- Added Storage SDK -->

    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
            // TODO: Replace with your actual Firebase project config
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET", // Required for image uploads
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage(); // Initialize Storage

        // --- Global Variables ---
        let currentUser = null;
        let currentEditingSkill = {};
        let currentEditingUser = {};
        let isUserViewActive = false;
        let skillsData = [];
        let signupRanks = ['ME1T', 'ME2', 'ME3', 'ME4', 'ME5', 'ME6']; // Default ranks
        let signupCourses = ['56th Mech', '56th Avionics', '56th Weapons']; // Default courses
        let currentAttendanceDate = null; // Track loaded attendance date

        // --- DOM Ready & Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
            // Attach event listeners
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('signup-form').addEventListener('submit', handleSignup);
            document.getElementById('edit-skill-icon-upload').addEventListener('change', handleFileSelect); // For image preview

            // Check for existing session
            auth.onAuthStateChanged(user => {
                if (user) {
                    loadUserData(user.uid);
                } else {
                    showLoginPopup();
                }
            });
        });

        // --- Authentication Functions ---
        function showLoginPopup() {
            document.getElementById('login-popup').style.display = 'flex';
            document.getElementById('signup-popup').style.display = 'none'; // Ensure signup is hidden
        }

        function closeLoginPopup() {
            document.getElementById('login-popup').style.display = 'none';
        }

        function showSignupForm() {
            document.getElementById('signup-popup').style.display = 'flex';
            document.getElementById('login-popup').style.display = 'none';
            populateSignupDropdowns(); // Populate dropdowns when shown
        }

        function closeSignupPopup() {
            document.getElementById('signup-popup').style.display = 'none';
        }

        function showLoginForm() {
            document.getElementById('login-popup').style.display = 'flex';
            document.getElementById('signup-popup').style.display = 'none';
        }

        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            auth.signInWithEmailAndPassword(email, password)
                .then(cred => {
                    console.log('Logged in with email:', cred.user.email);
                    loadUserData(cred.user.uid);
                    closeLoginPopup();
                })
                .catch(error => {
                    alert('Login failed: ' + error.message);
                    console.error('Login error:', error);
                });
        }

        function handleSignup(e) {
            e.preventDefault();
            const name = document.getElementById('signup-name').value.toUpperCase(); // Auto-convert to uppercase
            const rank = document.getElementById('signup-rank').value;
            const course = document.getElementById('signup-course').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;

            auth.createUserWithEmailAndPassword(email, password)
                .then(cred => {
                    console.log('Signed up with email:', cred.user.email);
                    // Save user profile data to Firestore
                    return db.collection('users').doc(cred.user.uid).set({
                        name: name,
                        rank: rank,
                        course: course,
                        email: email,
                        isAdmin: false,
                        completedSkills: [],
                        attendanceRecords: {}
                    });
                })
                .then(() => {
                    alert('Account created successfully! Logging you in...');
                    // Optionally, log them in automatically after signup
                    // The onAuthStateChanged will handle loading data once logged in.
                })
                .catch(error => {
                    alert('Signup failed: ' + error.message);
                    console.error('Signup error:', error);
                });
        }

        async function signInWithGoogle(isSignup = false) {
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                const result = await auth.signInWithPopup(provider);
                const user = result.user;
                console.log('Logged in with Google:', user.email);

                // Check if user exists in Firestore, if not, create profile
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (!userDoc.exists) {
                    if (isSignup) {
                        // If it's a signup attempt and user doesn't exist, get profile info
                        // For simplicity in this example, we'll use email as name and default rank/course
                        // In a real app, you might want a modal to confirm details
                        await db.collection('users').doc(user.uid).set({
                            name: user.displayName || user.email.split('@')[0].toUpperCase(), // Fallback to email prefix
                            rank: signupRanks[0], // Default to first rank
                            course: signupCourses[0], // Default to first course
                            email: user.email,
                            isAdmin: false,
                            completedSkills: [],
                            attendanceRecords: {}
                        });
                        alert('Google account linked successfully!');
                    } else {
                        // If logging in and user doesn't exist, prompt for signup flow or create minimal profile
                        // Let's create a minimal profile for first-time Google logins
                         await db.collection('users').doc(user.uid).set({
                            name: user.displayName || user.email.split('@')[0].toUpperCase(),
                            rank: signupRanks[0],
                            course: signupCourses[0],
                            email: user.email,
                            isAdmin: false,
                            completedSkills: [],
                            attendanceRecords: {}
                        });
                         alert('Welcome! Your Google account has been set up.');
                    }
                }
                loadUserData(user.uid);
                closeLoginPopup(); // Close popup after successful sign-in
                if (isSignup) closeSignupPopup();
            } catch (error) {
                console.error('Google sign-in error:', error);
                alert('Google sign-in failed: ' + error.message);
            }
        }

        function resetPassword() {
            const email = prompt('Please enter your email address:');
            if (email) {
                auth.sendPasswordResetEmail(email)
                    .then(() => {
                        alert('Password reset email sent!');
                    })
                    .catch(error => {
                        alert('Error sending reset email: ' + error.message);
                    });
            }
        }

        function logout() {
            auth.signOut()
                .then(() => {
                    console.log('User signed out.');
                    currentUser = null;
                    isUserViewActive = false;
                    // Reset UI elements
                    document.getElementById('user-display-name').textContent = 'Guest';
                    hideAllSections();
                    // Show login again
                    showLoginPopup();
                })
                .catch(error => {
                    console.error('Logout error:', error);
                });
        }

        // --- User Data Loading & UI Setup ---
        async function loadUserData(userId) {
            try {
                const doc = await db.collection('users').doc(userId).get();
                if (doc.exists) {
                    currentUser = doc.data();
                    currentUser.id = doc.id; // Store the Firestore ID

                    // Update UI with user info
                    document.getElementById('user-display-name').textContent = currentUser.name || 'User';

                    // Load signup settings (ranks/courses) which might affect profile editing
                    await loadSignupSettings();

                    // Determine view based on admin status
                    if (currentUser.isAdmin) {
                        isUserViewActive = false;
                        showSection('dashboard'); // Default admin view
                        document.getElementById('nav-user-view').style.display = 'block'; // Show user view link
                        // Load admin-specific data
                        loadSkillsList();
                        loadUsersList();
                    } else {
                        isUserViewActive = true;
                        switchToUserView(); // Switch to user view for non-admins
                    }
                } else {
                    console.error('No user document found!');
                    alert('User data could not be loaded. Please log in again.');
                    logout(); // Log out as data is missing
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                alert('Failed to load user data.');
            }
        }

        // --- Section Navigation ---
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));

            // Show target section
            document.getElementById(`${sectionName}-section`).style.display = 'block';
            document.getElementById(`nav-${sectionName}`).classList.add('active');

            // Update title
            document.getElementById('page-title').textContent = sectionName.charAt(0).toUpperCase() + sectionName.slice(1);

            // Special handling for sections that need data loading
            if (sectionName === 'skills' && currentUser?.isAdmin) {
                 loadSkillsList();
            } else if (sectionName === 'users' && currentUser?.isAdmin) {
                loadUsersList();
            } else if (sectionName === 'attendance' && currentUser?.isAdmin) {
                loadAttendance();
            } else if (sectionName === 'user-skills-section' && !currentUser?.isAdmin) {
                loadSkillGrid(); // Load user's skill grid
            }
        }

        function hideAllSections() {
             document.querySelectorAll('.section').forEach(el => el.style.display = 'none');
             document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
        }

        function switchToUserView() {
            if (currentUser?.isAdmin) {
                isUserViewActive = true;
                // Hide admin sidebar links except user view toggle
                document.querySelectorAll('.nav-link:not(#nav-user-view)').forEach(el => el.style.display = 'none');
                document.getElementById('nav-user-view').querySelector('span').textContent = 'Admin View'; // Change button text
                showSection('user-skills-section');
            } else if (isUserViewActive && currentUser?.isAdmin) {
                 // Switch back to Admin View
                 isUserViewActive = false;
                 document.querySelectorAll('.nav-link').forEach(el => el.style.display = 'flex'); // Show all admin links
                 document.getElementById('nav-user-view').querySelector('span').textContent = 'User View'; // Change button text back
                 showSection('dashboard'); // Or whatever default admin section you prefer
            }
        }

        // --- Profile Management ---
        function toggleProfilePopup() {
            const popup = document.getElementById('profile-popup');
            const isVisible = popup.style.display === 'block';
            if (isVisible) {
                popup.style.display = 'none';
            } else {
                updateProfilePopupContent();
                popup.style.display = 'block';
            }
        }

        function updateProfilePopupContent() {
            if (currentUser) {
                document.getElementById('profile-name').textContent = currentUser.name || '-';
                document.getElementById('profile-rank').textContent = currentUser.rank || '-';
                document.getElementById('profile-course').textContent = currentUser.course || '-';
                document.getElementById('profile-email').textContent = currentUser.email || '-';
            }
        }

        function closeProfilePopup() {
            document.getElementById('profile-popup').style.display = 'none';
        }

        function editProfile() {
            if (currentUser) {
                document.getElementById('edit-profile-name').value = currentUser.name || '';
                populateRankDropdown('edit-profile-rank', currentUser.rank); // Pre-select current rank
                populateCourseDropdown('edit-profile-course', currentUser.course); // Pre-select current course
                document.getElementById('edit-profile-popup').style.display = 'flex';
                closeProfilePopup(); // Close the view popup
            }
        }

        function closeEditProfilePopup() {
            document.getElementById('edit-profile-popup').style.display = 'none';
        }

        async function saveProfileChanges() {
            const newName = document.getElementById('edit-profile-name').value.toUpperCase();
            const newRank = document.getElementById('edit-profile-rank').value;
            const newCourse = document.getElementById('edit-profile-course').value;

            if (currentUser) {
                try {
                    await db.collection('users').doc(currentUser.id).update({
                        name: newName,
                        rank: newRank,
                        course: newCourse
                    });
                    // Update local current user object
                    currentUser.name = newName;
                    currentUser.rank = newRank;
                    currentUser.course = newCourse;

                    alert('Profile updated successfully!');
                    updateProfilePopupContent(); // Update the view popup if open
                    closeEditProfilePopup();
                    // Also update the header name
                    document.getElementById('user-display-name').textContent = newName;
                } catch (error) {
                    console.error('Error updating profile:', error);
                    alert('Failed to update profile: ' + error.message);
                }
            }
        }

        // --- Admin Functions: Skills ---
        async function loadSkillsList() {
            if (!currentUser?.isAdmin) return; // Only for admins

            const skillsList = document.getElementById('skillsList');
            skillsList.innerHTML = '<p>Loading skills...</p>';

            try {
                const snapshot = await db.collection('skills').orderBy('order').get();
                skillsData = []; // Reset array
                snapshot.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id; // Include Firestore ID
                    skillsData.push(data);
                });

                // Now populate the UI list
                skillsList.innerHTML = '';

                if (skillsData.length === 0) {
                    skillsList.innerHTML = '<p>No skills available.</p>';
                    return;
                }

                const skillGrid = document.createElement('div');
                skillGrid.className = 'skill-grid';

                skillsData.forEach((skill, index) => {
                    const skillCard = document.createElement('div');
                    skillCard.className = 'skill-card-ui';
                    skillCard.setAttribute('data-skill-id', skill.id);
                    const isTop = index === 0;
                    const isBottom = index === skillsData.length - 1;
                    const orderValue = skill.order !== undefined && skill.order !== null ? skill.order : 0;

                    // CHANGED: Use img tag for icon in admin list too
                    skillCard.innerHTML = `
                    <div class="skill-icon">
                        <img src="${skill.icon || 'path/to/default/icon.png'}" alt="${skill.name} icon"> <!-- Use skill.icon as src -->
                    </div>
                    <div class="skill-content">
                        <h3 class="skill-name">${skill.name}</h3>
                        <p class="skill-desc">${skill.description.substring(0, 100)}...</p>
                        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                            <button class="skill-btn" style="background: var(--primary); flex: 1;" ${isTop ? 'disabled' : ''} onclick="moveSkillUp('${skill.id}', ${orderValue})" title="Move Up">
                                <i class="fas fa-arrow-up"></i>
                            </button>
                            <button class="skill-btn" style="background: var(--primary); flex: 1;" ${isBottom ? 'disabled' : ''} onclick="moveSkillDown('${skill.id}', ${orderValue})" title="Move Down">
                                <i class="fas fa-arrow-down"></i>
                            </button>
                        </div>
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                            <button class="skill-btn" style="background: var(--warning); flex: 1;" onclick="editSkill('${skill.id}')">Edit</button>
                            <button class="skill-btn" style="background: var(--danger); flex: 1;" onclick="deleteSkill('${skill.id}')">Delete</button>
                        </div>
                    </div>
                    `;
                    skillGrid.appendChild(skillCard);
                });

                skillsList.appendChild(skillGrid);

            } catch (error) {
                console.error('Error loading skills list:', error);
                skillsList.innerHTML = '<p>Error loading skills.</p>';
            }
        }


        function createNewSkill() {
            currentEditingSkill = {}; // Reset object for new skill
            showEditForm();
        }

        function editSkill(skillId) {
            const skill = skillsData.find(s => s.id === skillId);
            if (skill) {
                currentEditingSkill = {...skill}; // Copy skill data
                showEditForm();
            }
        }

        function showEditForm() {
            document.getElementById('edit-skill-name').value = currentEditingSkill.name || '';
            // CHANGED: Populate the URL field instead of icon class
            document.getElementById('edit-skill-icon-url').value = currentEditingSkill.icon || ''; // Assumes 'icon' now stores the URL
            document.getElementById('edit-skill-description').value = currentEditingSkill.description || '';
            document.getElementById('edit-tools').value = Array.isArray(currentEditingSkill.tools) ? currentEditingSkill.tools.join(', ') : '';
            document.getElementById('edit-theory').value = currentEditingSkill.theory || '';

            // Clear file input and preview when showing the form
            document.getElementById('edit-skill-icon-upload').value = '';
            document.getElementById('upload-preview-container').style.display = 'none';
            document.getElementById('upload-preview').src = '';

            // Clear and populate steps
            const stepsContainer = document.getElementById('steps-container');
            stepsContainer.innerHTML = '';
            if (Array.isArray(currentEditingSkill.steps)) {
                currentEditingSkill.steps.forEach((step, index) => {
                    addStepToForm(index, step);
                });
            }

            // Clear and populate quiz
            const quizContainer = document.getElementById('quiz-container');
            quizContainer.innerHTML = '';
            if (Array.isArray(currentEditingSkill.quiz)) {
                currentEditingSkill.quiz.forEach((question, index) => {
                    addQuizQuestionToForm(index, question);
                });
            }

            // Show form
            document.getElementById('skills-section').style.display = 'none';
            document.getElementById('edit-skill-form').style.display = 'block';
            document.getElementById('edit-skill-title').textContent = currentEditingSkill.id ? 'Edit Skill' : 'Create New Skill';
        }

        function cancelEditSkill() {
             document.getElementById('edit-skill-form').style.display = 'none';
             document.getElementById('skills-section').style.display = 'block';
             showSection('skills'); // Go back to skills list
        }

        // --- NEW: Image Upload and Preview Functions ---
        function handleFileSelect(event) {
            const file = event.target.files[0];
            const previewContainer = document.getElementById('upload-preview-container');
            const previewImg = document.getElementById('upload-preview');

            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    previewContainer.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                previewContainer.style.display = 'none';
                previewImg.src = '';
            }
        }

        async function uploadIconImage(file) {
            if (!file) return null;

            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
            if (!allowedTypes.includes(file.type)) {
                alert('Please select a valid image file (JPEG, JPG, PNG, GIF, WEBP).');
                return null;
            }

            const maxSizeInBytes = 2 * 1024 * 1024; // 2MB
            if (file.size > maxSizeInBytes) {
                alert('File size exceeds 2MB limit.');
                return null;
            }

            const storageRef = storage.ref();
            // Generate a unique filename using timestamp and random string
            const timestamp = Date.now();
            const randomString = Math.random().toString(36).substring(2, 10);
            const fileExtension = file.name.split('.').pop().toLowerCase();
            const fileName = `skill_icons/${(currentEditingSkill.name || 'new_skill').replace(/\s+/g, '_')}_${timestamp}_${randomString}.${fileExtension}`;
            const fileRef = storageRef.child(fileName);

            try {
                console.log("Starting upload...");
                const snapshot = await fileRef.put(file);
                console.log("Upload successful, getting download URL...");
                const downloadURL = await snapshot.ref.getDownloadURL();
                console.log("Download URL obtained:", downloadURL);
                return downloadURL;
            } catch (error) {
                console.error("Error uploading image: ", error);
                alert('Failed to upload image. Check console for details.');
                return null;
            }
        }


        async function saveSkill() {
            // Update current skill with form values
            currentEditingSkill.name = document.getElementById('edit-skill-name').value;
            // CHANGED: Determine the icon URL based on input or upload
            let iconUrl = document.getElementById('edit-skill-icon-url').value.trim();

            const fileInput = document.getElementById('edit-skill-icon-upload');
            if (fileInput.files.length > 0) {
                // If a file is selected, upload it
                iconUrl = await uploadIconImage(fileInput.files[0]);
                if (!iconUrl) {
                     // Stop save if upload fails
                    alert('Failed to upload icon image. Skill not saved.');
                    return;
                }
                // Clear the file input after successful upload
                fileInput.value = '';
                document.getElementById('upload-preview-container').style.display = 'none';
                document.getElementById('upload-preview').src = '';
            } else if (!iconUrl) {
                 // If no file is selected and URL is empty, use a default icon or show an error
                // Option 1: Use a default icon URL
                // iconUrl = 'https://example.com/default_skill_icon.png';
                // Option 2: Require an icon (recommended)
                alert('Please provide an icon image URL or upload an image.');
                return;
            }

            currentEditingSkill.icon = iconUrl; // Store the determined URL
            currentEditingSkill.description = document.getElementById('edit-skill-description').value;
            currentEditingSkill.tools = document.getElementById('edit-tools').value.split(',').map(t => t.trim()).filter(t => t);
            currentEditingSkill.theory = document.getElementById('edit-theory').value;

            // If it's a new skill, add to Firestore
            if (!currentEditingSkill.id) {
                // Assign an initial order value, e.g., based on current length
                currentEditingSkill.order = skillsData.length;
                db.collection("skills").add(currentEditingSkill)
                    .then((docRef) => {
                        alert('Skill saved successfully!');
                        document.getElementById('edit-skill-form').style.display = 'none';
                        document.getElementById('skills-section').style.display = 'block';
                        showSection('skills'); // This will trigger loadSkillsList
                    })
                    .catch((error) => {
                        console.error("Error adding skill: ", error);
                        alert('Error saving skill: ' + error.message); // Show error message
                    });
            } else {
                // Update existing skill in Firestore
                db.collection("skills").doc(currentEditingSkill.id).set(currentEditingSkill)
                    .then(() => {
                        alert('Skill updated successfully!');
                        document.getElementById('edit-skill-form').style.display = 'none';
                        document.getElementById('skills-section').style.display = 'block';
                        showSection('skills'); // This will trigger loadSkillsList
                    })
                    .catch((error) => {
                        console.error("Error updating skill: ", error);
                        alert('Error saving skill: ' + error.message); // Show error message
                    });
            }
        }


        function deleteSkill(skillId) {
            if (confirm('Are you sure you want to delete this skill?')) {
                 db.collection('skills').doc(skillId).delete()
                    .then(() => {
                        console.log('Skill deleted successfully');
                        loadSkillsList(); // Refresh the list
                    })
                    .catch(error => {
                        console.error('Error deleting skill:', error);
                        alert('Failed to delete skill: ' + error.message);
                    });
            }
        }

        async function moveSkillUp(skillId, currentOrder) {
            const targetOrder = currentOrder - 1;
            if (targetOrder < 0) return; // Already at top

            // Find the skill that has the target order
            const skillToSwap = skillsData.find(s => s.order === targetOrder);
            if (!skillToSwap) return; // Shouldn't happen if logic is sound

            // Swap orders in Firestore
            const batch = db.batch();
            const skillRef = db.collection('skills').doc(skillId);
            const swapRef = db.collection('skills').doc(skillToSwap.id);

            batch.update(skillRef, { order: targetOrder });
            batch.update(swapRef, { order: currentOrder });

            try {
                await batch.commit();
                console.log('Orders swapped successfully');
                loadSkillsList(); // Refresh the list to reflect new order
            } catch (error) {
                console.error('Error swapping orders:', error);
                alert('Failed to move skill: ' + error.message);
            }
        }

        async function moveSkillDown(skillId, currentOrder) {
            const targetOrder = currentOrder + 1;
            // Assuming skillsData is sorted by order, the last item has the highest order
            const maxOrder = skillsData.reduce((max, s) => s.order > max ? s.order : max, 0);
            if (targetOrder > maxOrder) return; // Already at bottom

            // Find the skill that has the target order
            const skillToSwap = skillsData.find(s => s.order === targetOrder);
            if (!skillToSwap) return; // Shouldn't happen if logic is sound

            // Swap orders in Firestore
            const batch = db.batch();
            const skillRef = db.collection('skills').doc(skillId);
            const swapRef = db.collection('skills').doc(skillToSwap.id);

            batch.update(skillRef, { order: targetOrder });
            batch.update(swapRef, { order: currentOrder });

            try {
                await batch.commit();
                console.log('Orders swapped successfully');
                loadSkillsList(); // Refresh the list to reflect new order
            } catch (error) {
                console.error('Error swapping orders:', error);
                alert('Failed to move skill: ' + error.message);
            }
        }


        // --- Admin Functions: Users ---
        async function loadUsersList() {
            if (!currentUser?.isAdmin) return; // Only for admins

            const usersList = document.getElementById('usersList');
            usersList.innerHTML = '<p>Loading users...</p>';

            try {
                const snapshot = await db.collection('users').get();
                let html = '<table style="width: 100%; border-collapse: collapse;"><tr><th>Name</th><th>Rank</th><th>Course</th><th>Email</th><th>Admin</th><th>Actions</th></tr>';

                snapshot.forEach(doc => {
                    const u = doc.data();
                    u.id = doc.id;
                    html += `
                    <tr>
                        <td>${u.name}</td>
                        <td>${u.rank}</td>
                        <td>${u.course}</td>
                        <td>${u.email}</td>
                        <td>${u.isAdmin ? 'Yes' : 'No'}</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="editUser('${u.id}')">Edit</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteUser('${u.id}')">Delete</button>
                        </td>
                    </tr>
                    `;
                });

                html += '</table>';
                usersList.innerHTML = html;

            } catch (error) {
                console.error('Error loading users list:', error);
                usersList.innerHTML = '<p>Error loading users.</p>';
            }
        }

        function editUser(userId) {
            // Find user data
            db.collection('users').doc(userId).get().then(doc => {
                if (doc.exists) {
                    currentEditingUser = {id: doc.id, ...doc.data()};
                    // Populate edit fields (you would need an edit user form similar to skills)
                    // For brevity, let's assume a simple prompt for now, but a proper form is better.
                    const newName = prompt('Enter new name:', currentEditingUser.name);
                    const newRank = prompt('Enter new rank:', currentEditingUser.rank);
                    const newCourse = prompt('Enter new course:', currentEditingUser.course);
                    if (newName !== null && newRank !== null && newCourse !== null) {
                        db.collection('users').doc(userId).update({
                            name: newName.toUpperCase(), // Maintain uppercase convention
                            rank: newRank,
                            course: newCourse
                        }).then(() => {
                            alert('User updated successfully!');
                            loadUsersList(); // Refresh list
                        }).catch(error => {
                            console.error('Error updating user:', error);
                            alert('Failed to update user: ' + error.message);
                        });
                    }
                }
            });
        }

        function deleteUser(userId) {
             if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                  db.collection('users').doc(userId).delete()
                    .then(() => {
                        console.log('User deleted successfully');
                        loadUsersList(); // Refresh the list
                    })
                    .catch(error => {
                        console.error('Error deleting user:', error);
                        alert('Failed to delete user: ' + error.message);
                    });
             }
        }

        // --- Admin Functions: Settings ---
         async function loadSignupSettings() {
            try {
                const doc = await db.collection('settings').doc('signup').get();
                if (doc.exists) {
                    const data = doc.data();
                    signupRanks = data.ranks || signupRanks; // Use defaults if not set
                    signupCourses = data.courses || signupCourses;
                } else {
                    // Doc doesn't exist, use defaults and potentially create it later if settings are changed
                    console.log("Signup settings document does not exist, using defaults.");
                }
            } catch (error) {
                console.error("Error loading signup settings: ", error);
                // Fallback to defaults
            }
        }

        function showSignupSettings() {
             loadSignupSettings().then(() => {
                  populateRanksList();
                  populateCoursesList();
                  document.getElementById('skills-section').style.display = 'none';
                  document.getElementById('settings-section').style.display = 'none';
                  document.getElementById('signup-settings-form').style.display = 'block';
             });
        }

        function populateRanksList() {
            const container = document.getElementById('ranks-list');
            container.innerHTML = '';
            signupRanks.forEach((rank, index) => {
                const div = document.createElement('div');
                div.style = 'display: flex; align-items: center; margin-bottom: 0.5rem;';
                div.innerHTML = `
                    <span style="flex: 1;">${rank}</span>
                    <button class="btn btn-sm btn-warning" onclick="moveRank(${index}, -1)" ${index === 0 ? 'disabled' : ''}></button>
                    <button class="btn btn-sm btn-warning" onclick="moveRank(${index}, 1)" ${index === signupRanks.length - 1 ? 'disabled' : ''}></button>
                    <button class="btn btn-sm btn-danger" onclick="removeRank(${index})">X</button>
                `;
                container.appendChild(div);
            });
        }

        function populateCoursesList() {
            const container = document.getElementById('courses-list');
            container.innerHTML = '';
            signupCourses.forEach((course, index) => {
                const div = document.createElement('div');
                div.style = 'display: flex; align-items: center; margin-bottom: 0.5rem;';
                div.innerHTML = `
                    <span style="flex: 1;">${course}</span>
                    <button class="btn btn-sm btn-warning" onclick="moveCourse(${index}, -1)" ${index === 0 ? 'disabled' : ''}></button>
                    <button class="btn btn-sm btn-warning" onclick="moveCourse(${index}, 1)" ${index === signupCourses.length - 1 ? 'disabled' : ''}></button>
                    <button class="btn btn-sm btn-danger" onclick="removeCourse(${index})">X</button>
                `;
                container.appendChild(div);
            });
        }

        function addRank() {
            const input = document.getElementById('new-rank-input');
            const newRank = input.value.trim();
            if (newRank && !signupRanks.includes(newRank)) {
                signupRanks.push(newRank);
                input.value = '';
                populateRanksList();
            } else if (signupRanks.includes(newRank)) {
                alert('Rank already exists.');
            }
        }

        function removeRank(index) {
            if (confirm('Remove this rank?')) {
                signupRanks.splice(index, 1);
                populateRanksList();
            }
        }

        function moveRank(index, direction) {
            if ((direction === -1 && index > 0) || (direction === 1 && index < signupRanks.length - 1)) {
                const temp = signupRanks[index];
                signupRanks[index] = signupRanks[index + direction];
                signupRanks[index + direction] = temp;
                populateRanksList();
            }
        }

        function addCourse() {
            const input = document.getElementById('new-course-input');
            const newCourse = input.value.trim();
            if (newCourse && !signupCourses.includes(newCourse)) {
                signupCourses.push(newCourse);
                input.value = '';
                populateCoursesList();
            } else if (signupCourses.includes(newCourse)) {
                alert('Course already exists.');
            }
        }

        function removeCourse(index) {
            if (confirm('Remove this course?')) {
                signupCourses.splice(index, 1);
                populateCoursesList();
            }
        }

        function moveCourse(index, direction) {
            if ((direction === -1 && index > 0) || (direction === 1 && index < signupCourses.length - 1)) {
                const temp = signupCourses[index];
                signupCourses[index] = signupCourses[index + direction];
                signupCourses[index + direction] = temp;
                populateCoursesList();
            }
        }

        function cancelSignupSettings() {
             document.getElementById('signup-settings-form').style.display = 'none';
             document.getElementById('settings-section').style.display = 'block';
             // Save settings to Firestore
             db.collection('settings').doc('signup').set({
                 ranks: signupRanks,
                 courses: signupCourses
             }).then(() => {
                 console.log('Signup settings saved.');
                  // Reload settings globally to ensure consistency
                 loadSignupSettings();
                  // Repopulate dropdowns in case they were open
                 populateSignupDropdowns();
             }).catch(error => {
                 console.error('Error saving signup settings:', error);
                 alert('Failed to save settings: ' + error.message);
             });
        }

        function populateSignupDropdowns() {
            populateRankDropdown('signup-rank');
            populateCourseDropdown('signup-course');
        }

        function populateRankDropdown(elementId, selectedValue = null) {
            const selectElement = document.getElementById(elementId);
            selectElement.innerHTML = '';
            signupRanks.forEach(rank => {
                const option = document.createElement('option');
                option.value = rank;
                option.textContent = rank;
                if (selectedValue && rank === selectedValue) option.selected = true;
                selectElement.appendChild(option);
            });
        }

        function populateCourseDropdown(elementId, selectedValue = null) {
            const selectElement = document.getElementById(elementId);
            selectElement.innerHTML = '';
            signupCourses.forEach(course => {
                const option = document.createElement('option');
                option.value = course;
                option.textContent = course;
                if (selectedValue && course === selectedValue) option.selected = true;
                selectElement.appendChild(option);
            });
        }

        async function grantAdminAccess() {
            const email = document.getElementById('admin-email-input').value.trim();
            if (!email) {
                alert('Please enter an email address.');
                return;
            }

            // Find user by email
            const userQuery = await db.collection('users').where('email', '==', email).get();
            if (userQuery.empty) {
                alert('No user found with that email address.');
                return;
            }

            const userDoc = userQuery.docs[0]; // Assuming unique emails
            const userId = userDoc.id;

            // Confirm action
            if (confirm(`Grant admin access to ${email}?`)) {
                 db.collection('users').doc(userId).update({
                    isAdmin: true
                 }).then(() => {
                     alert(`Admin access granted to ${email}.`);
                     document.getElementById('admin-email-input').value = ''; // Clear input
                     if (currentUser?.isAdmin) loadUsersList(); // Refresh users list if on admin view
                 }).catch(error => {
                     console.error('Error granting admin access:', error);
                     alert('Failed to grant admin access: ' + error.message);
                 });
            }
        }


        // --- Admin Functions: Attendance ---
        async function loadAttendance(dateStr = null) {
             if (!currentUser?.isAdmin) return; // Only for admins

             if (!dateStr) {
                 // Prompt for date if not provided
                 dateStr = prompt('Enter date (YYYY-MM-DD) for attendance:', new Date().toISOString().split('T')[0]);
                 if (!dateStr) return; // User cancelled
             }

             const attendanceDataDiv = document.getElementById('attendance-data');
             attendanceDataDiv.innerHTML = '<p>Loading attendance for ' + dateStr + '...</p>';

             try {
                  // Fetch all users
                  const usersSnapshot = await db.collection('users').get();
                  let users = [];
                  usersSnapshot.forEach(doc => {
                      users.push({id: doc.id, ...doc.data()});
                  });

                  // Fetch attendance records for the specific date
                  // This assumes a subcollection or a map field per user
                  // Example structure: user.attendanceRecords[dateStr] = { status: 'present', notes: '' }
                  let html = `<h3>Attendance for ${dateStr}</h3><table style="width: 100%; border-collapse: collapse;"><tr><th>Name</th><th>Rank</th><th>Course</th><th>Status</th><th>Notes</th><th>Actions</th></tr>`;

                  for (const user of users) {
                      let record = { status: 'absent', notes: '' }; // Default status
                      if (user.attendanceRecords && user.attendanceRecords[dateStr]) {
                          record = user.attendanceRecords[dateStr];
                      }

                      html += `
                      <tr>
                          <td>${user.name}</td>
                          <td>${user.rank}</td>
                          <td>${user.course}</td>
                          <td><span class="status-bar status-${record.status}">${record.status.charAt(0).toUpperCase() + record.status.slice(1)}</span></td>
                          <td>${record.notes || '-'}</td>
                          <td>
                              <select onchange="updateAttendanceStatus('${user.id}', '${dateStr}', this.value)" style="margin-right: 0.5rem;">
                                  <option value="present" ${record.status === 'present' ? 'selected' : ''}>Present</option>
                                  <option value="absent" ${record.status === 'absent' ? 'selected' : ''}>Absent</option>
                                  <option value="excused" ${record.status === 'excused' ? 'selected' : ''}>Excused</option>
                                  <option value="late" ${record.status === 'late' ? 'selected' : ''}>Late</option>
                                  <option value="duty" ${record.status === 'duty' ? 'selected' : ''}>On Duty</option>
                                  <option value="pass" ${record.status === 'pass' ? 'selected' : ''}>Pass</option>
                                  <option value="extended_absence" ${record.status === 'extended_absence' ? 'selected' : ''}>Extended Absence</option>
                              </select>
                              <button class="btn btn-sm btn-primary" onclick="promptForNotes('${user.id}', '${dateStr}', '${record.notes || ''}')">Notes</button>
                          </td>
                      </tr>
                      `;
                  }

                  html += '</table>';
                  attendanceDataDiv.innerHTML = html;
                  currentAttendanceDate = dateStr; // Store loaded date

             } catch (error) {
                 console.error('Error loading attendance:', error);
                 attendanceDataDiv.innerHTML = '<p>Error loading attendance data.</p>';
             }
        }

        async function updateAttendanceStatus(userId, dateStr, newStatus) {
             if (!currentAttendanceDate || currentAttendanceDate !== dateStr) {
                 alert('Please reload the attendance data for this date before making changes.');
                 return;
             }
            try {
                await db.collection('users').doc(userId).set({
                    [`attendanceRecords.${dateStr}`]: {
                        status: newStatus,
                        notes: '' // Keep existing notes or set default
                    }
                }, { merge: true });
                console.log(`Attendance updated for user ${userId} on ${dateStr}`);
                // Optionally reload the specific row or the whole table
                loadAttendance(dateStr); // Reload table for the same date
            } catch (error) {
                console.error('Error updating attendance:', error);
                alert('Failed to update attendance: ' + error.message);
                // Reload to revert UI change if it failed
                 loadAttendance(dateStr);
            }
        }

        function promptForNotes(userId, dateStr, currentNotes) {
             if (!currentAttendanceDate || currentAttendanceDate !== dateStr) {
                 alert('Please reload the attendance data for this date before making changes.');
                 return;
             }
            const newNotes = prompt('Enter notes for absence:', currentNotes);
            if (newNotes !== null) { // User didn't cancel
                updateAttendanceNotes(userId, dateStr, newNotes);
            }
        }

        async function updateAttendanceNotes(userId, dateStr, newNotes) {
            try {
                await db.collection('users').doc(userId).set({
                    [`attendanceRecords.${dateStr}.notes`]: newNotes
                }, { merge: true });
                console.log(`Attendance notes updated for user ${userId} on ${dateStr}`);
                 loadAttendance(dateStr); // Reload table for the same date
            } catch (error) {
                console.error('Error updating attendance notes:', error);
                alert('Failed to update attendance notes: ' + error.message);
                 loadAttendance(dateStr);
            }
        }


        // --- User View Functions (Skills Grid & Detail) ---
        function loadSkillGrid() {
            const gridElement = document.getElementById('skill-grid');
            if (!gridElement) return; // Exit if element not found (shouldn't happen if called correctly)

            let html = '';
            skillsData.forEach(skill => {
                // Check if user has completed this skill
                const isCompleted = currentUser && currentUser.completedSkills && currentUser.completedSkills.includes(skill.id);

                // CHANGED: Use img tag for icon
                html += `
                <div class="skill-card-ui" onclick="loadSkillDetail('${skill.id}')">
                    <div class="skill-icon">
                        <img src="${skill.icon || 'path/to/default/icon.png'}" alt="${skill.name} icon"> <!-- Use skill.icon as src -->
                    </div>
                    <div class="skill-content">
                        <h3 class="skill-name">${skill.name}</h3>
                        <p class="skill-desc">${skill.description}</p>
                        <button class="skill-btn">
                            ${isCompleted ? 'Review' : 'Start'} Learning
                        </button>
                    </div>
                </div>
                `;
            });
            gridElement.innerHTML = html;
        }

        function loadSkillDetail(skillId) {
            document.getElementById('skill-grid').style.display = 'none';
            document.getElementById('skill-detail').style.display = 'block';
            const skill = skillsData.find(s => s.id === skillId);
            if (!skill) return;

            // CHANGED: Use img tag for icon in detail view
            let html = `
            <div class="skill-header">
                <img src="${skill.icon || 'path/to/default/icon.png'}" alt="${skill.name} icon" style="width: 2.5rem; height: 2.5rem; margin-right: 1rem;"> <!-- Use skill.icon as src -->
                <h2>${skill.name}</h2>
            </div>
            <div class="skill-section">
                <h3 class="section-title-ui">Required Tools</h3>
                <div class="tools-grid">
            `;
            (skill.tools || []).forEach(tool => {
                html += `
                <div class="tool-item">
                    <i class="fas fa-toolbox"></i> <!-- You might want to add custom tool icons too -->
                    <div>${tool}</div>
                </div>
                `;
            });
            html += `
                </div>
            </div>
            <div class="skill-section">
                <h3 class="section-title-ui">Step-by-Step Guide</h3>
                <div class="steps-container">
            `;
            (skill.steps || []).forEach(step => {
                html += `
                <div class="step-card">
                    <img src="${step.image}" alt="${step.title}" class="step-image">
                    <div class="step-content">
                        <h4 class="step-title">${step.title}</h4>
                        <p>${step.description}</p>
                    </div>
                </div>
                `;
            });
            html += `
                </div>
            </div>
            <div class="skill-section">
                <h3 class="section-title-ui">Theory & Principles</h3>
                <div class="theory-content">
                    <p>${skill.theory}</p>
                </div>
            </div>
            <div class="skill-section">
                <h3 class="section-title-ui">Knowledge Check</h3>
                <div class="quiz-container" id="quiz-container">
            `;
            (skill.quiz || []).forEach((q, index) => {
                html += `
                <div class="question">
                    <div class="question-text">${q.question}</div>
                    <div class="options">
                `;
                (q.options || []).forEach((opt, optIndex) => {
                    html += `
                    <div class="option" data-question="${index}" data-option="${optIndex}">
                        <input type="radio" name="q${index}" id="q${index}o${optIndex}">
                        <label for="q${index}o${optIndex}">${String.fromCharCode(65 + optIndex)}. ${opt}</label>
                    </div>
                    `;
                });
                html += `
                    </div>
                    <div class="quiz-result" id="result-${index}" style="display:none;"></div>
                </div>
                `;
            });
            html += `
                </div>
                <div class="quiz-nav">
                    <button class="back-btn" onclick="goBackToGrid()"> Back to Skills</button>
                    <button class="skill-btn" onclick="checkQuiz('${skillId}')">Check Answers</button>
                </div>
            </div>
            `;
            document.getElementById('skill-detail').innerHTML = html;

            // Add event listeners for quiz options
            document.querySelectorAll('.option').forEach(option => {
                option.addEventListener('click', function() {
                    const questionIndex = this.dataset.question;
                    const optionIndex = this.dataset.option;
                    document.querySelectorAll(`.option[data-question="${questionIndex}"]`).forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                });
            });
        }

        function goBackToGrid() {
            document.getElementById('skill-detail').style.display = 'none';
            document.getElementById('skill-grid').style.display = 'grid';
        }

        function checkQuiz(skillId) {
            const skill = skillsData.find(s => s.id === skillId);
            if (!skill || !skill.quiz) return;

            let allCorrect = true;
            skill.quiz.forEach((q, index) => {
                const selectedOptionElement = document.querySelector(`.option[data-question="${index}"].selected`);
                const selectedOptionIndex = selectedOptionElement ? parseInt(selectedOptionElement.dataset.option) : -1;
                const resultElement = document.getElementById(`result-${index}`);

                if (selectedOptionIndex === q.correctAnswerIndex) {
                    resultElement.textContent = 'Correct!';
                    resultElement.className = 'quiz-result correct';
                } else {
                    resultElement.textContent = `Incorrect. Correct answer: ${String.fromCharCode(65 + q.correctAnswerIndex)}. ${q.options[q.correctAnswerIndex]}`;
                    resultElement.className = 'quiz-result incorrect';
                    allCorrect = false;
                }
                resultElement.style.display = 'block';
            });

            if (allCorrect && currentUser) {
                // Mark skill as completed for the user
                const updatedCompletedSkills = [...(currentUser.completedSkills || []), skillId];
                 db.collection('users').doc(currentUser.id).update({
                    completedSkills: updatedCompletedSkills
                 }).then(() => {
                     currentUser.completedSkills = updatedCompletedSkills; // Update local cache
                     alert('Quiz passed! Skill marked as completed.');
                     // Potentially update the skill card UI to reflect completion
                     loadSkillGrid(); // Reload grid to show 'Review' button
                 }).catch(error => {
                     console.error('Error marking skill as complete:', error);
                     // Handle error appropriately
                 });
            }
        }


        // --- Helper Functions for Forms ---
        function addEmptyStep() {
            const stepsContainer = document.getElementById('steps-container');
            const index = stepsContainer.children.length;
            const stepDiv = document.createElement('div');
            stepDiv.className = 'step-item';
            stepDiv.innerHTML = `
                <h4>Step ${index + 1}</h4>
                <div class="form-col full-width">
                    <label>Title</label>
                    <input type="text" class="step-title-input" placeholder="Step title">
                </div>
                <div class="form-col full-width">
                    <label>Description</label>
                    <textarea class="step-desc-input" placeholder="Step description"></textarea>
                </div>
                <div class="form-col full-width">
                    <label>Image URL</label>
                    <input type="url" class="step-image-input" placeholder="https://example.com/image.jpg">
                </div>
                <div class="step-controls">
                    <button class="btn btn-danger btn-sm" onclick="this.parentElement.parentElement.remove()">Remove</button>
                </div>
            `;
            stepsContainer.appendChild(stepDiv);
        }

        function addStepToForm(index, stepData) {
             const stepsContainer = document.getElementById('steps-container');
             const stepDiv = document.createElement('div');
             stepDiv.className = 'step-item';
             stepDiv.innerHTML = `
                 <h4>Step ${index + 1}</h4>
                 <div class="form-col full-width">
                     <label>Title</label>
                     <input type="text" class="step-title-input" placeholder="Step title" value="${stepData.title || ''}">
                 </div>
                 <div class="form-col full-width">
                     <label>Description</label>
                     <textarea class="step-desc-input" placeholder="Step description">${stepData.description || ''}</textarea>
                 </div>
                 <div class="form-col full-width">
                     <label>Image URL</label>
                     <input type="url" class="step-image-input" placeholder="https://example.com/image.jpg" value="${stepData.image || ''}">
                 </div>
                 <div class="step-controls">
                     <button class="btn btn-danger btn-sm" onclick="this.parentElement.parentElement.remove()">Remove</button>
                 </div>
             `;
             stepsContainer.appendChild(stepDiv);
        }

         function addEmptyQuizQuestion() {
            const quizContainer = document.getElementById('quiz-container');
            const index = quizContainer.children.length;
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-item';
            questionDiv.innerHTML = `
                <h4>Question ${index + 1}</h4>
                <div class="form-col full-width">
                    <label>Question Text</label>
                    <input type="text" class="question-text-input" placeholder="Enter the question">
                </div>
                <div class="form-col full-width">
                    <label>Options (One per line)</label>
                    <textarea class="question-options-input" placeholder="Option A&#10;Option B&#10;Option C&#10;Option D"></textarea>
                </div>
                <div class="form-col">
                    <label>Correct Answer Index (0 for A, 1 for B, etc.)</label>
                    <input type="number" class="question-correct-index-input" min="0" max="3" value="0">
                </div>
                <div class="question-controls">
                    <button class="btn btn-danger btn-sm" onclick="this.parentElement.parentElement.remove()">Remove</button>
                </div>
            `;
            quizContainer.appendChild(questionDiv);
        }

         function addQuizQuestionToForm(index, questionData) {
             const quizContainer = document.getElementById('quiz-container');
             const questionDiv = document.createElement('div');
             questionDiv.className = 'question-item';
             const optionsText = (questionData.options || []).join('\n');
             questionDiv.innerHTML = `
                 <h4>Question ${index + 1}</h4>
                 <div class="form-col full-width">
                     <label>Question Text</label>
                     <input type="text" class="question-text-input" placeholder="Enter the question" value="${questionData.question || ''}">
                 </div>
                 <div class="form-col full-width">
                     <label>Options (One per line)</label>
                     <textarea class="question-options-input" placeholder="Option A&#10;Option B&#10;Option C&#10;Option D">${optionsText}</textarea>
                 </div>
                 <div class="form-col">
                     <label>Correct Answer Index (0 for A, 1 for B, etc.)</label>
                     <input type="number" class="question-correct-index-input" min="0" max="3" value="${questionData.correctAnswerIndex || 0}">
                 </div>
                 <div class="question-controls">
                     <button class="btn btn-danger btn-sm" onclick="this.parentElement.parentElement.remove()">Remove</button>
                 </div>
             `;
             quizContainer.appendChild(questionDiv);
        }

    </script>

</body>
</html>
