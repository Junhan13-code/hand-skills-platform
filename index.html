<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hand Skills Learning Platform</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* --- CSS REMAINS THE SAME AS IN YOUR ORIGINAL FILE --- */
        /* Paste the entire CSS block from your original file here */
        * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.container {
    width: 100%;
    max-width: 1200px;
    background: white;
    border-radius: 20px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    overflow: hidden;
}

/* Login Form */
.login-form {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 60px 40px;
    text-align: center;
}

.logo {
    width: 120px;
    height: 120px;
    background: linear-gradient(45deg, #667eea, #764ba2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 30px;
    color: white;
    font-size: 40px;
}

.login-form h2 {
    color: #333;
    margin-bottom: 30px;
    font-size: 2rem;
}

.form-group {
    width: 100%;
    max-width: 350px;
    margin-bottom: 20px;
}

.form-group input {
    width: 100%;
    padding: 15px;
    border: 2px solid #e1e5e9;
    border-radius: 10px;
    font-size: 16px;
    transition: border-color 0.3s;
}

.form-group input:focus {
    outline: none;
    border-color: #667eea;
}

.btn {
    background: linear-gradient(45deg, #667eea, #764ba2);
    color: white;
    border: none;
    padding: 15px 40px;
    border-radius: 10px;
    cursor: pointer;
    font-size: 16px;
    transition: transform 0.2s;
}

.btn:hover {
    transform: translateY(-2px);
}

.login-error {
    color: #e74c3c;
    margin-top: 15px;
    font-weight: 500;
}

/* Admin Dashboard */
.admin-dashboard {
    display: none;
    min-height: 600px;
}

.dashboard-layout {
    display: flex;
    min-height: 600px;
}

.sidebar {
    width: 250px;
    background: #2c3e50;
    color: white;
    padding: 20px 0;
}

.nav-item {
    padding: 15px 20px;
    cursor: pointer;
    transition: background 0.3s;
    display: flex;
    align-items: center;
}

.nav-item i {
    margin-right: 10px;
}

.nav-item:hover {
    background: #34495e;
}

.nav-item.active {
    background: #3498db;
}

.main-content {
    flex: 1;
    padding: 30px;
    background: #ecf0f1;
}

.section {
    display: none;
}

.section.active {
    display: block;
}

/* Skills List */
.skills-list {
    display: grid;
    gap: 20px;
}

.skill-card {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    border-left: 4px solid #3498db;
}

.skill-actions {
    margin-top: 15px;
    display: flex;
    gap: 10px;
}

.action-btn {
    padding: 8px 15px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
}

.edit-btn {
    background: #2ecc71;
    color: white;
}

.delete-btn {
    background: #e74c3c;
    color: white;
}

/* Edit Form */
.edit-form {
    display: none;
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

.form-group-full {
    grid-column: 1 / -1;
}

.step-item, .quiz-question {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    border: 1px solid #dee2e6;
}

.step-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.step-header h4 {
    color: #2c3e50;
}

.step-content {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

/* User Interface */
.user-interface {
    display: none;
    min-height: 600px;
}

.skill-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    padding: 20px;
}

.skill-card-ui {
    background: white;
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    cursor: pointer;
    transition: transform 0.3s;
    border: 1px solid #eee;
}

.skill-card-ui:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
}

.skill-icon {
    font-size: 3rem;
    color: #667eea;
    margin-bottom: 15px;
    text-align: center;
}

.skill-content {
    text-align: center;
}

.skill-name {
    color: #2c3e50;
    margin-bottom: 10px;
}

.skill-desc {
    color: #7f8c8d;
    margin-bottom: 15px;
    font-size: 0.9rem;
}

.skill-btn {
    background: linear-gradient(45deg, #667eea, #764ba2);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 25px;
    cursor: pointer;
    width: 100%;
}

/* Skill Detail */
.skill-detail {
    display: none;
    padding: 20px;
}

.skill-header {
    text-align: center;
    margin-bottom: 30px;
}

.skill-header i {
    font-size: 4rem;
    color: #667eea;
    margin-bottom: 15px;
}

.skill-header h2 {
    color: #2c3e50;
}

.skill-section {
    background: white;
    padding: 25px;
    border-radius: 10px;
    margin-bottom: 20px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
}

.section-title-ui {
    color: #2c3e50;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #eee;
}

.tools-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 15px;
}

.tool-item {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    border: 1px solid #dee2e6;
}

.step-card {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

.step-image {
    width: 150px;
    height: 100px;
    object-fit: cover;
    border-radius: 5px;
}

.step-content {
    flex: 1;
}

.step-title {
    color: #2c3e50;
    margin-bottom: 10px;
}

.theory-content {
    line-height: 1.6;
    color: #555;
}

.question {
    margin-bottom: 25px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

.question-text {
    font-weight: bold;
    margin-bottom: 15px;
    color: #2c3e50;
}

.options {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.option {
    display: flex;
    align-items: center;
    padding: 8px;
    cursor: pointer;
    border-radius: 5px;
    transition: background 0.2s;
}

.option:hover {
    background: #e9ecef;
}

.option.selected {
    background: #d1ecf1;
    border: 1px solid #bee5eb;
}

.option input[type="radio"] {
    margin-right: 10px;
}

.quiz-result {
    margin-top: 10px;
    padding: 8px;
    border-radius: 5px;
    font-weight: bold;
}

.correct {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.incorrect {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.quiz-nav {
    display: flex;
    justify-content: space-between;
    margin-top: 20px;
}

.back-btn {
    background: #6c757d;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
}

/* Responsive */
@media (max-width: 768px) {
    .dashboard-layout {
        flex-direction: column;
    }
    
    .sidebar {
        width: 100%;
        padding: 10px 0;
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .step-content {
        grid-template-columns: 1fr;
    }
    
    .skill-grid {
        grid-template-columns: 1fr;
    }
}
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Form -->
        <div id="loginForm" class="login-form">
            <div class="logo">
                <i class="fas fa-hand-holding-heart"></i>
            </div>
            <h2>Admin Login</h2>
            <div class="form-group">
                <input type="text" id="username" placeholder="Username" value="admin@yoursite.com"> <!-- Example email -->
            </div>
            <div class="form-group">
                <input type="password" id="password" placeholder="Password" value="MySuperSecretPassword123!"> <!-- Example password -->
            </div>
            <button class="btn" onclick="login()">Login</button>
            <div id="login-error" class="login-error"></div>
        </div>

        <!-- Admin Dashboard -->
        <div id="adminDashboard" class="admin-dashboard">
            <div class="dashboard-layout">
                <div class="sidebar">
                    <div class="nav-item active" onclick="showSection('skills')">
                        <i class="fas fa-tools"></i>
                        Manage Skills
                    </div>
                    <div class="nav-item" onclick="showSection('analytics')">
                        <i class="fas fa-chart-bar"></i>
                        Analytics
                    </div>
                    <div class="nav-item" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        Logout
                    </div>
                </div>
                <div class="main-content">
                    <!-- Skills Section -->
                    <div id="skills-section" class="section">
                        <h2>Manage Skills</h2>
                        <button class="btn" onclick="addNewSkill()" style="margin-bottom: 20px;">
                            <i class="fas fa-plus"></i> Add New Skill
                        </button>
                        <div id="skillsList" class="skills-list">
                            <!-- Skills will be loaded here dynamically -->
                        </div>
                    </div>

                    <!-- Analytics Section (Placeholder) -->
                    <div id="analytics-section" class="section">
                        <h2>Analytics</h2>
                        <p>Coming soon...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Skill Form -->
        <div id="edit-skill-form" class="edit-form">
            <h2>Edit Skill</h2>
            <div class="form-row">
                <div>
                    <label>Name</label>
                    <input type="text" id="edit-skill-name" placeholder="Skill name">
                </div>
                <div>
                    <label>Icon Class</label>
                    <input type="text" id="edit-skill-icon" placeholder="e.g., fas fa-bolt">
                </div>
            </div>
            <div class="form-group-full">
                <label>Description</label>
                <textarea id="edit-skill-description" rows="3" placeholder="Skill description"></textarea>
            </div>
            <div class="form-group-full">
                <label>Tools (comma separated)</label>
                <input type="text" id="edit-tools" placeholder="Tool 1, Tool 2, Tool 3">
            </div>
            <div class="form-group-full">
                <label>Theory</label>
                <textarea id="edit-theory" rows="5" placeholder="Theory content..."></textarea>
            </div>

            <h3 style="margin: 20px 0 10px;">Steps</h3>
            <div id="steps-container">
                <!-- Steps will be added here dynamically -->
            </div>
            <button class="btn" onclick="addStep()" style="margin-bottom: 20px;">
                <i class="fas fa-plus"></i> Add Step
            </button>

            <h3 style="margin: 20px 0 10px;">Quiz Questions</h3>
            <div id="quiz-container">
                <!-- Quiz questions will be added here dynamically -->
            </div>
            <button class="btn" onclick="addQuizQuestion()" style="margin-bottom: 20px;">
                <i class="fas fa-plus"></i> Add Question
            </button>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn" onclick="saveSkill()">Save Skill</button>
                <button class="btn" style="background: #6c757d;" onclick="showSection('skills')">Cancel</button>
            </div>
        </div>

        <!-- User Interface -->
        <div id="userInterface" class="user-interface">
            <div class="skill-grid" id="skill-grid">
                <!-- Skills will be loaded here dynamically -->
            </div>
            <div class="skill-detail" id="skill-detail">
                <!-- Skill details will be loaded here dynamically -->
            </div>
        </div>
    </div>

    <script>
      // --- Firebase Initialization ---
      // Import Firebase SDK modules
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
      import {
        getAuth,
        signInWithEmailAndPassword,
        signOut,
        onAuthStateChanged // To check login status on page load
      } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
      import {
        getFirestore,
        collection,
        getDocs,
        addDoc,
        updateDoc,
        deleteDoc,
        doc,
        setDoc
      } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

      // Your Firebase configuration (paste the object from Phase 2, Step 5 here)
      const firebaseConfig = {
        apiKey: "AIzaSyA6ZdINHlRF583T3HL5RsA4q2fmHeBcB_g",
        authDomain: "hand-skills-platform.firebaseapp.com",
        projectId: "hand-skills-platform",
        storageBucket: "hand-skills-platform.firebasestorage.app",
        messagingSenderId: "1021058690748",
        appId: "1:1021058690748:web:40fd86d1060d90bbe1eab9",
        measurementId: "G-R2J40EVW18"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // Global variable to hold skills data fetched from Firestore
      let skillsData = [];
      let currentEditingSkill = null; // Keeps track of skill being edited in admin panel
      let currentViewedSkillId = null; // Keeps track of skill being viewed in user interface

      // --- Firebase Helper Functions ---

      // Fetch all skills from Firestore
      async function loadSkillsFromFirestore() {
        try {
          const querySnapshot = await getDocs(collection(db, "skills"));
          skillsData = [];
          querySnapshot.forEach((doc) => {
            skillsData.push({ id: doc.id, ...doc.data() }); // Include Firestore document ID
          });
          console.log("Skills loaded from Firestore:", skillsData);
          return skillsData;
        } catch (error) {
          console.error("Error loading skills: ", error);
          alert("Error loading skills from server.");
        }
      }

      // --- Updated Application Logic ---

      // Check if user is logged in using Firebase Auth state persistence
      function checkLoginStatus() {
        onAuthStateChanged(auth, (user) => {
          if (user) {
            // User is signed in, see docs for a list of available properties
            // https://firebase.google.com/docs/reference/js/auth.user
            console.log("User is logged in:", user.email);
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'block';
            document.getElementById('userInterface').style.display = 'none';
            // Load skills after confirming admin is logged in
            loadSkillsFromFirestore().then(() => {
                 loadSkillsList(); // Load skills into the admin panel
                 // Load skills into the user interface if needed elsewhere
                 if (typeof loadSkillGrid === 'function') {
                     loadSkillGrid(); // Assuming loadSkillGrid is defined later in this script
                 }
             });
          } else {
            // User is signed out
            console.log("User is logged out");
            document.getElementById('loginForm').style.display = 'flex';
            document.getElementById('adminDashboard').style.display = 'none';
            document.getElementById('userInterface').style.display = 'none';
          }
        });
      }

      // Login function using Firebase Auth
      async function login() {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;

        // Basic validation
        if (!username || !password) {
          showError('Please enter both username and password.');
          return;
        }

        try {
          // Attempt to sign in with Firebase Auth
          // Note: You need to create this user in the Firebase Console first under "Authentication > Users"
          // For now, let's assume you have an admin user: admin@yoursite.com / MySuperSecretPassword123!
          const userCredential = await signInWithEmailAndPassword(auth, username, password);
          const user = userCredential.user;
          console.log("Login successful:", user.email);
          // onAuthStateChanged will handle showing the dashboard
        } catch (error) {
          console.error("Login error:", error);
          let errorMessage = 'Invalid credentials';
          if (error.code === 'auth/user-not-found') {
            errorMessage = 'User not found. Please create the admin user in Firebase Console.';
          } else if (error.code === 'auth/wrong-password') {
            errorMessage = 'Incorrect password.';
          } else if (error.code === 'auth/too-many-requests') {
            errorMessage = 'Too many failed attempts. Try again later.';
          }
          showError(errorMessage);
        }
      }

      // Logout function using Firebase Auth
      function logout() {
        signOut(auth).then(() => {
          console.log("User logged out successfully.");
          // onAuthStateChanged will handle hiding the dashboard
        }).catch((error) => {
          console.error("Logout error:", error);
          // Handle logout errors if needed
        });
      }

      // Show different sections in admin panel (unchanged)
      function showSection(section) {
        // Hide all sections
        document.querySelectorAll('.section').forEach(el => el.style.display = 'none');
        document.getElementById('edit-skill-form').style.display = 'none';
        // Remove active class from all nav items
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
        // Show selected section and highlight nav item
        document.getElementById(`${section}-section`).style.display = 'block';
        document.querySelector(`.nav-item[onclick="showSection('${section}')"]`).classList.add('active');
      }

      // Load skills list in admin panel (updated to use skillsData)
      function loadSkillsList() {
        const skillsList = document.getElementById('skillsList');
        if (!skillsList) return; // Guard clause if element isn't found
        skillsList.innerHTML = '';
        if (!skillsData || skillsData.length === 0) {
             skillsList.innerHTML = '<p>No skills found. Add one?</p>';
             return;
        }
        skillsData.forEach(skill => {
          const skillCard = document.createElement('div');
          skillCard.className = 'skill-card';
          skillCard.innerHTML = `
            <h4>${skill.name}</h4>
            <p>${skill.description.substring(0, 100)}...</p>
            <div class="skill-actions">
              <button class="action-btn edit-btn" onclick="editSkill('${skill.id}')">Edit</button>
              <button class="action-btn delete-btn" onclick="deleteSkill('${skill.id}')">Delete</button>
            </div>
          `;
          skillsList.appendChild(skillCard);
        });
      }

      // Add new skill (updated)
      function addNewSkill() {
        currentEditingSkill = {
          id: null, // Will be generated by Firestore on save
          name: '',
          icon: '',
          description: '',
          tools: [],
          steps: [],
          theory: '',
          quiz: []
        };
        showEditForm();
      }

      // Edit existing skill (updated)
      function editSkill(skillId) {
        // Find the skill object based on the ID passed from the button
        currentEditingSkill = skillsData.find(skill => skill.id === skillId);
        if (currentEditingSkill) {
          showEditForm();
        } else {
          console.error("Skill not found for editing:", skillId);
          alert("Skill not found.");
        }
      }

      // Show edit form (updated to populate from currentEditingSkill)
      function showEditForm() {
        if (!currentEditingSkill) {
          console.error("No skill selected for editing.");
          return;
        }
        document.getElementById('edit-skill-name').value = currentEditingSkill.name || '';
        document.getElementById('edit-skill-icon').value = currentEditingSkill.icon || '';
        document.getElementById('edit-skill-description').value = currentEditingSkill.description || '';
        document.getElementById('edit-tools').value = currentEditingSkill.tools ? currentEditingSkill.tools.join(', ') : '';
        document.getElementById('edit-theory').value = currentEditingSkill.theory || '';

        // Populate steps
        const stepsContainer = document.getElementById('steps-container');
        stepsContainer.innerHTML = ''; // Clear previous steps
        (currentEditingSkill.steps || []).forEach((step, index) => {
          addStepToForm(index, step);
        });

        // Populate quiz
        const quizContainer = document.getElementById('quiz-container');
        quizContainer.innerHTML = ''; // Clear previous questions
        (currentEditingSkill.quiz || []).forEach((question, index) => {
          addQuizQuestionToForm(index, question);
        });

        // Show form
        document.getElementById('skills-section').style.display = 'none';
        document.getElementById('edit-skill-form').style.display = 'block';
      }

      // Add step to form (unchanged)
      function addStepToForm(index, step = null) {
        const stepsContainer = document.getElementById('steps-container');
        const stepId = index !== undefined ? index : (currentEditingSkill.steps ? currentEditingSkill.steps.length : 0);
        const stepObj = step || {
          title: '',
          description: '',
          image: ''
        };

        // Ensure the steps array exists
        if (!currentEditingSkill.steps) {
            currentEditingSkill.steps = [];
        }
        // Add placeholder for the new step if it's a new step
        if (stepId >= currentEditingSkill.steps.length) {
            currentEditingSkill.steps.push(stepObj);
        }

        const stepElement = document.createElement('div');
        stepElement.className = 'step-item';
        stepElement.id = `step-${stepId}`;
        stepElement.innerHTML = `
          <div class="step-header">
            <h4>Step ${stepId + 1}</h4>
            <button class="action-btn delete-btn" onclick="removeStep(${stepId})">Remove</button>
          </div>
          <div class="step-content">
            <div>
              <label>Title</label>
              <input type="text" value="${stepObj.title}" onchange="updateStepField(${stepId}, 'title', this.value)" placeholder="Step title">
            </div>
            <div>
              <label>Description</label>
              <textarea onchange="updateStepField(${stepId}, 'description', this.value)" placeholder="Step description">${stepObj.description}</textarea>
            </div>
            <div>
              <label>Image URL</label>
              <input type="text" value="${stepObj.image}" onchange="updateStepField(${stepId}, 'image', this.value)" placeholder="Image URL">
            </div>
          </div>
        `;
        stepsContainer.appendChild(stepElement);
      }

      // Add new step (updated)
      function addStep() {
        if (!currentEditingSkill.steps) currentEditingSkill.steps = [];
        currentEditingSkill.steps.push({
          title: '',
          description: '',
          image: ''
        });
        addStepToForm(); // Pass undefined index to indicate it's a new step
      }

      // Update step field (unchanged)
      function updateStepField(index, field, value) {
        if (currentEditingSkill.steps && currentEditingSkill.steps[index]) {
          currentEditingSkill.steps[index][field] = value;
        }
      }

      // Remove step (updated)
      function removeStep(index) {
        if (currentEditingSkill.steps && currentEditingSkill.steps[index]) {
          currentEditingSkill.steps.splice(index, 1);
          // Re-render all steps after removal
          const stepsContainer = document.getElementById('steps-container');
          stepsContainer.innerHTML = '';
          currentEditingSkill.steps.forEach((step, idx) => {
            addStepToForm(idx, step); // Pass index and object to repopulate correctly
          });
        }
      }

      // Add quiz question to form (unchanged)
      function addQuizQuestionToForm(index, question = null) {
        const quizContainer = document.getElementById('quiz-container');
        const questionId = index !== undefined ? index : (currentEditingSkill.quiz ? currentEditingSkill.quiz.length : 0);
        const q = question || {
          question: '',
          options: ['', '', '', ''],
          answer: 0
        };

         // Ensure the quiz array exists
        if (!currentEditingSkill.quiz) {
            currentEditingSkill.quiz = [];
        }
        // Add placeholder for the new question if it's a new question
        if (questionId >= currentEditingSkill.quiz.length) {
            currentEditingSkill.quiz.push(q);
        }

        const questionElement = document.createElement('div');
        questionElement.className = 'quiz-question';
        questionElement.id = `question-${questionId}`;
        questionElement.innerHTML = `
          <div class="step-header">
            <h4>Question ${questionId + 1}</h4>
            <button class="action-btn delete-btn" onclick="removeQuizQuestion(${questionId})">Remove</button>
          </div>
          <div>
            <label>Question</label>
            <input type="text" value="${q.question}" onchange="updateQuizField(${questionId}, 'question', this.value)" placeholder="Question text">
          </div>
          <div class="quiz-options">
            <div>
              <label>Option A</label>
              <input type="text" value="${q.options[0]}" onchange="updateQuizOption(${questionId}, 0, this.value)" placeholder="Option A">
            </div>
            <div>
              <label>Option B</label>
              <input type="text" value="${q.options[1]}" onchange="updateQuizOption(${questionId}, 1, this.value)" placeholder="Option B">
            </div>
            <div>
              <label>Option C</label>
              <input type="text" value="${q.options[2]}" onchange="updateQuizOption(${questionId}, 2, this.value)" placeholder="Option C">
            </div>
            <div>
              <label>Option D</label>
              <input type="text" value="${q.options[3]}" onchange="updateQuizOption(${questionId}, 3, this.value)" placeholder="Option D">
            </div>
          </div>
          <div>
            <label>Correct Answer (0=A, 1=B, 2=C, 3=D)</label>
            <input type="number" min="0" max="3" value="${q.answer}" onchange="updateQuizField(${questionId}, 'answer', parseInt(this.value))">
          </div>
        `;
        quizContainer.appendChild(questionElement);
      }

      // Add new quiz question (updated)
      function addQuizQuestion() {
        if (!currentEditingSkill.quiz) currentEditingSkill.quiz = [];
        currentEditingSkill.quiz.push({
          question: '',
          options: ['', '', '', ''],
          answer: 0
        });
        addQuizQuestionToForm(); // Pass undefined index to indicate it's a new question
      }

      // Update quiz field (unchanged)
      function updateQuizField(questionId, field, value) {
        if (currentEditingSkill.quiz && currentEditingSkill.quiz[questionId]) {
          currentEditingSkill.quiz[questionId][field] = value;
        }
      }

      // Update quiz option (unchanged)
      function updateQuizOption(questionId, optionIndex, value) {
        if (currentEditingSkill.quiz[questionId] && currentEditingSkill.quiz[questionId].options[optionIndex] !== undefined) {
          currentEditingSkill.quiz[questionId].options[optionIndex] = value;
        }
      }

      // Remove quiz question (updated)
      function removeQuizQuestion(index) {
        if (currentEditingSkill.quiz && currentEditingSkill.quiz[index]) {
          currentEditingSkill.quiz.splice(index, 1);
          // Re-render all questions after removal
          const quizContainer = document.getElementById('quiz-container');
          quizContainer.innerHTML = '';
          currentEditingSkill.quiz.forEach((question, idx) => {
            addQuizQuestionToForm(idx, question); // Pass index and object to repopulate correctly
          });
        }
      }

      // Save skill to Firestore (NEW FUNCTION)
      async function saveSkill() {
        if (!currentEditingSkill) {
          console.error("No skill is currently being edited.");
          return;
        }

        try {
          // Update current skill with form values
          currentEditingSkill.name = document.getElementById('edit-skill-name').value;
          currentEditingSkill.icon = document.getElementById('edit-skill-icon').value;
          currentEditingSkill.description = document.getElementById('edit-skill-description').value;
          currentEditingSkill.tools = document.getElementById('edit-tools').value.split(',').map(t => t.trim()).filter(t => t);
          currentEditingSkill.theory = document.getElementById('edit-theory').value;

          // Determine if it's a new skill or updating an existing one
          if (!currentEditingSkill.id) {
            // It's a new skill - add to Firestore collection
            const docRef = await addDoc(collection(db, "skills"), currentEditingSkill);
            console.log("New skill added with ID: ", docRef.id);
            currentEditingSkill.id = docRef.id; // Assign the generated ID
            skillsData.push(currentEditingSkill); // Update local cache
          } else {
            // It's an existing skill - update the specific document
            const skillDocRef = doc(db, "skills", currentEditingSkill.id);
            await updateDoc(skillDocRef, currentEditingSkill);
            console.log("Skill updated with ID: ", currentEditingSkill.id);
            // Update local cache
            const index = skillsData.findIndex(s => s.id === currentEditingSkill.id);
            if (index !== -1) {
                skillsData[index] = currentEditingSkill;
            }
          }

          // Show success message
          alert('Skill saved successfully!');

          // Go back to skills list
          document.getElementById('edit-skill-form').style.display = 'none';
          document.getElementById('skills-section').style.display = 'block';

          // Reload skills list from Firestore to reflect changes
          await loadSkillsFromFirestore();
          loadSkillsList();

        } catch (error) {
          console.error("Error saving skill: ", error);
          alert("Error saving skill to server.");
        }
      }

      // Delete skill from Firestore (NEW FUNCTION)
      async function deleteSkill(skillId) {
        if (!confirm('Are you sure you want to delete this skill? This action cannot be undone.')) {
          return; // Exit if user cancels
        }

        try {
          // Delete the document from Firestore
          await deleteDoc(doc(db, "skills", skillId));
          console.log("Skill deleted with ID: ", skillId);

          // Update local cache
          skillsData = skillsData.filter(skill => skill.id !== skillId);

          // Reload the skills list in the UI
          loadSkillsList();

        } catch (error) {
          console.error("Error deleting skill: ", error);
          alert("Error deleting skill from server.");
        }
      }

      // Show error message (unchanged)
      function showError(msg) {
        document.getElementById('login-error').textContent = msg;
      }


      // --- User Interface Functions (Updated to use skillsData) ---

      // Load skill grid for user interface (updated)
      function loadSkillGrid() {
        const gridElement = document.getElementById('skill-grid');
        if (!gridElement) return; // Guard clause
        gridElement.innerHTML = ''; // Clear previous content
        if (!skillsData || skillsData.length === 0) {
             gridElement.innerHTML = '<p>No skills available yet.</p>';
             return;
        }
        skillsData.forEach(skill => {
          const skillCard = document.createElement('div');
          skillCard.className = 'skill-card-ui';
          // Pass the unique Firestore ID to the loadSkillDetail function
          skillCard.onclick = () => {
              currentViewedSkillId = skill.id; // Store the ID of the skill being viewed
              loadSkillDetail(skill.id);
          };
          skillCard.innerHTML = `
            <div class="skill-icon">
              <i class="${skill.icon}"></i>
            </div>
            <div class="skill-content">
              <h3 class="skill-name">${skill.name}</h3>
              <p class="skill-desc">${skill.description}</p>
              <button class="skill-btn">Learn Now</button>
            </div>
          `;
          gridElement.appendChild(skillCard);
        });
      }

      // Load detail view for a specific skill (updated)
      function loadSkillDetail(skillId) {
        // Find the skill object based on the ID passed from the card click
        const skill = skillsData.find(s => s.id === skillId);
        if (!skill) {
             console.error("Skill not found for detail view:", skillId);
             document.getElementById('skill-detail').innerHTML = '<p>Skill not found.</p>';
             document.getElementById('skill-grid').style.display = 'grid';
             document.getElementById('skill-detail').style.display = 'block'; // Still show container
             return;
        }

        document.getElementById('skill-grid').style.display = 'none';
        document.getElementById('skill-detail').style.display = 'block';

        let html = `
          <div class="skill-header">
            <i class="${skill.icon}"></i>
            <h2>${skill.name}</h2>
          </div>
          <div class="skill-section">
            <h3 class="section-title-ui">Required Tools</h3>
            <div class="tools-grid">
        `;
        (skill.tools || []).forEach(tool => {
          html += `
            <div class="tool-item">
              <i class="fas fa-toolbox"></i>
              <div>${tool}</div>
            </div>
          `;
        });
        html += `
            </div>
          </div>
          <div class="skill-section">
            <h3 class="section-title-ui">Step-by-Step Guide</h3>
            <div class="steps-container">
        `;
        (skill.steps || []).forEach(step => {
          html += `
            <div class="step-card">
              <img src="${step.image || 'https://placehold.co/200'}" alt="${step.title}" class="step-image">
              <div class="step-content">
                <h4 class="step-title">${step.title}</h4>
                <p>${step.description}</p>
              </div>
            </div>
          `;
        });
        html += `
            </div>
          </div>
          <div class="skill-section">
            <h3 class="section-title-ui">Theory & Principles</h3>
            <div class="theory-content">
              <p>${skill.theory}</p>
            </div>
          </div>
          <div class="skill-section">
            <h3 class="section-title-ui">Knowledge Check</h3>
            <div class="quiz-container" id="quiz-container">
        `;
        (skill.quiz || []).forEach((q, index) => {
          html += `
            <div class="question">
              <div class="question-text">${q.question}</div>
              <div class="options">
          `;
          q.options.forEach((opt, optIndex) => {
            html += `
              <div class="option" data-question="${index}" data-option="${optIndex}">
                <input type="radio" name="q${index}" id="q${index}o${optIndex}">
                <label for="q${index}o${optIndex}">${String.fromCharCode(65 + optIndex)}. ${opt}</label>
              </div>
            `;
          });
          html += `
              </div>
              <div class="quiz-result" id="result-${index}" style="display:none;"></div>
            </div>
          `;
        });
        html += `
            </div>
            <div class="quiz-nav">
              <button class="back-btn" onclick="goBackToGrid()">‚Üê Back to Skills</button>
              <button class="skill-btn" onclick="checkQuiz()">Check Answers</button>
            </div>
          </div>
        `;
        document.getElementById('skill-detail').innerHTML = html;

        // Add event listeners for quiz options
        document.querySelectorAll('.option').forEach(option => {
          option.addEventListener('click', function() {
            const questionIndex = this.dataset.question;
            const optionIndex = this.dataset.option;
            // Remove selected class from all options in this question
            document.querySelectorAll(`.option[data-question="${questionIndex}"]`).forEach(opt => {
              opt.classList.remove('selected');
            });
            // Add selected class to clicked option
            this.classList.add('selected');
          });
        });
      }

      // Check quiz answers (updated to use currentViewedSkillId)
      function checkQuiz() {
        // Get the skill ID from the stored variable
        if (!currentViewedSkillId) {
            console.error("Could not determine the skill ID for quiz. Ensure loadSkillDetail sets currentViewedSkillId.");
            alert("Cannot check quiz. Please reload the skill.");
            return;
        }

        // Find the skill object based on the stored ID
        const skillForQuiz = skillsData.find(s => s.id === currentViewedSkillId);
        if (!skillForQuiz) {
            console.error("Could not find skill data for quiz check.");
            alert("Skill data unavailable for quiz check.");
            return;
        }
        const quiz = skillForQuiz.quiz; // Use the quiz from the specific skill

        let score = 0;
        quiz.forEach((q, index) => {
          const selectedOption = document.querySelector(`.option[data-question="${index}"].selected`);
          if (selectedOption) {
            const selectedValue = parseInt(selectedOption.dataset.option);
            const resultDiv = document.getElementById(`result-${index}`);
            if (selectedValue === q.answer) {
              resultDiv.textContent = 'Correct!';
              resultDiv.className = 'quiz-result correct';
              score++;
            } else {
              resultDiv.textContent = `Incorrect. Correct answer: ${String.fromCharCode(65 + q.answer)}`;
              resultDiv.className = 'quiz-result incorrect';
            }
            resultDiv.style.display = 'block';
          }
        });

        // Show overall score
        const totalQuestions = quiz.length;
        if (totalQuestions > 0) {
            const percentage = Math.round((score / totalQuestions) * 100);
            alert(`Quiz completed!\nScore: ${score}/${totalQuestions} (${percentage}%)`);
        } else {
            alert("No quiz questions available for this skill.");
        }
      }


      // Go back to skill grid (unchanged)
      function goBackToGrid() {
        document.getElementById('skill-grid').style.display = 'grid';
        document.getElementById('skill-detail').style.display = 'none';
        // Clear the temporary variable when going back
        currentViewedSkillId = null;
      }

      // --- Initial Setup ---

      // Switch to user interface (unchanged)
      document.addEventListener('DOMContentLoaded', function() {
        // Add a demo button to switch to user interface (as in original)
        const adminHeader = document.querySelector('.admin-header');
        if (adminHeader) {
            const userBtn = document.createElement('button');
            userBtn.className = 'btn';
            userBtn.style.background = '#28a745';
            userBtn.textContent = 'Switch to User View';
            userBtn.onclick = function() {
              document.getElementById('loginForm').style.display = 'none';
              document.getElementById('adminDashboard').style.display = 'none';
              document.getElementById('userInterface').style.display = 'block';
              // Load skills for user view when switching
              loadSkillGrid();
            };
            adminHeader.appendChild(userBtn);
        }

        // Initialize the app by checking login status
        // This will also trigger loading skills if logged in
        checkLoginStatus();
      });

    </script>
</body>
</html>