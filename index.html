<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hand Skills Learning Platform - Admin & User System</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<!-- ADD Firebase Storage SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}
:root {
--primary: #4361ee;
--secondary: #3f37c9;
--accent: #4cc9f0;
--light: #f8f9fa;
--dark: #212529;
--gray: #6c757d;
--success: #4ade80;
--warning: #facc15;
--danger: #f87171;
--shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
--transition: all 0.3s ease;
}
body {
background-color: #f5f7fb;
color: var(--dark);
line-height: 1.6;
}
.container {
width: 100%;
max-width: 1200px;
margin: 0 auto;
padding: 0 20px;
}
/* Login Popup */
.login-popup {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0,0,0,0.7);
display: flex;
justify-content: center;
align-items: center;
z-index: 2000;
display: none;
}
.login-box {
background: white;
padding: 2.5rem;
border-radius: 10px;
box-shadow: var(--shadow);
width: 100%;
max-width: 450px;
text-align: center;
position: relative;
}
.login-box h2 {
margin-bottom: 1.5rem;
color: var(--primary);
}
.close-btn {
position: absolute;
top: 15px;
right: 15px;
font-size: 1.5rem;
cursor: pointer;
color: var(--gray);
}
.close-btn:hover {
color: var(--dark);
}
.form-group {
margin-bottom: 1.2rem;
text-align: left;
}
.form-group label {
display: block;
margin-bottom: 0.5rem;
font-weight: 500;
}
.form-group input, .form-group select {
width: 100%;
padding: 0.8rem;
border: 1px solid #ddd;
border-radius: 5px;
font-size: 1rem;
}
.btn {
display: block;
width: 100%;
padding: 0.8rem;
background: var(--primary);
color: white;
border: none;
border-radius: 5px;
font-size: 1rem;
font-weight: 600;
cursor: pointer;
transition: var(--transition);
margin-bottom: 0.5rem;
}
.btn:hover {
background: var(--secondary);
}
.btn-secondary {
background: var(--gray);
}
.btn-secondary:hover {
background: #5a6268;
}
.btn-success {
background: var(--success);
}
.btn-success:hover {
background: #22c55e;
}
.google-btn {
background: #DB4437;
}
.google-btn:hover {
background: #c23325;
}
.auth-toggle {
margin-top: 1rem;
color: var(--gray);
}
.auth-toggle a {
color: var(--primary);
text-decoration: none;
font-weight: 600;
}
.error-message {
color: var(--danger);
margin-top: 0.5rem;
font-size: 0.9rem;
}
.operation-message {
color: var(--success);
margin-top: 0.5rem;
font-size: 0.9rem;
}
/* Admin Dashboard */
.admin-dashboard {
display: none;
padding: 2rem 0;
}
.admin-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 2rem;
padding-bottom: 1rem;
border-bottom: 1px solid var(--light);
}
.admin-header h1 {
color: var(--primary);
}
.logout-btn {
background: var(--danger);
color: white;
border: none;
padding: 0.5rem 1rem;
border-radius: 5px;
cursor: pointer;
}
.admin-content {
display: grid;
grid-template-columns: 1fr 2fr;
gap: 2rem;
}
/* Navigation Panel */
.nav-panel {
background: white;
border-radius: 10px;
padding: 1.5rem;
box-shadow: var(--shadow);
}
.nav-panel h3 {
margin-bottom: 1.2rem;
padding-bottom: 0.5rem;
border-bottom: 1px solid var(--light);
}
.nav-item {
padding: 0.8rem;
margin-bottom: 0.5rem;
border-radius: 5px;
cursor: pointer;
transition: var(--transition);
}
.nav-item:hover, .nav-item.active {
background: var(--primary);
color: white;
}
/* Main Content Area */
.main-content-area {
background: white;
border-radius: 10px;
padding: 2rem;
box-shadow: var(--shadow);
}
.section-title {
font-size: 1.5rem;
color: var(--primary);
margin-bottom: 1.5rem;
padding-bottom: 0.5rem;
border-bottom: 1px solid var(--light);
}
.skill-list {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
gap: 1.5rem;
}
.skill-card {
border: 1px solid var(--light);
border-radius: 8px;
padding: 1.2rem;
cursor: pointer;
transition: var(--transition);
}
.skill-card:hover {
border-color: var(--primary);
transform: translateY(-3px);
box-shadow: 0 5px 15px rgba(0,0,0,0.05);
}
.skill-card h4 {
margin-bottom: 0.5rem;
color: var(--primary);
}
.skill-actions {
margin-top: 1rem;
display: flex;
gap: 0.5rem;
}
.action-btn {
padding: 0.4rem 0.8rem;
border-radius: 4px;
border: none;
cursor: pointer;
font-size: 0.9rem;
}
.edit-btn {
background: var(--warning);
color: white;
}
.delete-btn {
background: var(--danger);
color: white;
}
/* Edit Form */
.edit-form {
display: none;
}
.form-row {
display: flex;
gap: 1rem;
margin-bottom: 1.2rem;
}
.form-col {
flex: 1;
}
textarea {
width: 100%;
padding: 0.8rem;
border: 1px solid #ddd;
border-radius: 5px;
resize: vertical;
min-height: 100px;
}
.form-actions {
display: flex;
justify-content: flex-end;
gap: 1rem;
margin-top: 1.5rem;
}
/* Steps Editor */
.steps-editor {
margin-top: 1.5rem;
}
.step-item {
border: 1px solid var(--light);
border-radius: 5px;
padding: 1rem;
margin-bottom: 1rem;
position: relative;
}
.step-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 0.8rem;
}
.step-content {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 1rem;
}
.add-step-btn {
margin-top: 1rem;
background: var(--success);
color: white;
}
/* Quiz Editor */
.quiz-editor {
margin-top: 1.5rem;
}
.quiz-question {
border: 1px solid var(--light);
border-radius: 5px;
padding: 1rem;
margin-bottom: 1rem;
position: relative;
}
.quiz-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 0.8rem;
}
.quiz-content {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 1rem;
}
.quiz-options {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
gap: 1rem;
}
.add-quiz-btn {
margin-top: 1rem;
background: var(--success);
color: white;
}
/* Settings Tabs */
.settings-tabs {
display: flex;
border-bottom: 1px solid var(--light);
margin-bottom: 1.5rem;
}
.tab-button {
padding: 0.75rem 1.5rem;
background: none;
border: none;
border-bottom: 3px solid transparent;
cursor: pointer;
font-weight: 600;
color: var(--gray);
}
.tab-button.active {
border-bottom: 3px solid var(--primary);
color: var(--primary);
}
.tab-content {
display: none;
}
.tab-content.active {
display: block;
}
/* User Interface */
.user-interface {
display: none;
padding: 2rem 0;
}
/* Header Styles */
header {
background: linear-gradient(135deg, var(--primary), var(--secondary));
color: white;
padding: 2rem 0;
text-align: center;
margin-bottom: 2rem;
}
header h1 {
font-size: 2.5rem;
margin-bottom: 0.5rem;
}
header p {
font-size: 1.1rem;
opacity: 0.9;
}
/* Profile Button */
.profile-btn {
position: absolute;
top: 20px;
right: 120px;
background: rgba(0,0,0,0.3);
color: white;
border: none;
padding: 0.75rem 1.5rem;
border-radius: 5px;
cursor: pointer;
font-weight: 600;
transition: var(--transition);
}
.profile-btn:hover {
background: rgba(0,0,0,0.5);
}
/* Admin Switch Button */
.admin-switch {
position: absolute;
top: 20px;
right: 20px;
z-index: 100;
}
.admin-switch-btn {
background: rgba(0,0,0,0.3);
color: white;
border: none;
padding: 0.75rem 1.5rem;
border-radius: 5px;
cursor: pointer;
font-weight: 600;
transition: var(--transition);
}
.admin-switch-btn:hover {
background: rgba(0,0,0,0.5);
}
/* Profile Popup */
.profile-popup {
position: fixed;
top: 70px;
right: 20px;
width: 300px;
background: white;
border-radius: 10px;
box-shadow: var(--shadow);
z-index: 1000;
display: none;
}
.profile-header {
display: flex;
align-items: center;
padding: 1rem;
border-bottom: 1px solid var(--light);
}
.profile-header i {
font-size: 1.5rem;
margin-right: 0.5rem;
color: var(--primary);
}
.profile-header h3 {
font-size: 1.2rem;
margin: 0;
}
.profile-content {
padding: 1rem;
}
.profile-info {
margin-bottom: 1rem;
}
.info-item {
margin-bottom: 0.5rem;
}
.info-label {
font-weight: 600;
color: var(--gray);
font-size: 0.9rem;
}
.info-value {
font-size: 1rem;
}
.change-rank-select {
width: 100%;
margin-bottom: 1rem;
padding: 0.5rem;
border: 1px solid #ddd;
border-radius: 5px;
}
.update-rank-btn {
width: 100%;
margin-bottom: 0.5rem;
}
.close-profile-btn {
width: 100%;
background: var(--gray);
}
.close-profile-btn:hover {
background: #5a6268;
}
.logout-btn-popup {
width: 100%;
background: var(--danger);
}
.logout-btn-popup:hover {
background: #e53e3e;
}
/* User Management Section */
.users-section {
display: none;
}
.course-group {
margin-bottom: 2rem;
}
.course-title {
font-size: 1.3rem;
color: var(--secondary);
margin-bottom: 1rem;
padding-bottom: 0.5rem;
border-bottom: 1px solid var(--light);
}
.user-list {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
gap: 1rem;
}
.user-card {
background: var(--light);
border-radius: 8px;
padding: 1rem;
display: flex;
justify-content: space-between;
align-items: center;
}
.user-details {
flex-grow: 1;
}
.user-name {
font-weight: 600;
margin-bottom: 0.25rem;
}
.user-rank {
font-size: 0.9rem;
color: var(--gray);
}
.user-course {
font-size: 0.9rem;
color: var(--primary);
}
.edit-user-btn {
background: var(--warning);
color: white;
border: none;
padding: 0.5rem 1rem;
border-radius: 4px;
cursor: pointer;
}
.edit-user-btn:hover {
background: #e4bb0b;
}
/* Edit User Modal */
.edit-user-modal {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0,0,0,0.7);
display: flex;
justify-content: center;
align-items: center;
z-index: 3000;
display: none;
}
.edit-user-box {
background: white;
padding: 2rem;
border-radius: 10px;
box-shadow: var(--shadow);
width: 100%;
max-width: 500px;
text-align: center;
position: relative;
}
.edit-user-box h3 {
margin-bottom: 1.5rem;
color: var(--primary);
}
/* Settings Sections */
.signup-settings-section {
display: none;
}
.settings-controls {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 2rem;
}
.settings-column {
background: var(--light);
padding: 1.5rem;
border-radius: 8px;
}
.setting-title {
font-size: 1.2rem;
margin-bottom: 1rem;
color: var(--primary);
}
.setting-item {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 0.5rem;
padding: 0.5rem 0;
border-bottom: 1px solid rgba(0,0,0,0.1);
}
.setting-actions {
display: flex;
gap: 0.5rem;
}
.delete-btn-setting {
background: var(--danger);
color: white;
border: none;
padding: 0.25rem 0.5rem;
border-radius: 4px;
cursor: pointer;
}
.delete-btn-setting:hover {
opacity: 0.9;
}
.move-up-btn, .move-down-btn {
background: var(--primary);
color: white;
border: none;
padding: 0.25rem 0.5rem;
border-radius: 4px;
cursor: pointer;
}
.move-up-btn:hover, .move-down-btn:hover {
opacity: 0.9;
}
.add-item-input {
display: flex;
margin-top: 1rem;
}
.add-item-input input {
flex: 1;
margin-right: 0.5rem;
}
.add-item-input button {
background: var(--success);
color: white;
border: none;
padding: 0.5rem;
border-radius: 4px;
cursor: pointer;
}
/* Skill Grid */
.skill-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
gap: 1.5rem;
margin-top: 2rem;
}
.skill-card-ui {
background: white;
border-radius: 10px;
overflow: hidden;
box-shadow: var(--shadow);
transition: var(--transition);
cursor: pointer;
height: 100%;
display: flex;
flex-direction: column;
}
.skill-card-ui:hover {
transform: translateY(-5px);
box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
}
.skill-icon {
background: linear-gradient(135deg, var(--primary), var(--accent));
color: white;
font-size: 3rem;
height: 150px;
display: flex;
align-items: center;
justify-content: center;
}
.skill-content {
padding: 1.5rem;
flex-grow: 1;
display: flex;
flex-direction: column;
}
.skill-name {
font-size: 1.5rem;
margin-bottom: 0.75rem;
color: var(--primary);
}
.skill-desc {
color: var(--gray);
flex-grow: 1;
}
.skill-btn {
background: var(--primary);
color: white;
border: none;
padding: 0.75rem;
border-radius: 5px;
cursor: pointer;
font-weight: 600;
margin-top: 1rem;
transition: var(--transition);
}
.skill-btn:hover {
background: var(--secondary);
}
/* Skill Detail */
.skill-detail {
background: white;
border-radius: 10px;
padding: 2rem;
box-shadow: var(--shadow);
margin-top: 1.5rem;
display: none;
}
.skill-header {
display: flex;
align-items: center;
margin-bottom: 2rem;
padding-bottom: 1rem;
border-bottom: 2px solid var(--light);
}
.skill-header i {
font-size: 2.5rem;
margin-right: 1rem;
color: var(--primary);
}
.skill-header h2 {
font-size: 2rem;
color: var(--dark);
}
.skill-section {
margin-bottom: 2.5rem;
}
.section-title-ui {
font-size: 1.5rem;
color: var(--primary);
margin-bottom: 1rem;
padding-bottom: 0.5rem;
border-bottom: 1px solid var(--light);
}
/* Tools Section */
.tools-grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
gap: 1rem;
}
.tool-item {
background: var(--light);
border-radius: 8px;
padding: 1rem;
text-align: center;
transition: var(--transition);
}
.tool-item:hover {
background: var(--primary);
color: white;
}
.tool-item i {
font-size: 1.8rem;
margin-bottom: 0.5rem;
color: var(--primary);
}
.tool-item:hover i {
color: white;
}
/* Steps Section */
.steps-container {
display: flex;
flex-direction: column;
gap: 1.5rem;
}
.step-card {
display: flex;
gap: 1.5rem;
background: var(--light);
border-radius: 8px;
overflow: hidden;
}
.step-image {
width: 200px;
height: 150px;
object-fit: cover;
}
.step-content {
padding: 1.2rem;
flex-grow: 1;
}
.step-title {
font-size: 1.2rem;
margin-bottom: 0.5rem;
color: var(--primary);
}
/* Theory Section */
.theory-content {
background: var(--light);
padding: 1.5rem;
border-radius: 8px;
line-height: 1.8;
}
/* Quiz Section */
.quiz-container {
background: var(--light);
padding: 1.5rem;
border-radius: 8px;
}
.question {
margin-bottom: 1.5rem;
}
.question-text {
font-weight: 600;
margin-bottom: 0.75rem;
}
.options {
display: flex;
flex-direction: column;
gap: 0.5rem;
}
.option {
display: flex;
align-items: center;
padding: 0.75rem;
background: white;
border-radius: 5px;
cursor: pointer;
transition: var(--transition);
}
.option:hover {
background: #e9ecef;
}
.option.selected {
background: var(--primary);
color: white;
}
.quiz-result {
margin-top: 1.5rem;
padding: 1rem;
border-radius: 5px;
text-align: center;
font-weight: 600;
}
.quiz-result.correct {
background: var(--success);
color: white;
}
.quiz-result.incorrect {
background: var(--danger);
color: white;
}
.quiz-nav {
display: flex;
justify-content: space-between;
margin-top: 1.5rem;
}
.back-btn {
background: var(--gray);
color: white;
border: none;
padding: 0.75rem 1.5rem;
border-radius: 5px;
cursor: pointer;
font-weight: 600;
}
/* Footer */
footer {
background: var(--dark);
color: white;
text-align: center;
padding: 1.5rem 0;
margin-top: 3rem;
}
/* Responsive Design */
@media (max-width: 992px) {
.admin-content {
grid-template-columns: 1fr;
}
.nav-panel {
margin-bottom: 2rem;
}
.settings-controls {
grid-template-columns: 1fr;
}
.settings-tabs {
flex-wrap: wrap;
}
.tab-button {
padding: 0.5rem;
}
}
@media (max-width: 768px) {
.step-card {
flex-direction: column;
}
.step-image {
width: 100%;
height: 200px;
}
.skill-header {
flex-direction: column;
text-align: center;
}
.skill-header i {
margin-right: 0;
margin-bottom: 1rem;
}
.form-row {
flex-direction: column;
gap: 0;
}
.profile-btn, .admin-switch {
position: static;
text-align: center;
margin-top: 1rem;
}
.profile-btn {
margin-right: 1rem;
}
.profile-popup {
position: absolute;
top: 50px;
right: 10px;
}
}
/* Confirmation Modal */
.login-popup.confirmation-modal {
/* Inherits basic styles from .login-popup */
z-index: 3001; /* Ensure it's above other modals */
}
/* No specific additional styling needed unless customization is desired */

/* NEW: Styling for image preview */
.image-preview-container {
    display: flex;
    align-items: center;
    margin-top: 0.5rem;
}
.image-preview {
    width: 50px;
    height: 50px;
    object-fit: cover;
    border-radius: 4px;
    margin-right: 1rem;
    border: 1px solid #ddd;
}
.no-image-text {
    font-size: 0.9rem;
    color: var(--gray);
    font-style: italic;
}
/* END NEW STYLING */
</style>
</head>
<body>
<header>
<div class="container">
<h1><i class="fas fa-tools"></i> Hand Skills Learning Platform</h1>
<p>Master essential hands-on skills with step-by-step guidance</p>
</div>
<button class="profile-btn" id="profileBtn" onclick="toggleProfilePopup()" style="display: none;">
<i class="fas fa-user"></i> Profile
</button>
<button class="admin-switch-btn" id="adminSwitchBtn" onclick="switchToUserInterface()" style="display: none;">
<i class="fas fa-user-graduate"></i> User View
</button>
<button class="admin-switch-btn" id="adminBackBtn" onclick="switchToAdminInterface()" style="display: none;">
<i class="fas fa-lock"></i> Admin View
</button>
<button class="profile-btn" id="loginBtn" onclick="openLoginPopup()" style="display: none;">
<i class="fas fa-sign-in-alt"></i> Login
</button>
</header>
<!-- Profile Popup -->
<div class="profile-popup" id="profilePopup">
<div class="profile-header">
<i class="fas fa-user-circle"></i>
<h3>User Profile</h3>
</div>
<div class="profile-content">
<div class="profile-info">
<div class="info-item">
<span class="info-label">Name</span>
<div class="info-value" id="popup-name-display"></div>
</div>
<div class="info-item">
<span class="info-label">Rank</span>
<div class="info-value" id="popup-rank-display"></div>
</div>
<div class="info-item">
<span class="info-label">Course</span>
<div class="info-value" id="popup-course-display"></div>
</div>
<div class="info-item">
<span class="info-label">Email</span>
<div class="info-value" id="popup-email-display"></div>
</div>
</div>
<div class="form-group">
<label for="edit-rank">Change Rank</label>
<select id="edit-rank" class="change-rank-select">
<!-- Options will be loaded dynamically -->
</select>
</div>
<button class="btn update-rank-btn" onclick="updateOwnRank()">Update Rank</button>
<button class="btn close-profile-btn" onclick="toggleProfilePopup()">Close</button>
<button class="btn logout-btn-popup" onclick="logout()">Logout</button>
</div>
</div>
<!-- Login Popup -->
<div class="login-popup" id="loginPopup">
<div class="login-box">
<span class="close-btn" onclick="closeLoginPopup()">&times;</span>
<h2><i class="fas fa-lock"></i> Login</h2>
<div id="loginForm">
<div class="form-group">
<label for="email">Email</label>
<input type="email" id="email" placeholder="Enter your email">
</div>
<div class="form-group">
<label for="password">Password</label>
<input type="password" id="password" placeholder="Enter password">
</div>
<button class="btn" onclick="login()">Login</button>
<button class="btn google-btn" onclick="googleLogin()">
<i class="fab fa-google"></i> Sign in with Google
</button>
<div class="auth-toggle">
<a href="#" onclick="toggleAuthMode()">New User? Sign Up</a> |
<a href="#" onclick="showForgotPassword()">Forgot Password?</a>
</div>
</div>
<div id="signupForm" style="display: none;">
<div class="form-group">
<label for="rank">Rank</label>
<select id="rank">
<option value="">Select Rank</option>
<!-- Options will be loaded dynamically -->
</select>
</div>
<div class="form-group">
<label for="course">Course</label>
<select id="course">
<option value="">Select Course</option>
<!-- Options will be loaded dynamically -->
</select>
</div>
<div class="form-group">
<label for="name">Full Name</label>
<input type="text" id="name" placeholder="Enter your full name">
</div>
<button class="btn" onclick="signup()">Sign Up</button>
<div class="auth-toggle">
<a href="#" onclick="toggleAuthMode()">Already have an account? Login</a>
</div>
</div>
<div id="forgotPasswordForm" style="display: none;">
<div class="form-group">
<label for="forgot-email">Email</label>
<input type="email" id="forgot-email" placeholder="Enter your email">
</div>
<button class="btn" onclick="sendPasswordReset()">Send Reset Email</button>
<div class="auth-toggle">
<a href="#" onclick="toggleAuthMode()">Back to Login</a>
</div>
</div>
<div id="profileForm" style="display: none;">
<h3>Complete Your Profile</h3>
<div class="form-group">
<label for="profile-rank">Rank</label>
<select id="profile-rank">
<!-- Options will be loaded dynamically -->
</select>
</div>
<div class="form-group">
<label for="profile-course">Course</label>
<select id="profile-course">
<!-- Options will be loaded dynamically -->
</select>
</div>
<div class="form-group">
<label for="profile-name">Full Name</label>
<input type="text" id="profile-name" placeholder="Enter your full name">
</div>
<button class="btn" onclick="completeProfile()">Save Profile</button>
</div>
<div class="error-message" id="auth-error"></div>
</div>
</div>
<!-- Confirmation Modal for Revoking Admin Access -->
<div class="login-popup confirmation-modal" id="confirmRevokeModal" style="display: none;">
<div class="login-box">
<span class="close-btn" onclick="closeConfirmRevokeModal()">&times;</span>
<h2><i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i> Confirm Revoke</h2>
<p id="confirm-revoke-message">Are you sure you want to revoke admin access?</p>
<div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
<button class="btn btn-secondary" onclick="closeConfirmRevokeModal()" style="flex: 1;">Cancel</button>
<button class="btn" style="background: var(--danger); flex: 1;" onclick="performRevokeAdmin()">Revoke</button>
</div>
<div class="error-message" id="revoke-confirm-error"></div>
</div>
</div>
<!-- Grant Admin Success Notification Modal -->
<div class="login-popup" id="grantSuccessModal" style="display: none; z-index: 3002;"> <!-- Higher z-index than confirmRevokeModal -->
<div class="login-box">
<span class="close-btn" onclick="closeGrantSuccessModal()">&times;</span>
<h2><i class="fas fa-check-circle" style="color: var(--success);"></i> Success</h2>
<p id="grant-success-message">Admin access granted successfully!</p>
<div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
<!-- A simple OK button to close the modal -->
<button class="btn" style="background: var(--primary); flex: 1;" onclick="closeGrantSuccessModal()">OK</button>
</div>
<!-- Optional: Error display if needed later -->
<div class="error-message" id="grant-success-error"></div>
</div>
</div>
<!-- End of Grant Admin Success Notification Modal -->
<!-- Admin Dashboard -->
<div class="admin-dashboard" id="adminDashboard">
<div class="container">
<div class="admin-header">
<h1><i class="fas fa-tools"></i> Hand Skills Learning Platform - Admin Panel</h1>
<button class="logout-btn" onclick="logout()">Logout</button>
</div>
<div class="admin-content">
<div class="nav-panel">
<h3>Navigation</h3>
<div class="nav-item active" onclick="showSection('dashboard')">Dashboard</div>
<div class="nav-item" onclick="showSection('skills')">Manage Skills</div>
<div class="nav-item" onclick="showSection('users')">Manage Users</div>
<div class="nav-item" onclick="showSection('settings')">Settings</div>
</div>
<div class="main-content-area">
<!-- Dashboard Section -->
<div id="dashboard-section" class="section">
<h2 class="section-title">Dashboard Overview</h2>
<p>Welcome to the Hand Skills Learning Platform Admin Panel. From here you can manage skills, content, and user access.</p>
<div style="margin-top: 2rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
<div style="background: var(--light); padding: 1.5rem; border-radius: 8px; text-align: center;">
<i class="fas fa-tools" style="font-size: 2.5rem; color: var(--primary); margin-bottom: 1rem;"></i>
<h3 id="total-skills">0</h3>
<p>Total skills in the system</p>
</div>
</div>
</div>
<!-- Skills Management Section -->
<div id="skills-section" class="section" style="display: none;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
<h2 class="section-title">Manage Skills</h2>
<button class="btn" onclick="addNewSkill()" style="background: var(--success);">Add New Skill</button>
</div>
<div class="skill-list" id="skillsList">
<!-- Skills will be loaded here -->
</div>
</div>
<!-- Users Management Section -->
<div id="users-section" class="section users-section">
<h2 class="section-title">Manage Users</h2>
<div id="usersContent">
<!-- User groups will be loaded here -->
</div>
</div>
<!-- Settings Section -->
<div id="settings-section" class="section" style="display: none;">
<h2 class="section-title">System Settings</h2>
<div class="settings-tabs">
<button class="tab-button active" data-tab="signupSettings">Signup Settings</button>
<button class="tab-button" data-tab="adminAccess">Admin Access</button>
</div>
<div id="signupSettingsTab" class="tab-content active">
<div class="settings-controls">
<div class="settings-column">
<h3 class="setting-title">Manage Ranks</h3>
<div id="ranksList">
<!-- Ranks will be loaded here -->
</div>
<div class="add-item-input">
<input type="text" id="newRankInput" placeholder="New rank name">
<button onclick="addRank()">Add Rank</button>
</div>
<div class="operation-message" id="rankMessage"></div>
</div>
<div class="settings-column">
<h3 class="setting-title">Manage Courses</h3>
<div id="coursesList">
<!-- Courses will be loaded here -->
</div>
<div class="add-item-input">
<input type="text" id="newCourseInput" placeholder="New course name">
<button onclick="addCourse()">Add Course</button>
</div>
<div class="operation-message" id="courseMessage"></div>
</div>
</div>
</div>
<div id="adminAccessTab" class="tab-content">
<h3 class="section-title">Admin Access Management</h3>
<div class="admin-access-form">
<div class="form-group">
<label for="admin-email">Email Address</label>
<input type="email" id="admin-email" placeholder="Enter email address">
</div>
<button class="btn" onclick="grantAdminAccess()">Grant Admin Access</button>
</div>
<div id="adminList">
<!-- Admin list will be loaded here -->
</div>
</div>
</div>
</div>
<!-- Edit Skill Form -->
<div id="edit-skill-form" class="edit-form">
<h2 class="section-title">Edit Skill</h2>
<div class="form-row">
<div class="form-col">
<label for="edit-skill-name">Skill Name</label>
<input type="text" id="edit-skill-name" placeholder="Enter skill name">
</div>
<div class="form-col">
    <label for="edit-skill-icon-file">Upload Icon</label>
    <input type="file" id="edit-skill-icon-file" accept="image/*">
    <div class="image-preview-container">
        <img id="skill-icon-preview" class="image-preview" src="" alt="Preview">
        <span id="no-image-text" class="no-image-text">No image selected.</span>
    </div>
</div>
</div>
<div class="form-row">
<div class="form-col">
<label for="edit-skill-description">Description</label>
<textarea id="edit-skill-description" placeholder="Enter skill description"></textarea>
</div>
</div>
<div class="form-row">
<div class="form-col">
<label for="edit-tools">Tools Required (comma separated)</label>
<textarea id="edit-tools" placeholder="Enter required tools"></textarea>
</div>
</div>
<div class="form-row">
<div class="form-col">
<label for="edit-theory">Theory Section</label>
<textarea id="edit-theory" placeholder="Enter theoretical content"></textarea>
</div>
</div>
<div class="steps-editor">
<h3>Steps</h3>
<div id="steps-container">
<!-- Steps will be added here -->
</div>
<button class="btn add-step-btn" onclick="addStep()">Add Step</button>
</div>
<div class="quiz-editor">
<h3>Quiz Questions</h3>
<div id="quiz-container">
<!-- Quiz questions will be added here -->
</div>
<button class="btn add-quiz-btn" onclick="addQuizQuestion()">Add Question</button>
</div>
<div class="form-actions">
<button class="btn btn-secondary" onclick="cancelEdit()">Cancel</button>
<button class="btn" onclick="saveSkill()">Save Changes</button>
</div>
</div>
</div>
</div>
</div>
<!-- Edit User Modal -->
<div class="edit-user-modal" id="editUserModal">
<div class="edit-user-box">
<span class="close-btn" onclick="closeEditUserModal()">&times;</span>
<h3>Edit User</h3>
<div class="form-group">
<label for="edit-user-name">Name</label>
<input type="text" id="edit-user-name" placeholder="Enter user name">
</div>
<div class="form-group">
<label for="edit-user-rank">Rank</label>
<select id="edit-user-rank">
<!-- Options will be loaded dynamically -->
</select>
</div>
<div class="form-group">
<label for="edit-user-course">Course</label>
<select id="edit-user-course">
<!-- Options will be loaded dynamically -->
</select>
</div>
<button class="btn" onclick="saveEditedUser()">Save Changes</button>
</div>
</div>
<!-- User Interface -->
<div class="user-interface" id="userInterface">
<main class="container">
<div id="main-content">
<div class="skill-grid" id="skill-grid">
<!-- Skills will be loaded here -->
</div>
<div id="skill-detail" class="skill-detail">
<!-- Skill details will be loaded here -->
</div>
</div>
</main>
<footer>
<div class="container">
<p>&copy; 2026 Hand Skills Learning Platform | Master Essential Hands-On Skills</p>
</div>
</footer>
</div>
<script>
// Initialize Firebase
const firebaseConfig = {
apiKey: "AIzaSyA6ZdINHlRF583T3HL5RsA4q2fmHeBcB_g",
authDomain: "hand-skills-platform.firebaseapp.com",
projectId: "hand-skills-platform",
storageBucket: "hand-skills-platform.firebasestorage.app",
messagingSenderId: "1021058690748",
appId: "1:1021058690748:web:40fd86d1060d90bbe1eab9",
measurementId: "G-R2J40EVW18"
};
// Initialize Firebase App, Auth, Firestore, Storage
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage(); // Initialize Storage

// Global variables
let skillsData = [];
let usersData = [];
let currentEditingSkill = null;
let currentUser = null;
let originalEditingSkill = null; // Store original skill data
let currentAuthMode = 'login'; // 'login', 'signup', 'forgot', 'profile'
let editingUserId = null; // Track user being edited
let isAdmin = false; // Track if current user is admin
let ranksData = []; // Store ranks from Firestore
let coursesData = []; // Store courses from Firestore
let wasInAdminView = false; // Track if we were in admin view before switching
// --- NEW VARIABLES FOR REVOKE CONFIRMATION ---
let pendingRevokeAdminId = null;
let pendingRevokeAdminEmail = null;
// --- END NEW VARIABLES ---

// Initialize the app
window.onload = function() {
// Check if user is already logged in
auth.onAuthStateChanged(user => {
if (user) {
// User is logged in
loadUserData(user.uid);
// Hide the login button if user is logged in
document.getElementById('loginBtn').style.display = 'none';
} else {
// User is not logged in
// Show user interface by default
document.getElementById('userInterface').style.display = 'block';
loadSkillsFromFirebase();
// Hide the login popup initially
document.getElementById('loginPopup').style.display = 'none';
// Show the login button in the header
document.getElementById('loginBtn').style.display = 'block';
}
});
// Load ranks and courses from Firestore
loadRanksAndCourses();
};

// Helper function to convert Data URL to Blob
function dataURLtoBlob(dataurl) {
var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
blob = new Blob([arr[1]], {type: mime});
return blob;
}

// Load ranks and courses from Firestore
async function loadRanksAndCourses() {
try {
// Load ranks
const ranksSnapshot = await db.collection("ranks").orderBy("order").get();
ranksData = [];
ranksSnapshot.forEach(doc => {
ranksData.push({ id: doc.id, ...doc.data() });
});
// Load courses
const coursesSnapshot = await db.collection("courses").orderBy("order").get();
coursesData = [];
coursesSnapshot.forEach(doc => {
coursesData.push({ id: doc.id, ...doc.data() });
});
// Update dropdowns in signup and profile forms
updateDropdowns();
} catch (error) {
console.error("Error loading ranks/courses: ", error);
}
}

// Update dropdowns in forms
function updateDropdowns() {
// Update signup form rank dropdown
const rankSelect = document.getElementById('rank');
rankSelect.innerHTML = '<option value="">Select Rank</option>';
ranksData.forEach(rank => {
const option = document.createElement('option');
option.value = rank.name;
option.textContent = rank.name;
rankSelect.appendChild(option);
});
// Update signup form course dropdown
const courseSelect = document.getElementById('course');
courseSelect.innerHTML = '<option value="">Select Course</option>';
coursesData.forEach(course => {
const option = document.createElement('option');
option.value = course.name;
option.textContent = course.name;
courseSelect.appendChild(option);
});
// Update profile form rank dropdown
const profileRankSelect = document.getElementById('profile-rank');
profileRankSelect.innerHTML = '<option value="">Select Rank</option>';
ranksData.forEach(rank => {
const option = document.createElement('option');
option.value = rank.name;
option.textContent = rank.name;
profileRankSelect.appendChild(option);
});
// Update profile form course dropdown
const profileCourseSelect = document.getElementById('profile-course');
profileCourseSelect.innerHTML = '<option value="">Select Course</option>';
coursesData.forEach(course => {
const option = document.createElement('option');
option.value = course.name;
option.textContent = course.name;
profileCourseSelect.appendChild(option);
});
// Update edit user form dropdowns
const editRankSelect = document.getElementById('edit-user-rank');
editRankSelect.innerHTML = '';
ranksData.forEach(rank => {
const option = document.createElement('option');
option.value = rank.name;
option.textContent = rank.name;
editRankSelect.appendChild(option);
});
const editCourseSelect = document.getElementById('edit-user-course');
editCourseSelect.innerHTML = '';
coursesData.forEach(course => {
const option = document.createElement('option');
option.value = course.name;
option.textContent = course.name;
editCourseSelect.appendChild(option);
});
// Update profile popup rank dropdown
const profilePopupRankSelect = document.getElementById('edit-rank');
profilePopupRankSelect.innerHTML = '';
ranksData.forEach(rank => {
const option = document.createElement('option');
option.value = rank.name;
option.textContent = rank.name;
if (currentUser && rank.name === currentUser.rank) {
option.selected = true;
}
profilePopupRankSelect.appendChild(option);
});
}

// Load user data from Firestore
async function loadUserData(userId) {
try {
const userDoc = await db.collection("users").doc(userId).get();
if (userDoc.exists) {
currentUser = userDoc.data();
currentUser.id = userId;
// Check if user is admin
const adminDoc = await db.collection("admins").doc(userId).get();
if (adminDoc.exists) {
isAdmin = true;
// Show admin dashboard
document.getElementById('adminDashboard').style.display = 'block';
document.getElementById('userInterface').style.display = 'none';
document.getElementById('loginPopup').style.display = 'none';
document.getElementById('profileBtn').style.display = 'block';
document.getElementById('adminSwitchBtn').style.display = 'block';
document.getElementById('adminBackBtn').style.display = 'none';
setupFirestoreListeners();
showSection('dashboard');
} else {
isAdmin = false;
// Show user interface
document.getElementById('userInterface').style.display = 'block';
document.getElementById('adminDashboard').style.display = 'none';
document.getElementById('loginPopup').style.display = 'none';
document.getElementById('profileBtn').style.display = 'block';
document.getElementById('adminSwitchBtn').style.display = 'none';
document.getElementById('adminBackBtn').style.display = 'none';
loadSkillsFromFirebase();
}
} else {
// New user - prompt for profile completion
showProfileCompletion();
}
} catch (error) {
console.error("Error loading user  ", error);
}
}

// Show profile completion form
function showProfileCompletion() {
document.getElementById('loginForm').style.display = 'none';
document.getElementById('signupForm').style.display = 'none';
document.getElementById('forgotPasswordForm').style.display = 'none';
document.getElementById('profileForm').style.display = 'block';
document.getElementById('auth-error').textContent = '';
}

// Complete profile after signup/google login
async function completeProfile() {
const rank = document.getElementById('profile-rank').value;
const course = document.getElementById('profile-course').value;
const name = document.getElementById('profile-name').value.toUpperCase();
if (!rank || !course || !name) {
document.getElementById('auth-error').textContent = 'Please fill in all fields';
return;
}
try {
// Get current user UID
const user = auth.currentUser;
if (!user) throw new Error('No authenticated user');
// Save profile to Firestore
await db.collection("users").doc(user.uid).set({
rank: rank,
course: course,
name: name,
email: user.email,
completedSkills: [],
lastLogin: new Date()
});
// Reload user data
loadUserData(user.uid);
} catch (error) {
console.error("Error completing profile: ", error);
document.getElementById('auth-error').textContent = error.message;
}
}

// Toggle between login/signup/forgot forms
function toggleAuthMode() {
if (currentAuthMode === 'login') {
document.getElementById('loginForm').style.display = 'none';
document.getElementById('signupForm').style.display = 'block';
currentAuthMode = 'signup';
} else if (currentAuthMode === 'signup') {
document.getElementById('signupForm').style.display = 'none';
document.getElementById('loginForm').style.display = 'block';
currentAuthMode = 'login';
}
document.getElementById('auth-error').textContent = '';
}
function showForgotPassword() {
document.getElementById('loginForm').style.display = 'none';
document.getElementById('forgotPasswordForm').style.display = 'block';
currentAuthMode = 'forgot';
document.getElementById('auth-error').textContent = '';
}

// Login function
function login() {
const email = document.getElementById('email').value;
const password = document.getElementById('password').value;
if (!email || !password) {
document.getElementById('auth-error').textContent = 'Please enter both email and password';
return;
}
auth.signInWithEmailAndPassword(email, password)
.then(userCredential => {
loadUserData(userCredential.user.uid);
})
.catch(error => {
document.getElementById('auth-error').textContent = error.message;
});
}

// Signup function
function signup() {
const email = document.getElementById('signup-email').value;
const password = document.getElementById('signup-password').value;
const rank = document.getElementById('rank').value;
const course = document.getElementById('course').value;
const name = document.getElementById('name').value.toUpperCase();
if (!email || !password || !rank || !course || !name) {
document.getElementById('auth-error').textContent = 'Please fill in all fields';
return;
}
auth.createUserWithEmailAndPassword(email, password)
.then(userCredential => {
// Save profile data to Firestore
db.collection("users").doc(userCredential.user.uid).set({
rank: rank,
course: course,
name: name,
email: email,
completedSkills: [],
lastLogin: new Date()
});
loadUserData(userCredential.user.uid);
})
.catch(error => {
document.getElementById('auth-error').textContent = error.message;
});
}

// Google login function
function googleLogin() {
const provider = new firebase.auth.GoogleAuthProvider();
auth.signInWithPopup(provider)
.then(result => {
const user = result.user;
// Check if user exists in Firestore
db.collection("users").doc(user.uid).get().then(doc => {
if (doc.exists) {
// User already exists, load data
loadUserData(user.uid);
} else {
// New user via Google, prompt for profile completion
showProfileCompletion();
}
});
})
.catch(error => {
document.getElementById('auth-error').textContent = error.message;
});
}

// Send password reset email
function sendPasswordReset() {
const email = document.getElementById('forgot-email').value;
if (!email) {
document.getElementById('auth-error').textContent = 'Please enter your email';
return;
}
auth.sendPasswordResetEmail(email)
.then(() => {
alert('Password reset email sent!');
toggleAuthMode();
})
.catch(error => {
document.getElementById('auth-error').textContent = error.message;
});
}

// Close login popup
// Close login popup
function closeLoginPopup() {
document.getElementById('loginPopup').style.display = 'none';
// Show the login button in the header when popup is closed while logged out
document.getElementById('loginBtn').style.display = 'block';
}

// Open login popup
// Open login popup
function openLoginPopup() {
document.getElementById('loginPopup').style.display = 'flex';
// Hide the login button when the popup opens
document.getElementById('loginBtn').style.display = 'none';
}

// Toggle profile popup
function toggleProfilePopup() {
const popup = document.getElementById('profilePopup');
if (popup.style.display === 'block') {
popup.style.display = 'none';
} else {
popup.style.display = 'block';
// Update profile info in popup
document.getElementById('popup-name-display').textContent = currentUser.name;
document.getElementById('popup-rank-display').textContent = currentUser.rank;
document.getElementById('popup-course-display').textContent = currentUser.course;
document.getElementById('popup-email-display').textContent = currentUser.email;
// Update rank dropdown in popup
updateDropdowns();
}
}

// Switch to user interface (from admin)
function switchToUserInterface() {
wasInAdminView = true;
document.getElementById('adminDashboard').style.display = 'none';
document.getElementById('userInterface').style.display = 'block';
document.getElementById('adminSwitchBtn').style.display = 'none';
document.getElementById('adminBackBtn').style.display = 'block';
// Load skills for user view
loadSkillsFromFirebase();
}

// Switch to admin interface (from user)
function switchToAdminInterface() {
wasInAdminView = false;
document.getElementById('userInterface').style.display = 'none';
document.getElementById('adminDashboard').style.display = 'block';
document.getElementById('adminSwitchBtn').style.display = 'block';
document.getElementById('adminBackBtn').style.display = 'none';
}

// Update own rank in profile popup
async function updateOwnRank() {
const newRank = document.getElementById('edit-rank').value;
if (!newRank) {
alert('Please select a rank');
return;
}
try {
await db.collection("users").doc(currentUser.id).update({
rank: newRank
});
currentUser.rank = newRank;
document.getElementById('popup-rank-display').textContent = newRank;
// Update dropdown in popup
updateDropdowns();
alert('Rank updated successfully!');
} catch (error) {
console.error("Error updating rank: ", error);
alert('Error updating rank: ' + error.message);
}
}

// Setup Firestore listeners to sync data in real-time
function setupFirestoreListeners() {
// Listen for changes in skills collection
db.collection("skills").onSnapshot((snapshot) => {
skillsData = [];
snapshot.forEach(doc => {
skillsData.push({ id: doc.id, ...doc.data() });
});
// --- CORRECTED SORTING LOGIC ---
// Sort by 'order' field, handling potentially missing 'order' values gracefully
// Assign a high default value (like the current length) if 'order' is missing or null/undefined
skillsData.sort((a, b) => {
const orderA = a.order !== undefined && a.order !== null ? a.order : Infinity; // Or use a large number
const orderB = b.order !== undefined && b.order !== null ? b.order : Infinity;
return orderA - orderB;
});
// --- END OF CORRECTION ---
updateCounters();
// Update user interface if visible
if (document.getElementById('userInterface').style.display === 'block') {
loadSkillGrid(); // This will now use the sorted skillsData
}
// Update admin list if currently viewing the skills section
if (document.getElementById('skills-section').style.display === 'block') {
loadSkillsList(); // This will also use the sorted skillsData
}
// Update user preview if currently viewing (if applicable)
// if (document.getElementById('user-preview-section').style.display === 'block') {
//     loadSkillGrid(); // This might also use sorted skillsData
// }
});

// Listen for changes in users collection
db.collection("users").onSnapshot((snapshot) => {
usersData = [];
snapshot.forEach(doc => {
usersData.push({ id: doc.id, ...doc.data() });
});
// Refresh user management section if currently active
if (document.getElementById('users-section').style.display === 'block') {
loadUsersManagement();
}
});

// Listen for changes in admins collection
db.collection("admins").onSnapshot((snapshot) => {
// Refresh admin access section if currently active
if (document.getElementById('adminAccessTab').style.display === 'block') {
loadAdminList();
}
});

// Listen for changes in ranks collection
db.collection("ranks").onSnapshot((snapshot) => {
loadRanksAndCourses(); // Reload ranks and courses
// Refresh signup settings section if currently active
if (document.getElementById('settings-section').style.display === 'block') {
loadSignupSettings();
}
});

// Listen for changes in courses collection
db.collection("courses").onSnapshot((snapshot) => {
loadRanksAndCourses(); // Reload ranks and courses
// Refresh signup settings section if currently active
if (document.getElementById('settings-section').style.display === 'block') {
loadSignupSettings();
}
});
} // <-- This closing brace was missing!

// Grant admin access to another user
async function grantAdminAccess() {
const email = document.getElementById('admin-email').value;
if (!email) {
alert('Please enter an email address'); // Could also use a modal for this error
return;
}
try {
// Find user by email
const userQuery = await db.collection("users").where("email", "==", email).get();
if (userQuery.empty) {
alert('User not found');
return;
}
const userDoc = userQuery.docs[0];
const userId = userDoc.id;

// Add user to admins collection
await db.collection("admins").doc(userId).set({
email: email,
grantedBy: currentUser.email,
date: new Date()
});

// Clear the input field
document.getElementById('admin-email').value = ''; // Keep this line

// CHANGED FROM ALERT TO MODAL
// alert('Admin access granted successfully!'); // Comment out or remove this line
showGrantSuccessModal('Admin access granted successfully for ' + email + '!'); // Call the new modal function

// --- ADD THIS LINE ---
loadAdminList(); // Reload the admin list immediately
// --- END OF ADDITION ---
} catch (error) {
console.error("Error granting admin access: ", error);
alert('Error granting admin access: ' + error.message); // You could also use a modal for errors
}
}

// Load admin list
async function loadAdminList() {
try {
const snapshot = await db.collection("admins").get();
const adminList = document.getElementById('adminList');
// --- IMPROVED CONTENT GENERATION ---
let adminItemsHTML = '<h3 class="section-title">Current Admins</h3>';
if (snapshot.empty) {
adminItemsHTML += '<p>No admins found.</p>';
} else {
// Fetch user details for each admin UID to get email/name if needed
const adminPromises = snapshot.docs.map(async (doc) => {
const adminId = doc.id; // This is the user UID
const userData = await db.collection("users").doc(adminId).get();
if (userData.exists) {
return { uid: adminId, email: userData.data().email, name: userData.data().name }; // Include name if desired
} else {
// Fallback if user doesn't exist in users collection anymore
const adminData = doc.data();
return { uid: adminId, email: adminData.email || 'Unknown Email', name: 'Unknown User' };
}
});
const adminDetails = await Promise.all(adminPromises);

adminDetails.forEach(admin => {
adminItemsHTML += `
<div style="background: var(--light); padding: 1rem; margin: 0.5rem 0; border-radius: 5px; display: flex; justify-content: space-between; align-items: center;">
<span>${admin.email} (${admin.name})</span> <!-- Display email and name -->
<button class="btn btn-secondary" onclick="revokeAdminAccess('${admin.uid}', '${admin.email}')" style="width: auto; padding: 0.5rem 1rem;">Revoke</button>
</div>
`;
});
}
adminList.innerHTML = adminItemsHTML;
// --- END OF IMPROVEMENT ---
} catch (error) {
console.error("Error loading admin list: ", error);
document.getElementById('adminList').innerHTML = '<p>Error loading admin list.</p>';
}
}

// --- MODIFIED FUNCTION: Revoke admin access (uses modal now) ---
async function revokeAdminAccess(adminId, email) {
// Store the IDs for the actual revocation action
pendingRevokeAdminId = adminId;
pendingRevokeAdminEmail = email;

// Set the message in the modal
document.getElementById('confirm-revoke-message').textContent =
`Are you sure you want to revoke admin access for ${email}? This action cannot be undone.`;

// Clear any previous errors
document.getElementById('revoke-confirm-error').textContent = '';

// Show the confirmation modal
document.getElementById('confirmRevokeModal').style.display = 'flex';
}
// --- END MODIFIED FUNCTION ---

// --- NEW FUNCTIONS: Handle the modal confirmation ---
function performRevokeAdmin() {
if (!pendingRevokeAdminId || !pendingRevokeAdminEmail) {
console.error("Revoke operation lacks necessary data.");
closeConfirmRevokeModal(); // Close modal anyway
return; // Exit if data is missing
}

// Perform the revocation using stored IDs
db.collection("admins").doc(pendingRevokeAdminId).delete()
.then(() => {
console.log('Admin access revoked successfully for:', pendingRevokeAdminEmail);
// Close the modal
closeConfirmRevokeModal();
// Reload the admin list to reflect the change
loadAdminList();
// Clear pending IDs
pendingRevokeAdminId = null;
pendingRevokeAdminEmail = null;
})
.catch(error => {
console.error("Error revoking admin access: ", error);
// Display error message inside the modal
document.getElementById('revoke-confirm-error').textContent = 'Error revoking admin access: ' + error.message;
});
}

function closeConfirmRevokeModal() {
document.getElementById('confirmRevokeModal').style.display = 'none';
// Clear pending IDs when cancelled or closed
pendingRevokeAdminId = null;
pendingRevokeAdminEmail = null;
}

function showGrantSuccessModal(message = "Admin access granted successfully!") {
document.getElementById('grant-success-message').textContent = message;
document.getElementById('grantSuccessModal').style.display = 'flex';
}

function closeGrantSuccessModal() {
document.getElementById('grantSuccessModal').style.display = 'none';
// Optional: Clear the message when closed
document.getElementById('grant-success-message').textContent = "Admin access granted successfully!";
// Optional: Clear any potential error message
document.getElementById('grant-success-error').textContent = '';
}
// --- END NEW FUNCTIONS ---

// Load signup settings
async function loadSignupSettings() {
try {
// Load ranks
const ranksSnapshot = await db.collection("ranks").orderBy("order").get();
const ranksList = document.getElementById('ranksList');
ranksList.innerHTML = '';

let rankItemsHTML = '';
ranksSnapshot.forEach((doc, index) => {
const rank = doc.data();
const isTop = index === 0;
const isBottom = index === ranksSnapshot.size - 1;

rankItemsHTML += `
<div class="setting-item">
<span>${rank.name}</span>
<div class="setting-actions">
<button class="move-up-btn" ${isTop ? 'disabled' : ''} onclick="moveRankUp('${doc.id}', ${rank.order})" title="Move Up">
<i class="fas fa-arrow-up"></i>
</button>
<button class="move-down-btn" ${isBottom ? 'disabled' : ''} onclick="moveRankDown('${doc.id}', ${rank.order})" title="Move Down">
<i class="fas fa-arrow-down"></i>
</button>
<button class="delete-btn-setting" onclick="deleteRank('${doc.id}', '${rank.name}')">Delete</button>
</div>
</div>
`;
});
ranksList.innerHTML = rankItemsHTML;

// Load courses
const coursesSnapshot = await db.collection("courses").orderBy("order").get();
const coursesList = document.getElementById('coursesList');
coursesList.innerHTML = '';

let courseItemsHTML = '';
coursesSnapshot.forEach((doc, index) => {
const course = doc.data();
const isTop = index === 0;
const isBottom = index === coursesSnapshot.size - 1;

courseItemsHTML += `
<div class="setting-item">
<span>${course.name}</span>
<div class="setting-actions">
<button class="move-up-btn" ${isTop ? 'disabled' : ''} onclick="moveCourseUp('${doc.id}', ${course.order})" title="Move Up">
<i class="fas fa-arrow-up"></i>
</button>
<button class="move-down-btn" ${isBottom ? 'disabled' : ''} onclick="moveCourseDown('${doc.id}', ${course.order})" title="Move Down">
<i class="fas fa-arrow-down"></i>
</button>
<button class="delete-btn-setting" onclick="deleteCourse('${doc.id}', '${course.name}')">Delete</button>
</div>
</div>
`;
});
coursesList.innerHTML = courseItemsHTML;

} catch (error) {
console.error("Error loading signup settings: ", error);
}
}

// Move Rank Up
async function moveRankUp(rankId, currentOrder) {
if (currentOrder <= 0) return; // Already at the top
const targetOrder = currentOrder - 1;
try {
// Find the rank that currently has the target order
const targetRankSnapshot = await db.collection("ranks")
.where("order", "==", targetOrder)
.limit(1)
.get();
if (targetRankSnapshot.empty) {
console.error("Target rank for swapping not found for order:", targetOrder);
return;
}
const targetRankDoc = targetRankSnapshot.docs[0];
const targetRankId = targetRankDoc.id;

// Perform batch write to swap orders atomically
const batch = db.batch();
batch.update(db.collection("ranks").doc(rankId), { order: targetOrder });
batch.update(db.collection("ranks").doc(targetRankId), { order: currentOrder });

await batch.commit();
console.log("Rank moved up successfully");
// Reload the settings list to reflect changes
loadSignupSettings();
} catch (error) {
console.error("Error moving rank up: ", error);
alert("Failed to move rank up: " + error.message);
}
}

// Move Rank Down
async function moveRankDown(rankId, currentOrder) {
// Need to find the highest order to know if this is the bottom
const allRanksSnapshot = await db.collection("ranks").orderBy("order").get();
const ranksArray = allRanksSnapshot.docs.map(d => d.data());
const maxOrder = Math.max(...ranksArray.map(r => r.order));

if (currentOrder >= maxOrder) return; // Already at the bottom
const targetOrder = currentOrder + 1;
try {
// Find the rank that currently has the target order
const targetRankSnapshot = await db.collection("ranks")
.where("order", "==", targetOrder)
.limit(1)
.get();
if (targetRankSnapshot.empty) {
console.error("Target rank for swapping not found for order:", targetOrder);
return;
}
const targetRankDoc = targetRankSnapshot.docs[0];
const targetRankId = targetRankDoc.id;

// Perform batch write to swap orders atomically
const batch = db.batch();
batch.update(db.collection("ranks").doc(rankId), { order: targetOrder });
batch.update(db.collection("ranks").doc(targetRankId), { order: currentOrder });

await batch.commit();
console.log("Rank moved down successfully");
// Reload the settings list to reflect changes
loadSignupSettings();
} catch (error) {
console.error("Error moving rank down: ", error);
alert("Failed to move rank down: " + error.message);
}
}

// Move Course Up
async function moveCourseUp(courseId, currentOrder) {
if (currentOrder <= 0) return; // Already at the top
const targetOrder = currentOrder - 1;
try {
// Find the course that currently has the target order
const targetCourseSnapshot = await db.collection("courses")
.where("order", "==", targetOrder)
.limit(1)
.get();
if (targetCourseSnapshot.empty) {
console.error("Target course for swapping not found for order:", targetOrder);
return;
}
const targetCourseDoc = targetCourseSnapshot.docs[0];
const targetCourseId = targetCourseDoc.id;

// Perform batch write to swap orders atomically
const batch = db.batch();
batch.update(db.collection("courses").doc(courseId), { order: targetOrder });
batch.update(db.collection("courses").doc(targetCourseId), { order: currentOrder });

await batch.commit();
console.log("Course moved up successfully");
// Reload the settings list to reflect changes
loadSignupSettings();
} catch (error) {
console.error("Error moving course up: ", error);
alert("Failed to move course up: " + error.message);
}
}

// Move Course Down
async function moveCourseDown(courseId, currentOrder) {
// Need to find the highest order to know if this is the bottom
const allCoursesSnapshot = await db.collection("courses").orderBy("order").get();
const coursesArray = allCoursesSnapshot.docs.map(d => d.data());
const maxOrder = Math.max(...coursesArray.map(r => r.order));

if (currentOrder >= maxOrder) return; // Already at the bottom
const targetOrder = currentOrder + 1;
try {
// Find the course that currently has the target order
const targetCourseSnapshot = await db.collection("courses")
.where("order", "==", targetOrder)
.limit(1)
.get();
if (targetCourseSnapshot.empty) {
console.error("Target course for swapping not found for order:", targetOrder);
return;
}
const targetCourseDoc = targetCourseSnapshot.docs[0];
const targetCourseId = targetCourseDoc.id;

// Perform batch write to swap orders atomically
const batch = db.batch();
batch.update(db.collection("courses").doc(courseId), { order: targetOrder });
batch.update(db.collection("courses").doc(targetCourseId), { order: currentOrder });

await batch.commit();
console.log("Course moved down successfully");
// Reload the settings list to reflect changes
loadSignupSettings();
} catch (error) {
console.error("Error moving course down: ", error);
alert("Failed to move course down: " + error.message);
}
}

// Move Skill Up - RELIES ON THE GLOBAL skillsData ARRAY
async function moveSkillUp(skillId, currentOrder) {
// --- ADD CHECK FOR VALID ORDER VALUE ---
if (typeof currentOrder !== 'number' || isNaN(currentOrder)) {
console.error("Invalid order value received for moveSkillUp:", currentOrder);
alert("Cannot move skill: Invalid order data.");
return;
}
// --- END CHECK ---

// Find the index of the skill to move in the global skillsData array
const currentIndex = skillsData.findIndex(s => s.id === skillId);

// Check if it's already at the top (has the lowest order value among existing ones)
// Or if the skill is not found in the array
if (currentIndex <= 0) {
console.log("Skill is already at the top or not found, cannot move up.");
return; // Do nothing if it's the first item or not found
}

// Find the skill immediately preceding it in the sorted list (which has the target lower order)
const previousSkill = skillsData[currentIndex - 1];
if (!previousSkill) {
console.error("Previous skill not found in skillsData.");
return;
}
const targetSkillId = previousSkill.id;
// Use the previous skill's order, ensuring it's a number
const targetOrder = previousSkill.order !== undefined && previousSkill.order !== null ? previousSkill.order : currentOrder - 1;

try {
// Perform batch write to swap orders atomically
const batch = db.batch();
// Update the current skill to have the order of the previous one
batch.update(db.collection("skills").doc(skillId), { order: targetOrder });
// Update the previous skill to have the order of the current one
batch.update(db.collection("skills").doc(targetSkillId), { order: currentOrder });

await batch.commit();
console.log("Skill moved up successfully");
// The onSnapshot listener will automatically update skillsData and trigger loadSkillsList
// So reloading here might be redundant, but explicitly calling it ensures UI update
// Only reload if the current view is the skills section
if (document.getElementById('skills-section').style.display === 'block') {
loadSkillsList(); // Reload the admin panel list
}
// Potentially reload user interface list too if it's visible
if (document.getElementById('userInterface').style.display === 'block') {
loadSkillGrid(); // Reload the user interface grid
}
} catch (error) {
console.error("Error moving skill up: ", error);
alert("Failed to move skill up: " + error.message);
}
}

// Move Skill Down - RELIES ON THE GLOBAL skillsData ARRAY
async function moveSkillDown(skillId, currentOrder) {
// --- ADD CHECK FOR VALID ORDER VALUE ---
if (typeof currentOrder !== 'number' || isNaN(currentOrder)) {
console.error("Invalid order value received for moveSkillDown:", currentOrder);
alert("Cannot move skill: Invalid order data.");
return;
}
// --- END CHECK ---

// Find the index of the skill to move in the global skillsData array
const currentIndex = skillsData.findIndex(s => s.id === skillId);

// Check if it's already at the bottom (has the highest order value among existing ones)
// Or if the skill is not found in the array
if (currentIndex === -1 || currentIndex >= skillsData.length - 1) {
console.log("Skill is already at the bottom or not found, cannot move down.");
return; // Do nothing if it's the last item or not found
}

// Find the skill immediately succeeding it in the sorted list (which has the target higher order)
const nextSkill = skillsData[currentIndex + 1];
if (!nextSkill) {
console.error("Next skill not found in skillsData.");
return;
}
const targetSkillId = nextSkill.id;
// Use the next skill's order, ensuring it's a number
const targetOrder = nextSkill.order !== undefined && nextSkill.order !== null ? nextSkill.order : currentOrder + 1;

try {
// Perform batch write to swap orders atomically
const batch = db.batch();
// Update the current skill to have the order of the next one
batch.update(db.collection("skills").doc(skillId), { order: targetOrder });
// Update the next skill to have the order of the current one
batch.update(db.collection("skills").doc(targetSkillId), { order: currentOrder });

await batch.commit();
console.log("Skill moved down successfully");
// The onSnapshot listener will automatically update skillsData and trigger loadSkillsList
// So reloading here might be redundant, but explicitly calling it ensures UI update
// Only reload if the current view is the skills section
if (document.getElementById('skills-section').style.display === 'block') {
loadSkillsList(); // Reload the admin panel list
}
// Potentially reload user interface list too if it's visible
if (document.getElementById('userInterface').style.display === 'block') {
loadSkillGrid(); // Reload the user interface grid
}
} catch (error) {
console.error("Error moving skill down: ", error);
alert("Failed to move skill down: " + error.message);
}
}

// Add a new rank
async function addRank() {
const newRankInput = document.getElementById('newRankInput');
const newRank = newRankInput.value.trim();
if (!newRank) {
document.getElementById('rankMessage').textContent = 'Please enter a rank name';
setTimeout(() => {
document.getElementById('rankMessage').textContent = '';
}, 3000);
return;
}
try {
// Check if rank already exists
const existingRank = ranksData.find(r => r.name === newRank);
if (existingRank) {
document.getElementById('rankMessage').textContent = 'This rank already exists';
setTimeout(() => {
document.getElementById('rankMessage').textContent = '';
}, 3000);
return;
}
// Calculate the new order value based on the current number of ranks
const newOrder = ranksData.length;

// Add new rank to Firestore
await db.collection("ranks").add({
name: newRank,
order: newOrder
});

// Clear input
newRankInput.value = '';
document.getElementById('rankMessage').textContent = 'Rank added successfully!';
setTimeout(() => {
document.getElementById('rankMessage').textContent = '';
}, 3000);
} catch (error) {
console.error("Error adding rank: ", error);
document.getElementById('rankMessage').textContent = 'Error adding rank: ' + error.message;
setTimeout(() => {
document.getElementById('rankMessage').textContent = '';
}, 3000);
}
}

// Delete a rank
async function deleteRank(rankId, rankName) {
if (!confirm(`Are you sure you want to delete the rank "${rankName}"?`)) {
return;
}
try {
await db.collection("ranks").doc(rankId).delete();
document.getElementById('rankMessage').textContent = 'Rank deleted successfully!';
setTimeout(() => {
document.getElementById('rankMessage').textContent = '';
}, 3000);
} catch (error) {
console.error("Error deleting rank: ", error);
document.getElementById('rankMessage').textContent = 'Error deleting rank: ' + error.message;
setTimeout(() => {
document.getElementById('rankMessage').textContent = '';
}, 3000);
}
}

// Add a new course
async function addCourse() {
const newCourseInput = document.getElementById('newCourseInput');
const newCourse = newCourseInput.value.trim();
if (!newCourse) {
document.getElementById('courseMessage').textContent = 'Please enter a course name';
setTimeout(() => {
document.getElementById('courseMessage').textContent = '';
}, 3000);
return;
}
try {
// Check if course already exists
const existingCourse = coursesData.find(c => c.name === newCourse);
if (existingCourse) {
document.getElementById('courseMessage').textContent = 'This course already exists';
setTimeout(() => {
document.getElementById('courseMessage').textContent = '';
}, 3000);
return;
}
// Calculate the new order value based on the current number of courses
const newOrder = coursesData.length;

// Add new course to Firestore
await db.collection("courses").add({
name: newCourse,
order: newOrder
});

// Clear input
newCourseInput.value = '';
document.getElementById('courseMessage').textContent = 'Course added successfully!';
setTimeout(() => {
document.getElementById('courseMessage').textContent = '';
}, 3000);
} catch (error) {
console.error("Error adding course: ", error);
document.getElementById('courseMessage').textContent = 'Error adding course: ' + error.message;
setTimeout(() => {
document.getElementById('courseMessage').textContent = '';
}, 3000);
}
}

// Delete a course
async function deleteCourse(courseId, courseName) {
if (!confirm(`Are you sure you want to delete the course "${courseName}"?`)) {
return;
}
try {
await db.collection("courses").doc(courseId).delete();
document.getElementById('courseMessage').textContent = 'Course deleted successfully!';
setTimeout(() => {
document.getElementById('courseMessage').textContent = '';
}, 3000);
} catch (error) {
console.error("Error deleting course: ", error);
document.getElementById('courseMessage').textContent = 'Error deleting course: ' + error.message;
setTimeout(() => {
document.getElementById('courseMessage').textContent = '';
}, 3000);
}
}

// Logout function
function logout() {
auth.signOut().then(() => {
currentUser = null;
isAdmin = false;
// Hide interfaces
document.getElementById('adminDashboard').style.display = 'none';
document.getElementById('userInterface').style.display = 'block';
document.getElementById('profilePopup').style.display = 'none';
// Hide profile/admin buttons
document.getElementById('profileBtn').style.display = 'none';
document.getElementById('adminSwitchBtn').style.display = 'none';
document.getElementById('adminBackBtn').style.display = 'none';
// Hide the login popup if it happens to be open
document.getElementById('loginPopup').style.display = 'none';
// Show the login button again after logging out
document.getElementById('loginBtn').style.display = 'block';
loadSkillsFromFirebase();
}).catch(error => {
console.error("Error signing out: ", error);
});
}

// Show different sections in admin panel
// Show different sections in admin panel
function showSection(section) {
// Hide all sections
document.querySelectorAll('.section').forEach(el => el.style.display = 'none');
document.getElementById('edit-skill-form').style.display = 'none';

// Remove active class from all nav items
document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));

// Show selected section and highlight nav item
document.getElementById(`${section}-section`).style.display = 'block';
document.querySelector(`.nav-item[onclick="showSection('${section}')"]`).classList.add('active');

if (section === 'dashboard') {
updateCounters();
}
// IMPORTANT: Always reload skills list when showing skills section
if (section === 'skills') {
loadSkillsList(); // Use the modified function
}
// Load users management when showing users section
if (section === 'users') {
loadUsersManagement();
}
// Load settings content when showing settings section
if (section === 'settings') {
// Load signup settings by default or the active tab
const activeTabButton = document.querySelector('.tab-button.active');
const activeTabId = activeTabButton ? activeTabButton.getAttribute('data-tab') : 'signupSettings';
if (activeTabId === 'signupSettings') {
loadSignupSettings();
} else if (activeTabButton && activeTabId === 'adminAccess') { // Added check for activeTabButton
loadAdminList(); // Call loadAdminList when Admin Access tab is active
}
}
}

// Load skills list in admin panel - MODIFIED TO USE GRID LAYOUT WITH EDIT/DELETE/REORDER BUTTONS
// Uses the globally managed skillsData array, sorted by 'order'
// Load skills list in admin panel - MODIFIED TO USE GRID LAYOUT WITH EDIT/DELETE/REORDER BUTTONS
// Uses the globally managed skillsData array, sorted by 'order'
async function loadSkillsList() {
const skillsList = document.getElementById('skillsList');
skillsList.innerHTML = '';

// Sort the global skillsData array by 'order' field before displaying
// This redundant sorting is fine if skillsData is always kept sorted by the listener,
// but doing it here ensures correctness at the point of rendering.
const sortedSkillsArray = [...skillsData].sort((a, b) => {
const orderA = a.order !== undefined && a.order !== null ? a.order : Infinity;
const orderB = b.order !== undefined && b.order !== null ? b.order : Infinity;
return orderA - orderB;
});

if (sortedSkillsArray.length === 0) {
skillsList.innerHTML = '<p>No skills available.</p>';
return;
}

const skillGrid = document.createElement('div');
skillGrid.className = 'skill-grid';

sortedSkillsArray.forEach((skill, index) => {
const skillCard = document.createElement('div');
skillCard.className = 'skill-card-ui';
skillCard.setAttribute('data-skill-id', skill.id);

const isTop = index === 0;
const isBottom = index === sortedSkillsArray.length - 1;

// --- FIX: Provide fallback value (0) for skill.order if it's undefined/null ---
const orderValue = skill.order !== undefined && skill.order !== null ? skill.order : 0;
// --- END FIX ---

// Inside loadSkillsList, within the sortedSkillsArray.forEach loop:
// ... (finding isTop, isBottom, orderValue) ...

// CHANGED: Updated HTML string for admin list card to use image tag with fallback
const iconUrl = skill.icon && typeof skill.icon === 'string' && /\.(jpg|jpeg|png|gif|svg)$/i.test(skill.icon) ? skill.icon : 'path/to/your/default/icon.png';
skillCard.innerHTML = `
<div class="skill-icon">
<img src="${iconUrl}" alt="${skill.name} icon" style="max-width: 100%; max-height: 100%; object-fit: contain;">
</div>
<div class="skill-content">
<h3 class="skill-name">${skill.name}</h3>
<p class="skill-desc">${skill.description.substring(0, 100)}...</p>
<div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
<button class="skill-btn" style="background: var(--primary); flex: 1;" ${isTop ? 'disabled' : ''} onclick="moveSkillUp('${skill.id}', ${orderValue})" title="Move Up">
<i class="fas fa-arrow-up"></i>
</button>
<button class="skill-btn" style="background: var(--primary); flex: 1;" ${isBottom ? 'disabled' : ''} onclick="moveSkillDown('${skill.id}', ${orderValue})" title="Move Down">
<i class="fas fa-arrow-down"></i>
</button>
</div>
<div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
<button class="skill-btn" style="background: var(--warning); flex: 1;" onclick="editSkill('${skill.id}')">Edit</button>
<button class="skill-btn" style="background: var(--danger); flex: 1;" onclick="deleteSkill('${skill.id}')">Delete</button>
</div>
</div>
`;
// ... (rest of the loop remains the same)
skillGrid.appendChild(skillCard);
});
skillsList.appendChild(skillGrid);

// Note: Removed the try-catch block as it now relies on the pre-loaded skillsData array
}

// Load users management in admin panel
function loadUsersManagement() {
const usersContent = document.getElementById('usersContent');
usersContent.innerHTML = '';

// Group users by course
const courses = {};
usersData.forEach(user => {
if (!courses[user.course]) {
courses[user.course] = [];
}
courses[user.course].push(user);
});

// Render each course group
Object.keys(courses).forEach(course => {
const courseGroup = document.createElement('div');
courseGroup.className = 'course-group';
courseGroup.innerHTML = `
<h3 class="course-title">${course}</h3>
<div class="user-list" id="course-${course.replace(/\s+/g, '-')}">
<!-- Users will be added here -->
</div>
`;
usersContent.appendChild(courseGroup);

// Add users to this course
const userList = document.getElementById(`course-${course.replace(/\s+/g, '-')}`);
courses[course].forEach(user => {
const userCard = document.createElement('div');
userCard.className = 'user-card';

// --- MODIFICATION STARTS HERE ---
userCard.innerHTML = `
<div class="user-details">
<div class="user-name">${user.name}</div>
<div class="user-rank">${user.rank}</div>
<div class="user-course">${user.course}</div>
<div class="user-email">${user.email}</div> <!-- Optional: Display email -->
</div>
<div> <!-- Wrap buttons in a div -->
<button class="edit-user-btn" onclick="editUser('${user.id}')">Edit</button>
<button class="action-btn delete-btn" onclick="deleteUser('${user.id}', '${user.name}')">Delete</button> <!-- Add Delete Button -->
</div>
`;
// --- MODIFICATION ENDS HERE ---
userList.appendChild(userCard);
});
});
}

// Edit user function
function editUser(userId) {
editingUserId = userId;
const user = usersData.find(u => u.id === userId);
if (!user) return;
document.getElementById('edit-user-name').value = user.name;
document.getElementById('edit-user-rank').value = user.rank;
document.getElementById('edit-user-course').value = user.course;
document.getElementById('editUserModal').style.display = 'flex';
}

// Save edited user
async function saveEditedUser() {
const name = document.getElementById('edit-user-name').value.toUpperCase();
const rank = document.getElementById('edit-user-rank').value;
const course = document.getElementById('edit-user-course').value;
if (!name || !rank || !course) {
alert('Please fill in all fields');
return;
}
try {
await db.collection("users").doc(editingUserId).update({
name: name,
rank: rank,
course: course
});
document.getElementById('editUserModal').style.display = 'none';
alert('User updated successfully!');
} catch (error) {
console.error("Error updating user: ", error);
alert('Error updating user: ' + error.message);
}
}

// Close edit user modal
function closeEditUserModal() {
document.getElementById('editUserModal').style.display = 'none';
}

// Close edit user modal
function closeEditUserModal() {
document.getElementById('editUserModal').style.display = 'none';
}

// --- ADD THIS NEW FUNCTION ---
// Delete a user
async function deleteUser(userId, userName) {
if (!confirm(`Are you sure you want to delete the user "${userName}"? This action cannot be undone.`)) {
return;
}
try {
// Delete user document from 'users' collection
await db.collection("users").doc(userId).delete();

// Also remove from 'admins' collection if they were an admin
await db.collection("admins").doc(userId).delete().catch(error => {
// Ignore error if the user wasn't an admin
if (error.code !== 'not-found') {
console.error("Error removing user from admins during deletion: ", error);
}
});

alert(`User "${userName}" has been deleted successfully.`);

// Optionally, refresh the user list to reflect the deletion
if (document.getElementById('users-section').style.display === 'block') {
loadUsersManagement(); // Reload the user list if currently viewing
}
} catch (error) {
console.error("Error deleting user: ", error);
alert('Error deleting user: ' + error.message);
}
}
// --- END OF NEW FUNCTION ---

// Update dashboard counters
function updateCounters() {
document.getElementById('total-skills').textContent = skillsData.length;
}

// Add new skill
// Add new skill
// Add new skill
async function addNewSkill() {
try {
// Calculate the new order value based on the *maximum* existing order in the CURRENTLY KNOWN skillsData + 1
// Ensure skillsData is sorted first to get the latest max
// Use the same sorting logic as elsewhere to find the max order
const sortedSkillsForOrderCalc = [...skillsData].sort((a, b) => {
const orderA = a.order !== undefined && a.order !== null ? a.order : -1; // Use -1 or 0 if missing for calculation
const orderB = b.order !== undefined && b.order !== null ? b.order : -1;
return orderA - orderB;
});

const maxExistingOrder = sortedSkillsForOrderCalc.length > 0 ? (sortedSkillsForOrderCalc[sortedSkillsForOrderCalc.length - 1].order || 0) : -1;
const newOrder = maxExistingOrder + 1;

currentEditingSkill = {
id: null, // Will be assigned by Firestore on add
name: '',
icon: '', // Will store the image URL
description: '',
tools: [],
steps: [],
theory: '',
quiz: [],
order: newOrder // Set the initial order based on max + 1
};
originalEditingSkill = JSON.parse(JSON.stringify(currentEditingSkill)); // Store original data
showEditForm();
} catch (error) {
console.error("Error calculating order for new skill: ", error);
alert("Error initializing new skill. Please try again.");
}
}

// Edit existing skill
function editSkill(skillId) {
currentEditingSkill = skillsData.find(skill => skill.id === skillId);
originalEditingSkill = JSON.parse(JSON.stringify(currentEditingSkill)); // Store original data
if (currentEditingSkill) {
showEditForm();
}
}

// Show edit form
function showEditForm() {
document.getElementById('edit-skill-name').value = currentEditingSkill.name || '';

// NEW: Handle icon loading for editing
const iconPreview = document.getElementById('skill-icon-preview');
const noImageText = document.getElementById('no-image-text');
const iconFileInput = document.getElementById('edit-skill-icon-file');
if (currentEditingSkill.icon && typeof currentEditingSkill.icon === 'string' && /\.(jpg|jpeg|png|gif|svg)$/i.test(currentEditingSkill.icon)) {
    iconPreview.src = currentEditingSkill.icon;
    iconPreview.style.display = 'block';
    noImageText.style.display = 'none';
} else {
    iconPreview.src = '';
    iconPreview.style.display = 'none';
    noImageText.style.display = 'inline'; // Or keep it visible as default text
}
// Clear the file input if editing an existing skill
iconFileInput.value = '';

document.getElementById('edit-skill-description').value = currentEditingSkill.description || '';
document.getElementById('edit-tools').value = Array.isArray(currentEditingSkill.tools) ? currentEditingSkill.tools.join(', ') : '';
document.getElementById('edit-theory').value = currentEditingSkill.theory || '';

// Clear and populate steps
const stepsContainer = document.getElementById('steps-container');
stepsContainer.innerHTML = '';
if (Array.isArray(currentEditingSkill.steps)) {
currentEditingSkill.steps.forEach((step, index) => {
addStepToForm(index, step);
});
}

// Clear and populate quiz
const quizContainer = document.getElementById('quiz-container');
quizContainer.innerHTML = '';
if (Array.isArray(currentEditingSkill.quiz)) {
currentEditingSkill.quiz.forEach((question, index) => {
addQuizQuestionToForm(index, question);
});
}

// Show form
document.getElementById('skills-section').style.display = 'none';
document.getElementById('edit-skill-form').style.display = 'block';
}

// Cancel edit and restore original data
function cancelEdit() {
// Restore original skill data
currentEditingSkill = JSON.parse(JSON.stringify(originalEditingSkill));
// Return to skills list
document.getElementById('edit-skill-form').style.display = 'none';
document.getElementById('skills-section').style.display = 'block';
}

// Add step to form
function addStepToForm(index, step = null) {
const stepsContainer = document.getElementById('steps-container');
const stepId = index !== undefined ? index : (currentEditingSkill.steps ? currentEditingSkill.steps.length : 0);
const stepObj = step || { title: '', description: '', image: '' };

const stepElement = document.createElement('div');
stepElement.className = 'step-item';
stepElement.id = `step-${stepId}`;
stepElement.innerHTML = `
<div class="step-header">
<h4>Step ${stepId + 1}</h4>
<button class="action-btn delete-btn" onclick="removeStep(${stepId})">Remove</button>
</div>
<div class="step-content">
<div>
<label>Title</label>
<input type="text" value="${stepObj.title}" onchange="updateStepField(${stepId}, 'title', this.value)" placeholder="Step title">
</div>
<div>
<label>Description</label>
<textarea onchange="updateStepField(${stepId}, 'description', this.value)" placeholder="Step description">${stepObj.description}</textarea>
</div>
<div>
<label>Image URL</label>
<input type="text" value="${stepObj.image}" onchange="updateStepField(${stepId}, 'image', this.value)" placeholder="Image URL">
</div>
</div>
`;
stepsContainer.appendChild(stepElement);
}

// Add new step
function addStep() {
if (!currentEditingSkill.steps) currentEditingSkill.steps = [];
currentEditingSkill.steps.push({ title: '', description: '', image: '' });
addStepToForm();
}

// Update step field
function updateStepField(index, field, value) {
if (currentEditingSkill.steps && currentEditingSkill.steps[index]) {
currentEditingSkill.steps[index][field] = value;
}
}

// Remove step
function removeStep(index) {
if (currentEditingSkill.steps && currentEditingSkill.steps[index]) {
currentEditingSkill.steps.splice(index, 1);
// Re-render all steps
const stepsContainer = document.getElementById('steps-container');
stepsContainer.innerHTML = '';
currentEditingSkill.steps.forEach((step, idx) => {
addStepToForm(idx, step);
});
}
}

// Add quiz question to form
function addQuizQuestionToForm(index, question = null) {
const quizContainer = document.getElementById('quiz-container');
const questionId = index !== undefined ? index : (currentEditingSkill.quiz ? currentEditingSkill.quiz.length : 0);
const q = question || { question: '', options: ['', '', '', ''], answer: 0 };

const questionElement = document.createElement('div');
questionElement.className = 'quiz-question';
questionElement.id = `question-${questionId}`;
questionElement.innerHTML = `
<div class="quiz-header">
<h4>Question ${questionId + 1}</h4>
<button class="action-btn delete-btn" onclick="removeQuizQuestion(${questionId})">Remove</button>
</div>
<div class="quiz-content">
<div>
<label>Question Text</label>
<input type="text" value="${q.question}" onchange="updateQuizField(${questionId}, 'question', this.value)" placeholder="Question text">
</div>
<div class="quiz-options">
<div>
<label>Option A</label>
<input type="text" value="${q.options[0]}" onchange="updateQuizOption(${questionId}, 0, this.value)" placeholder="Option A">
</div>
<div>
<label>Option B</label>
<input type="text" value="${q.options[1]}" onchange="updateQuizOption(${questionId}, 1, this.value)" placeholder="Option B">
</div>
<div>
<label>Option C</label>
<input type="text" value="${q.options[2]}" onchange="updateQuizOption(${questionId}, 2, this.value)" placeholder="Option C">
</div>
<div>
<label>Option D</label>
<input type="text" value="${q.options[3]}" onchange="updateQuizOption(${questionId}, 3, this.value)" placeholder="Option D">
</div>
</div>
<div>
<label>Correct Answer (0=A, 1=B, 2=C, 3=D)</label>
<input type="number" min="0" max="3" value="${q.answer}" onchange="updateQuizField(${questionId}, 'answer', parseInt(this.value))">
</div>
</div>
`;
quizContainer.appendChild(questionElement);
}

// Add new quiz question
function addQuizQuestion() {
if (!currentEditingSkill.quiz) currentEditingSkill.quiz = [];
currentEditingSkill.quiz.push({ question: '', options: ['', '', '', ''], answer: 0 });
addQuizQuestionToForm();
}

// Update quiz field
function updateQuizField(questionId, field, value) {
if (currentEditingSkill.quiz && currentEditingSkill.quiz[questionId]) {
currentEditingSkill.quiz[questionId][field] = value;
}
}

// Update quiz option
function updateQuizOption(questionId, optionIndex, value) {
if (currentEditingSkill.quiz &&
currentEditingSkill.quiz[questionId] &&
currentEditingSkill.quiz[questionId].options[optionIndex] !== undefined) {
currentEditingSkill.quiz[questionId].options[optionIndex] = value;
}
}

// Remove quiz question
function removeQuizQuestion(index) {
if (currentEditingSkill.quiz && currentEditingSkill.quiz[index]) {
currentEditingSkill.quiz.splice(index, 1);
// Re-render all questions with correct numbering
const quizContainer = document.getElementById('quiz-container');
quizContainer.innerHTML = '';
currentEditingSkill.quiz.forEach((question, idx) => {
addQuizQuestionToForm(idx, question);
});
}
}

// NEW: Event Listener for Icon File Upload
document.getElementById('edit-skill-icon-file').addEventListener('change', function(event) {
    const file = event.target.files[0];
    const preview = document.getElementById('skill-icon-preview');
    const noImageText = document.getElementById('no-image-text');

    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.src = e.target.result;
            preview.style.display = 'block';
            noImageText.style.display = 'none'; // Hide the "No image" text
        }
        reader.readAsDataURL(file);
    } else {
        preview.src = '';
        preview.style.display = 'none';
        noImageText.style.display = 'inline'; // Show the "No image" text if no file is selected
    }
});

// Save skill
async function saveSkill() { // Make function async
// Update current skill with form values
currentEditingSkill.name = document.getElementById('edit-skill-name').value;

// NEW: Handle Icon Upload
const iconFileInput = document.getElementById('edit-skill-icon-file');
const iconPreview = document.getElementById('skill-icon-preview');
let iconUrl = ''; // Default to empty string

if (iconFileInput.files.length > 0) {
    // A new file was selected
    const file = iconFileInput.files[0];
    const reader = new FileReader();

    // Convert the selected file to a Data URL
    reader.onload = async function(e) {
        try {
            const dataUrl = e.target.result;
            const blob = dataURLtoBlob(dataUrl); // Use the helper function

            // Create a unique filename (optional, based on timestamp)
            const fileName = `skill_icons/${currentEditingSkill.id || Date.now()}_${file.name}`;
            const storageRef = storage.ref(fileName);

            // Upload the blob to Firebase Storage
            const snapshot = await storageRef.put(blob);
            iconUrl = await snapshot.ref.getDownloadURL(); // Get the download URL

            console.log("Image uploaded successfully:", iconUrl);

            // Now proceed with saving the skill document to Firestore with the new icon URL
            if (!currentEditingSkill.id) {
                // If it's a new skill, add it first to get an ID
                const docRef = await db.collection("skills").add({...currentEditingSkill, icon: iconUrl});
                console.log("New skill saved with ID:", docRef.id);
            } else {
                // If it's an existing skill, update it
                await db.collection("skills").doc(currentEditingSkill.id).update({icon: iconUrl});
                console.log("Existing skill updated with new icon URL:", currentEditingSkill.id);
            }

            // Final success message and UI update
            alert('Skill saved successfully!');
            document.getElementById('edit-skill-form').style.display = 'none';
            document.getElementById('skills-section').style.display = 'block';
            showSection('skills'); // This will trigger loadSkillsList

        } catch (uploadError) {
            console.error("Error uploading image or saving skill: ", uploadError);
            alert('Error saving skill: ' + uploadError.message);
        }
    };

    reader.onerror = function(e) {
        console.error("Error reading file: ", e);
        alert('Error reading the selected image file.');
    };

    reader.readAsDataURL(file); // Start reading the file

} else {
    // No new file selected, keep the existing icon if editing, or set default
    if (currentEditingSkill.id) { // Editing existing skill
         iconUrl = currentEditingSkill.icon || ''; // Keep existing URL or set to empty if none
    } else { // Adding new skill without icon
         iconUrl = ''; // Set to empty string for new skill
    }

    // Save the skill without uploading a new image
    try {
        if (!currentEditingSkill.id) {
            // Add new skill with the determined icon URL
            const docRef = await db.collection("skills").add({...currentEditingSkill, icon: iconUrl});
            console.log("New skill saved with ID:", docRef.id);
        } else {
            // Update existing skill, only if icon changed (though in this path it hasn't)
            // We still update other fields and potentially the icon if it was an existing one
            await db.collection("skills").doc(currentEditingSkill.id).set(currentEditingSkill);
            console.log("Existing skill updated (without new image):", currentEditingSkill.id);
        }

        // Success message and UI update
        alert('Skill saved successfully!');
        document.getElementById('edit-skill-form').style.display = 'none';
        document.getElementById('skills-section').style.display = 'block';
        showSection('skills'); // This will trigger loadSkillsList

    } catch (error) {
        console.error("Error saving skill to Firestore: ", error);
        alert('Error saving skill: ' + error.message);
    }
}
}


// Delete skill
function deleteSkill(skillId) {
if (!skillId) {
console.warn("Attempted to delete a skill with an invalid or empty ID:", skillId);
alert("Cannot delete skill: Invalid ID.");
return;
}
if (confirm('Are you sure you want to delete this skill?')) {
db.collection("skills").doc(skillId).delete()
.then(() => {
console.log("Skill deleted successfully with ID:", skillId);
})
.catch((error) => {
console.error("Error removing skill with ID '" + skillId + "': ", error);
});
}
}

// Load skills from Firebase
// Load skills from Firebase (for user interface)
// Load skills from Firebase (for user interface)
async function loadSkillsFromFirebase() {
try {
// Use onSnapshot for real-time updates, similar to the listener above
// But for initial load, you might stick with get(), though onSnapshot is generally preferred
// Using get() here as per your original structure, but ensure consistency with the listener
const snapshot = await db.collection("skills").get(); // Get all skills first
let tempSkillsData = [];
snapshot.forEach(doc => {
tempSkillsData.push({ id: doc.id, ...doc.data() });
});

// Sort by 'order' field, handling potentially missing 'order' values gracefully
tempSkillsData.sort((a, b) => {
const orderA = a.order !== undefined && a.order !== null ? a.order : Infinity;
const orderB = b.order !== undefined && b.order !== null ? b.order : Infinity;
return orderA - orderB;
});

skillsData = tempSkillsData; // Update the global array
loadSkillGrid(); // Now load the grid with the sorted data
} catch (error) {
console.error("Error loading skills: ", error);
}
}

// Load skill grid for user interface
// --- UPDATED: Function to load skills grid for User Interface ---
function loadSkillGrid() {
console.log("loadSkillGrid called"); // Debug log
const gridElement = document.getElementById('skill-grid');
if (!gridElement) {
console.error("loadSkillGrid: Could not find #skill-grid element");
return;
}

// Clear previous content
gridElement.innerHTML = '';

if (!skillsData || skillsData.length === 0) {
console.warn("loadSkillGrid: skillsData is empty or not loaded yet.");
gridElement.innerHTML = '<p>No skills available.</p>'; // Optional: Show a message
return;
}

console.log("loadSkillGrid: Rendering", skillsData.length, "skills"); // Debug log

let html = '';
skillsData.forEach(skill => {
// Safely check for completion status
const isCompleted = currentUser && Array.isArray(currentUser.completedSkills) && currentUser.completedSkills.includes(skill.id);

// CHANGED: Use img tag for icon in user grid, with fallback
const iconUrl = skill.icon && typeof skill.icon === 'string' && /\.(jpg|jpeg|png|gif|svg)$/i.test(skill.icon) ? skill.icon : 'path/to/your/default/icon.png';
html += `
<div class="skill-card-ui" onclick="loadSkillDetail('${skill.id}')">
<div class="skill-icon">
<img src="${iconUrl}" alt="${skill.name || 'Skill'} icon" style="max-width: 100%; max-height: 100%; object-fit: contain;">
</div>
<div class="skill-content">
<h3 class="skill-name">${skill.name || 'Unnamed Skill'}</h3>
<p class="skill-desc">${skill.description || 'No description available.'}</p>
<button class="skill-btn">
${isCompleted ? 'Review' : 'Start'} Learning
</button>
</div>
</div>
`;
});

gridElement.innerHTML = html; // Set the generated HTML
console.log("loadSkillGrid: Finished rendering HTML"); // Debug log
}

// Load detail view for a specific skill
function loadSkillDetail(skillId) {
document.getElementById('skill-grid').style.display = 'none';
document.getElementById('skill-detail').style.display = 'block';
const skill = skillsData.find(s => s.id === skillId);
if (!skill) return;

let html = `
<div class="skill-header">
<img src="${skill.icon && typeof skill.icon === 'string' && /\.(jpg|jpeg|png|gif|svg)$/i.test(skill.icon) ? skill.icon : 'path/to/your/default/icon.png'}" alt="${skill.name} icon" style="width: 2.5rem; height: 2.5rem; margin-right: 1rem; object-fit: contain;">
<h2>${skill.name}</h2>
</div>
<div class="skill-section">
<h3 class="section-title-ui">Required Tools</h3>
<div class="tools-grid">
`;
skill.tools.forEach(tool => {
html += `
<div class="tool-item">
<i class="fas fa-toolbox"></i>
<div>${tool}</div>
</div>
`;
});
html += `
</div>
</div>
<div class="skill-section">
<h3 class="section-title-ui">Step-by-Step Guide</h3>
<div class="steps-container">
`;
skill.steps.forEach(step => {
html += `
<div class="step-card">
<img src="${step.image}" alt="${step.title}" class="step-image">
<div class="step-content">
<h4 class="step-title">${step.title}</h4>
<p>${step.description}</p>
</div>
</div>
`;
});
html += `
</div>
</div>
<div class="skill-section">
<h3 class="section-title-ui">Theory & Principles</h3>
<div class="theory-content">
<p>${skill.theory}</p>
</div>
</div>
<div class="skill-section">
<h3 class="section-title-ui">Knowledge Check</h3>
<div class="quiz-container" id="quiz-container">
`;
skill.quiz.forEach((q, index) => {
html += `
<div class="question">
<div class="question-text">${q.question}</div>
<div class="options">
`;
q.options.forEach((opt, optIndex) => {
html += `
<div class="option" data-question="${index}" data-option="${optIndex}">
<input type="radio" name="q${index}" id="q${index}o${optIndex}">
<label for="q${index}o${optIndex}">${String.fromCharCode(65 + optIndex)}. ${opt}</label>
</div>
`;
});
html += `
</div>
<div class="quiz-result" id="result-${index}" style="display:none;"></div>
</div>
`;
});
html += `
</div>
<div class="quiz-nav">
<button class="back-btn" onclick="goBackToGrid()"> Back to Skills</button>
<button class="skill-btn" onclick="checkQuiz('${skillId}')">Check Answers</button>
</div>
</div>
`;

document.getElementById('skill-detail').innerHTML = html;

// Add event listeners for quiz options
document.querySelectorAll('.option').forEach(option => {
option.addEventListener('click', function() {
const questionIndex = this.dataset.question;
const optionIndex = this.dataset.option;

// Remove selected class from all options in this question
document.querySelectorAll(`.option[data-question="${questionIndex}"]`).forEach(opt => {
opt.classList.remove('selected');
});

// Add selected class to clicked option
this.classList.add('selected');
});
});
}

// Check quiz answers
function checkQuiz(skillId) {
const skill = skillsData.find(s => s.id === skillId);
if (!skill) return;

let score = 0;
let allAnswered = true;

skill.quiz.forEach((q, index) => {
const selectedOption = document.querySelector(`.option[data-question="${index}"].selected`);
if (!selectedOption) {
allAnswered = false;
return;
}
const selectedValue = parseInt(selectedOption.dataset.option);
const resultDiv = document.getElementById(`result-${index}`);

if (selectedValue === q.answer) {
resultDiv.textContent = 'Correct!';
resultDiv.className = 'quiz-result correct';
score++;
} else {
resultDiv.textContent = `Incorrect. Correct answer: ${String.fromCharCode(65 + q.answer)}`;
resultDiv.className = 'quiz-result incorrect';
}
resultDiv.style.display = 'block';
});

if (!allAnswered) {
alert('Please answer all questions before checking your answers.');
return;
}

// Show overall score
const totalQuestions = skill.quiz.length;
const percentage = Math.round((score / totalQuestions) * 100);

// Mark skill as completed if passed
if (percentage >= 70 && currentUser) {
if (!currentUser.completedSkills.includes(skillId)) {
// Update user's completed skills in Firestore
currentUser.completedSkills.push(skillId);
db.collection("users").doc(currentUser.id).update({
completedSkills: firebase.firestore.FieldValue.arrayUnion(skillId)
}).then(() => {
localStorage.setItem('currentUser', JSON.stringify(currentUser));
alert(\`Quiz completed!
Score: \${score}/\${totalQuestions} (\${percentage}%)
Congratulations! You've completed this skill.\`);
});
} else {
alert(\`Quiz completed!
Score: \${score}/\${totalQuestions} (\${percentage}%)\`);
}
} else {
alert(\`Quiz completed!
Score: \${score}/\${totalQuestions} (\${percentage}%)
You need at least 70% to pass. Try again!\`);
}
}

// Settings tab functionality
document.querySelectorAll('.tab-button').forEach(button => {
button.addEventListener('click', function() {
const tabName = this.getAttribute('data-tab');

// Remove active class from all buttons and tabs
document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));

// Add active class to clicked button and corresponding tab
this.classList.add('active');
document.getElementById(\`\${tabName}Tab\`).classList.add('active');

// --- ADD THIS CONDITIONAL CALL ---
if (tabName === 'adminAccess') {
loadAdminList(); // Load admin list specifically when the Admin Access tab is clicked
}
// --- END OF ADDITION ---
});
});
</script>
</body>
</html>
