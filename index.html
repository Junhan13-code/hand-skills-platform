<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hand Skills Learning Platform</title>
    <!-- Include Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #007bff;
            --secondary: #6c757d;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #343a40;
            --gray: #6c757d;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f7fc;
            color: #333;
        }

        /* Header Styles */
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 1rem 0;
            text-align: center;
            position: relative; /* For positioning buttons absolutely within header */
            margin-bottom: 2rem;
        }

        header h1 {
            font-size: 1.8rem;
            margin: 0.5rem 0 0.25rem 0; /* Reduced bottom margin */
        }

        header p {
            font-size: 0.9rem;
            opacity: 0.9;
            margin: 0;
        }

        /* Button Styles */
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px; /* Rounded edges */
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.3s ease;
            width: 100%;
            margin-top: 0.5rem;
        }

        .btn:hover {
            background: #0056b3;
        }

        .btn.google-btn {
            background: #DB4437; /* Google Red */
            color: white;
        }

        .btn.google-btn:hover {
            background: #C23321; /* Darker Google Red */
        }

        .btn-secondary {
            background: var(--secondary);
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .logout-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .logout-btn:hover {
            background: #bd2130;
        }

        .admin-switch-btn {
            background: var(--info);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px; /* Rounded edges */
            cursor: pointer;
            font-size: 0.9rem;
            margin-left: 0.5rem;
        }

        .admin-switch-btn:hover {
            background: #138496;
        }

        .profile-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--dark);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px; /* Rounded edges */
            cursor: pointer;
            font-size: 0.9rem;
        }

         /* Login Popup Styles */
        .login-popup {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5); /* Semi-transparent background */
            z-index: 2000; /* Ensure it's on top */
            justify-content: center;
            align-items: center;
        }

        .login-container {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 400px;
            position: relative;
        }

        .close-login-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }

        .close-login-btn:hover {
            color: var(--danger);
        }

        .auth-toggle {
            margin-top: 1rem;
            font-size: 0.85rem;
        }

        .auth-toggle a {
            color: var(--primary);
            text-decoration: none;
            margin: 0 0.5rem;
        }

        .auth-toggle a:hover {
            text-decoration: underline;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.25rem;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 5px;
            box-sizing: border-box;
        }

        #auth-error {
            color: var(--danger);
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }

        /* Profile Popup Styles */
        .profile-popup {
            display: none; /* Hidden by default */
            position: fixed;
            top: 60px; /* Position below the header */
            right: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            width: 300px;
            z-index: 1000;
            overflow: hidden;
        }

        .profile-header {
            background: var(--primary);
            color: white;
            padding: 1rem;
            text-align: center;
        }

        .profile-header i {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            display: block;
        }

        .profile-content {
            padding: 1.5rem;
        }

        .profile-info {
            margin-bottom: 1.5rem;
        }

        .info-item {
            margin-bottom: 1rem;
        }

        .info-item strong {
            display: block;
            margin-bottom: 0.25rem;
            color: var(--dark);
        }

        .info-item span {
            color: var(--gray);
        }

        .edit-profile-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--light);
        }

        .edit-profile-section label {
            display: block;
            margin-bottom: 0.25rem;
            font-weight: 500;
        }

        .edit-profile-section select,
        .edit-profile-section input {
            width: calc(100% - 22px); /* Account for padding/borders */
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 5px;
            margin-bottom: 0.5rem;
            box-sizing: border-box;
        }

        .edit-profile-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
        }

        .edit-profile-btn:hover {
            background: #0056b3;
        }

        /* User Interface Styles */
        .user-interface {
            display: none; /* Hidden by default, shown after login */
            padding: 0 1rem; /* Add side padding */
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .skill-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .skill-card-ui {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .skill-card-ui:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .skill-icon {
            width: 100%;
            height: 150px;
            overflow: hidden;
        }

        .skill-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .skill-content {
            padding: 1rem;
        }

        .skill-name {
            margin: 0 0 0.5rem 0;
            font-size: 1.1rem;
        }

        .skill-completed {
            color: var(--success);
            font-weight: bold;
        }

        .skill-not-completed {
            color: var(--gray);
        }

        /* Skill Detail Styles */
        .skill-detail {
            display: none;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 2rem;
            margin: 1rem 0;
        }

        .back-to-skills-btn {
             background: var(--secondary);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px; /* Rounded edges */
            cursor: pointer;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

         .back-to-skills-btn:hover {
            background: #5a6268;
        }

        .skill-header {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .skill-header img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            margin-right: 1.5rem;
            border-radius: 5px;
        }

        .skill-header h2 {
            margin: 0;
            font-size: 1.8rem;
        }

        .steps-container, .quiz-container {
            margin-top: 1.5rem;
        }

        .step-card {
            background: var(--light);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .step-image {
            width: 100%;
            height: 200px;
            overflow: hidden;
            border-radius: 5px;
            margin-bottom: 0.5rem;
        }

        .step-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .step-title {
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .step-description {
            color: var(--dark);
        }

        .quiz-question {
            margin-bottom: 1.5rem;
            padding: 0.5rem 0;
        }

        .quiz-question-text {
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .quiz-options label {
            display: block;
            margin-bottom: 0.25rem;
        }

        .complete-skill-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 1rem;
        }

         .complete-skill-btn:hover {
            background: #218838;
        }

        /* Admin Dashboard Styles */
        .admin-dashboard {
            display: none; /* Hidden by default, shown for admins */
            padding: 1rem 0;
            background-color: #f0f4f8;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding: 0.75rem 1.5rem;
            border-bottom: 1px solid var(--light);
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .admin-header h1 {
            color: var(--primary);
            font-size: 1.5rem;
            margin: 0;
        }

        .admin-content {
            display: grid;
            grid-template-columns: 250px 1fr; /* Sidebar and Main Content */
            gap: 2rem;
        }

        .nav-panel {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            height: fit-content; /* Stick to content height */
        }

        .nav-panel h3 {
            margin-top: 0;
            margin-bottom: 1rem;
            color: var(--dark);
        }

        .nav-item {
            padding: 0.75rem;
            cursor: pointer;
            border-radius: 5px;
            margin-bottom: 0.5rem;
            transition: background-color 0.2s ease;
        }

        .nav-item:hover {
            background-color: #e9ecef;
        }

        .nav-item.active {
            background-color: var(--primary);
            color: white;
        }

        .main-content-area {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .section {
            display: none; /* Hidden by default, shown by JS */
        }

        .section.active {
            display: block; /* Shown when activated */
        }

        .section-title {
            color: var(--dark);
            margin-top: 0;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--light);
        }

        .skill-list {
            margin-top: 1rem;
        }

        .skill-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border: 1px solid var(--light);
            border-radius: 5px;
            margin-bottom: 0.5rem;
        }

        .skill-item-info {
            flex-grow: 1;
        }

        .skill-item-actions {
            display: flex;
            gap: 0.5rem;
        }

        .skill-order-controls button {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        .course-group {
            margin-bottom: 2rem;
        }

        .course-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .user-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }

        .user-card {
            border: 1px solid var(--light);
            border-radius: 5px;
            padding: 1rem;
        }

        .user-card h4 {
            margin: 0 0 0.5rem 0;
        }

        .user-card p {
            margin: 0.25rem 0;
            font-size: 0.9rem;
            color: var(--gray);
        }

        .user-actions {
            margin-top: 0.75rem;
        }

        .user-actions button {
            margin-right: 0.5rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        /* Settings Tab Styles */
        .settings-tabs {
            display: flex;
            border-bottom: 1px solid var(--light);
            margin-bottom: 1.5rem;
        }

        .tab-button {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border: none;
            background: transparent;
            border-bottom: 3px solid transparent;
            transition: border-color 0.3s ease;
        }

        .tab-button:hover {
            background-color: #f8f9fa;
        }

        .tab-button.active {
            border-bottom: 3px solid var(--primary);
            color: var(--primary);
        }

        .tab-content {
            display: none; /* Hidden by default */
        }

        .tab-content.active {
            display: block; /* Shown when active */
        }

        .settings-controls {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Two columns for controls */
            gap: 2rem;
        }

        .control-group {
            margin-bottom: 1.5rem;
        }

        .control-group h3 {
            margin-top: 0;
            color: var(--dark);
        }

        .form-control {
            margin-bottom: 0.5rem;
        }

        .form-control label {
            display: block;
            margin-bottom: 0.25rem;
            font-weight: 500;
        }

        .form-control input, .form-control select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 5px;
            box-sizing: border-box;
        }

        .form-control button {
            width: auto; /* Let button size based on text */
            padding: 0.5rem 1rem;
            margin-top: 0.25rem;
        }

        /* Edit Skill Form Styles */
        /* Note: Removed .section class from the main edit form div */
        .edit-form {
            display: none; /* Hidden by default */
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 800px;
            z-index: 1500; /* Above other content but below popups/modals */
            max-height: 90vh;
            overflow-y: auto;
        }

         /* Explicitly add .section class to tab content areas if needed for hiding/showing via showSection */
        /* These are now hidden/shown by the tab switching logic, not showSection */
        /* #edit-steps-tab-content.section,
        #edit-quiz-tab-content.section {
            display: none;
        } */


        .edit-form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .edit-form-header h2 {
            margin: 0;
        }

        .edit-form-tabs {
            display: flex;
            border-bottom: 1px solid var(--light);
            margin-bottom: 1.5rem;
        }

        .tab-btn {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border: none;
            background: transparent;
            border-bottom: 2px solid transparent;
        }

        .tab-btn.active {
            border-bottom: 2px solid var(--primary);
            color: var(--primary);
        }

        .tab-content-form {
            display: none;
        }

        .tab-content-form.active {
            display: block;
        }

        .steps-container-form, .quiz-container-form {
            margin-top: 1rem;
        }

        .step-form-item, .quiz-form-item {
            border: 1px solid var(--light);
            border-radius: 5px;
            padding: 1rem;
            margin-bottom: 1rem;
            background-color: #fafafa;
        }

        .step-form-item h4, .quiz-form-item h4 {
            margin-top: 0;
        }

        .form-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        .form-row .form-group {
            flex: 1;
        }

        .remove-step-btn, .remove-question-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .add-step-btn, .add-question-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 1rem;
        }

        /* Confirmation Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5); /* Semi-transparent background */
            z-index: 3000; /* Highest z-index */
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 500px;
            text-align: center;
        }

        .modal-content h3 {
            color: var(--danger);
            margin-top: 0;
        }

        .modal-buttons {
            margin-top: 1.5rem;
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

         .modal-buttons .btn {
            width: auto; /* Override full width for modal buttons */
            flex: 1;
            margin-top: 0;
        }

        .error-message {
            color: var(--danger);
            font-size: 0.9rem;
            margin-top: 0.5rem;
            text-align: left; /* Or center if preferred */
        }

         /* Responsive Design */
        @media (max-width: 992px) {
            .admin-content {
                grid-template-columns: 1fr; /* Stack sidebar and main content */
            }
            .nav-panel {
                margin-bottom: 1.5rem;
            }
             .settings-controls {
                grid-template-columns: 1fr; /* Single column on smaller screens */
            }
            .settings-tabs {
                flex-wrap: wrap;
            }
            .tab-button {
                padding: 0.5rem;
                font-size: 0.9rem; /* Smaller text on small screens */
            }
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.5rem;
            }
            .skill-header {
                flex-direction: column;
                text-align: center;
            }
            .skill-header img {
                margin-right: 0;
                margin-bottom: 1rem;
                width: 80px;
                height: 80px;
            }
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            .profile-btn, .admin-switch-btn, .logout-btn {
                 font-size: 0.8rem;
                 padding: 0.4rem 0.8rem;
            }
            .section-title {
                font-size: 1.4rem;
            }
            .admin-header h1 {
                 font-size: 1.4rem;
            }
        }

    </style>
</head>
<body>

    <header>
        <h1><i class="fas fa-tools"></i> Hand Skills Learning Platform</h1>
        <p>Master Essential Skills Efficiently</p>
        <!-- Login Button (Shown when logged out) -->
        <button class="profile-btn" id="loginBtn" onclick="openLoginPopup()" style="display: none;">
            <i class="fas fa-sign-in-alt"></i> Login
        </button>
        <!-- Profile Button (Shown when logged in) -->
        <button class="profile-btn" id="profileBtn" onclick="toggleProfilePopup()" style="display: none;">
            <i class="fas fa-user"></i> Profile
        </button>
        <!-- Admin Switch Button (Shown for admins) -->
        <button class="admin-switch-btn" id="adminSwitchBtn" onclick="switchToAdminInterface()" style="display: none;">
            <i class="fas fa-lock"></i> Admin Panel
        </button>
        <!-- Admin Back Button (Shown when in user view from admin) -->
        <button class="admin-switch-btn" id="adminBackBtn" onclick="switchToUserInterface()" style="display: none;">
            <i class="fas fa-user-graduate"></i> User View
        </button>
    </header>

    <!-- Login Popup -->
    <div class="login-popup" id="loginPopup">
        <div class="login-container">
            <span class="close-login-btn" onclick="closeLoginPopup()">&times;</span>
            <h2>Login / Sign Up</h2>
            <div id="auth-error" style="color: red; margin-bottom: 1rem;"></div>
            <div id="loginForm">
                <div class="form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" placeholder="Enter password">
                </div>
                <button class="btn" onclick="login()">Login</button>
                <button class="btn google-btn" onclick="googleLogin()">
                    <i class="fab fa-google"></i> Sign in with Google
                </button>
                <div class="auth-toggle">
                    <a href="#" onclick="toggleAuthMode()">New User? Sign Up</a> |
                    <a href="#" onclick="showForgotPassword()">Forgot Password?</a>
                </div>
            </div>
            <div id="signupForm" style="display: none;">
                 <div class="form-group">
                    <label for="signup-name">Full Name</label>
                    <input type="text" id="signup-name" placeholder="Enter your full name">
                </div>
                 <div class="form-group">
                    <label for="signup-rank">Rank</label>
                    <select id="signup-rank">
                        <!-- Populated dynamically -->
                    </select>
                </div>
                 <div class="form-group">
                    <label for="signup-course">Course</label>
                    <select id="signup-course">
                         <!-- Populated dynamically -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="signup-email">Email</label>
                    <input type="email" id="signup-email" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="signup-password">Password</label>
                    <input type="password" id="signup-password" placeholder="Enter password">
                </div>
                 <button class="btn" onclick="signup()">Sign Up</button>
                  <div class="auth-toggle">
                    <a href="#" onclick="toggleAuthMode()">Already have an account? Login</a> |
                    <a href="#" onclick="showForgotPassword()">Forgot Password?</a>
                </div>
            </div>
             <div id="forgotForm" style="display: none;">
                <div class="form-group">
                    <label for="forgot-email">Enter your email</label>
                    <input type="email" id="forgot-email" placeholder="Email">
                </div>
                <button class="btn" onclick="sendPasswordReset()">Send Reset Link</button>
                 <div class="auth-toggle">
                    <a href="#" onclick="toggleAuthMode()">Back to Login</a>
                </div>
            </div>
        </div>
    </div>

     <!-- Profile Popup -->
    <div class="profile-popup" id="profilePopup">
        <div class="profile-header">
            <i class="fas fa-user-circle"></i>
            <h3>User Profile</h3>
        </div>
        <div class="profile-content">
            <div class="profile-info">
                <div class="info-item">
                    <strong>Name:</strong>
                    <span id="popup-name-display">Loading...</span>
                </div>
                <div class="info-item">
                    <strong>Rank:</strong>
                    <span id="popup-rank-display">Loading...</span>
                </div>
                 <div class="info-item">
                    <strong>Course:</strong>
                    <span id="popup-course-display">Loading...</span>
                </div>
                <div class="info-item">
                    <strong>Email:</strong>
                    <span id="popup-email-display">Loading...</span>
                </div>
            </div>
            <div class="edit-profile-section">
                <label for="edit-rank">Edit Rank:</label>
                <select id="edit-rank">
                     <!-- Populated dynamically -->
                </select>
                <button class="edit-profile-btn" onclick="updateOwnRank()">Update Rank</button>
            </div>
             <button class="btn" style="margin-top: 1rem;" onclick="logout()">Logout</button>
        </div>
    </div>

    <!-- User Interface -->
    <div class="user-interface" id="userInterface">
        <div class="container">
            <h2>Your Skills</h2>
            <div class="skill-grid" id="skill-grid">
                <!-- Skills loaded here by loadSkillGrid() -->
            </div>
        </div>
    </div>

    <!-- Skill Detail View -->
    <div class="skill-detail" id="skillDetail" style="display: none;">
        <div class="container">
            <button class="back-to-skills-btn" onclick="showSkillGrid()"><i class="fas fa-arrow-left"></i> Back to Skills</button>
            <div id="skill-detail-content">
                <!-- Content loaded here by loadSkillDetail() -->
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div class="admin-dashboard" id="adminDashboard">
        <div class="container">
            <div class="admin-header">
                <h1><i class="fas fa-tools"></i> Hand Skills Learning Platform - Admin Panel</h1>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
            <div class="admin-content">
                <div class="nav-panel">
                    <h3>Navigation</h3>
                    <div class="nav-item active" onclick="showSection('dashboard')">Dashboard</div>
                    <div class="nav-item" onclick="showSection('skills')">Manage Skills</div>
                    <div class="nav-item" onclick="showSection('users')">Manage Users</div>
                    <div class="nav-item" onclick="showSection('settings')">Settings</div>
                </div>
                <div class="main-content-area">
                    <!-- Dashboard Section -->
                    <div id="dashboard-section" class="section active">
                        <h2 class="section-title">Dashboard Overview</h2>
                        <p>Total Skills: <span id="total-skills-count">0</span></p>
                        <p>Total Users: <span id="total-users-count">0</span></p>
                        <p>Admin Users: <span id="admin-users-count">0</span></p>
                    </div>

                    <!-- Skills Management Section -->
                    <div id="skills-section" class="section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h2 class="section-title">Manage Skills</h2>
                            <button class="btn" onclick="addNewSkill()">Add New Skill</button>
                        </div>
                        <div class="skill-list" id="skillsList"></div>
                    </div>

                    <!-- Users Management Section -->
                    <div id="users-section" class="section">
                        <h2 class="section-title">Manage Users</h2>
                        <div id="usersContent"></div>
                    </div>

                    <!-- Settings Section -->
                    <div id="settings-section" class="section">
                        <h2 class="section-title">System Settings</h2>
                        <div class="settings-tabs">
                             <button class="tab-button active" data-tab="signupSettings">Signup Settings</button>
                            <button class="tab-button" data-tab="adminAccess">Admin Access</button>
                        </div>
                        <div id="signup-settings-content" class="tab-content active">
                             <div class="settings-controls">
                                <div class="control-group">
                                    <h3>Manage Ranks</h3>
                                     <div class="form-control">
                                        <label for="new-rank-input">Add New Rank:</label>
                                        <div style="display: flex; gap: 0.5rem;">
                                            <input type="text" id="new-rank-input" placeholder="e.g., ME7">
                                            <button class="btn btn-secondary" onclick="addRank()">Add</button>
                                        </div>
                                    </div>
                                    <div class="form-control">
                                        <label>Select Rank to Remove:</label>
                                         <select id="remove-rank-select">
                                            <!-- Populated dynamically -->
                                        </select>
                                        <button class="btn btn-secondary" onclick="removeRank()">Remove Selected</button>
                                    </div>
                                </div>
                                 <div class="control-group">
                                    <h3>Manage Courses</h3>
                                     <div class="form-control">
                                        <label for="new-course-input">Add New Course:</label>
                                        <div style="display: flex; gap: 0.5rem;">
                                            <input type="text" id="new-course-input" placeholder="e.g., 57th Tech">
                                            <button class="btn btn-secondary" onclick="addCourse()">Add</button>
                                        </div>
                                    </div>
                                    <div class="form-control">
                                        <label>Select Course to Remove:</label>
                                         <select id="remove-course-select">
                                           <!-- Populated dynamically -->
                                        </select>
                                        <button class="btn btn-secondary" onclick="removeCourse()">Remove Selected</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="admin-access-content" class="tab-content">
                             <div class="form-control">
                                <label for="admin-email">Grant Admin Access (Enter Email):</label>
                                <div style="display: flex; gap: 0.5rem;">
                                    <input type="email" id="admin-email" placeholder="user@example.com">
                                    <button class="btn" onclick="grantAdminAccess()">Grant Access</button>
                                </div>
                            </div>
                            <div id="adminList" style="margin-top: 1.5rem;">
                                <!-- Admin list loaded here by loadAdminList() -->
                            </div>
                        </div>
                    </div>

                     <!-- Edit Skill Form - MODIFIED: Removed 'section' class from main div -->
                    <div id="edit-skill-form" class="edit-form"> <!-- Removed 'section' class -->
                        <div class="edit-form-header">
                            <h2>Edit Skill</h2>
                            <button class="btn btn-secondary" onclick="cancelEdit()">Cancel</button>
                        </div>
                         <div class="edit-form-tabs">
                            <button class="tab-btn active" data-tab-target="edit-steps-tab-content">Steps</button>
                            <button class="tab-btn" data-tab-target="edit-quiz-tab-content">Quiz</button>
                        </div>
                        <div id="edit-steps-tab-content" class="tab-content-form active"> <!-- Added 'section' class here if needed for specific logic -->
                            <div class="form-group">
                                <label for="edit-skill-name">Skill Name</label>
                                <input type="text" id="edit-skill-name" placeholder="Enter skill name">
                            </div>
                            <div class="form-group">
                                <label for="edit-skill-image">Skill Image (Upload New)</label>
                                <input type="file" id="edit-skill-image" accept="image/*">
                                <p><em>Or use existing URL:</em></p>
                                <input type="text" id="edit-skill-image-url" placeholder="Image URL">
                            </div>
                             <div class="steps-container-form" id="steps-container">
                                <!-- Steps added here dynamically -->
                            </div>
                            <button class="add-step-btn" onclick="addEmptyStepForm()">+ Add Step</button>
                        </div>
                        <div id="edit-quiz-tab-content" class="tab-content-form"> <!-- Added 'section' class here if needed for specific logic -->
                            <div class="quiz-container-form" id="quiz-container">
                                <!-- Quiz questions added here dynamically -->
                            </div>
                            <button class="add-step-btn" onclick="addEmptyQuizQuestionForm()">+ Add Question</button>
                        </div>
                         <button class="btn" style="margin-top: 1.5rem;" onclick="saveSkill()">Save Skill</button>
                    </div>

                </div>
            </div>
        </div>
    </div>



    <!-- Confirmation Modals -->
     <!-- Revoke Admin Confirmation Modal -->
    <div id="confirmRevokeModal" class="modal">
        <div class="modal-content">
            <h3><i class="fas fa-exclamation-triangle"></i> Confirm Revoke Admin Access</h3>
            <p>Are you sure you want to revoke admin access? This action cannot be undone.</p>
             <div id="revoke-confirm-error" class="error-message"></div> <!-- Error display -->
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeConfirmRevokeModal()">Cancel</button>
                <button class="btn" style="background: var(--danger);" onclick="confirmRevokeAdminAccess()">Revoke</button>
            </div>
        </div>
    </div>

    <!-- Grant Admin Success Modal -->
    <div id="grantSuccessModal" class="modal">
        <div class="modal-content">
            <h3><i class="fas fa-check-circle" style="color: var(--success);"></i> Success</h3>
            <p id="grant-success-message">Admin access granted successfully!</p>
             <div class="modal-buttons">
                <button class="btn" onclick="closeGrantSuccessModal()">OK</button>
            </div>
             <div class="error-message" id="grant-success-error"></div>
        </div>
    </div>


    <!-- Scripts -->
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <!-- Firebase Authentication -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <!-- Firestore Database -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <!-- Firebase Storage -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>

    <script>
        // TODO: Replace with your Firebase project configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Global Variables
        let skillsData = [];
        let usersData = [];
        let currentEditingSkill = null;
        let currentUser = null;
        let originalEditingSkill = null; // Store original skill data
        let currentAuthMode = 'login'; // 'login', 'signup', 'forgot', 'profile'
        let editingUserId = null; // Track user being edited
        let isAdmin = false; // Track if current user is admin
        let ranksData = []; // Store ranks from Firestore
        let coursesData = []; // Store courses from Firestore
        let wasInAdminView = false; // Track if we were in admin view before switching
        // - NEW VARIABLES FOR REVOKE CONFIRMATION -
        let pendingRevokeAdminId = null;
        let pendingRevokeAdminEmail = null;


        // Initialize the app
        window.onload = function() {
            // Check if user is already logged in
            auth.onAuthStateChanged(user => {
                if (user) {
                    // User is logged in
                    loadUserData(user.uid);
                    // Hide the login button if user is logged in
                    document.getElementById('loginBtn').style.display = 'none';
                } else {
                    // User is not logged in
                    // Show user interface by default to load skills
                    document.getElementById('userInterface').style.display = 'block';
                    // Load skills for unauthenticated users if allowed by rules
                    // Otherwise, they'll see an empty grid until login
                    loadSkillsFromFirebase(); // Attempt to load, will handle permissions in the function or via Firestore rules
                    // Hide the login popup initially
                    document.getElementById('loginPopup').style.display = 'none';
                    // Show the login button
                    document.getElementById('loginBtn').style.display = 'block';
                }
            });

            // Load ranks and courses from Firestore
            loadRanksAndCourses();

             // Setup Firestore listeners to sync data in real-time - Moved here for initialization
            setupFirestoreListeners();

             // Set up tab switching for Settings
            document.querySelectorAll('.tab-button[data-tab]').forEach(button => {
                button.addEventListener('click', () => {
                    // Remove active class from all tab buttons and content
                    document.querySelectorAll('.tab-button[data-tab]').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('#signup-settings-content, #admin-access-content').forEach(content => content.classList.remove('active'));

                    // Add active class to clicked button
                    button.classList.add('active');

                    // Show corresponding content
                    const tabId = button.getAttribute('data-tab');
                    if (tabId === 'signupSettings') {
                        document.getElementById('signup-settings-content').classList.add('active');
                          // Load Signup Settings content specifically
                        loadSignupSettings();
                    } else if (tabId === 'adminAccess') {
                        document.getElementById('admin-access-content').classList.add('active');
                         // Load Admin Access content specifically
                        loadAdminList();
                    }
                });
            });

             // Set up tab switching for Edit Skill Form
            document.querySelectorAll('.tab-btn[data-tab-target]').forEach(button => {
                button.addEventListener('click', () => {
                    // Remove active from all
                    document.querySelectorAll('.tab-btn[data-tab-target]').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content-form').forEach(c => c.classList.remove('active'));

                    // Activate clicked tab
                    button.classList.add('active');

                    // Show selected content
                    const targetId = button.getAttribute('data-tab-target');
                    document.getElementById(targetId).classList.add('active');
                });
            });
        };



        // Setup Firestore listeners to sync data in real-time
        function setupFirestoreListeners() {
            // Listen for changes in skills collection
            db.collection("skills").onSnapshot((snapshot) => {
                skillsData = [];
                snapshot.forEach(doc => {
                    skillsData.push({ id: doc.id, ...doc.data() });
                });

                // - CORRECTED SORTING LOGIC -
                // Sort by 'order' field, handling potentially missing 'order' values gracefully
                // Assign a high default value (like Infinity) if 'order' is missing or null/undefined
                skillsData.sort((a, b) => {
                    const orderA = a.order !== undefined && a.order !== null ? a.order : Infinity;
                    const orderB = b.order !== undefined && b.order !== null ? b.order : Infinity;
                    return orderA - orderB;
                });
                // - END OF CORRECTION -

                updateCounters();

                // Update user interface if visible - CRITICAL FIX: Call loadSkillGrid here
                if (document.getElementById('userInterface').style.display === 'block') {
                    loadSkillGrid(); // This will now use the sorted skillsData
                }

                // Update admin list if currently viewing the skills section
                if (document.getElementById('skills-section').style.display === 'block') {
                    loadSkillsList(); // This will also use the sorted skillsData
                }
                 // Update dashboard if visible
                if (document.getElementById('dashboard-section').style.display === 'block') {
                     updateCounters(); // Just update counts, no list reload needed here
                }
            });

            // Listen for changes in users collection
            db.collection("users").onSnapshot((snapshot) => {
                usersData = [];
                snapshot.forEach(doc => {
                    usersData.push({ id: doc.id, ...doc.data() });
                });

                // Refresh user management section if currently active
                if (document.getElementById('users-section').style.display === 'block') {
                    loadUsersManagement();
                }
                 // Update dashboard if visible
                if (document.getElementById('dashboard-section').style.display === 'block') {
                     updateCounters(); // Just update counts, no list reload needed here
                }
            });

            // Listen for changes in admins collection
            db.collection("admins").onSnapshot((snapshot) => {
                 // Update dashboard if visible
                if (document.getElementById('dashboard-section').style.display === 'block') {
                     updateCounters(); // Just update counts, no list reload needed here
                }
                 // Refresh admin access section if currently active (only updates the list part)
                 // This might fire frequently, consider optimizing if needed
                 const activeTabButton = document.querySelector('.tab-button.active');
                 const activeTabId = activeTabButton ? activeTabButton.getAttribute('data-tab') : null;
                 if (activeTabId === 'adminAccess' && document.getElementById('settings-section').style.display === 'block') {
                      loadAdminList();
                 }
            });

            // Listen for changes in ranks collection
            db.collection("ranks").onSnapshot((snapshot) => {
                loadRanksAndCourses(); // Reload ranks and courses

                // Refresh signup settings section if currently active
                const activeTabButton = document.querySelector('.tab-button.active');
                const activeTabId = activeTabButton ? activeTabButton.getAttribute('data-tab') : null;
                if (activeTabId === 'signupSettings' && document.getElementById('settings-section').style.display === 'block') {
                    loadSignupSettings();
                }
            });

            // Listen for changes in courses collection
            db.collection("courses").onSnapshot((snapshot) => {
                loadRanksAndCourses(); // Reload ranks and courses

                // Refresh signup settings section if currently active
                 const activeTabButton = document.querySelector('.tab-button.active');
                const activeTabId = activeTabButton ? activeTabButton.getAttribute('data-tab') : null;
                if (activeTabId === 'signupSettings' && document.getElementById('settings-section').style.display === 'block') {
                    loadSignupSettings();
                }
            });
        } // <-- Closing brace for setupFirestoreListeners


        // Load user data from Firestore
        async function loadUserData(userId) {
            try {
                const userDoc = await db.collection("users").doc(userId).get();
                if (userDoc.exists) {
                    currentUser = userDoc.data();
                    currentUser.id = userId;

                    // Check if user is admin
                    const adminDoc = await db.collection("admins").doc(userId).get();
                    if (adminDoc.exists) {
                        isAdmin = true;
                        // Show admin dashboard
                        document.getElementById('adminDashboard').style.display = 'block';
                        document.getElementById('userInterface').style.display = 'none'; // Hide user interface
                        document.getElementById('profileBtn').style.display = 'block';
                        document.getElementById('adminSwitchBtn').style.display = 'block';
                        document.getElementById('adminBackBtn').style.display = 'none';
                        // Initially show dashboard
                        showSection('dashboard'); // CRITICAL FIX: Moved here and made explicit call
                    } else {
                        isAdmin = false;
                        // Show user interface
                        document.getElementById('userInterface').style.display = 'block';
                        document.getElementById('adminDashboard').style.display = 'none';
                        document.getElementById('profileBtn').style.display = 'block';
                        document.getElementById('adminSwitchBtn').style.display = 'none'; // Hide admin switch for non-admins
                        document.getElementById('adminBackBtn').style.display = 'none';
                        // Load skills for user view - This should ideally happen via the skills listener now
                        // loadSkillsFromFirebase(); // Not strictly needed if listener handles it, but ensure grid loads
                         if (document.getElementById('userInterface').style.display === 'block') {
                            loadSkillGrid(); // Load skills grid for user
                        }
                    }

                    // Update profile popup with user data
                    if (currentUser) {
                        document.getElementById('popup-name-display').textContent = currentUser.name || 'N/A';
                        document.getElementById('popup-rank-display').textContent = currentUser.rank || 'N/A';
                        document.getElementById('popup-course-display').textContent = currentUser.course || 'N/A';
                        document.getElementById('popup-email-display').textContent = currentUser.email || 'N/A';
                        // Update rank dropdown in popup
                        updateDropdowns();
                    }

                } else {
                    console.error("User document does not exist!");
                    // Handle case where user exists in Auth but not in Firestore
                    // Maybe redirect to profile completion?
                }
            } catch (error) {
                console.error("Error loading user data: ", error);
            }
        }


        // Show different sections in admin panel
        function showSection(section) {
            // Hide all sections (those with class 'section')
            document.querySelectorAll('.section').forEach(el => el.style.display = 'none');

            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));

            // Show selected section and highlight nav item
            document.getElementById(`${section}-section`).style.display = 'block';
            document.querySelector(`.nav-item[onclick="showSection('${section}')"]`).classList.add('active');

            if (section === 'dashboard') {
                updateCounters();
            }

            // IMPORTANT: Always reload skills list when showing skills section
            if (section === 'skills') {
                loadSkillsList(); // Use the modified function
            }

            // Load users management when showing users section
            if (section === 'users') {
                loadUsersManagement();
            }

            // Load settings content when showing settings section
            if (section === 'settings') {
                 // Load the active settings tab content
                 const activeTabButton = document.querySelector('.tab-button.active');
                 const activeTabId = activeTabButton ? activeTabButton.getAttribute('data-tab') : 'signupSettings'; // Default to signup settings
                 if (activeTabId === 'signupSettings') {
                     loadSignupSettings();
                 } else if (activeTabButton && activeTabId === 'adminAccess') { // Check activeTabButton exists before accessing its properties
                     loadAdminList();
                 }
            }
        }


        // Update dashboard counters
        function updateCounters() {
            document.getElementById('total-skills-count').textContent = skillsData.length;

            const totalUsers = usersData.length;
            document.getElementById('total-users-count').textContent = totalUsers;

            // Count admins - This requires fetching the admins collection snapshot
            // More efficient to keep a count updated by the listener
            let adminCount = 0;
             db.collection("admins").get().then(snapshot => {
                 adminCount = snapshot.size;
                 document.getElementById('admin-users-count').textContent = adminCount;
             }).catch(error => {
                 console.error("Error getting admin count: ", error);
                 // Fallback to approximate count if needed
                 // document.getElementById('admin-users-count').textContent = "Err";
             });
        }


        // Load skills list in admin panel - MODIFIED TO USE GRID LAYOUT WITH EDIT/DELETE/REORDER BUTTONS
        // Uses the globally managed skillsData array, sorted by 'order'
        async function loadSkillsList() {
            const skillsList = document.getElementById('skillsList');
            skillsList.innerHTML = '';

            // The global skillsData array is already sorted by 'order' via the onSnapshot listener.

            skillsData.forEach((skill, index) => {
                const skillItem = document.createElement('div');
                skillItem.className = 'skill-item';
                skillItem.innerHTML = `
                    <div class="skill-item-info">
                        <strong>${skill.name}</strong>
                    </div>
                    <div class="skill-item-actions">
                        <div class="skill-order-controls">
                             <button class="btn btn-secondary" onclick="moveSkillUp('${skill.id}')" ${index === 0 ? 'disabled' : ''}></button>
                            <button class="btn btn-secondary" onclick="moveSkillDown('${skill.id}')" ${index === skillsData.length - 1 ? 'disabled' : ''}></button>
                        </div>
                        <button class="btn btn-secondary" onclick="editSkill('${skill.id}')">Edit</button>
                        <button class="btn" style="background: var(--danger);" onclick="deleteSkill('${skill.id}', '${skill.name}')">Delete</button>
                    </div>
                `;
                skillsList.appendChild(skillItem);
            });
        }


         // Move skill up in order
        async function moveSkillUp(skillId) {
             try {
                // Find the current index of the skill in the sorted array
                const currentIndex = skillsData.findIndex(s => s.id === skillId);

                // Check if it's already at the top (has the lowest order value among existing ones)
                // Or if the skill is not found in the array
                if (currentIndex <= 0) {
                    console.log("Skill is already at the top or not found, cannot move up.");
                    return; // Do nothing if it's the first item or not found
                }

                // Find the skill immediately preceding it in the sorted list (which has the target lower order)
                const previousSkill = skillsData[currentIndex - 1];
                if (!previousSkill) {
                    console.error("Previous skill not found in skillsData.");
                    return;
                }
                const targetSkillId = previousSkill.id;

                // Get current orders
                const currentOrder = skillsData[currentIndex].order !== undefined ? skillsData[currentIndex].order : Infinity;
                const targetOrder = skillsData[currentIndex - 1].order !== undefined ? skillsData[currentIndex - 1].order : Infinity;

                 // Calculate new order for current skill (should be between the one before the target and the target)
                // A simple approach: swap the 'order' values.
                // More robust: insert current skill's order between the order before the target and the target's order.
                // Swapping is simpler for adjacent moves.
                const updatedCurrentData = { order: targetOrder };
                const updatedTargetData = { order: currentOrder };

                // Perform the updates in a batch write for atomicity
                const batch = db.batch();
                batch.update(db.collection("skills").doc(skillId), updatedCurrentData);
                batch.update(db.collection("skills").doc(targetSkillId), updatedTargetData);
                await batch.commit();

                console.log("Skill moved up successfully");
                // The onSnapshot listener will automatically update skillsData and trigger loadSkillsList
                // So reloading here might be redundant, but explicitly calling it ensures UI update
                // Only reload if the current view is the skills section
                if (document.getElementById('skills-section').style.display === 'block') {
                    loadSkillsList(); // Reload the admin panel list
                }
                // Potentially reload user interface list too if it's visible
                 if (document.getElementById('userInterface').style.display === 'block') {
                    loadSkillGrid(); // Reload the user interface grid
                }
            } catch (error) {
                console.error("Error moving skill up: ", error);
            }
        }


        // Move skill down in order
        async function moveSkillDown(skillId) {
             try {
                // Find the current index of the skill in the sorted array
                const currentIndex = skillsData.findIndex(s => s.id === skillId);

                // Check if it's already at the bottom (has the highest order value among existing ones)
                // Or if the skill is not found in the array
                if (currentIndex === -1 || currentIndex >= skillsData.length - 1) {
                    console.log("Skill is already at the bottom or not found, cannot move down.");
                    return; // Do nothing if it's the last item or not found
                }

                // Find the skill immediately succeeding it in the sorted list (which has the target higher order)
                const nextSkill = skillsData[currentIndex + 1];
                if (!nextSkill) {
                    console.error("Next skill not found in skillsData.");
                    return;
                }
                const targetSkillId = nextSkill.id;

                 // Get current orders
                const currentOrder = skillsData[currentIndex].order !== undefined ? skillsData[currentIndex].order : Infinity;
                const targetOrder = skillsData[currentIndex + 1].order !== undefined ? skillsData[currentIndex + 1].order : Infinity;

                 // Calculate new order for current skill (should be between the target and the one after the target)
                // Swapping the 'order' values is simpler for adjacent moves.
                const updatedCurrentData = { order: targetOrder };
                const updatedTargetData = { order: currentOrder };

                 // Perform the updates in a batch write for atomicity
                const batch = db.batch();
                batch.update(db.collection("skills").doc(skillId), updatedCurrentData);
                batch.update(db.collection("skills").doc(targetSkillId), updatedTargetData);
                await batch.commit();

                console.log("Skill moved down successfully");
                // The onSnapshot listener will automatically update skillsData and trigger loadSkillsList
                // So reloading here might be redundant, but explicitly calling it ensures UI update
                // Only reload if the current view is the skills section
                if (document.getElementById('skills-section').style.display === 'block') {
                    loadSkillsList(); // Reload the admin panel list
                }
                 // Potentially reload user interface list too if it's visible
                  if (document.getElementById('userInterface').style.display === 'block') {
                    loadSkillGrid(); // Reload the user interface grid
                }
            } catch (error) {
                console.error("Error moving skill down: ", error);
            }
        }


        // Edit skill function
        function editSkill(skillId) {
            const skill = skillsData.find(s => s.id === skillId);
            if (!skill) {
                 alert('Skill not found for editing.');
                 return;
            }
            currentEditingSkill = JSON.parse(JSON.stringify(skill)); // Deep copy
            originalEditingSkill = JSON.parse(JSON.stringify(skill)); // Store original for cancellation

            document.getElementById('edit-skill-name').value = currentEditingSkill.name || '';
            document.getElementById('edit-skill-image-url').value = currentEditingSkill.imageUrl || '';

            // Clear and populate steps
            const stepsContainer = document.getElementById('steps-container');
            stepsContainer.innerHTML = '';
            if (Array.isArray(currentEditingSkill.steps)) {
                currentEditingSkill.steps.forEach((step, index) => {
                    addStepToForm(index, step);
                });
            }

            // Clear and populate quiz
            const quizContainer = document.getElementById('quiz-container');
            quizContainer.innerHTML = '';
            if (Array.isArray(currentEditingSkill.quiz)) {
                currentEditingSkill.quiz.forEach((question, index) => {
                    addQuizQuestionToForm(index, question);
                });
            }

            // Show form - CRITICAL FIX: Do NOT add 'section' class to this element anymore
            // The showSection function hides elements with class 'section'.
            // This form now uses its own display logic and is positioned fixed.
            document.getElementById('edit-skill-form').style.display = 'block'; // Use block or flex depending on your layout needs
            // Hiding other sections is handled by showSection when navigating main tabs.
            // We don't want the main sections to interfere with this specific form.
        }


        // Add step to form
        function addStepToForm(index, step = null) {
            const stepsContainer = document.getElementById('steps-container');
            const stepId = index !== undefined ? index : (currentEditingSkill.steps ? currentEditingSkill.steps.length : 0);
            const stepObj = step || { title: '', description: '', image: '' };
            const stepElement = document.createElement('div');
            stepElement.className = 'step-form-item';
            stepElement.innerHTML = `
                <h4>Step ${stepId + 1}</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" value="${stepObj.title}" onchange="updateStepValue(${stepId}, 'title', this.value)">
                    </div>
                    <div class="form-group">
                        <label>Image URL</label>
                        <input type="text" value="${stepObj.image}" onchange="updateStepValue(${stepId}, 'image', this.value)">
                    </div>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea rows="3" onchange="updateStepValue(${stepId}, 'description', this.value)">${stepObj.description}</textarea>
                </div>
                <button class="remove-step-btn" onclick="removeStepFromForm(${stepId})">Remove Step</button>
            `;
            stepsContainer.appendChild(stepElement);
        }

         // Add empty step to form (for adding new)
        function addEmptyStepForm() {
             if (!currentEditingSkill.steps) {
                currentEditingSkill.steps = [];
            }
            const newIndex = currentEditingSkill.steps.length;
            addStepToForm(newIndex); // Pass undefined index to let function calculate
        }


        // Add quiz question to form
        function addQuizQuestionToForm(index, question = null) {
             const quizContainer = document.getElementById('quiz-container');
            const qIndex = index !== undefined ? index : (currentEditingSkill.quiz ? currentEditingSkill.quiz.length : 0);
            const qObj = question || { question: '', options: ['', '', '', ''], correctAnswerIndex: 0 };
            const questionElement = document.createElement('div');
            questionElement.className = 'quiz-form-item';
            questionElement.innerHTML = `
                <h4>Question ${qIndex + 1}</h4>
                <div class="form-group">
                    <label>Question Text</label>
                    <input type="text" value="${qObj.question || ''}" onchange="updateQuizValue(${qIndex}, 'question', this.value)">
                </div>
                <div class="form-group">
                    <label>Options (Enter 4 options)</label>
                    ${qObj.options.map((opt, optIdx) => `
                        <input type="text" value="${opt || ''}" onchange="updateQuizOptionValue(${qIndex}, ${optIdx}, this.value)" placeholder="Option ${optIdx + 1}">
                    `).join('')}
                </div>
                <div class="form-group">
                    <label>Correct Answer Index (0-3)</label>
                    <input type="number" min="0" max="3" value="${qObj.correctAnswerIndex || 0}" onchange="updateQuizValue(${qIndex}, 'correctAnswerIndex', parseInt(this.value))">
                </div>
                <button class="remove-question-btn" onclick="removeQuizQuestionFromForm(${qIndex})">Remove Question</button>
            `;
            quizContainer.appendChild(questionElement);
        }

         // Add empty quiz question to form (for adding new)
        function addEmptyQuizQuestionForm() {
             if (!currentEditingSkill.quiz) {
                currentEditingSkill.quiz = [];
            }
            const newIndex = currentEditingSkill.quiz.length;
            addQuizQuestionToForm(newIndex); // Pass undefined index to let function calculate
        }


        // Update step value in currentEditingSkill object
        function updateStepValue(index, field, value) {
            if (!currentEditingSkill.steps) currentEditingSkill.steps = [];
            if (!currentEditingSkill.steps[index]) currentEditingSkill.steps[index] = {};
            currentEditingSkill.steps[index][field] = value;
        }

         // Update quiz question value in currentEditingSkill object
        function updateQuizValue(index, field, value) {
            if (!currentEditingSkill.quiz) currentEditingSkill.quiz = [];
            if (!currentEditingSkill.quiz[index]) currentEditingSkill.quiz[index] = { options: ['', '', '', ''] };
            currentEditingSkill.quiz[index][field] = value;
        }

         // Update quiz option value
        function updateQuizOptionValue(questionIndex, optionIndex, value) {
             if (!currentEditingSkill.quiz) currentEditingSkill.quiz = [];
            if (!currentEditingSkill.quiz[questionIndex]) currentEditingSkill.quiz[questionIndex] = { options: ['', '', '', ''] };
            if (!Array.isArray(currentEditingSkill.quiz[questionIndex].options)) {
                 currentEditingSkill.quiz[questionIndex].options = ['', '', '', ''];
            }
            currentEditingSkill.quiz[questionIndex].options[optionIndex] = value;
        }


        // Remove step from form and data
        function removeStepFromForm(index) {
             if (currentEditingSkill.steps && currentEditingSkill.steps[index] !== undefined) {
                currentEditingSkill.steps.splice(index, 1);
                // Re-render the entire steps container to reflect removal and re-indexing
                const stepsContainer = document.getElementById('steps-container');
                stepsContainer.innerHTML = '';
                 if (Array.isArray(currentEditingSkill.steps)) {
                    currentEditingSkill.steps.forEach((step, i) => {
                        addStepToForm(i, step); // Re-add with new indices
                    });
                }
            }
        }

          // Remove quiz question from form and data
        function removeQuizQuestionFromForm(index) {
             if (currentEditingSkill.quiz && currentEditingSkill.quiz[index] !== undefined) {
                currentEditingSkill.quiz.splice(index, 1);
                // Re-render the entire quiz container to reflect removal and re-indexing
                const quizContainer = document.getElementById('quiz-container');
                quizContainer.innerHTML = '';
                 if (Array.isArray(currentEditingSkill.quiz)) {
                    currentEditingSkill.quiz.forEach((question, i) => {
                        addQuizQuestionToForm(i, question); // Re-add with new indices
                    });
                }
            }
        }


        // Cancel edit and restore original data
        function cancelEdit() {
            // Restore original skill data
            currentEditingSkill = JSON.parse(JSON.stringify(originalEditingSkill));

            // Hide form
            document.getElementById('edit-skill-form').style.display = 'none';

            // Potentially re-show the skills list if that was the previous view before editing
            // For simplicity, we rely on the user clicking back to the skills section.
            // The data will be restored if they re-edit.
        }


        // Save skill function
        async function saveSkill() {
            if (!currentEditingSkill) {
                 alert('No skill is currently being edited.');
                 return;
            }

            const skillRef = db.collection("skills").doc(currentEditingSkill.id);

            // Prepare update data
            const updateData = {
                name: document.getElementById('edit-skill-name').value,
                // Keep the existing imageUrl unless a new file is uploaded
                // Image upload logic would go here if implemented
                // For now, assume URL is entered or kept as is
                imageUrl: document.getElementById('edit-skill-image-url').value || currentEditingSkill.imageUrl,
                steps: currentEditingSkill.steps || [],
                quiz: currentEditingSkill.quiz || []
                // 'order' field is managed separately by moveSkillUp/Down
            };

             // Handle skill image upload if a new file is selected
            const skillImageFile = document.getElementById('edit-skill-image').files[0]; // This gets the file object
            if (skillImageFile) { // If a new file is selected
                console.log("Uploading new skill image...");
                try {
                    const timestamp = new Date().getTime();
                    const filePath = `skill_images/${currentEditingSkill.id}_${timestamp}_${skillImageFile.name}`;
                    const uploadTask = storage.ref(filePath).put(skillImageFile);

                    // Wait for the upload to complete and get the download URL
                    const downloadURL = await new Promise((resolve, reject) => {
                        uploadTask.on(
                            'state_changed',
                            null, // Progress callback can be added
                            (error) => {
                                console.error("Upload error:", error);
                                reject(error);
                            },
                            () => {
                                // Upload completed successfully, now get the download URL
                                uploadTask.snapshot.ref.getDownloadURL().then((url) => {
                                    console.log("File available at", url);
                                    resolve(url);
                                });
                            }
                        );
                    });

                    // Update the image URL in the data to be saved
                    updateData.imageUrl = downloadURL;
                    console.log("Updated image URL to:", downloadURL);

                } catch (uploadError) {
                    console.error("Error uploading skill image: ", uploadError);
                    alert("Error uploading image. Please try again. Skill not saved.");
                    return; // Stop saving if image upload fails
                }
            } else {
                 console.log("No new image file selected, keeping existing URL or input URL.");
                 // The updateData.imageUrl is already set from the input field or original data above.
            }


            try {
                await skillRef.update(updateData);
                alert('Skill updated successfully!');
                // Reset the file input after successful save
                document.getElementById('edit-skill-image').value = '';
                // Clear the temporary URL input if it was used just for this save
                // document.getElementById('edit-skill-image-url').value = ''; // Keep this if user might want to reuse the URL field

                // Close the edit form
                cancelEdit(); // This also resets currentEditingSkill

                 // The onSnapshot listener will automatically update the UI

            } catch (error) {
                console.error("Error saving skill: ", error);
                alert('Error saving skill: ' + error.message);
            }
        }


        // Delete skill function
        async function deleteSkill(skillId, skillName) {
            if (!confirm(`Are you sure you want to delete the skill "${skillName}"?`)) {
                return; // Exit if user cancels
            }
            try {
                await db.collection("skills").doc(skillId).delete();
                console.log("Skill successfully deleted!");
                 // The onSnapshot listener will automatically update skillsData and trigger loadSkillsList
                // So explicitly reloading here is usually redundant unless you need immediate visual feedback
                 if (document.getElementById('skills-section').style.display === 'block') {
                    loadSkillsList(); // Reload the admin panel list
                }
                 if (document.getElementById('userInterface').style.display === 'block') {
                    loadSkillGrid(); // Reload the user interface grid
                }
                 // Update dashboard counts
                 if (document.getElementById('dashboard-section').style.display === 'block') {
                     updateCounters();
                }
            } catch (error) {
                console.error("Error removing skill: ", error);
                alert('Error deleting skill: ' + error.message);
            }
        }


        // Add new skill function (initialize empty skill)
        function addNewSkill() {
             // Create a temporary ID for the new skill object
            const tempId = Date.now().toString(); // Simple unique ID generation
            currentEditingSkill = {
                id: tempId,
                name: '',
                imageUrl: '',
                steps: [],
                quiz: [],
                order: skillsData.length // Set initial order to the end of the current list
            };
            originalEditingSkill = JSON.parse(JSON.stringify(currentEditingSkill)); // Store original for cancellation

             // Clear form fields
            document.getElementById('edit-skill-name').value = '';
            document.getElementById('edit-skill-image-url').value = '';

            // Clear and populate steps (empty)
            const stepsContainer = document.getElementById('steps-container');
            stepsContainer.innerHTML = '';
            // Clear and populate quiz (empty)
            const quizContainer = document.getElementById('quiz-container');
            quizContainer.innerHTML = '';

            // Show form
            document.getElementById('edit-skill-form').style.display = 'block';
            // The saveSkill function will handle creating the document in Firestore
        }


         // Load users management in admin panel
        function loadUsersManagement() {
            const usersContent = document.getElementById('usersContent');
            usersContent.innerHTML = '';

            // Group users by course
            const courses = {};
            usersData.forEach(user => {
                if (!courses[user.course]) {
                    courses[user.course] = [];
                }
                courses[user.course].push(user);
            });

            // Render each course group
            Object.keys(courses).forEach(course => {
                const courseGroup = document.createElement('div');
                courseGroup.className = 'course-group';
                courseGroup.innerHTML = `
                    <h3 class="course-title">${course}</h3>
                    <div class="user-list">
                        ${courses[course].map(user => `
                            <div class="user-card">
                                <h4>${user.name}</h4>
                                <p><strong>Rank:</strong> ${user.rank}</p>
                                <p><strong>Email:</strong> ${user.email}</p>
                                <div class="user-actions">
                                    <button class="btn btn-secondary" onclick="editUser('${user.id}')">Edit Details</button>
                                    <button class="btn" style="background: var(--warning);" onclick="resetUserProgress('${user.id}', '${user.name}')">Reset Progress</button>
                                    <button class="btn" style="background: var(--danger);" onclick="deleteUser('${user.id}', '${user.name}', '${user.email}')">Delete User</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                usersContent.appendChild(courseGroup);
            });
        }


        // Edit user details (placeholder function)
        function editUser(userId) {
             editingUserId = userId; // Track which user is being edited
             // Find the user object
             const user = usersData.find(u => u.id === userId);
             if (!user) {
                alert('User not found for editing.');
                return;
             }

             // Prompt for new details (could be a modal/form)
             const newName = prompt('Enter new name:', user.name);
             const newRank = prompt('Enter new rank:', user.rank);
             const newCourse = prompt('Enter new course:', user.course);

             if (newName !== null && newRank !== null && newCourse !== null) { // User did not cancel
                  // Validate or process inputs if necessary (e.g., trim, convert name to uppercase)
                  const processedName = newName.trim().toUpperCase(); // Auto-convert to uppercase as per requirement
                  const processedRank = newRank.trim();
                  const processedCourse = newCourse.trim();

                  // Update in Firestore
                  db.collection("users").doc(userId).update({
                       name: processedName,
                       rank: processedRank,
                       course: processedCourse
                  }).then(() => {
                      alert('User details updated successfully!');
                      // The onSnapshot listener will automatically update the UI
                  }).catch(error => {
                      console.error("Error updating user: ", error);
                      alert('Error updating user: ' + error.message);
                  });
             }
              editingUserId = null; // Clear tracking
        }


         // Reset user progress (placeholder function)
        async function resetUserProgress(userId, userName) {
             if (!confirm(`Are you sure you want to reset progress for user "${userName}"?`)) {
                return; // Exit if user cancels
            }
            try {
                await db.collection("users").doc(userId).update({
                    completedSkills: []
                });
                alert(`Progress for "${userName}" has been reset.`);
                 // The onSnapshot listener will automatically update the UI
            } catch (error) {
                console.error("Error resetting user progress: ", error);
                alert('Error resetting progress: ' + error.message);
            }
        }


         // Delete user function
        async function deleteUser(userId, userName, userEmail) {
             if (!confirm(`Are you sure you want to delete the user "${userName}" (${userEmail})? This action cannot be undone.`)) {
                return; // Exit if user cancels
            }
            try {
                // Delete user document from 'users' collection
                await db.collection("users").doc(userId).delete();

                // Attempt to remove user from 'admins' collection if they were an admin
                try {
                    await db.collection("admins").doc(userId).delete();
                    console.log("User was an admin, admin access revoked during deletion.");
                } catch (adminRemovalError) {
                    // It's okay if the user wasn't an admin, the error 'not-found' is expected in that case.
                    if (adminRemovalError.code !== 'not-found') {
                         console.error("Error removing user from admins during deletion: ", adminRemovalError);
                         // Depending on requirements, you might want to show an error here,
                         // but often silently ignoring a 'not-found' for admin status is fine.
                    }
                }

                alert(`User "${userName}" has been deleted successfully.`);

                // The onSnapshot listener for users will automatically update the UI
                 if (document.getElementById('users-section').style.display === 'block') {
                    loadUsersManagement(); // Reload the user list if currently viewing
                }
                 // Update dashboard counts
                 if (document.getElementById('dashboard-section').style.display === 'block') {
                     updateCounters();
                }

            } catch (error) {
                console.error("Error deleting user: ", error);
                alert('Error deleting user: ' + error.message);
            }
        }


        // Load skill grid for user interface
        function loadSkillGrid() {
            const gridElement = document.getElementById('skill-grid');
            // Clear previous content
            gridElement.innerHTML = '';

            skillsData.forEach(skill => {
                // Check if user has completed this skill
                const isCompleted = currentUser && currentUser.completedSkills && currentUser.completedSkills.includes(skill.id);
                const statusText = isCompleted ? 'Completed' : 'Not Started';
                const statusClass = isCompleted ? 'skill-completed' : 'skill-not-completed';

                const skillCard = document.createElement('div');
                skillCard.className = 'skill-card-ui';
                skillCard.onclick = () => loadSkillDetail(skill.id); // Use arrow function for correct 'this' binding if needed inside
                skillCard.innerHTML = `
                    <div class="skill-icon">
                        <img src="${skill.imageUrl || 'https://placehold.co/250x150?text=No+Image'}" alt="${skill.name}">
                    </div>
                    <div class="skill-content">
                        <h3 class="skill-name">${skill.name}</h3>
                        <p class="${statusClass}">${statusText}</p>
                    </div>
                `;
                gridElement.appendChild(skillCard);
            });
        }


        // Load skill detail view
        async function loadSkillDetail(skillId) {
            const skill = skillsData.find(s => s.id === skillId);
            if (!skill) {
                 // Handle skill not found
                 document.getElementById('skill-detail-content').innerHTML = '<p>Skill not found.</p>';
                 document.getElementById('skillDetail').style.display = 'block';
                 document.getElementById('userInterface').style.display = 'none';
                 return;
            }

            let html = `<div class="skill-header">
                            <img src="${skill.imageUrl || 'https://placehold.co/100x100?text=No+Image'}" alt="${skill.name}">
                            <div>
                                <h2>${skill.name}</h2>
                                ${currentUser && currentUser.completedSkills && currentUser.completedSkills.includes(skillId) ?
                                    '<p style="color: green; font-weight: bold;">Status: Completed</p>' :
                                    '<p style="color: orange;">Status: In Progress / Not Started</p>'
                                }
                            </div>
                        </div>`;

            // Add steps
            if (skill.steps && skill.steps.length > 0) {
                html += `<div class="steps-container"><h3>Steps</h3>`;
                skill.steps.forEach(step => {
                    html += `<div class="step-card">
                                <div class="step-image"><img src="${step.image || 'https://placehold.co/250x200?text=No+Image'}" alt="${step.title}"></div>
                                <div class="step-title">${step.title}</div>
                                <div class="step-description">${step.description}</div>
                             </div>`;
                });
                html += `</div>`;
            }

            // Add quiz
            if (skill.quiz && skill.quiz.length > 0) {
                html += `<div class="quiz-container"><h3>Knowledge Check</h3>`;
                skill.quiz.forEach((q, index) => {
                    html += `<div class="quiz-question">
                                <div class="quiz-question-text">${index + 1}. ${q.question}</div>
                                <div class="quiz-options">
                                    ${q.options.map((opt, optIdx) => `<label><input type="radio" name="quiz-q${index}" value="${optIdx}"> ${opt}</label>`).join('')}
                                </div>
                             </div>`;
                });
                html += `</div>`;
            }

            // Add complete button if not already completed
            if (!(currentUser && currentUser.completedSkills && currentUser.completedSkills.includes(skillId))) {
                 html += `<button class="complete-skill-btn" onclick="markSkillComplete('${skillId}')">Mark as Complete</button>`;
            }

            document.getElementById('skill-detail-content').innerHTML = html;
            document.getElementById('skillDetail').style.display = 'block';
            document.getElementById('userInterface').style.display = 'none';
        }


        // Mark skill as complete
        async function markSkillComplete(skillId) {
            if (!currentUser || !currentUser.id) {
                 alert('You must be logged in to complete a skill.');
                 return;
            }
            try {
                const userRef = db.collection("users").doc(currentUser.id);
                // Atomically add the skill ID to the completedSkills array
                await userRef.update({
                    completedSkills: firebase.firestore.FieldValue.arrayUnion(skillId)
                });

                // Optimistically update the local currentUser object
                if (!currentUser.completedSkills) {
                     currentUser.completedSkills = [];
                }
                if (!currentUser.completedSkills.includes(skillId)) {
                    currentUser.completedSkills.push(skillId);
                }

                 // Reload the detail view to show the new status, or just update the status text
                 // For simplicity, just reload the detail view
                 loadSkillDetail(skillId);

                 console.log("Skill marked as complete!");

            } catch (error) {
                console.error("Error marking skill complete: ", error);
                alert('Error completing skill: ' + error.message);
            }
        }


        // Show skill grid view
        function showSkillGrid() {
             document.getElementById('skillDetail').style.display = 'none';
            document.getElementById('userInterface').style.display = 'block';
            // Optionally, reload the grid if data might have changed (though listener should handle it)
            // loadSkillGrid();
        }


        // Switch to user interface (from admin)
        function switchToUserInterface() {
            wasInAdminView = true;
            document.getElementById('adminDashboard').style.display = 'none';
            document.getElementById('userInterface').style.display = 'block';
            document.getElementById('adminSwitchBtn').style.display = 'none';
            document.getElementById('adminBackBtn').style.display = 'block';
            // Load skills for user view - Should be handled by listener, but ensure grid loads
             if (document.getElementById('userInterface').style.display === 'block') {
                loadSkillGrid(); // Load skills grid for user
            }
        }


        // Switch to admin interface (from user)
        function switchToAdminInterface() {
            wasInAdminView = false;
            document.getElementById('userInterface').style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'block';
            document.getElementById('adminSwitchBtn').style.display = 'block';
            document.getElementById('adminBackBtn').style.display = 'none';
            // Show dashboard by default when switching to admin view
             showSection('dashboard');
        }


        // Logout function
        function logout() {
            auth.signOut().then(() => {
                currentUser = null;
                isAdmin = false;
                // Hide interfaces
                document.getElementById('adminDashboard').style.display = 'none';
                document.getElementById('userInterface').style.display = 'none'; // Also hide user interface
                document.getElementById('skillDetail').style.display = 'none'; // Hide detail view
                document.getElementById('profilePopup').style.display = 'none';
                // Hide profile/admin buttons
                document.getElementById('profileBtn').style.display = 'none';
                document.getElementById('adminSwitchBtn').style.display = 'none';
                document.getElementById('adminBackBtn').style.display = 'none';
                // Hide the login popup if it happens to be open
                document.getElementById('loginPopup').style.display = 'none';
                // Show the login button again after logging out
                document.getElementById('loginBtn').style.display = 'block';
                // Clear any ongoing edits
                currentEditingSkill = null;
                originalEditingSkill = null;
                editingUserId = null;
                // Optionally reload skills for unauthenticated view
                 loadSkillsFromFirebase();
            }).catch(error => {
                console.error("Error signing out: ", error);
            });
        }


        // Toggle Profile Popup
        function toggleProfilePopup() {
             const popup = document.getElementById('profilePopup');
             // Close if open, otherwise open
             if (popup.style.display === 'block') {
                popup.style.display = 'none';
             } else {
                  // Update profile data first (in case it changed elsewhere)
                   if (currentUser) {
                        document.getElementById('popup-name-display').textContent = currentUser.name || 'N/A';
                        document.getElementById('popup-rank-display').textContent = currentUser.rank || 'N/A';
                        document.getElementById('popup-course-display').textContent = currentUser.course || 'N/A';
                        document.getElementById('popup-email-display').textContent = currentUser.email || 'N/A';
                        // Update rank dropdown in popup
                        updateDropdowns();
                    }
                 popup.style.display = 'block';
             }
        }


        // Update own rank in profile popup
        async function updateOwnRank() {
            const newRank = document.getElementById('edit-rank').value;
            if (!newRank) {
                alert('Please select a rank');
                return;
            }
            try {
                await db.collection("users").doc(currentUser.id).update({
                    rank: newRank
                });

                currentUser.rank = newRank;
                document.getElementById('popup-rank-display').textContent = newRank;
                // Update dropdown in popup
                updateDropdowns();
                alert('Rank updated successfully!');
                 // The onSnapshot listener will automatically update the UI if necessary
            } catch (error) {
                console.error("Error updating rank: ", error);
                alert('Error updating rank: ' + error.message);
            }
        }


         // Update dropdowns in profile and signup forms
        function updateDropdowns() {
             const profilePopupRankSelect = document.getElementById('edit-rank');
             const signupRankSelect = document.getElementById('signup-rank');
             const signupCourseSelect = document.getElementById('signup-course');
             const removeRankSelect = document.getElementById('remove-rank-select');
             const removeCourseSelect = document.getElementById('remove-course-select');

             // Clear existing options
             [profilePopupRankSelect, signupRankSelect, removeRankSelect].forEach(select => {
                 if (select) select.innerHTML = '';
             });
             [signupCourseSelect, removeCourseSelect].forEach(select => {
                 if (select) select.innerHTML = '';
             });


             // Populate Ranks
             ranksData.forEach(rank => {
                const option1 = document.createElement('option');
                option1.value = rank.name;
                option1.textContent = rank.name;
                if (currentUser && rank.name === currentUser.rank) {
                    option1.selected = true;
                }
                if(profilePopupRankSelect) profilePopupRankSelect.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = rank.name;
                option2.textContent = rank.name;
                 if(signupRankSelect) signupRankSelect.appendChild(option2);

                 const option3 = document.createElement('option');
                option3.value = rank.name;
                option3.textContent = rank.name;
                 if(removeRankSelect) removeRankSelect.appendChild(option3);
            });

             // Populate Courses
             coursesData.forEach(course => {
                const option1 = document.createElement('option');
                option1.value = course.name;
                option1.textContent = course.name;
                if (currentUser && course.name === currentUser.course) {
                    option1.selected = true;
                }
                 if(signupCourseSelect) signupCourseSelect.appendChild(option1);

                 const option2 = document.createElement('option');
                option2.value = course.name;
                option2.textContent = course.name;
                 if(removeCourseSelect) removeCourseSelect.appendChild(option2);
            });
        }


        // Load ranks and courses from Firestore
        async function loadRanksAndCourses() {
            try {
                const ranksSnapshot = await db.collection("ranks").get();
                ranksData = [];
                ranksSnapshot.forEach(doc => {
                    ranksData.push({ id: doc.id, ...doc.data() });
                });

                const coursesSnapshot = await db.collection("courses").get();
                coursesData = [];
                coursesSnapshot.forEach(doc => {
                    coursesData.push({ id: doc.id, ...doc.data() });
                });

                 // Update dropdowns after loading
                updateDropdowns();

            } catch (error) {
                console.error("Error loading ranks/courses: ", error);
            }
        }


        // Add Rank
        async function addRank() {
            const newRankInput = document.getElementById('new-rank-input');
            const newRankName = newRankInput.value.trim();
            if (!newRankName) {
                 alert('Please enter a rank name.');
                 return;
            }
            // Check if rank already exists
            if (ranksData.some(r => r.name === newRankName)) {
                 alert('Rank already exists.');
                 return;
            }
            try {
                 await db.collection("ranks").add({
                    name: newRankName
                 });
                 newRankInput.value = ''; // Clear input after successful add
                 // Listener will update the UI
            } catch (error) {
                 console.error("Error adding rank: ", error);
                 alert('Error adding rank: ' + error.message);
            }
        }


         // Remove Rank
        async function removeRank() {
             const removeRankSelect = document.getElementById('remove-rank-select');
             const selectedRankName = removeRankSelect.value;
             if (!selectedRankName) {
                 alert('Please select a rank to remove.');
                 return;
             }
             if (!confirm(`Are you sure you want to remove the rank "${selectedRankName}"?`)) {
                return; // Exit if user cancels
            }
             // Find the document ID for the rank name
             const rankDoc = ranksData.find(r => r.name === selectedRankName);
             if (!rankDoc) {
                 console.error("Rank document not found for deletion.");
                 return;
             }
             const rankDocId = rankDoc.id;

            try {
                 await db.collection("ranks").doc(rankDocId).delete();
                 // Listener will update the UI
            } catch (error) {
                 console.error("Error removing rank: ", error);
                 alert('Error removing rank: ' + error.message);
            }
        }


         // Add Course
        async function addCourse() {
            const newCourseInput = document.getElementById('new-course-input');
            const newCourseName = newCourseInput.value.trim();
            if (!newCourseName) {
                 alert('Please enter a course name.');
                 return;
            }
            // Check if course already exists
            if (coursesData.some(c => c.name === newCourseName)) {
                 alert('Course already exists.');
                 return;
            }
            try {
                 await db.collection("courses").add({
                    name: newCourseName
                 });
                 newCourseInput.value = ''; // Clear input after successful add
                 // Listener will update the UI
            } catch (error) {
                 console.error("Error adding course: ", error);
                 alert('Error adding course: ' + error.message);
            }
        }


         // Remove Course
        async function removeCourse() {
             const removeCourseSelect = document.getElementById('remove-course-select');
             const selectedCourseName = removeCourseSelect.value;
             if (!selectedCourseName) {
                 alert('Please select a course to remove.');
                 return;
             }
             if (!confirm(`Are you sure you want to remove the course "${selectedCourseName}"?`)) {
                return; // Exit if user cancels
            }
             // Find the document ID for the course name
             const courseDoc = coursesData.find(c => c.name === selectedCourseName);
             if (!courseDoc) {
                 console.error("Course document not found for deletion.");
                 return;
             }
             const courseDocId = courseDoc.id;

            try {
                 await db.collection("courses").doc(courseDocId).delete();
                 // Listener will update the UI
            } catch (error) {
                 console.error("Error removing course: ", error);
                 alert('Error removing course: ' + error.message);
            }
        }


        // Load signup settings content
        async function loadSignupSettings() {
            // Populate rank and course dropdowns/inputs using the shared loadRanksAndCourses/updateDropdowns logic
            // This function is triggered when the 'Signup Settings' tab becomes active
            // The HTML structure already contains the necessary controls
            // Just ensure the dropdowns are populated correctly
            updateDropdowns(); // This updates all relevant dropdowns on the page
            console.log("Signup settings loaded/reloaded.");
        }


        // Grant admin access to another user
        async function grantAdminAccess() {
            const email = document.getElementById('admin-email').value;
            if (!email) {
                alert('Please enter an email address');
                return;
            }
            try {
                // Find user by email
                const userQuery = await db.collection("users").where("email", "==", email).get();
                if (userQuery.empty) {
                    alert('User not found');
                    return;
                }
                const userDoc = userQuery.docs[0];
                const userId = userDoc.id;

                // Add user to admins collection
                await db.collection("admins").doc(userId).set({
                    email: email,
                    grantedBy: currentUser.email,
                    date: new Date()
                });

                // Clear the input field
                document.getElementById('admin-email').value = '';
                // CHANGED FROM ALERT TO MODAL
                // alert('Admin access granted successfully!');
                showGrantSuccessModal('Admin access granted successfully for ' + email + '!');
                 // Reload the admin list immediately to reflect the change
                if (document.getElementById('admin-access-content').classList.contains('active') &&
                    document.getElementById('settings-section').style.display === 'block') {
                     loadAdminList();
                }

            } catch (error) {
                console.error("Error granting admin access: ", error);
                alert('Error granting admin access: ' + error.message);
            }
        }


        // Load admin list
        async function loadAdminList() {
            try {
                const snapshot = await db.collection("admins").get();
                const adminList = document.getElementById('adminList');

                // - IMPROVED CONTENT GENERATION -
                let adminItemsHTML = '<h3 class="section-title">Current Admins</h3>';
                if (snapshot.empty) {
                    adminItemsHTML += '<p>No admins found.</p>';
                } else {
                    // Fetch user details for each admin UID to get email/name if needed
                    const adminPromises = snapshot.docs.map(async (doc) => {
                        const adminId = doc.id; // This is the user UID
                        const userData = await db.collection("users").doc(adminId).get();
                        if (userData.exists) {
                            return { uid: adminId, email: userData.data().email, name: userData.data().name || 'Unknown Name' }; // Include name if desired
                        } else {
                            // Fallback if user doesn't exist in users collection anymore
                            const adminData = doc.data();
                            return { uid: adminId, email: adminData.email || 'Unknown Email', name: 'Unknown User' };
                        }
                    });
                    const adminDetails = await Promise.all(adminPromises);

                    adminDetails.forEach(admin => {
                        adminItemsHTML += `<div style="background: var(--light); padding: 1rem; margin: 0.5rem 0; border-radius: 5px; display: flex; justify-content: space-between; align-items: center;">
                                            <span>${admin.email} (${admin.name})</span> <!-- Display email and name -->
                                            <button class="btn btn-secondary" onclick="revokeAdminAccess('${admin.uid}', '${admin.email}')" style="width: auto; padding: 0.5rem 1rem;">Revoke</button>
                                        </div>`;
                    });
                }
                adminList.innerHTML = adminItemsHTML;
                // - END OF IMPROVEMENT -
            } catch (error) {
                console.error("Error loading admin list: ", error);
                document.getElementById('adminList').innerHTML = '<p>Error loading admin list.</p>';
            }
        }


        // Revoke admin access (shows confirmation modal)
        function revokeAdminAccess(adminId, email) {
             pendingRevokeAdminId = adminId;
             pendingRevokeAdminEmail = email;
             document.getElementById('revoke-confirm-error').textContent = ''; // Clear previous errors
             document.getElementById('confirmRevokeModal').style.display = 'flex';
        }


         // Confirms the revocation after modal approval
        async function confirmRevokeAdminAccess() {
            if (!pendingRevokeAdminId) {
                 console.error("No pending admin ID to revoke.");
                 closeConfirmRevokeModal();
                 return;
            }

            const adminId = pendingRevokeAdminId;
            const email = pendingRevokeAdminEmail; // Just for reference in potential messages

            try {
                 await db.collection("admins").doc(adminId).delete();
                 console.log("Admin access revoked successfully for UID:", adminId);
                 closeConfirmRevokeModal(); // Close modal on success

                 // Reload the admin list to reflect the change
                 if (document.getElementById('admin-access-content').classList.contains('active') &&
                     document.getElementById('settings-section').style.display === 'block') {
                     loadAdminList();
                 }
                  // Update dashboard counts
                 if (document.getElementById('dashboard-section').style.display === 'block') {
                     updateCounters();
                }

            } catch (error) {
                console.error("Error revoking admin access: ", error);
                // Display error message inside the modal
                document.getElementById('revoke-confirm-error').textContent = 'Error revoking admin access: ' + error.message;
            }
        }


        function closeConfirmRevokeModal() {
            document.getElementById('confirmRevokeModal').style.display = 'none';
            // Clear pending IDs when cancelled or closed
            pendingRevokeAdminId = null;
            pendingRevokeAdminEmail = null;
        }


         function showGrantSuccessModal(message = "Admin access granted successfully!") {
            document.getElementById('grant-success-message').textContent = message;
            document.getElementById('grantSuccessModal').style.display = 'flex';
        }


        function closeGrantSuccessModal() {
            document.getElementById('grantSuccessModal').style.display = 'none';
            // Optional: Clear the message when closed
            document.getElementById('grant-success-message').textContent = "Admin access granted successfully!";
            // Optional: Clear any potential error message
            document.getElementById('grant-success-error').textContent = '';
        }


        // --- AUTHENTICATION FUNCTIONS ---

        // Login function
        async function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                // User signed in, load their data
                loadUserData(userCredential.user.uid);
                 // Hide the login popup
                document.getElementById('loginPopup').style.display = 'none';
                // Hide the login button in the header when logged in
                document.getElementById('loginBtn').style.display = 'none';

            } catch (error) {
                document.getElementById('auth-error').textContent = error.message;
            }
        }


        // Signup function
        async function signup() {
            const name = document.getElementById('signup-name').value.toUpperCase(); // Auto-convert to uppercase
            const rank = document.getElementById('signup-rank').value;
            const course = document.getElementById('signup-course').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;

            if (!name || !rank || !course || !email || !password) {
                 document.getElementById('auth-error').textContent = 'All fields are required.';
                 return;
            }

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                // Save profile data to Firestore
                await db.collection("users").doc(userCredential.user.uid).set({
                    rank: rank,
                    course: course,
                    name: name,
                    email: email,
                    completedSkills: [],
                    lastLogin: new Date()
                });
                loadUserData(userCredential.user.uid);
                 // Hide the login popup
                document.getElementById('loginPopup').style.display = 'none';
                // Hide the login button in the header when logged in
                document.getElementById('loginBtn').style.display = 'none';

            } catch (error) {
                document.getElementById('auth-error').textContent = error.message;
            }
        }


        // Google login function
        function googleLogin() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).then(result => {
                const user = result.user;
                // Check if user exists in Firestore
                db.collection("users").doc(user.uid).get().then(doc => {
                    if (doc.exists) {
                        // User already exists, load data
                        loadUserData(user.uid);
                         // Hide the login popup
                        document.getElementById('loginPopup').style.display = 'none';
                        // Hide the login button in the header when logged in
                        document.getElementById('loginBtn').style.display = 'none';
                    } else {
                        // New user via Google, prompt for profile completion
                        // For simplicity in this context, we'll use the same flow as manual signup
                        // but pre-fill known Google data if possible.
                        // Here, we'll just call showProfileCompletion which can handle Google users too.
                        showProfileCompletionGoogle(user);
                    }
                }).catch(error => {
                     document.getElementById('auth-error').textContent = error.message;
                });
            }).catch(error => {
                document.getElementById('auth-error').textContent = error.message;
            });
        }


         // Show profile completion form for Google login
        function showProfileCompletionGoogle(googleUser) {
             // Populate signup form fields with Google data where possible
             document.getElementById('signup-name').value = googleUser.displayName || '';
             document.getElementById('signup-email').value = googleUser.email || '';
             // Hide login form, show signup form (which acts as completion)
             document.getElementById('loginForm').style.display = 'none';
             document.getElementById('forgotForm').style.display = 'none'; // Ensure forgot is hidden too
             document.getElementById('signupForm').style.display = 'block';
             currentAuthMode = 'signup'; // Set mode to signup for completion
             // The user still needs to select rank/course and potentially confirm email/name
             // The signup() function will handle the Firestore creation.
             // Ensure the submit button calls 'signup()' not 'login()'
             // The HTML already has onclick="signup()" for the signup button.
             // Just make sure the form fields are clear or pre-filled appropriately.
             // Rank and Course still need selection.
             updateDropdowns(); // Ensure dropdowns are populated
        }


        // Show forgot password form
        function showForgotPassword() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'none';
            document.getElementById('forgotForm').style.display = 'block';
            currentAuthMode = 'forgot';
            document.getElementById('auth-error').textContent = '';
        }


        // Send password reset email
        function sendPasswordReset() {
            const email = document.getElementById('forgot-email').value;
            if (!email) {
                document.getElementById('auth-error').textContent = 'Please enter your email';
                return;
            }
            auth.sendPasswordResetEmail(email).then(() => {
                alert('Password reset email sent!');
                toggleAuthMode(); // Go back to login
            }).catch(error => {
                document.getElementById('auth-error').textContent = error.message;
            });
        }


        // Toggle between login/signup/forgot forms
        function toggleAuthMode() {
            if (currentAuthMode === 'login') {
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('signupForm').style.display = 'block';
                document.getElementById('forgotForm').style.display = 'none'; // Hide forgot if visible
                currentAuthMode = 'signup';
            } else if (currentAuthMode === 'signup') {
                document.getElementById('signupForm').style.display = 'none';
                document.getElementById('loginForm').style.display = 'block';
                document.getElementById('forgotForm').style.display = 'none'; // Hide forgot if visible
                currentAuthMode = 'login';
            } else if (currentAuthMode === 'forgot') {
                 document.getElementById('forgotForm').style.display = 'none';
                 document.getElementById('loginForm').style.display = 'block';
                 document.getElementById('signupForm').style.display = 'none'; // Hide signup if visible
                 currentAuthMode = 'login';
            }
            document.getElementById('auth-error').textContent = '';
        }


        // Close login popup
        function closeLoginPopup() {
            document.getElementById('loginPopup').style.display = 'none';
            // Show the login button in the header when popup is closed while logged out
            // Only show if no user is logged in (check global isAdmin/user state)
            if (!currentUser) {
                 document.getElementById('loginBtn').style.display = 'block';
            }
            // Reset form visibility to default (login form)
             document.getElementById('loginForm').style.display = 'block';
             document.getElementById('signupForm').style.display = 'none';
             document.getElementById('forgotForm').style.display = 'none';
             currentAuthMode = 'login';
             document.getElementById('auth-error').textContent = ''; // Clear errors on close
        }


        // Open login popup
        function openLoginPopup() {
            document.getElementById('loginPopup').style.display = 'flex';
            // Hide the login button when the popup opens
            document.getElementById('loginBtn').style.display = 'none';
             // Reset form visibility to default (login form)
             document.getElementById('loginForm').style.display = 'block';
             document.getElementById('signupForm').style.display = 'none';
             document.getElementById('forgotForm').style.display = 'none';
             currentAuthMode = 'login';
             document.getElementById('auth-error').textContent = ''; // Clear errors on open
             // Pre-populate rank/course dropdowns for signup
             updateDropdowns();
        }


        // Placeholder for loadSkillsFromFirebase if needed for public view
        function loadSkillsFromFirebase() {
             // This function attempts to load skills, relying on Firestore security rules
            // to determine if unauthenticated users can read them.
            // The onSnapshot listener in setupFirestoreListeners handles loading and updating skillsData.
            // This function could be used to explicitly trigger a load attempt or handle errors differently.
            console.log("Attempting to load skills from Firebase...");
            // The actual loading happens in the onSnapshot listener which is already set up.
            // We can call loadSkillGrid here if we expect skills to be readable without auth.
             if (document.getElementById('userInterface').style.display === 'block') {
                loadSkillGrid(); // Try to load grid, will show empty if no skills accessible
            }
        }


    </script>
</body>
</html>
