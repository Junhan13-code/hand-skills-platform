<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hand Skills Learning Platform</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --accent: #4cc9f0;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --success: #4ade80;
            --warning: #facc15;
            --danger: #f87171;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fb;
            color: var(--dark);
            line-height: 1.6;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* Header Styles */
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 2rem 0;
            text-align: center;
            margin-bottom: 2rem;
            position: relative;
        }
        header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* Button Styles */
        .btn {
            padding: 0.6rem 1.2rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: #3a56e4; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-danger:hover { background-color: #f75c5c; }
        .btn-warning { background-color: var(--warning); color: black; }
        .btn-warning:hover { background-color: #f9c50d; }
        .btn-secondary { background-color: var(--secondary); color: white; }
        .btn-secondary:hover { background-color: #352da8; }

        /* Profile & Switch Buttons */
        .profile-btn, .admin-switch-btn {
            position: absolute;
            top: 20px;
            background: rgba(0,0,0,0.3);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }
        .profile-btn:hover, .admin-switch-btn:hover {
            background: rgba(0,0,0,0.5);
        }
        .profile-btn {
            right: 120px;
        }
        .admin-switch-btn {
            right: 20px;
        }

        /* Admin Dashboard Layout */
        .admin-dashboard {
            display: none;
            padding: 2rem 0;
            background-color: #f0f4f8; /* Light background for admin panel */
        }

        .admin-wrapper {
            display: grid;
            grid-template-columns: 250px 1fr; /* Sidebar + Main Content */
            gap: 2rem;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* Navigation Panel */
        .nav-panel {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            height: fit-content; /* Keeps it sticky */
            position: sticky;
            top: 2rem;
        }
        .nav-panel h3 {
            margin-bottom: 1.2rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e2e8f0;
            color: var(--primary);
            font-size: 1.2rem;
        }
        .nav-item {
            padding: 0.8rem;
            margin-bottom: 0.5rem;
            border-radius: 8px; /* Rounded corners */
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--dark);
            text-decoration: none;
        }
        .nav-item:hover {
            background-color: #f0f4ff;
        }
        .nav-item.active {
            background-color: #e3f2fd;
            color: var(--primary);
        }

        /* Main Content Area */
        .main-content-area {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        /* Section Titles */
        .section-title {
            font-size: 1.8rem; /* Slightly larger font */
            color: var(--primary);
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #eee;
            margin-bottom: 1.5rem;
            background-color: #fafafa;
        }

        /* Individual Sections */
        .section {
            display: none;
            padding: 0 1.5rem 1.5rem;
        }
        .section.active {
            display: block;
        }

        /* Dashboard Stats Grid */
        .dashboard-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: white;
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 1.5rem;
            text-align: center;
            border-top: 3px solid var(--primary);
        }
        .stat-card h3 { font-size: 2rem; margin-bottom: 0.5rem; color: var(--primary); }
        .stat-card p { color: var(--gray); font-size: 0.9rem; }

        /* Skills List Styles */
        .skill-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        .skill-card-ui {
            background: white;
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 1.5rem;
            border: 1px solid #eee;
            transition: var(--transition);
        }
        .skill-card-ui:hover {
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        .skill-card-ui .skill-header h3 { margin-bottom: 0.5rem; color: var(--secondary); }
        .skill-card-ui .skill-content p { color: var(--gray); margin-bottom: 1rem; font-size: 0.95rem; }
        .skill-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: space-between;
        }
        .skill-btn {
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
        }

        /* Users Management Styles */
        .users-section .section-title { margin-bottom: 1rem; }
        .course-group {
            margin-bottom: 2rem;
            background: white;
            border-radius: 8px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }
        .course-title {
            background-color: var(--light);
            padding: 1rem 1.5rem;
            margin: 0;
            font-size: 1.3rem;
            color: var(--primary);
        }
        .user-list {
            padding: 1rem;
        }
        .user-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid #eee;
        }
        .user-card:last-child { border-bottom: none; }
        .user-details .user-name { font-weight: 600; }
        .user-details .user-rank { font-size: 0.9rem; color: var(--gray); }
        .user-details .user-course { font-size: 0.9rem; color: var(--primary); }
        .user-actions {
            display: flex;
            gap: 0.5rem;
        }
        .action-btn {
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
        }

        /* Settings Tab Styles */
        .settings-tabs {
            display: flex;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 1.5rem;
            background-color: #fafafa;
            border-radius: 6px 6px 0 0;
        }
        .tab-button {
            background: none;
            border: none;
            padding: 0.8rem 1.5rem;
            font-weight: 600;
            color: var(--gray);
            cursor: pointer;
            border-radius: 0;
            transition: var(--transition);
        }
        .tab-button:hover {
            color: var(--primary);
        }
        .tab-button.active {
            color: var(--primary);
            background: white;
            border-bottom: 3px solid var(--primary);
        }
        .tab-content {
            display: none;
            padding: 1rem 0;
        }
        .tab-content.active {
            display: block;
        }
        .settings-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        @media (max-width: 768px) {
             .settings-controls { grid-template-columns: 1fr; }
        }
        .control-group {
            margin-bottom: 2rem;
            background: var(--light);
            padding: 1.5rem;
            border-radius: 8px;
        }
        .control-group h4 {
            margin-bottom: 1rem;
            color: var(--primary);
        }
        .items-list {
            margin-bottom: 1rem;
        }
        .item-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background: white;
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }
        .add-item-input {
            display: flex;
            gap: 0.5rem;
        }
        .add-item-input input {
            flex: 1;
            padding: 0.6rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .operation-message {
            margin-top: 0.5rem;
            padding: 0.5rem;
            border-radius: 4px;
        }
        .operation-message.success { background-color: #d4edda; color: #155724; }
        .operation-message.error { background-color: #f8d7da; color: #721c24; }

        /* Admin Access Form */
        .admin-access-form {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        .form-group input {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        #adminList {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
        }
        .admin-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: white;
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }
        #adminList button.btn { /* Revoke button */
            background: var(--danger);
        }

        /* Edit Form Styles */
        .edit-form {
            display: none;
            padding: 1.5rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-top: 1.5rem;
        }
        /* - TABS STYLING - */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            background-color: #fafafa;
            border-radius: 6px 6px 0 0;
        }
        .tab-btn {
            background: none;
            border: none;
            padding: 0.75rem 1.25rem;
            font-weight: 600;
            color: var(--gray);
            cursor: pointer;
            border-radius: 0;
            transition: var(--transition);
        }
        .tab-btn:hover {
            color: var(--primary);
        }
        .tab-btn.active {
            color: var(--primary);
            background: white;
            border-bottom: 3px solid var(--primary);
        }
        .form-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .form-col { /* Changed from form-group to form-col for inner layout */
            flex: 1;
            margin-bottom: 1rem;
        }
        .form-col label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        .form-col input, .form-col textarea, .form-col select {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .form-col textarea {
            min-height: 100px;
            resize: vertical;
        }
        .step-card {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            border-left: 3px solid var(--primary);
        }
        .step-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        /* Tool Card Styling */
        .tool-card {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            border-left: 3px solid var(--secondary);
        }
        .tool-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .tool-card-header h4 {
            margin: 0;
            color: var(--secondary);
        }
        .remove-tool-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
        }
        /* Image Preview */
        .image-upload-preview {
            width: 100%;
            height: 150px;
            border: 1px dashed #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            margin-top: 0.5rem;
            border-radius: 4px;
        }
        .image-upload-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* Modals */
        .login-popup, .confirmation-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }
        .login-box {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }
        .close-btn:hover {
            color: var(--danger);
        }
        .login-box h2 {
            margin-bottom: 1.5rem;
            color: var(--secondary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .login-form, .signup-form, .forgot-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .form-group-modal {
            margin-bottom: 1rem;
        }
        .form-group-modal label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        .form-group-modal input, .form-group-modal select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        .form-toggle {
            text-align: center;
            margin-top: 1rem;
        }
        .form-toggle a {
            color: var(--primary);
            text-decoration: none;
        }
        .form-toggle a:hover {
            text-decoration: underline;
        }
        .error-message {
            color: var(--danger);
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }
        .google-login-btn {
            background-color: #4285F4;
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .google-login-btn:hover {
            background-color: #3367D6;
        }

        /* Profile Popup */
        .profile-popup {
            position: fixed;
            top: 70px;
            right: 20px;
            width: 300px;
            background: white;
            border-radius: 10px;
            box-shadow: var(--shadow);
            z-index: 1000;
            display: none;
        }
        .profile-header {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--light);
        }
        .profile-header i {
            font-size: 1.5rem;
            margin-right: 0.5rem;
            color: var(--primary);
        }
        .profile-header h3 {
            font-size: 1.2rem;
            margin: 0;
        }
        .profile-content {
            padding: 1rem;
        }
        .profile-info {
            margin-bottom: 1rem;
        }
        .info-item {
            margin-bottom: 0.5rem;
        }
        .info-label {
            font-weight: 600;
            color: var(--gray);
            font-size: 0.9rem;
        }
        .info-value {
            font-size: 1rem;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        .form-group select, .form-group input {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .update-rank-btn, .close-profile-btn, .logout-btn-popup {
            width: 100%;
            margin-bottom: 0.5rem;
        }

        /* Edit User Modal */
        .edit-user-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            display: none;
        }
        .edit-user-box {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 500px;
            text-align: center;
            position: relative;
        }
        .edit-user-box h3 {
            margin-bottom: 1.5rem;
            color: var(--secondary);
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1.5rem;
        }
        .modal-actions button {
            flex: 1;
        }

        /* User Interface */
        .user-interface {
            display: none;
            padding: 2rem 0;
        }
        .skill-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        .skill-card-ui {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: var(--transition);
            cursor: pointer;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .skill-card-ui:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }
        .skill-icon {
            height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            font-size: 3rem;
        }
        .skill-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .skill-content {
            padding: 1.5rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .skill-name {
            font-size: 1.5rem;
            margin-bottom: 0.75rem;
            color: var(--primary);
        }
        .skill-desc {
            color: var(--gray);
            flex-grow: 1;
        }
        .skill-btn { /* This is the original class for buttons inside skill cards in the grid */
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 1rem;
        }
        .skill-btn:hover {
            background: #3a56e4;
        }
        /* Theory Section */
        .theory-content {
            background: var(--light);
            padding: 1.5rem;
            border-radius: 8px;
            line-height: 1.8;
        }
        /* Quiz Section */
        .quiz-container {
            background: var(--light);
            padding: 1.5rem;
            border-radius: 8px;
        }
        .question {
            margin-bottom: 1.5rem;
        }
        .question-text {
            font-weight: 600;
            margin-bottom: 0.75rem;
        }
        .options {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .option {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: var(--transition);
        }
        .option:hover {
            background: #e9ecef;
        }
        .option.selected {
            background: var(--primary);
            color: white;
        }
        .quiz-result.correct {
            color: var(--success);
        }
        .quiz-result.incorrect {
            color: var(--danger);
        }
        .quiz-result {
            margin-top: 1rem;
            font-weight: 600;
        }

        /* Footer */
        footer {
            background-color: var(--dark);
            color: white;
            padding: 2rem 0;
            text-align: center;
            margin-top: 3rem;
        }
        footer p {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        /* Responsive Adjustments */
        @media (max-width: 992px) {
            .admin-wrapper {
                grid-template-columns: 1fr; /* Stack sidebar and main content on medium screens */
            }
            .nav-panel {
                 position: static; /* Unstick on small screens */
                 margin-bottom: 2rem;
            }
        }
        @media (max-width: 768px) {
            header h1 { font-size: 1.8rem; }
            .profile-btn, .admin-switch-btn { padding: 0.5rem 1rem; font-size: 0.9rem; }
            .section-title { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1><i class="fas fa-tools"></i> Hand Skills Learning Platform</h1>
            <p>Master essential hands-on skills with step-by-step guidance</p>
        </div>
        <button class="profile-btn" id="profileBtn" onclick="toggleProfilePopup()" style="display: none;">
            <i class="fas fa-user"></i> Profile
        </button>
        <button class="admin-switch-btn" id="adminSwitchBtn" onclick="switchToUserInterface()" style="display: none;">
            <i class="fas fa-user-graduate"></i> User View
        </button>
        <button class="admin-switch-btn" id="adminBackBtn" onclick="switchToAdminInterface()" style="display: none;">
            <i class="fas fa-lock"></i> Admin View
        </button>
    </header>

    <!-- Profile Popup -->
    <div class="profile-popup" id="profilePopup">
        <div class="profile-header">
            <i class="fas fa-user-circle"></i>
            <h3>User Profile</h3>
        </div>
        <div class="profile-content">
            <div class="profile-info">
                <div class="info-item">
                    <span class="info-label">Name</span>
                    <div class="info-value" id="popup-name-display"></div>
                </div>
                <div class="info-item">
                    <span class="info-label">Rank</span>
                    <div class="info-value" id="popup-rank-display"></div>
                </div>
                <div class="info-item">
                    <span class="info-label">Course</span>
                    <div class="info-value" id="popup-course-display"></div>
                </div>
                <div class="info-item">
                    <span class="info-label">Email</span>
                    <div class="info-value" id="popup-email-display"></div>
                </div>
            </div>
            <div class="form-group">
                <label for="edit-rank">Change Rank</label>
                <select id="edit-rank" class="change-rank-select">
                    <!-- Options will be loaded dynamically -->
                </select>
            </div>
            <button class="btn update-rank-btn" onclick="updateOwnRank()">Update Rank</button>
            <button class="btn close-profile-btn" onclick="toggleProfilePopup()">Close</button>
            <button class="btn logout-btn-popup" onclick="logout()">Logout</button>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div class="admin-dashboard" id="adminDashboard">
        <div class="container">
            <div class="admin-wrapper">
                <!-- Sidebar Navigation -->
                <div class="nav-panel">
                    <h3>Navigation</h3>
                    <div class="nav-item active" onclick="showSection('dashboard')">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </div>
                    <div class="nav-item" onclick="showSection('skills')">
                        <i class="fas fa-tools"></i> Manage Skills
                    </div>
                    <div class="nav-item" onclick="showSection('users')">
                        <i class="fas fa-users"></i> Manage Users
                    </div>
                    <div class="nav-item" onclick="showSection('settings')">
                        <i class="fas fa-cog"></i> Settings
                    </div>
                </div>

                <!-- Main Content Area -->
                <div class="main-content-area">
                    <!-- Dashboard Section -->
                    <div id="dashboard-section" class="section active">
                        <h2 class="section-title">Dashboard Overview</h2>
                        <p>Welcome to the Hand Skills Learning Platform Admin Panel. From here you can manage skills, content, and user access.</p>
                        <div class="dashboard-stats-grid">
                            <div class="stat-card">
                                <h3 id="totalSkillsCount">0</h3>
                                <p>Total Skills</p>
                            </div>
                            <div class="stat-card">
                                <h3 id="totalUsersCount">0</h3>
                                <p>Total Users</p>
                            </div>
                            <div class="stat-card">
                                <h3 id="activeAdminsCount">0</h3>
                                <p>Active Admins</p>
                            </div>
                            <div class="stat-card">
                                <h3 id="completedQuizzesCount">0</h3>
                                <p>Completed Quizzes</p>
                            </div>
                        </div>
                    </div>

                    <!-- Skills Management Section -->
                    <div id="skills-section" class="section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h2 class="section-title">Manage Skills</h2>
                            <button class="btn btn-primary" onclick="addNewSkill()">
                                <i class="fas fa-plus"></i> Add New Skill
                            </button>
                        </div>
                        <div class="skill-list" id="skillsList">
                            <!-- Skills will be loaded here -->
                        </div>
                    </div>

                    <!-- Users Management Section -->
                    <div id="users-section" class="section users-section">
                        <h2 class="section-title">Manage Users</h2>
                        <div id="usersContent">
                            <!-- User groups will be loaded here -->
                        </div>
                    </div>

                    <!-- Settings Section -->
                    <div id="settings-section" class="section">
                        <h2 class="section-title">System Settings</h2>
                        <div class="settings-tabs">
                            <button class="tab-button active" data-tab="signupSettings">Signup Settings</button>
                            <button class="tab-button" data-tab="adminAccess">Admin Access</button>
                        </div>

                        <div id="signupSettingsTab" class="tab-content active">
                            <div class="settings-controls">
                                <div class="control-group">
                                    <h4><i class="fas fa-star"></i> Manage Ranks</h4>
                                    <div class="items-list" id="ranksList">
                                        <!-- Ranks will be loaded here -->
                                    </div>
                                    <div class="add-item-input">
                                        <input type="text" id="newRankInput" placeholder="New rank name">
                                        <button class="btn btn-primary" onclick="addRank()">Add Rank</button>
                                    </div>
                                    <div class="operation-message" id="rankMessage"></div>
                                </div>
                                <div class="control-group">
                                    <h4><i class="fas fa-book"></i> Manage Courses</h4>
                                    <div class="items-list" id="coursesList">
                                        <!-- Courses will be loaded here -->
                                    </div>
                                    <div class="add-item-input">
                                        <input type="text" id="newCourseInput" placeholder="New course name">
                                        <button class="btn btn-primary" onclick="addCourse()">Add Course</button>
                                    </div>
                                    <div class="operation-message" id="courseMessage"></div>
                                </div>
                            </div>
                        </div>

                        <div id="adminAccessTab" class="tab-content">
                            <h3 class="section-title">Admin Access Management</h3>
                            <div class="admin-access-form">
                                <div class="form-group">
                                    <label for="admin-email">Email Address</label>
                                    <input type="email" id="admin-email" placeholder="Enter email address">
                                </div>
                                <button class="btn btn-primary" onclick="grantAdminAccess()">Grant Admin Access</button>
                            </div>
                            <div id="adminList">
                                <!-- Admin list will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Skill Form -->
    <div id="edit-skill-form" class="edit-form">
        <div class="section-title">Edit Skill</div>
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" data-tab="info">üìå Skill Info</button>
            <button class="tab-btn" data-tab="tools">üõ†Ô∏è Tools</button>
            <button class="tab-btn" data-tab="steps">üìã Steps</button>
            <button class="tab-btn" data-tab="quiz">‚ùì Quiz</button>
            <button class="tab-btn" data-tab="theory">üìñ Theory</button>
        </div>
        <!-- Tab Content -->
        <div id="tab-info" class="tab-content active">
            <div class="form-row">
                <div class="form-col">
                    <label for="edit-skill-name">Skill Name *</label>
                    <input type="text" id="edit-skill-name" placeholder="e.g., Soldering Basics" required>
                </div>
                <div class="form-col">
                    <label for="edit-skill-image">Skill Image *</label>
                    <input type="file" id="edit-skill-image" accept="image/*" onchange="previewSkillImage(this)">
                    <div class="image-upload-preview" id="skill-image-preview">
                        <!-- Preview image will appear here -->
                    </div>
                    <!-- Hidden input to store existing URL -->
                    <input type="hidden" id="skill-image-url-hidden">
                </div>
            </div>
            <div class="form-col">
                <label for="edit-skill-description">Description *</label>
                <textarea id="edit-skill-description" placeholder="Describe the skill..." required></textarea>
            </div>
        </div>
        <div id="tab-tools" class="tab-content">
            <div id="tools-container">
                <!-- Tool cards will be added here dynamically -->
            </div>
            <button class="btn btn-primary" onclick="addTool()">+ Add Tool</button>
        </div>
        <div id="tab-steps" class="tab-content">
            <div id="steps-container">
                <!-- Step cards will be added here dynamically -->
            </div>
            <button class="btn btn-primary" onclick="addStep()">+ Add Step</button>
        </div>
        <div id="tab-quiz" class="tab-content">
            <div id="quiz-container">
                <!-- Quiz question cards will be added here dynamically -->
            </div>
            <button class="btn btn-primary" onclick="addQuestion()">+ Add Question</button>
        </div>
        <div id="tab-theory" class="tab-content">
            <div class="form-col">
                <label for="edit-skill-theory">Theory *</label>
                <textarea id="edit-skill-theory" placeholder="Enter theoretical information..." required></textarea>
            </div>
        </div>
        <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #eee;">
            <button class="btn btn-secondary" onclick="cancelEdit()">Cancel</button>
            <button class="btn btn-primary" onclick="saveSkill()">Save Changes</button>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="edit-user-modal" id="editUserModal">
        <div class="edit-user-box">
            <span class="close-btn" onclick="closeEditUserModal()">&times;</span>
            <h3>Edit User</h3>
            <div class="form-group">
                <label for="edit-user-name">Name</label>
                <input type="text" id="edit-user-name" placeholder="Enter full name">
            </div>
            <div class="form-group">
                <label for="edit-user-rank">Rank</label>
                <select id="edit-user-rank">
                    <!-- Options will be loaded dynamically -->
                </select>
            </div>
            <div class="form-group">
                <label for="edit-user-course">Course</label>
                <select id="edit-user-course">
                    <!-- Options will be loaded dynamically -->
                </select>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeEditUserModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveEditedUser()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal for Revoking Admin Access -->
    <div class="login-popup confirmation-modal" id="confirmRevokeModal" style="display: none;">
        <div class="login-box">
            <span class="close-btn" onclick="closeConfirmRevokeModal()">&times;</span>
            <h2><i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i> Confirm Revoke</h2>
            <p id="confirm-revoke-message">Are you sure you want to revoke admin access?</p>
            <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
                <button class="btn btn-secondary" onclick="closeConfirmRevokeModal()" style="flex: 1;">Cancel</button>
                <button class="btn btn-danger" style="flex: 1;" onclick="performRevokeAdmin()">Revoke</button>
            </div>
            <div class="error-message" id="revoke-confirm-error"></div>
        </div>
    </div>

    <!-- Grant Admin Success Notification Modal -->
    <div class="login-popup" id="grantSuccessModal" style="display: none; z-index: 3002;">
        <div class="login-box">
            <span class="close-btn" onclick="closeGrantSuccessModal()">&times;</span>
            <h2><i class="fas fa-check-circle" style="color: var(--success);"></i> Success</h2>
            <p id="grant-success-message">Admin access granted successfully!</p>
            <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
                <button class="btn btn-primary" style="flex: 1;" onclick="closeGrantSuccessModal()">OK</button>
            </div>
            <div class="error-message" id="grant-success-error"></div>
        </div>
    </div>

    <!-- Login Popup -->
    <div class="login-popup" id="loginPopup" style="display: none;">
        <div class="login-box">
            <span class="close-btn" onclick="closeLoginPopup()">&times;</span>
            <h2><i class="fas fa-lock"></i> Login</h2>
            <div id="authContainer">
                <!-- Auth forms will be loaded here -->
            </div>
        </div>
    </div>

    <!-- User Interface -->
    <div class="user-interface" id="userInterface">
        <main class="container">
            <div id="main-content">
                <div class="skill-grid" id="skill-grid">
                    <!-- Skills will be loaded here -->
                </div>
                <div id="skill-detail" class="skill-detail">
                    <!-- Skill details will be loaded here -->
                </div>
            </div>
        </main>
    </div>
    <footer>
        <div class="container">
            <p>&copy; 2026 Hand Skills Learning Platform | Master Essential Hands-On Skills</p>
        </div>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script> <!-- Add Storage SDK -->

    <script>
        // Your existing Firebase config and all JavaScript functions remain exactly the same
        const firebaseConfig = {
            apiKey: "AIzaSyA6ZdINHlRF583T3HL5RsA4q2fmHeBcB_g",
            authDomain: "hand-skills-platform.firebaseapp.com",
            projectId: "hand-skills-platform",
            storageBucket: "hand-skills-platform.appspot.com",
            messagingSenderId: "1040566746608",
            appId: "1:1040566746608:web:793c684b54255944def063"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage(); // Initialize Storage

        // Global variables
        let skillsData = [];
        let usersData = [];
        let currentEditingSkill = null;
        let currentUser = null;
        let originalEditingSkill = null; // Store original skill data
        let currentAuthMode = 'login'; // 'login', 'signup', 'forgot', 'profile'
        let editingUserId = null; // Track user being edited
        let isAdmin = false; // Track if current user is admin
        let ranksData = []; // Store ranks from Firestore
        let coursesData = []; // Store courses from Firestore
        let wasInAdminView = false; // Track if we were in admin view before switching

        // - NEW VARIABLES FOR REVOKE CONFIRMATION -
        let pendingRevokeAdminId = null;
        let pendingRevokeAdminEmail = null;
        // - END NEW VARIABLES -

        window.onload = function() {
            // Check if user is already logged in
            auth.onAuthStateChanged(async function(user) {
                if (user) {
                    const idTokenResult = await user.getIdTokenResult();
                    isAdmin = idTokenResult.claims.admin || user.email === 'jacksparrow6194@gmail.com';

                    currentUser = {
                        id: user.uid,
                        email: user.email,
                        name: localStorage.getItem('userName') || user.displayName || '',
                        rank: localStorage.getItem('userRank') || '',
                        course: localStorage.getItem('userCourse') || '',
                        completedSkills: JSON.parse(localStorage.getItem('completedSkills')) || []
                    };

                    document.getElementById('profileBtn').style.display = 'block';
                    if (isAdmin) {
                        document.getElementById('adminSwitchBtn').style.display = 'block';
                        // Optionally load admin data if coming back after login
                        setupFirestoreListeners();
                        showSection('dashboard');
                    } else {
                        document.getElementById('adminSwitchBtn').style.display = 'none';
                        document.getElementById('userInterface').style.display = 'block';
                        setupFirestoreListeners();
                        loadSkillGrid();
                    }
                    updateProfileDisplay();
                } else {
                    document.getElementById('profileBtn').style.display = 'none';
                    document.getElementById('adminSwitchBtn').style.display = 'none';
                    document.getElementById('adminBackBtn').style.display = 'none';
                    openLoginPopup(); // Open login popup if not logged in
                }
            });
        }

        function setupFirestoreListeners() {
            // Listen for changes in skills collection
            db.collection("skills").onSnapshot((snapshot) => {
                skillsData = [];
                snapshot.forEach(doc => {
                    skillsData.push({ id: doc.id, ...doc.data() });
                });
                // - CORRECTED SORTING LOGIC -
                skillsData.sort((a, b) => {
                    const orderA = a.order !== undefined && a.order !== null ? a.order : Infinity;
                    const orderB = b.order !== undefined && b.order !== null ? b.order : Infinity;
                    return orderA - orderB;
                });
                updateCounters();
                // Update user interface if visible
                if (document.getElementById('userInterface').style.display === 'block') {
                    loadSkillGrid(); // This will now use the sorted skillsData
                }
                // Update admin list if currently viewing the skills section
                if (document.getElementById('skills-section').style.display === 'block') {
                    loadSkillsList();
                }
            });

            // Listen for changes in users collection
            db.collection("users").onSnapshot((snapshot) => {
                usersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateCounters();
                if (document.getElementById('users-section').style.display === 'block') {
                    loadUsersManagement();
                }
            });

            // Listen for changes in ranks collection
            db.collection("ranks").onSnapshot((snapshot) => {
                ranksData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (document.getElementById('signupSettingsTab').classList.contains('active')) {
                    loadSignupSettings();
                }
                updateDropdowns(); // Update dropdowns in profile popup
            });

            // Listen for changes in courses collection
            db.collection("courses").onSnapshot((snapshot) => {
                coursesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (document.getElementById('signupSettingsTab').classList.contains('active')) {
                    loadSignupSettings();
                }
                updateDropdowns(); // Update dropdowns in profile popup
            });

            // Listen for changes in admins collection
            db.collection("admins").onSnapshot((snapshot) => {
                updateCounters();
                if (document.getElementById('adminAccessTab').classList.contains('active')) {
                    loadAdminList();
                }
            });
        }

        function updateCounters() {
            document.getElementById('totalSkillsCount').textContent = skillsData.length;
            document.getElementById('totalUsersCount').textContent = usersData.length;
            // Count admins (excluding super admin)
            db.collection("admins").get().then(snapshot => {
                const adminCount = snapshot.size - 1; // Subtract 1 for super admin
                document.getElementById('activeAdminsCount').textContent = adminCount;
            });
        }

        function showSection(section) {
            document.querySelectorAll('.section').forEach(el => el.style.display = 'none');
            document.getElementById('edit-skill-form').style.display = 'none';

            const activeNavItems = document.querySelectorAll('.nav-item.active');
            activeNavItems.forEach(item => item.classList.remove('active'));

            document.getElementById(section + '-section').style.display = 'block';
            document.querySelector(`.nav-item[onclick="showSection('${section}')"]`).classList.add('active');

            if (section === 'settings') {
                const activeTabButton = document.querySelector('.tab-button.active');
                const activeTabId = activeTabButton ? activeTabButton.getAttribute('data-tab') : 'signupSettings';
                if (activeTabId === 'signupSettings') {
                    loadSignupSettings();
                } else if (activeTabId === 'adminAccess') {
                    loadAdminList();
                }
            } else if (section === 'users') {
                loadUsersManagement();
            } else if (section === 'skills') {
                loadSkillsList();
            }
        }

        // Load skills list for admin panel
        function loadSkillsList() {
            const skillsList = document.getElementById('skillsList');
            skillsList.innerHTML = '';
            skillsData.forEach(skill => {
                const skillCard = document.createElement('div');
                skillCard.className = 'skill-card-ui';
                skillCard.innerHTML = `
                    <div class="skill-content">
                        <div class="skill-header">
                            <h3>${skill.name}</h3>
                        </div>
                        <p>${skill.description || 'No description provided.'}</p>
                        <div class="skill-actions">
                            <button class="skill-btn btn-warning" onclick="editSkill('${skill.id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="skill-btn btn-danger" onclick="deleteSkill('${skill.id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                        <div class="skill-actions">
                            <button class="skill-btn btn-primary" onclick="moveSkill('${skill.id}', 'up')" title="Move Up">
                                <i class="fas fa-arrow-up"></i>
                            </button>
                            <button class="skill-btn btn-primary" onclick="moveSkill('${skill.id}', 'down')" title="Move Down">
                                <i class="fas fa-arrow-down"></i>
                            </button>
                        </div>
                    </div>
                `;
                skillsList.appendChild(skillCard);
            });
        }

        // Move Skill Up
        async function moveSkillUp(skillId, currentOrder) {
             if (typeof currentOrder !== 'number' || isNaN(currentOrder)) {
                 console.error("Invalid order value received for moveSkillUp:", currentOrder);
                 alert("Cannot move skill: Invalid order data.");
                 return;
             }
             const currentIndex = skillsData.findIndex(s => s.id === skillId);
             if (currentIndex === -1 || currentIndex === 0) {
                 console.log("Skill is already at the top or not found, cannot move up.");
                 return;
             }
             const previousSkill = skillsData[currentIndex - 1];
             if (!previousSkill) {
                 console.error("Previous skill not found in skillsData.");
                 return;
             }
             const targetSkillId = previousSkill.id;
             const targetOrder = previousSkill.order !== undefined && previousSkill.order !== null ? previousSkill.order : NaN;
             if (isNaN(targetOrder)) {
                 console.error("Calculated target order is invalid (NaN). Cannot proceed.");
                 alert("Error calculating order. Cannot move skill.");
                 return;
             }

             try {
                 const batch = db.batch();
                 batch.update(db.collection("skills").doc(skillId), { order: targetOrder });
                 batch.update(db.collection("skills").doc(targetSkillId), { order: currentOrder });
                 await batch.commit();
             } catch (error) {
                 console.error("Error moving skill up: ", error);
                 alert("Failed to move skill up: " + error.message);
             }
         }

         // Move Skill Down
         async function moveSkillDown(skillId, currentOrder) {
             if (typeof currentOrder !== 'number' || isNaN(currentOrder)) {
                 console.error("Invalid order value received for moveSkillDown:", currentOrder);
                 alert("Cannot move skill: Invalid order data.");
                 return;
             }
             const currentIndex = skillsData.findIndex(s => s.id === skillId);
             if (currentIndex === -1 || currentIndex >= skillsData.length - 1) {
                 console.log("Skill is already at the bottom or not found, cannot move down.");
                 return;
             }
             const nextSkill = skillsData[currentIndex + 1];
             if (!nextSkill) {
                 console.error("Next skill not found in skillsData.");
                 return;
             }
             const targetSkillId = nextSkill.id;
             const targetOrder = nextSkill.order !== undefined && nextSkill.order !== null ? nextSkill.order : NaN;
             if (isNaN(targetOrder)) {
                 console.error("Calculated target order is invalid (NaN). Cannot proceed.");
                 alert("Error calculating order. Cannot move skill.");
                 return;
             }

             try {
                 const batch = db.batch();
                 batch.update(db.collection("skills").doc(skillId), { order: targetOrder });
                 batch.update(db.collection("skills").doc(targetSkillId), { order: currentOrder });
                 await batch.commit();
             } catch (error) {
                 console.error("Error moving skill down: ", error);
                 alert("Failed to move skill down: " + error.message);
             }
         }

         // Move Skill Wrapper (calls up/down based on direction)
         async function moveSkill(skillId, direction) {
              const skill = skillsData.find(s => s.id === skillId);
              if (!skill || typeof skill.order !== 'number') {
                  console.error("Cannot move skill: Invalid skill or order data.", skill);
                  alert("Cannot move skill: Data error.");
                  return;
              }
              if (direction === 'up') {
                  await moveSkillUp(skillId, skill.order);
              } else if (direction === 'down') {
                  await moveSkillDown(skillId, skill.order);
              }
          }

        // Add new skill
        async function addNewSkill() {
            try {
                const sortedSkillsForOrderCalc = [...skillsData].sort((a, b) => {
                    const orderA = a.order !== undefined && a.order !== null ? a.order : -1;
                    const orderB = b.order !== undefined && b.order !== null ? b.order : -1;
                    return orderA - orderB;
                });
                const maxExistingOrder = sortedSkillsForOrderCalc.length > 0 ? (sortedSkillsForOrderCalc[sortedSkillsForOrderCalc.length - 1].order || 0) : -1;
                const newOrder = maxExistingOrder + 1;
                currentEditingSkill = {
                    id: null, // Will be assigned by Firestore on add
                    name: '',
                    imageUrl: '',
                    description: '',
                    tools: [],
                    theory: '',
                    quiz: [],
                    steps: [],
                    order: newOrder
                };
                originalEditingSkill = JSON.parse(JSON.stringify(currentEditingSkill)); // Store original data
                showEditForm();
            } catch (error) {
                console.error("Error calculating order for new skill: ", error);
                alert("Error initializing new skill. Please try again.");
            }
        }

        // Edit existing skill
        function editSkill(skillId) {
            currentEditingSkill = skillsData.find(skill => skill.id === skillId);
            originalEditingSkill = JSON.parse(JSON.stringify(currentEditingSkill)); // Store original data
            if (currentEditingSkill) {
                showEditForm();
            }
        }

        // Show edit form
        function showEditForm() {
            // Populate the form fields based on currentEditingSkill
            document.getElementById('edit-skill-name').value = currentEditingSkill.name || '';
            document.getElementById('edit-skill-description').value = currentEditingSkill.description || '';
            document.getElementById('edit-skill-theory').value = currentEditingSkill.theory || '';
            document.getElementById('skill-image-url-hidden').value = currentEditingSkill.imageUrl || ''; // Store existing URL

            // Set image preview if URL exists
            const preview = document.getElementById('skill-image-preview');
            if (currentEditingSkill.imageUrl) {
                preview.innerHTML = `<img src="${currentEditingSkill.imageUrl}" alt="Skill Icon">`;
            } else {
                preview.innerHTML = 'No image selected';
            }

            // Populate tools section
            const toolsContainer = document.getElementById('tools-container');
            toolsContainer.innerHTML = ''; // Clear existing
            if (Array.isArray(currentEditingSkill.tools)) {
                currentEditingSkill.tools.forEach((tool, index) => {
                    addTool(index); // Pass index to addTool to reuse IDs
                });
            } else {
                // If tools is not an array or doesn't exist, start with one empty field
                addTool();
            }

            // Clear and populate steps
            const stepsContainer = document.getElementById('steps-container');
            stepsContainer.innerHTML = '';
            if (Array.isArray(currentEditingSkill.steps)) {
                currentEditingSkill.steps.forEach((step, index) => {
                    addStep(index);
                });
            } else {
                addStep();
            }

            // Clear and populate quiz
            const quizContainer = document.getElementById('quiz-container');
            quizContainer.innerHTML = '';
            if (Array.isArray(currentEditingSkill.quiz)) {
                currentEditingSkill.quiz.forEach((q, index) => {
                    addQuestion(index);
                });
            } else {
                addQuestion();
            }

            document.getElementById('edit-skill-form').style.display = 'block';
            // Scroll to top of form
            document.getElementById('edit-skill-form').scrollIntoView({ behavior: 'smooth' });
        }

        // Function to preview skill image
        function previewSkillImage(input) {
            const preview = document.getElementById('skill-image-preview');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" alt="Skill Icon Preview">`;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Add Tool function
        function addTool(index = null) {
            const container = document.getElementById('tools-container');
            const toolIndex = index !== null ? index : container.children.length;
            const tool = currentEditingSkill.tools[toolIndex] || { name: '', imageUrl: '' };

            const toolCard = document.createElement('div');
            toolCard.className = 'tool-card';
            toolCard.id = `tool-card-${toolIndex}`;
            toolCard.innerHTML = `
                <div class="tool-card-header">
                    <h4>Tool ${toolIndex + 1}</h4>
                    <button class="remove-tool-btn" onclick="removeTool(${toolIndex})">X</button>
                </div>
                <div class="form-col">
                    <label for="tool-name-${toolIndex}">Name *</label>
                    <input type="text" id="tool-name-${toolIndex}" value="${tool.name}" placeholder="Tool name" required>
                </div>
                <div class="form-col">
                    <label for="tool-image-${toolIndex}">Image</label>
                    <input type="file" id="tool-image-${toolIndex}" accept="image/*" onchange="previewToolImage(this, ${toolIndex})">
                    <div class="image-upload-preview" id="tool-image-preview-${toolIndex}">
                        ${tool.imageUrl ? `<img src="${tool.imageUrl}" alt="Tool Image">` : 'No image selected'}
                    </div>
                    <input type="hidden" id="tool-image-url-hidden-${toolIndex}" value="${tool.imageUrl}">
                </div>
            `;
            container.appendChild(toolCard);
        }

        // Function to preview individual tool image
        function previewToolImage(input, toolIndex) {
            const previewId = `tool-image-preview-${toolIndex}`;
            const preview = document.getElementById(previewId);
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" alt="Tool Image Preview">`;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Remove Tool function
        function removeTool(index) {
            const toolCard = document.getElementById(`tool-card-${index}`);
            if (toolCard) {
                toolCard.remove();
                // Shift subsequent tool card IDs down if needed for display
                // The data array index will be handled during save
            }
        }

        // Add Step function
        function addStep(index = null) {
            const container = document.getElementById('steps-container');
            const stepIndex = index !== null ? index : container.children.length;
            const step = currentEditingSkill.steps[stepIndex] || { description: '', imageUrl: '' };

            const stepCard = document.createElement('div');
            stepCard.className = 'step-card';
            stepCard.id = `step-card-${stepIndex}`;
            stepCard.innerHTML = `
                <div class="step-card-header">
                    <h4>Step ${stepIndex + 1}</h4>
                    <button class="remove-tool-btn" onclick="removeStep(${stepIndex})">X</button>
                </div>
                <div class="form-col">
                    <label for="step-desc-${stepIndex}">Description *</label>
                    <textarea id="step-desc-${stepIndex}" placeholder="Step description..." required>${step.description}</textarea>
                </div>
                <div class="form-col">
                    <label for="step-image-${stepIndex}">Image</label>
                    <input type="file" id="step-image-${stepIndex}" accept="image/*" onchange="previewStepImage(this, ${stepIndex})">
                    <div class="image-upload-preview" id="step-image-preview-${stepIndex}">
                        ${step.imageUrl ? `<img src="${step.imageUrl}" alt="Step Image">` : 'No image selected'}
                    </div>
                    <input type="hidden" id="step-image-url-hidden-${stepIndex}" value="${step.imageUrl}">
                </div>
            `;
            container.appendChild(stepCard);
        }

        // Function to preview individual step image
        function previewStepImage(input, stepIndex) {
            const previewId = `step-image-preview-${stepIndex}`;
            const preview = document.getElementById(previewId);
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" alt="Step Image Preview">`;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Remove Step function
        function removeStep(index) {
            const stepCard = document.getElementById(`step-card-${index}`);
            if (stepCard) {
                stepCard.remove();
            }
        }

        // Add Question function
        function addQuestion(index = null) {
            const container = document.getElementById('quiz-container');
            const questionIndex = index !== null ? index : container.children.length;
            const question = currentEditingSkill.quiz[questionIndex] || { question: '', options: ['', '', '', ''], answer: 0 };

            const questionCard = document.createElement('div');
            questionCard.className = 'step-card';
            questionCard.id = `question-card-${questionIndex}`;
            questionCard.innerHTML = `
                <div class="step-card-header">
                    <h4>Question ${questionIndex + 1}</h4>
                    <button class="remove-tool-btn" onclick="removeQuestion(${questionIndex})">X</button>
                </div>
                <div class="form-col">
                    <label for="question-text-${questionIndex}">Question *</label>
                    <textarea id="question-text-${questionIndex}" placeholder="Enter question..." required>${question.question}</textarea>
                </div>
                <div class="form-col">
                    <label>Options *</label>
                    ${question.options.map((opt, optIdx) => `
                        <div class="form-row">
                            <div class="form-col">
                                <input type="text" id="question-option-${questionIndex}-${optIdx}" value="${opt}" placeholder="Option ${String.fromCharCode(65 + optIdx)}" required>
                            </div>
                            <div class="form-col" style="display: flex; align-items: center;">
                                <input type="radio" name="answer-${questionIndex}" id="answer-${questionIndex}-${optIdx}" value="${optIdx}" ${optIdx === question.answer ? 'checked' : ''}>
                                <label for="answer-${questionIndex}-${optIdx}">Correct Answer</label>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            container.appendChild(questionCard);
        }

        // Remove Question function
        function removeQuestion(index) {
            const questionCard = document.getElementById(`question-card-${index}`);
            if (questionCard) {
                questionCard.remove();
            }
        }

        // Upload tool image to Firebase Storage
        async function uploadToolImage(file) {
            if (!file) return null;
            const storageRef = storage.ref();
            const fileRef = storageRef.child(`tool_images/${Date.now()}_${file.name}`);
            try {
                await fileRef.put(file);
                const downloadURL = await fileRef.getDownloadURL();
                return downloadURL;
            } catch (error) {
                console.error("Error uploading tool image: ", error);
                return null;
            }
        }

        // Save skill (complete logic)
        async function saveSkill() {
            console.log("Saving skill...", currentEditingSkill);

            // Gather data from form fields
            const name = document.getElementById('edit-skill-name').value.trim();
            const description = document.getElementById('edit-skill-description').value.trim();
            const theory = document.getElementById('edit-skill-theory').value.trim();
            const imageFile = document.getElementById('edit-skill-image').files[0];
            let imageUrl = document.getElementById('skill-image-url-hidden').value; // Get existing URL

            if (!name || !description || !theory) {
                alert("Please fill in all required fields (Name, Description, Theory).");
                return;
            }

            // Upload new skill image if selected
            if (imageFile) {
                console.log("Uploading new skill image...");
                imageUrl = await uploadToolImage(imageFile);
                if (!imageUrl) {
                    alert("Error uploading skill image. Skill not saved.");
                    return;
                }
            }

            // Prepare tools data with potential image uploads
            const toolsContainer = document.getElementById('tools-container');
            const numToolInputs = toolsContainer.children.length;
            const tools = [];
            for (let i = 0; i < numToolInputs; i++) {
                const nameInput = document.getElementById(`tool-name-${i}`);
                const imageFileInput = document.getElementById(`tool-image-${i}`);
                let toolImageUrl = document.getElementById(`tool-image-url-hidden-${i}`).value; // Get existing URL
                const toolImageFile = imageFileInput ? imageFileInput.files[0] : null; // Get the file object if input exists

                if (toolImageFile) { // If a new file is selected for this tool
                    console.log(`Uploading new image for tool ${i + 1}...`); // Debug log
                    toolImageUrl = await uploadToolImage(toolImageFile); // Upload new file if selected
                    if (!toolImageUrl) {
                        alert(`Error uploading image for tool ${i + 1}. Skill not saved.`);
                        console.error(`Failed to get tool image URL for tool ${i + 1}`); // Debug log
                        return; // Stop saving if upload fails
                    }
                }

                if (nameInput && nameInput.value.trim()) {
                    tools.push({
                        name: nameInput.value.trim(),
                        imageUrl: toolImageUrl // Use the URL from hidden input or newly uploaded URL
                    });
                }
            }

            // Prepare steps data with potential image uploads
            const stepsContainer = document.getElementById('steps-container');
            const numStepInputs = stepsContainer.children.length;
            const steps = [];
            for (let i = 0; i < numStepInputs; i++) {
                const descInput = document.getElementById(`step-desc-${i}`);
                const imageFileInput = document.getElementById(`step-image-${i}`);
                let stepImageUrl = document.getElementById(`step-image-url-hidden-${i}`).value; // Get existing URL
                const stepImageFile = imageFileInput ? imageFileInput.files[0] : null;

                if (stepImageFile) {
                    console.log(`Uploading new image for step ${i + 1}...`); // Debug log
                    stepImageUrl = await uploadToolImage(stepImageFile);
                    if (!stepImageUrl) {
                        alert(`Error uploading image for step ${i + 1}. Skill not saved.`);
                        console.error(`Failed to get step image URL for step ${i + 1}`); // Debug log
                        return; // Stop saving if upload fails
                    }
                }

                if (descInput && descInput.value.trim()) {
                    steps.push({
                        description: descInput.value.trim(),
                        imageUrl: stepImageUrl
                    });
                }
            }

            // Prepare quiz data
            const quizContainer = document.getElementById('quiz-container');
            const numQuestionInputs = quizContainer.children.length;
            const quiz = [];
            for (let i = 0; i < numQuestionInputs; i++) {
                const questionInput = document.getElementById(`question-text-${i}`);
                const questionText = questionInput ? questionInput.value.trim() : '';
                if (!questionText) continue; // Skip empty questions

                const options = [];
                let correctAnswer = 0;
                for (let j = 0; j < 4; j++) { // Assuming 4 options A, B, C, D
                    const optionInput = document.getElementById(`question-option-${i}-${j}`);
                    const optionChecked = document.getElementById(`answer-${i}-${j}`).checked;
                    if (optionInput) {
                        options.push(optionInput.value.trim());
                        if (optionChecked) {
                            correctAnswer = j;
                        }
                    }
                }

                quiz.push({
                    question: questionText,
                    options: options,
                    answer: correctAnswer
                });
            }

            // Construct the final skill object
            const skillToSave = {
                name: name,
                description: description,
                theory: theory,
                imageUrl: imageUrl, // Use the potentially updated imageUrl
                tools: tools,
                steps: steps,
                quiz: quiz,
                order: currentEditingSkill.order // Preserve the order
            };

            try {
                let docRef;
                if (currentEditingSkill.id) { // If editing existing skill
                    docRef = db.collection("skills").doc(currentEditingSkill.id);
                    await docRef.update(skillToSave);
                    console.log("Skill updated successfully!");
                } else { // If adding new skill
                    docRef = db.collection("skills").doc(); // Create a new doc reference
                    skillToSave.order = currentEditingSkill.order; // Ensure order is set
                    await docRef.set(skillToSave);
                    console.log("New skill added successfully!");
                }
                // Reset the editing state
                currentEditingSkill = null;
                originalEditingSkill = null;
                cancelEdit(); // Close form after saving
            } catch (error) {
                console.error("Error saving skill: ", error);
                alert("Error saving skill: " + error.message);
            }
        }


        // Hide edit form
        function cancelEdit() {
            document.getElementById('edit-skill-form').style.display = 'none';
            // Reset form data if cancelled without saving?
            // currentEditingSkill = originalEditingSkill;
        }

        // Delete skill
        async function deleteSkill(skillId) {
            if (!confirm('Are you sure you want to delete this skill?')) return;
            try {
                await db.collection("skills").doc(skillId).delete();
                console.log("Skill deleted successfully!");
            } catch (error) {
                console.error("Error deleting skill: ", error);
                alert("Failed to delete skill: " + error.message);
            }
        }

        // Load users management in admin panel
        function loadUsersManagement() {
            const usersContent = document.getElementById('usersContent');
            usersContent.innerHTML = '';

            // Group users by course
            const courses = {};
            usersData.forEach(user => {
                if (!courses[user.course]) {
                    courses[user.course] = [];
                }
                courses[user.course].push(user);
            });

            // Render each course group
            Object.keys(courses).forEach(course => {
                const courseGroup = document.createElement('div');
                courseGroup.className = 'course-group';
                courseGroup.innerHTML = `
                    <h3 class="course-title">${course}</h3>
                    <div class="user-list" id="course-${course.replace(/\s+/g, '-')}">
                        <!-- Users will be added here -->
                    </div>
                `;
                usersContent.appendChild(courseGroup);

                // Add users to this course
                const userList = document.getElementById(`course-${course.replace(/\s+/g, '-')}`);
                courses[course].forEach(user => {
                    const userCard = document.createElement('div');
                    userCard.className = 'user-card';
                    userCard.innerHTML = `
                        <div class="user-details">
                            <div class="user-name">${user.name}</div>
                            <div class="user-rank">${user.rank}</div>
                            <div class="user-course">${user.course}</div>
                            <div class="user-email">${user.email}</div> <!-- Optional: Display email -->
                        </div>
                        <div class="user-actions">
                            <button class="action-btn btn-warning" onclick="editUser('${user.id}')">Edit</button>
                            <button class="action-btn btn-danger" onclick="deleteUser('${user.id}', '${user.name}')">Delete</button>
                        </div>
                    `;
                    userList.appendChild(userCard);
                });
            });
        }

        // Edit User Modal Functions
        function editUser(userId) {
            const user = usersData.find(u => u.id === userId);
            if (!user) return;
            document.getElementById('edit-user-name').value = user.name;
            document.getElementById('edit-user-rank').value = user.rank;
            document.getElementById('edit-user-course').value = user.course;
            document.getElementById('editUserModal').style.display = 'flex';
        }

        async function saveEditedUser() {
            const name = document.getElementById('edit-user-name').value.toUpperCase();
            const rank = document.getElementById('edit-user-rank').value;
            const course = document.getElementById('edit-user-course').value;

            if (!name || !rank || !course) {
                alert('Please fill in all fields');
                return;
            }

            try {
                await db.collection("users").doc(editingUserId).update({
                    name: name,
                    rank: rank,
                    course: course
                });
                closeEditUserModal();
                // Optionally reload users data - handled by onSnapshot listener
            } catch (error) {
                console.error("Error updating user: ", error);
                alert('Error updating user: ' + error.message);
            }
        }

        function closeEditUserModal() {
            document.getElementById('editUserModal').style.display = 'none';
            editingUserId = null;
        }

        // Delete User
        async function deleteUser(userId, userName) {
            if (!confirm(`Are you sure you want to delete the user "${userName}"?`)) {
                return;
            }
            try {
                await db.collection("users").doc(userId).delete();
                // Optionally revoke admin access if they had it
                await db.collection("admins").doc(userId).delete().catch(() => {}); // Ignore error if no admin doc
            } catch (error) {
                console.error("Error deleting user: ", error);
                alert('Error deleting user: ' + error.message);
            }
        }

        // Load Signup Settings
        async function loadSignupSettings() {
            try {
                // Load Ranks
                const ranksSnapshot = await db.collection("ranks").orderBy("order").get();
                ranksData = ranksSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const ranksList = document.getElementById('ranksList');
                ranksList.innerHTML = '';
                ranksData.forEach((rank, index) => {
                    const isTop = index === 0;
                    const isBottom = index === ranksData.length - 1;
                    const itemEntry = document.createElement('div');
                    itemEntry.className = 'item-entry';
                    itemEntry.innerHTML = `
                        <span>${rank.name}</span>
                        <div class="setting-actions">
                            <button class="btn btn-primary" ${isTop ? 'disabled' : ''} onclick="moveRankUp('${rank.id}', ${rank.order})" title="Move Up"><i class="fas fa-arrow-up"></i></button>
                            <button class="btn btn-primary" ${isBottom ? 'disabled' : ''} onclick="moveRankDown('${rank.id}', ${rank.order})" title="Move Down"><i class="fas fa-arrow-down"></i></button>
                            <button class="btn btn-danger" onclick="deleteRank('${rank.id}', '${rank.name}')"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    ranksList.appendChild(itemEntry);
                });

                // Load Courses
                const coursesSnapshot = await db.collection("courses").orderBy("order").get();
                coursesData = coursesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const coursesList = document.getElementById('coursesList');
                coursesList.innerHTML = '';
                coursesData.forEach((course, index) => {
                    const isTop = index === 0;
                    const isBottom = index === coursesData.length - 1;
                    const itemEntry = document.createElement('div');
                    itemEntry.className = 'item-entry';
                    itemEntry.innerHTML = `
                        <span>${course.name}</span>
                        <div class="setting-actions">
                            <button class="btn btn-primary" ${isTop ? 'disabled' : ''} onclick="moveCourseUp('${course.id}', ${course.order})" title="Move Up"><i class="fas fa-arrow-up"></i></button>
                            <button class="btn btn-primary" ${isBottom ? 'disabled' : ''} onclick="moveCourseDown('${course.id}', ${course.order})" title="Move Down"><i class="fas fa-arrow-down"></i></button>
                            <button class="btn btn-danger" onclick="deleteCourse('${course.id}', '${course.name}')"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    coursesList.appendChild(itemEntry);
                });
            } catch (error) {
                console.error("Error loading signup settings: ", error);
                alert("Error loading signup settings: " + error.message);
            }
        }

        // Add Rank
        async function addRank() {
            const newRankInput = document.getElementById('newRankInput');
            const newRank = newRankInput.value.trim();
            if (!newRank) {
                document.getElementById('rankMessage').textContent = 'Please enter a rank name';
                setTimeout(() => { document.getElementById('rankMessage').textContent = ''; }, 3000);
                return;
            }

            // Check if rank already exists
            const existingRank = ranksData.find(r => r.name === newRank);
            if (existingRank) {
                document.getElementById('rankMessage').textContent = 'This rank already exists';
                setTimeout(() => { document.getElementById('rankMessage').textContent = ''; }, 3000);
                return;
            }

            try {
                // Calculate the new order value based on the current number of ranks
                const newOrder = ranksData.length;
                // Add new rank to Firestore
                await db.collection("ranks").add({
                    name: newRank,
                    order: newOrder
                });
                // Clear input
                newRankInput.value = '';
                document.getElementById('rankMessage').textContent = 'Rank added successfully!';
                setTimeout(() => { document.getElementById('rankMessage').textContent = ''; }, 3000);
            } catch (error) {
                console.error("Error adding rank: ", error);
                document.getElementById('rankMessage').textContent = 'Error adding rank: ' + error.message;
                setTimeout(() => { document.getElementById('rankMessage').textContent = ''; }, 3000);
            }
        }

        // Add Course
        async function addCourse() {
            const newCourseInput = document.getElementById('newCourseInput');
            const newCourse = newCourseInput.value.trim();
            if (!newCourse) {
                document.getElementById('courseMessage').textContent = 'Please enter a course name';
                setTimeout(() => { document.getElementById('courseMessage').textContent = ''; }, 3000);
                return;
            }

            // Check if course already exists
            const existingCourse = coursesData.find(c => c.name === newCourse);
            if (existingCourse) {
                document.getElementById('courseMessage').textContent = 'This course already exists';
                setTimeout(() => { document.getElementById('courseMessage').textContent = ''; }, 3000);
                return;
            }

            try {
                // Calculate the new order value based on the current number of courses
                const newOrder = coursesData.length;
                // Add new course to Firestore
                await db.collection("courses").add({
                    name: newCourse,
                    order: newOrder
                });
                // Clear input
                newCourseInput.value = '';
                document.getElementById('courseMessage').textContent = 'Course added successfully!';
                setTimeout(() => { document.getElementById('courseMessage').textContent = ''; }, 3000);
            } catch (error) {
                console.error("Error adding course: ", error);
                document.getElementById('courseMessage').textContent = 'Error adding course: ' + error.message;
                setTimeout(() => { document.getElementById('courseMessage').textContent = ''; }, 3000);
            }
        }

        // Move Rank Up
        async function moveRankUp(rankId, currentOrder) {
            if (currentOrder <= 0) return; // Already at the top
            const targetOrder = currentOrder - 1;
            try {
                // Find the rank that currently has the target order
                const targetRankSnapshot = await db.collection("ranks").where("order", "==", targetOrder).limit(1).get();
                if (targetRankSnapshot.empty) {
                    console.error("Target rank for swapping not found for order:", targetOrder);
                    return;
                }
                const targetRankDoc = targetRankSnapshot.docs[0];
                const targetRankId = targetRankDoc.id;

                // Perform batch update to swap orders
                const batch = db.batch();
                batch.update(db.collection("ranks").doc(rankId), { order: targetOrder });
                batch.update(db.collection("ranks").doc(targetRankId), { order: currentOrder });
                await batch.commit();
            } catch (error) {
                console.error("Error moving rank up: ", error);
                alert("Failed to move rank up: " + error.message);
            }
        }

        // Move Rank Down
        async function moveRankDown(rankId, currentOrder) {
             if (currentOrder < 0) return; // Check for valid starting order
             const maxOrder = ranksData.length - 1;
             if (currentOrder >= maxOrder) return; // Already at the bottom based on known data
             const targetOrder = currentOrder + 1;
             try {
                 // Find the rank that currently has the target order
                 const targetRankSnapshot = await db.collection("ranks").where("order", "==", targetOrder).limit(1).get();
                 if (targetRankSnapshot.empty) {
                     console.error("Target rank for swapping not found for order:", targetOrder);
                     return;
                 }
                 const targetRankDoc = targetRankSnapshot.docs[0];
                 const targetRankId = targetRankDoc.id;

                 // Perform batch update to swap orders
                 const batch = db.batch();
                 batch.update(db.collection("ranks").doc(rankId), { order: targetOrder });
                 batch.update(db.collection("ranks").doc(targetRankId), { order: currentOrder });
                 await batch.commit();
             } catch (error) {
                 console.error("Error moving rank down: ", error);
                 alert("Failed to move rank down: " + error.message);
             }
         }

        // Move Course Up
        async function moveCourseUp(courseId, currentOrder) {
            if (currentOrder <= 0) return; // Already at the top
            const targetOrder = currentOrder - 1;
            try {
                // Find the course that currently has the target order
                const targetCourseSnapshot = await db.collection("courses").where("order", "==", targetOrder).limit(1).get();
                if (targetCourseSnapshot.empty) {
                    console.error("Target course for swapping not found for order:", targetOrder);
                    return;
                }
                const targetCourseDoc = targetCourseSnapshot.docs[0];
                const targetCourseId = targetCourseDoc.id;

                // Perform batch update to swap orders
                const batch = db.batch();
                batch.update(db.collection("courses").doc(courseId), { order: targetOrder });
                batch.update(db.collection("courses").doc(targetCourseId), { order: currentOrder });
                await batch.commit();
            } catch (error) {
                console.error("Error moving course up: ", error);
                alert("Failed to move course up: " + error.message);
            }
        }

        // Move Course Down
        async function moveCourseDown(courseId, currentOrder) {
             if (currentOrder < 0) return; // Check for valid starting order
             const maxOrder = coursesData.length - 1;
             if (currentOrder >= maxOrder) return; // Already at the bottom based on known data
             const targetOrder = currentOrder + 1;
             try {
                 // Find the course that currently has the target order
                 const targetCourseSnapshot = await db.collection("courses").where("order", "==", targetOrder).limit(1).get();
                 if (targetCourseSnapshot.empty) {
                     console.error("Target course for swapping not found for order:", targetOrder);
                     return;
                 }
                 const targetCourseDoc = targetCourseSnapshot.docs[0];
                 const targetCourseId = targetCourseDoc.id;

                 // Perform batch update to swap orders
                 const batch = db.batch();
                 batch.update(db.collection("courses").doc(courseId), { order: targetOrder });
                 batch.update(db.collection("courses").doc(targetCourseId), { order: currentOrder });
                 await batch.commit();
             } catch (error) {
                 console.error("Error moving course down: ", error);
                 alert("Failed to move course down: " + error.message);
             }
         }

        // Delete Rank
        async function deleteRank(rankId, rankName) {
            if (!confirm(`Are you sure you want to delete the rank "${rankName}"?`)) {
                return;
            }
            try {
                await db.collection("ranks").doc(rankId).delete();
                document.getElementById('rankMessage').textContent = 'Rank deleted successfully!';
                setTimeout(() => { document.getElementById('rankMessage').textContent = ''; }, 3000);
            } catch (error) {
                console.error("Error deleting rank: ", error);
                document.getElementById('rankMessage').textContent = 'Error deleting rank: ' + error.message;
                setTimeout(() => { document.getElementById('rankMessage').textContent = ''; }, 3000);
            }
        }

        // Delete Course
        async function deleteCourse(courseId, courseName) {
            if (!confirm(`Are you sure you want to delete the course "${courseName}"?`)) {
                return;
            }
            try {
                await db.collection("courses").doc(courseId).delete();
                document.getElementById('courseMessage').textContent = 'Course deleted successfully!';
                setTimeout(() => { document.getElementById('courseMessage').textContent = ''; }, 3000);
            } catch (error) {
                console.error("Error deleting course: ", error);
                document.getElementById('courseMessage').textContent = 'Error deleting course: ' + error.message;
                setTimeout(() => { document.getElementById('courseMessage').textContent = ''; }, 3000);
            }
        }

        // Admin Access Management
        async function grantAdminAccess() {
            const emailInput = document.getElementById('admin-email');
            const email = emailInput.value.trim();
            if (!email) {
                alert('Please enter an email address.');
                return;
            }

            try {
                // Find user by email
                const userQuery = await db.collection("users").where("email", "==", email).limit(1).get();
                if (userQuery.empty) {
                    alert('No user found with this email address.');
                    return;
                }
                const userDoc = userQuery.docs[0];
                const userId = userDoc.id;

                // Grant admin access by adding a document to the 'admins' collection
                await db.collection("admins").doc(userId).set({
                    grantedBy: currentUser.id,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                emailInput.value = '';
                showGrantSuccessModal('Admin access granted successfully for ' + email + '!');
                loadAdminList(); // Reload the admin list immediately
            } catch (error) {
                console.error("Error granting admin access: ", error);
                alert('Error granting admin access: ' + error.message); // You could also use a modal for errors
            }
        }

        async function loadAdminList() {
            try {
                const snapshot = await db.collection("admins").get();
                const adminList = document.getElementById('adminList');
                // - IMPROVED CONTENT GENERATION -
                let adminItemsHTML = '<h3 class="section-title">Current Admins</h3>';
                if (snapshot.empty) {
                    adminItemsHTML += '<p>No admins found.</p>';
                } else {
                    // Fetch user details for each admin UID to get email/name if needed
                    const adminPromises = snapshot.docs.map(async (doc) => {
                        const adminId = doc.id; // This is the user UID
                        const userData = await db.collection("users").doc(adminId).get();
                        if (userData.exists) {
                            return { uid: adminId, email: userData.data().email, name: userData.data().name }; // Include name if desired
                        } else {
                            // Fallback if user data doesn't exist (shouldn't happen if cleanup is done properly)
                            return { uid: adminId, email: 'Unknown (User Deleted?)', name: 'Unknown' };
                        }
                    });
                    const adminDetails = await Promise.all(adminPromises);

                    adminDetails.forEach(detail => {
                        if (detail.email !== 'jacksparrow6194@gmail.com') { // Exclude super admin
                             adminItemsHTML += `
                                 <div class="admin-list-item">
                                     <div>
                                         <strong>${detail.name}</strong><br>
                                         <small>${detail.email}</small>
                                     </div>
                                     <button class="btn" onclick="revokeAdminAccess('${detail.uid}', '${detail.email}')">Revoke</button>
                                 </div>
                             `;
                         }
                    });
                }
                adminList.innerHTML = adminItemsHTML;
            } catch (error) {
                console.error("Error loading admin list: ", error);
                document.getElementById('adminList').innerHTML = '<p>Error loading admin list.</p>';
            }
        }

        function revokeAdminAccess(uid, email) {
            pendingRevokeAdminId = uid;
            pendingRevokeAdminEmail = email;
            document.getElementById('confirm-revoke-message').textContent = `Are you sure you want to revoke admin access for ${email}?`;
            document.getElementById('confirmRevokeModal').style.display = 'flex';
        }

        async function performRevokeAdmin() {
            if (!pendingRevokeAdminId) return;
            try {
                await db.collection("admins").doc(pendingRevokeAdminId).delete();
                closeConfirmRevokeModal();
                // Reload admin list
                if (document.getElementById('adminAccessTab').classList.contains('active')) {
                    loadAdminList();
                }
            } catch (error) {
                console.error("Error revoking admin access: ", error);
                document.getElementById('revoke-confirm-error').textContent = 'Error revoking admin access: ' + error.message;
            }
        }

        function closeConfirmRevokeModal() {
            document.getElementById('confirmRevokeModal').style.display = 'none';
            pendingRevokeAdminId = null;
            pendingRevokeAdminEmail = null;
            document.getElementById('revoke-confirm-error').textContent = '';
        }

        function showGrantSuccessModal(message) {
            document.getElementById('grant-success-message').textContent = message;
            document.getElementById('grantSuccessModal').style.display = 'flex';
        }

        function closeGrantSuccessModal() {
            document.getElementById('grantSuccessModal').style.display = 'none';
            // Optional: Clear the message when closed
            document.getElementById('grant-success-message').textContent = "Admin access granted successfully!";
            // Optional: Clear any potential error message
            document.getElementById('grant-success-error').textContent = '';
        }

        // Profile & Navigation Functions
        function toggleProfilePopup() {
            const popup = document.getElementById('profilePopup');
            if (popup.style.display === 'block') {
                popup.style.display = 'none';
            } else {
                popup.style.display = 'block';
                // Update profile info in popup
                document.getElementById('popup-name-display').textContent = currentUser.name;
                document.getElementById('popup-rank-display').textContent = currentUser.rank;
                document.getElementById('popup-course-display').textContent = currentUser.course;
                document.getElementById('popup-email-display').textContent = currentUser.email;
                // Update rank dropdown in popup
                updateDropdowns();
            }
        }

        function updateDropdowns() {
            const rankSelect = document.getElementById('edit-rank');
            rankSelect.innerHTML = ''; // Clear existing options
            ranksData.sort((a, b) => (a.order !== undefined && a.order !== null ? a.order : Infinity) - (b.order !== undefined && b.order !== null ? b.order : Infinity)).forEach(rank => {
                const option = document.createElement('option');
                option.value = rank.name;
                option.text = rank.name;
                if (rank.name === currentUser.rank) {
                    option.selected = true;
                }
                rankSelect.appendChild(option);
            });
        }

        function updateProfileDisplay() {
            if (currentUser) {
                document.getElementById('popup-name-display').textContent = currentUser.name;
                document.getElementById('popup-rank-display').textContent = currentUser.rank;
                document.getElementById('popup-course-display').textContent = currentUser.course;
                document.getElementById('popup-email-display').textContent = currentUser.email;
            }
        }

        async function updateOwnRank() {
            const newRank = document.getElementById('edit-rank').value;
            if (!newRank || !currentUser) return;

            try {
                await db.collection("users").doc(currentUser.id).update({
                    rank: newRank
                });
                currentUser.rank = newRank;
                localStorage.setItem('userRank', newRank);
                updateProfileDisplay();
                toggleProfilePopup(); // Close popup after update
                alert('Rank updated successfully!');
            } catch (error) {
                console.error("Error updating rank: ", error);
                alert('Error updating rank: ' + error.message);
            }
        }

        // Switch to user interface (from admin)
        function switchToUserInterface() {
            wasInAdminView = true;
            document.getElementById('adminDashboard').style.display = 'none';
            document.getElementById('userInterface').style.display = 'block';
            document.getElementById('adminSwitchBtn').style.display = 'none';
            document.getElementById('adminBackBtn').style.display = 'block';
        }

        // Switch back to admin interface (from user)
        function switchToAdminInterface() {
            document.getElementById('userInterface').style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'block';
            document.getElementById('adminSwitchBtn').style.display = 'block';
            document.getElementById('adminBackBtn').style.display = 'none';
            if (wasInAdminView) {
                showSection('dashboard'); // Show dashboard when returning from user view
                wasInAdminView = false;
            }
        }

        // Logout function
        async function logout() {
            try {
                await auth.signOut();
                currentUser = null;
                isAdmin = false;
                document.getElementById('adminDashboard').style.display = 'none';
                document.getElementById('userInterface').style.display = 'none';
                document.getElementById('profilePopup').style.display = 'none';
                document.getElementById('profileBtn').style.display = 'none';
                document.getElementById('adminSwitchBtn').style.display = 'none';
                document.getElementById('adminBackBtn').style.display = 'none';
                openLoginPopup(); // Re-open login popup
            } catch (error) {
                console.error("Error signing out: ", error);
                alert("An error occurred during logout. Please try again.");
            }
        }

        // Settings tab functionality
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', function() {
                const tabName = this.getAttribute('data-tab');
                // Remove active class from all buttons and tabs
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                // Add active class to clicked button and corresponding tab
                this.classList.add('active');
                document.getElementById(`${tabName}Tab`).classList.add('active');

                if (tabName === 'signupSettings') {
                    loadSignupSettings();
                } else if (tabName === 'adminAccess') {
                    loadAdminList();
                }
            });
        });

        // --- AUTHENTICATION LOGIC ---

        // Open login popup
        function openLoginPopup() {
            currentAuthMode = 'login';
            renderAuthForm();
            document.getElementById('loginPopup').style.display = 'flex';
        }

        // Close login popup
        function closeLoginPopup() {
            document.getElementById('loginPopup').style.display = 'none';
        }

        // Render authentication forms based on mode
        function renderAuthForm() {
            const container = document.getElementById('authContainer');
            let html = '';
            if (currentAuthMode === 'login') {
                html = `
                    <form id="loginForm" class="login-form">
                        <div class="form-group-modal">
                            <label for="email">Email</label>
                            <input type="email" id="email" required>
                        </div>
                        <div class="form-group-modal">
                            <label for="password">Password</label>
                            <input type="password" id="password" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Login</button>
                        <div class="form-toggle">
                            <a href="#" onclick="currentAuthMode='signup'; renderAuthForm();">Don't have an account? Sign Up</a><br>
                            <a href="#" onclick="currentAuthMode='forgot'; renderAuthForm();">Forgot Password?</a>
                        </div>
                        <div class="error-message" id="auth-error"></div>
                    </form>
                `;
            } else if (currentAuthMode === 'signup') {
                html = `
                    <form id="signupForm" class="signup-form">
                        <div class="form-group-modal">
                            <label for="signup-email">Email</label>
                            <input type="email" id="signup-email" required>
                        </div>
                        <div class="form-group-modal">
                            <label for="signup-password">Password</label>
                            <input type="password" id="signup-password" required>
                        </div>
                        <div class="form-group-modal">
                            <label for="signup-name">Full Name</label>
                            <input type="text" id="signup-name" required>
                        </div>
                        <div class="form-group-modal">
                            <label for="signup-rank">Rank</label>
                            <select id="signup-rank" required>
                                <!-- Options will be populated by JS -->
                            </select>
                        </div>
                        <div class="form-group-modal">
                            <label for="signup-course">Course</label>
                            <select id="signup-course" required>
                                <!-- Options will be populated by JS -->
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Sign Up</button>
                        <div class="form-toggle">
                            <a href="#" onclick="currentAuthMode='login'; renderAuthForm();">Already have an account? Login</a>
                        </div>
                        <div class="error-message" id="auth-error"></div>
                    </form>
                `;
                // Populate signup dropdowns after HTML is set
                setTimeout(populateSignupDropdowns, 0);
            } else if (currentAuthMode === 'forgot') {
                html = `
                    <form id="forgotForm" class="forgot-form">
                        <div class="form-group-modal">
                            <label for="forgot-email">Email</label>
                            <input type="email" id="forgot-email" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Send Reset Email</button>
                        <div class="form-toggle">
                            <a href="#" onclick="currentAuthMode='login'; renderAuthForm();">Back to Login</a>
                        </div>
                        <div class="error-message" id="auth-error"></div>
                    </form>
                `;
            }
            container.innerHTML = html;

            // Attach event listeners after rendering
            if (currentAuthMode === 'login') {
                document.getElementById('loginForm').addEventListener('submit', handleLogin);
            } else if (currentAuthMode === 'signup') {
                document.getElementById('signupForm').addEventListener('submit', handleSignup);
            } else if (currentAuthMode === 'forgot') {
                document.getElementById('forgotForm').addEventListener('submit', handleForgotPassword);
            }
        }

        // Populate signup dropdowns
        async function populateSignupDropdowns() {
            // Wait for ranksData and coursesData to be loaded
            if (ranksData.length === 0 || coursesData.length === 0) {
                // If data isn't ready, wait a bit and try again
                setTimeout(populateSignupDropdowns, 100);
                return;
            }

            const rankSelect = document.getElementById('signup-rank');
            rankSelect.innerHTML = ''; // Clear existing options
            ranksData.sort((a, b) => (a.order !== undefined && a.order !== null ? a.order : Infinity) - (b.order !== undefined && b.order !== null ? b.order : Infinity)).forEach(rank => {
                const option = document.createElement('option');
                option.value = rank.name;
                option.text = rank.name;
                rankSelect.appendChild(option);
            });

            const courseSelect = document.getElementById('signup-course');
            courseSelect.innerHTML = ''; // Clear existing options
            coursesData.sort((a, b) => (a.order !== undefined && a.order !== null ? a.order : Infinity) - (b.order !== undefined && b.order !== null ? b.order : Infinity)).forEach(course => {
                const option = document.createElement('option');
                option.value = course.name;
                option.text = course.name;
                courseSelect.appendChild(option);
            });
        }

        // Handle login form submission
        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            document.getElementById('auth-error').textContent = '';

            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                // Check if user exists in Firestore
                const userDoc = await db.collection("users").doc(userCredential.user.uid).get();
                if (userDoc.exists) {
                    // User exists, load data
                    loadUserData(userCredential.user.uid);
                } else {
                    // User does not exist in Firestore, sign them out
                    await auth.signOut();
                    document.getElementById('auth-error').textContent = 'Account not found in the system. Please contact an administrator.';
                }
            } catch (error) {
                document.getElementById('auth-error').textContent = error.message;
            }
        }

        // Handle signup form submission
        async function handleSignup(event) {
            event.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const name = document.getElementById('signup-name').value.toUpperCase();
            const rank = document.getElementById('signup-rank').value;
            const course = document.getElementById('signup-course').value;
            document.getElementById('auth-error').textContent = '';

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                await db.collection("users").doc(userCredential.user.uid).set({
                    name: name,
                    rank: rank,
                    course: course,
                    email: email,
                    completedSkills: [],
                    lastLogin: new Date()
                });
                loadUserData(userCredential.user.uid);
            } catch (error) {
                document.getElementById('auth-error').textContent = error.message;
            }
        }

        // Handle forgot password form submission
        async function handleForgotPassword(event) {
            event.preventDefault();
            const email = document.getElementById('forgot-email').value;
            document.getElementById('auth-error').textContent = '';

            try {
                await auth.sendPasswordResetEmail(email);
                alert('Password reset email sent successfully!');
                currentAuthMode = 'login';
                renderAuthForm();
            } catch (error) {
                document.getElementById('auth-error').textContent = error.message;
            }
        }

        // Google login function
        function googleLogin() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).then(result => {
                const user = result.user;
                // Check if user exists in Firestore
                db.collection("users").doc(user.uid).get().then(doc => {
                    if (doc.exists) {
                        // User already exists, load data
                        loadUserData(user.uid);
                    } else {
                        // New user via Google, prompt for profile completion
                        showProfileCompletion();
                    }
                }).catch(error => {
                    console.error("Error checking user existence: ", error);
                    document.getElementById('auth-error').textContent = 'Error logging in.';
                });
            }).catch(error => {
                console.error("Google login error: ", error);
                document.getElementById('auth-error').textContent = error.message;
            });
        }

        // Show profile completion for Google sign-in
        function showProfileCompletion() {
            currentAuthMode = 'profile';
            renderAuthForm();
        }

        // Load user data after successful login
        async function loadUserData(userId) {
            try {
                const userDoc = await db.collection("users").doc(userId).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    currentUser = {
                        id: userId,
                        name: userData.name,
                        rank: userData.rank,
                        course: userData.course,
                        email: userData.email,
                        completedSkills: userData.completedSkills || []
                    };
                    localStorage.setItem('userName', currentUser.name);
                    localStorage.setItem('userRank', currentUser.rank);
                    localStorage.setItem('userCourse', currentUser.course);
                    localStorage.setItem('completedSkills', JSON.stringify(currentUser.completedSkills));

                    // Update UI based on user/admin status
                    const idTokenResult = await auth.currentUser.getIdTokenResult();
                    isAdmin = idTokenResult.claims.admin || currentUser.email === 'jacksparrow6194@gmail.com';

                    document.getElementById('profileBtn').style.display = 'block';
                    if (isAdmin) {
                        document.getElementById('adminSwitchBtn').style.display = 'block';
                        document.getElementById('userInterface').style.display = 'none';
                        document.getElementById('adminDashboard').style.display = 'block';
                        showSection('dashboard');
                    } else {
                        document.getElementById('adminSwitchBtn').style.display = 'none';
                        document.getElementById('adminDashboard').style.display = 'none';
                        document.getElementById('userInterface').style.display = 'block';
                        loadSkillGrid();
                    }
                    updateProfileDisplay();
                    closeLoginPopup();
                } else {
                    throw new Error("User data not found in Firestore.");
                }
            } catch (error) {
                console.error("Error loading user data: ", error);
                document.getElementById('auth-error').textContent = 'Error loading user data.';
            }
        }

        // Load skill grid for user interface
        function loadSkillGrid() {
            const grid = document.getElementById('skill-grid');
            grid.innerHTML = '';
            skillsData.forEach(skill => {
                const card = document.createElement('div');
                card.className = 'skill-card-ui';
                card.onclick = () => loadSkillDetail(skill.id);
                card.innerHTML = `
                    <div class="skill-icon">
                        ${skill.imageUrl ? `<img src="${skill.imageUrl}" alt="${skill.name} Icon">` : '<i class="fas fa-wrench"></i>'}
                    </div>
                    <div class="skill-content">
                        <h3 class="skill-name">${skill.name}</h3>
                        <p class="skill-desc">${skill.description}</p>
                        <button class="skill-btn" onclick="event.stopPropagation(); loadSkillDetail('${skill.id}')">View Details</button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // Load skill detail for user interface
        async function loadSkillDetail(skillId) {
            const skill = skillsData.find(s => s.id === skillId);
            if (!skill) return;

            let html = `
                <div class="skill-header">
                    <h2>${skill.name}</h2>
                    <p>${skill.description}</p>
                </div>
                <div class="skill-body">
                    <div class="skill-section">
                        <h3>Theory</h3>
                        <div class="theory-content">${skill.theory}</div>
                    </div>
                    <div class="skill-section">
                        <h3>Tools Required</h3>
                        <div class="tools-grid">
            `;
            if (skill.tools && Array.isArray(skill.tools) && skill.tools.length > 0) {
                skill.tools.forEach(tool => {
                    html += `
                        <div class="tool-item">
                            <div class="tool-icon">
                                ${tool.imageUrl ? `<img src="${tool.imageUrl}" alt="${tool.name} Icon">` : '<i class="fas fa-toolbox"></i>'}
                            </div>
                            <div class="tool-info">
                                <h4>${tool.name}</h4>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += '<p>No tools specified.</p>';
            }
            html += `
                        </div>
                    </div>
                    <div class="skill-section">
                        <h3>Steps</h3>
            `;
            if (skill.steps && Array.isArray(skill.steps) && skill.steps.length > 0) {
                skill.steps.forEach(step => {
                    html += `
                        <div class="step-item">
                            <div class="step-content">
                                <p>${step.description}</p>
                            </div>
                            ${step.imageUrl ? `<div class="step-image"><img src="${step.imageUrl}" alt="Step Image"></div>` : ''}
                        </div>
                    `;
                });
            } else {
                html += '<p>No steps defined.</p>';
            }
            html += `
                    </div>
            `;

            if (skill.quiz && Array.isArray(skill.quiz) && skill.quiz.length > 0) {
                html += `
                    <div class="skill-section">
                        <h3>Quiz</h3>
                        <div class="quiz-container">
                `;
                skill.quiz.forEach((q, index) => {
                    html += `
                        <div class="question">
                            <div class="question-text">${index + 1}. ${q.question}</div>
                            <div class="options">
                    `;
                    q.options.forEach((opt, optIndex) => {
                        html += `
                            <div class="option" data-question="${index}" data-option="${optIndex}">
                                <input type="radio" id="q${index}_o${optIndex}" name="question_${index}" value="${optIndex}">
                                <label for="q${index}_o${optIndex}">${String.fromCharCode(65 + optIndex)}. ${opt}</label>
                            </div>
                        `;
                    });
                    html += `
                            </div>
                            <div class="quiz-result" id="result-${index}" style="display: none;"></div>
                        </div>
                    `;
                });
                html += `
                            <button class="skill-btn" onclick="checkQuiz('${skillId}')">Check Answers</button>
                        </div>
                    </div>
                `;
            }

            html += `
                </div>
            `;
            document.getElementById('skill-detail').innerHTML = html;

            // Add event listeners for quiz options
            document.querySelectorAll('.option').forEach(option => {
                option.addEventListener('click', function() {
                    const questionIndex = this.dataset.question;
                    const optionIndex = this.dataset.option;
                    // Remove selected class from all options in this question
                    document.querySelectorAll(`.option[data-question="${questionIndex}"]`).forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    // Add selected class to clicked option
                    this.classList.add('selected');
                });
            });
        }

        // Check quiz answers
        function checkQuiz(skillId) {
            const skill = skillsData.find(s => s.id === skillId);
            if (!skill) return;
            let score = 0;
            let allAnswered = true;
            skill.quiz.forEach((q, index) => {
                const selectedOption = document.querySelector(`.option[data-question="${index}"].selected`);
                if (!selectedOption) {
                    allAnswered = false;
                    return;
                }
                const selectedValue = parseInt(selectedOption.dataset.option);
                const resultDiv = document.getElementById(`result-${index}`);
                if (selectedValue === q.answer) {
                    resultDiv.textContent = 'Correct!';
                    resultDiv.className = 'quiz-result correct';
                    score++;
                } else {
                    resultDiv.textContent = `Incorrect. Correct answer: ${String.fromCharCode(65 + q.answer)}`;
                    resultDiv.className = 'quiz-result incorrect';
                }
                resultDiv.style.display = 'block';
            });

            if (!allAnswered) {
                alert('Please answer all questions before checking your answers.');
                return;
            }

            // Show overall score
            const totalQuestions = skill.quiz.length;
            const percentage = Math.round((score / totalQuestions) * 100);

            // Mark skill as completed if passed
            if (percentage >= 70 && currentUser) {
                if (!currentUser.completedSkills.includes(skillId)) {
                    // Update user's completed skills in Firestore
                    currentUser.completedSkills.push(skillId);
                    db.collection("users").doc(currentUser.id).update({
                        completedSkills: firebase.firestore.FieldValue.arrayUnion(skillId)
                    }).then(() => {
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                        alert(`Quiz completed!\nScore: ${score}/${totalQuestions} (${percentage}%)\nCongratulations! You've completed this skill.`);
                    });
                } else {
                    alert(`Quiz completed!\nScore: ${score}/${totalQuestions} (${percentage}%)\nYou have already completed this skill.`);
                }
            } else {
                alert(`Quiz completed!\nScore: ${score}/${totalQuestions} (${percentage}%)\nYou need at least 70% to pass. Try again!`);
            }
        }

    </script>
</body>
</html>
