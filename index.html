<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>

    <!-- Include Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Include Materialize CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding-top: 60px; /* Adjust based on your header height */
            background-color: #f5f5f5;
        }

        .admin-container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #2c3e50;
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
        }

        .header-title {
            margin: 0;
            font-size: 1.5em;
        }

        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .logout-btn, .back-to-user-btn {
            background-color: #e74c3c !important; /* Override default btn color */
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .logout-btn:hover, .back-to-user-btn:hover {
            background-color: #c0392b !important; /* Darker shade on hover */
        }

        .admin-panel-tabs {
            background-color: #ecf0f1;
            border-bottom: 1px solid #ddd;
        }

        .tab a {
            color: #2c3e50 !important;
            font-weight: bold;
        }

        .tab a.active {
            color: #3498db !important; /* Active tab indicator color */
            border-bottom: 3px solid #3498db;
        }

        .tab-content {
            display: none;
            padding: 20px;
            background-color: white;
            border: 1px solid #ddd;
            border-top: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab-content.active {
            display: block;
        }

        .setting-section {
            margin-bottom: 30px;
        }

        .setting-section h3 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }

        .add-rank-course-form {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center; /* Align items vertically */
        }

        .add-rank-course-form input {
            flex-grow: 1; /* Allow input to grow and take available space */
            margin-right: 5px; /* Add some space between input and button */
        }

        .add-rank-course-form button {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 4px;
        }

        .add-rank-course-form button:hover {
            background-color: #219a52;
        }

        .settings-list {
            list-style-type: none;
            padding: 0;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            background-color: #fafafa;
            margin-bottom: 5px;
            border-radius: 4px;
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-actions {
            display: flex;
            gap: 5px; /* Reduced gap between buttons */
        }

        /* --- NEW STYLES FOR UP/DOWN ARROWS --- */
        .move-up-btn, .move-down-btn {
            background-color: #3498db; /* Blue color for arrows */
            color: white;
            border: none;
            padding: 5px 10px; /* Smaller padding for smaller buttons */
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.9em; /* Slightly smaller font */
            min-width: 30px; /* Ensure consistent minimum width */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .move-up-btn:hover, .move-down-btn:hover {
            background-color: #2980b9; /* Darker blue on hover */
        }

        .move-up-btn:disabled, .move-down-btn:disabled {
            background-color: #bdc3c7; /* Grey out disabled buttons */
            cursor: not-allowed; /* Show not-allowed cursor */
        }

        .move-up-btn:disabled:hover, .move-down-btn:disabled:hover {
            background-color: #bdc3c7; /* Maintain grey color on hover when disabled */
        }
        /* --- END NEW STYLES FOR UP/DOWN ARROWS --- */

        .delete-btn-setting {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px; /* Match padding with arrow buttons */
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.9em; /* Match font size */
        }

        .delete-btn-setting:hover {
            background-color: #c0392b;
        }

        .users-table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #ecf0f1;
            font-weight: bold;
        }

        tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        .edit-user-btn, .remove-admin-btn, .grant-admin-btn {
            margin: 0 2px; /* Small margin around buttons */
            padding: 5px 10px; /* Smaller padding */
            font-size: 0.9em; /* Smaller font */
        }

        .grant-admin-btn {
            background-color: #27ae60 !important;
        }

        .remove-admin-btn {
            background-color: #f39c12 !important;
        }

        .edit-user-btn {
            background-color: #3498db !important;
        }

        .grant-admin-btn:hover {
            background-color: #219a52 !important;
        }

        .remove-admin-btn:hover {
            background-color: #d35400 !important;
        }

        .edit-user-btn:hover {
            background-color: #2980b9 !important;
        }

        .status-cell {
            text-transform: uppercase; /* Example: Make status text uppercase */
        }

        .parade-state-container {
            margin-top: 20px;
        }

        .parade-state-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        .parade-state-controls select, .parade-state-controls input, .parade-state-controls button {
            margin-right: 5px;
        }

        .parade-state-table-container {
            overflow-x: auto;
        }

        .attendance-summary-container {
            margin-top: 20px;
        }

        .attendance-summary-table {
            width: 100%;
            border-collapse: collapse;
        }

        .attendance-summary-table th,
        .attendance-summary-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center; /* Center text in summary table */
        }

        .attendance-summary-table th {
            background-color: #ecf0f1;
            font-weight: bold;
        }

        .attendance-summary-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        .export-btn {
            background-color: #8e44ad; /* Purple color */
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 4px;
            margin-top: 10px;
        }

        .export-btn:hover {
            background-color: #7d3c98; /* Darker purple on hover */
        }

        .admin-only {
            display: none; /* Initially hidden */
        }

        .loading-spinner {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
                padding: 10px;
            }
            .header-controls {
                margin-top: 10px;
                width: 100%;
                justify-content: space-between;
            }
            .admin-container {
                padding: 10px;
            }
            .add-rank-course-form {
                flex-direction: column;
                align-items: stretch;
            }
            .add-rank-course-form input, .add-rank-course-form button {
                width: 100%;
                margin-right: 0;
                margin-bottom: 10px;
            }
            .setting-actions {
                 /* On small screens, maybe stack the buttons vertically if needed */
                 /* flex-direction: column; */
                 /* gap: 2px; */ /* Smaller gap if stacked */
            }
        }
    </style>
</head>
<body>

<div class="header">
    <h1 class="header-title">Admin Dashboard</h1>
    <div class="header-controls">
        <button class="btn waves-effect waves-light back-to-user-btn" onclick="switchToUserView()">Back to User View</button>
        <button class="btn waves-effect waves-light logout-btn" onclick="logout()">Logout</button>
    </div>
</div>

<div class="admin-container">
    <ul class="tabs admin-panel-tabs">
        <li class="tab"><a href="#manage-users" class="active">Manage Users</a></li>
        <li class="tab"><a href="#attendance-tracking">Attendance Tracking</a></li>
        <li class="tab"><a href="#settings">Settings</a></li> <!-- Link to Settings Tab -->
        <li class="tab"><a href="#attendance-summary">Attendance Summary</a></li>
    </ul>

    <div id="manage-users" class="tab-content active">
        <h2>Manage Users</h2>
        <div class="users-table-container">
            <table id="usersTable">
                <thead>
                    <tr>
                        <th>Email</th>
                        <th>Name</th>
                        <th>Rank</th>
                        <th>Course</th>
                        <th>Admin Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <!-- User rows will be populated here by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <div id="attendance-tracking" class="tab-content">
        <h2>Attendance Tracking</h2>
        <div class="parade-state-container">
            <div class="parade-state-controls">
                <select id="filterCourseSelect">
                    <option value="">All Courses</option>
                    <!-- Course options will be populated dynamically -->
                </select>
                <input type="date" id="filterDateInput">
                <button class="btn waves-effect waves-light" onclick="applyFilters()">Apply Filters</button>
                <button class="btn waves-effect waves-light" onclick="clearFilters()">Clear Filters</button>
            </div>
            <div class="parade-state-table-container">
                <table id="paradeStateTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Rank</th>
                            <th>Course</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Details</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="paradeStateTableBody">
                         <!-- Parade state rows will be populated here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="settings" class="tab-content">
        <h2>Settings</h2>
        <!-- Signup Settings Section -->
        <div class="setting-section">
            <h3>Signup Settings</h3>

            <div class="add-rank-course-form">
                <input type="text" id="newRankInput" placeholder="Enter new rank (e.g., ME1T)">
                <button onclick="addRank()">Add Rank</button>
            </div>
            <ul id="ranksList" class="settings-list">
                <!-- Ranks will be listed here dynamically -->
            </ul>

            <div class="add-rank-course-form">
                <input type="text" id="newCourseInput" placeholder="Enter new course (e.g., 56th Mech)">
                <button onclick="addCourse()">Add Course</button>
            </div>
            <ul id="coursesList" class="settings-list">
                <!-- Courses will be listed here dynamically -->
            </ul>
        </div>

        <!-- Other Settings Sections (e.g., Admin Management) would go here -->
        <div class="setting-section">
            <h3>Admin Management</h3>
            <div class="add-rank-course-form">
                <input type="email" id="newAdminEmailInput" placeholder="Enter email to grant admin access">
                <button onclick="grantAdminAccess()">Grant Admin Access</button>
            </div>
            <ul id="adminsList" class="settings-list">
                <!-- Admin emails will be listed here dynamically -->
            </ul>
        </div>

    </div> <!-- End of #settings tab content -->

    <div id="attendance-summary" class="tab-content">
        <h2>Attendance Summary</h2>
        <div class="attendance-summary-container">
            <div class="parade-state-controls">
                <label for="summaryStartDate">Start Date:</label>
                <input type="date" id="summaryStartDate">
                <label for="summaryEndDate">End Date:</label>
                <input type="date" id="summaryEndDate">
                <button class="btn waves-effect waves-light" onclick="generateAttendanceSummary()">Generate Summary</button>
            </div>
            <div class="parade-state-table-container">
                <table id="attendanceSummaryTable" class="attendance-summary-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Total Days</th>
                            <th>Present</th>
                            <th>Absent</th>
                            <th>Late</th>
                            <th>On Duty (OD)</th>
                            <th>Medical Leave (ML)</th>
                            <th>Annual Leave (AL)</th>
                            <th>Percentage Present</th>
                        </tr>
                    </thead>
                    <tbody id="attendanceSummaryTableBody">
                        <!-- Summary rows will be populated here -->
                    </tbody>
                </table>
            </div>
            <button class="btn waves-effect waves-light export-btn" onclick="exportAttendanceSummaryToCSV()">Export to CSV</button>
        </div>
    </div>

</div>

<!-- Include Materialize JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<!-- Include Firebase App, Firestore, Auth SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

<script>
    // Your Firebase configuration object
    const firebaseConfig = {
        // Paste your config here
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let currentUserEmail = null;
    let currentUserName = null;
    let currentUserRank = null;
    let currentUserCourse = null;
    let isAdmin = false;

    // DOM Elements
    const manageUsersTab = document.getElementById('manage-users');
    const attendanceTrackingTab = document.getElementById('attendance-tracking');
    const settingsTab = document.getElementById('settings');
    const attendanceSummaryTab = document.getElementById('attendance-summary');

    // ... (previous code remains unchanged until setupFirestoreListeners) ...

    // Modify the loadSignupSettings function
    async function loadSignupSettings() {
        try {
            // Load ranks
            const ranksSnapshot = await db.collection("ranks").orderBy("order").get();
            const ranksList = document.getElementById('ranksList');
            ranksList.innerHTML = ''; // Clear previous list
            ranksSnapshot.forEach((doc, index) => { // Use index from forEach
                const rank = doc.data();
                // Calculate indices for up/down actions
                const canMoveUp = index > 0;
                const canMoveDown = index < ranksSnapshot.size - 1;

                const rankItem = document.createElement('div');
                rankItem.className = 'setting-item';
                rankItem.innerHTML = `
                    <span>${rank.name}</span>
                    <div class="setting-actions">
                        <button class="move-up-btn" ${canMoveUp ? '' : 'disabled'} onclick="moveRankUp('${doc.id}', ${rank.order})">↑</button>
                        <button class="move-down-btn" ${canMoveDown ? '' : 'disabled'} onclick="moveRankDown('${doc.id}', ${rank.order})">↓</button>
                        <button class="delete-btn-setting" onclick="deleteRank('${doc.id}', '${rank.name}')">Delete</button>
                    </div>
                `;
                ranksList.appendChild(rankItem);
            });

            // Load courses
            const coursesSnapshot = await db.collection("courses").orderBy("order").get();
            const coursesList = document.getElementById('coursesList');
            coursesList.innerHTML = ''; // Clear previous list
            coursesSnapshot.forEach((doc, index) => { // Use index from forEach
                const course = doc.data();
                // Calculate indices for up/down actions
                const canMoveUp = index > 0;
                const canMoveDown = index < coursesSnapshot.size - 1;

                const courseItem = document.createElement('div');
                courseItem.className = 'setting-item';
                courseItem.innerHTML = `
                    <span>${course.name}</span>
                    <div class="setting-actions">
                        <button class="move-up-btn" ${canMoveUp ? '' : 'disabled'} onclick="moveCourseUp('${doc.id}', ${course.order})">↑</button>
                        <button class="move-down-btn" ${canMoveDown ? '' : 'disabled'} onclick="moveCourseDown('${doc.id}', ${course.order})">↓</button>
                        <button class="delete-btn-setting" onclick="deleteCourse('${doc.id}', '${course.name}')">Delete</button>
                    </div>
                `;
                coursesList.appendChild(courseItem);
            });
        } catch (error) {
            console.error("Error loading signup settings: ", error);
        }
    }

    // Add the moveRankUp function
    async function moveRankUp(rankId, currentOrder) {
        if (currentOrder <= 0) return; // Cannot move up if already at the top

        const targetOrder = currentOrder - 1;
        try {
            // Fetch the item that is currently at the target position
            const targetItemSnapshot = await db.collection("ranks")
                .where("order", "==", targetOrder)
                .limit(1)
                .get();

            if (!targetItemSnapshot.empty) {
                const targetDoc = targetItemSnapshot.docs[0];
                const targetDocId = targetDoc.id;

                // Perform a batch write to swap the orders atomically
                const batch = db.batch();

                // Swap the order of the current item to the target's order
                batch.update(db.collection("ranks").doc(rankId), { order: targetOrder });
                // Swap the order of the target item to the current item's original order
                batch.update(db.collection("ranks").doc(targetDocId), { order: currentOrder });

                await batch.commit();
                console.log("Rank moved up successfully.");
            } else {
                 console.error("Target rank for swapping not found.");
            }
        } catch (error) {
            console.error("Error moving rank up: ", error);
        }
    }

    // Add the moveRankDown function
    async function moveRankDown(rankId, currentOrder) {
        // Need to find the maximum order number to determine if we can move down
        const snapshot = await db.collection("ranks").orderBy("order").get();
        const maxOrder = snapshot.size - 1;
        if (currentOrder >= maxOrder) return; // Cannot move down if already at the bottom

        const targetOrder = currentOrder + 1;
        try {
            // Fetch the item that is currently at the target position
            const targetItemSnapshot = await db.collection("ranks")
                .where("order", "==", targetOrder)
                .limit(1)
                .get();

            if (!targetItemSnapshot.empty) {
                const targetDoc = targetItemSnapshot.docs[0];
                const targetDocId = targetDoc.id;

                // Perform a batch write to swap the orders atomically
                const batch = db.batch();

                // Swap the order of the current item to the target's order
                batch.update(db.collection("ranks").doc(rankId), { order: targetOrder });
                // Swap the order of the target item to the current item's original order
                batch.update(db.collection("ranks").doc(targetDocId), { order: currentOrder });

                await batch.commit();
                console.log("Rank moved down successfully.");
            } else {
                 console.error("Target rank for swapping not found.");
            }
        } catch (error) {
            console.error("Error moving rank down: ", error);
        }
    }

    // Add the moveCourseUp function
    async function moveCourseUp(courseId, currentOrder) {
        if (currentOrder <= 0) return; // Cannot move up if already at the top

        const targetOrder = currentOrder - 1;
        try {
            // Fetch the item that is currently at the target position
            const targetItemSnapshot = await db.collection("courses")
                .where("order", "==", targetOrder)
                .limit(1)
                .get();

            if (!targetItemSnapshot.empty) {
                const targetDoc = targetItemSnapshot.docs[0];
                const targetDocId = targetDoc.id;

                // Perform a batch write to swap the orders atomically
                const batch = db.batch();

                // Swap the order of the current item to the target's order
                batch.update(db.collection("courses").doc(courseId), { order: targetOrder });
                // Swap the order of the target item to the current item's original order
                batch.update(db.collection("courses").doc(targetDocId), { order: currentOrder });

                await batch.commit();
                console.log("Course moved up successfully.");
            } else {
                 console.error("Target course for swapping not found.");
            }
        } catch (error) {
            console.error("Error moving course up: ", error);
        }
    }

    // Add the moveCourseDown function
    async function moveCourseDown(courseId, currentOrder) {
        // Need to find the maximum order number to determine if we can move down
        const snapshot = await db.collection("courses").orderBy("order").get();
        const maxOrder = snapshot.size - 1;
        if (currentOrder >= maxOrder) return; // Cannot move down if already at the bottom

        const targetOrder = currentOrder + 1;
        try {
            // Fetch the item that is currently at the target position
            const targetItemSnapshot = await db.collection("courses")
                .where("order", "==", targetOrder)
                .limit(1)
                .get();

            if (!targetItemSnapshot.empty) {
                const targetDoc = targetItemSnapshot.docs[0];
                const targetDocId = targetDoc.id;

                // Perform a batch write to swap the orders atomically
                const batch = db.batch();

                // Swap the order of the current item to the target's order
                batch.update(db.collection("courses").doc(courseId), { order: targetOrder });
                // Swap the order of the target item to the current item's original order
                batch.update(db.collection("courses").doc(targetDocId), { order: currentOrder });

                await batch.commit();
                console.log("Course moved down successfully.");
            } else {
                 console.error("Target course for swapping not found.");
            }
        } catch (error) {
            console.error("Error moving course down: ", error);
        }
    }

// Add a new rank
async function addRank() {
const newRankInput = document.getElementById('newRankInput');
const newRank = newRankInput.value.trim();
if (!newRank) {
document.getElementById('rankMessage').textContent = 'Please enter a rank name';
setTimeout(() => {
document.getElementById('rankMessage').textContent = '';
}, 3000);
return;
}

try {
// Check if rank already exists
const existingRank = ranksData.find(r => r.name === newRank);
if (existingRank) {
document.getElementById('rankMessage').textContent = 'This rank already exists';
setTimeout(() => {
document.getElementById('rankMessage').textContent = '';
}, 3000);
return;
}

// Add new rank to Firestore
await db.collection("ranks").add({
name: newRank,
order: ranksData.length
});

// Clear input
newRankInput.value = '';
document.getElementById('rankMessage').textContent = 'Rank added successfully!';
setTimeout(() => {
document.getElementById('rankMessage').textContent = '';
}, 3000);
} catch (error) {
console.error("Error adding rank: ", error);
document.getElementById('rankMessage').textContent = 'Error adding rank: ' + error.message;
setTimeout(() => {
document.getElementById('rankMessage').textContent = '';
}, 3000);
}
}

// Delete a rank
async function deleteRank(rankId, rankName) {
if (!confirm(`Are you sure you want to delete the rank "${rankName}"?`)) {
return;
}

try {
await db.collection("ranks").doc(rankId).delete();
document.getElementById('rankMessage').textContent = 'Rank deleted successfully!';
setTimeout(() => {
document.getElementById('rankMessage').textContent = '';
}, 3000);
} catch (error) {
console.error("Error deleting rank: ", error);
document.getElementById('rankMessage').textContent = 'Error deleting rank: ' + error.message;
setTimeout(() => {
document.getElementById('rankMessage').textContent = '';
}, 3000);
}
}

// Add a new course
async function addCourse() {
const newCourseInput = document.getElementById('newCourseInput');
const newCourse = newCourseInput.value.trim();
if (!newCourse) {
document.getElementById('courseMessage').textContent = 'Please enter a course name';
setTimeout(() => {
document.getElementById('courseMessage').textContent = '';
}, 3000);
return;
}

try {
// Check if course already exists
const existingCourse = coursesData.find(c => c.name === newCourse);
if (existingCourse) {
document.getElementById('courseMessage').textContent = 'This course already exists';
setTimeout(() => {
document.getElementById('courseMessage').textContent = '';
}, 3000);
return;
}

// Add new course to Firestore
await db.collection("courses").add({
name: newCourse,
order: coursesData.length
});

// Clear input
newCourseInput.value = '';
document.getElementById('courseMessage').textContent = 'Course added successfully!';
setTimeout(() => {
document.getElementById('courseMessage').textContent = '';
}, 3000);
} catch (error) {
console.error("Error adding course: ", error);
document.getElementById('courseMessage').textContent = 'Error adding course: ' + error.message;
setTimeout(() => {
document.getElementById('courseMessage').textContent = '';
}, 3000);
}
}

// Delete a course
async function deleteCourse(courseId, courseName) {
if (!confirm(`Are you sure you want to delete the course "${courseName}"?`)) {
return;
}

try {
await db.collection("courses").doc(courseId).delete();
document.getElementById('courseMessage').textContent = 'Course deleted successfully!';
setTimeout(() => {
document.getElementById('courseMessage').textContent = '';
}, 3000);
} catch (error) {
console.error("Error deleting course: ", error);
document.getElementById('courseMessage').textContent = 'Error deleting course: ' + error.message;
setTimeout(() => {
document.getElementById('courseMessage').textContent = '';
}, 3000);
}
}

// Logout function
function logout() {
    auth.signOut().then(() => {
        currentUser = null;
        isAdmin = false;
        
        // Hide interfaces
        document.getElementById('adminDashboard').style.display = 'none';
        document.getElementById('userInterface').style.display = 'block';
        document.getElementById('profilePopup').style.display = 'none';
        
        // Hide profile/admin buttons
        document.getElementById('profileBtn').style.display = 'none';
        document.getElementById('adminSwitchBtn').style.display = 'none';
        document.getElementById('adminBackBtn').style.display = 'none';
        
        // Hide the login popup if it happens to be open
        document.getElementById('loginPopup').style.display = 'none'; 
        
         // Show the login button again after logging out
        document.getElementById('loginBtn').style.display = 'block'; 
        
        loadSkillsFromFirebase();
    }).catch(error => {
        console.error("Error signing out: ", error);
    });
}

// Show different sections in admin panel
// Show different sections in admin panel
function showSection(section) {
    // Hide all sections
    document.querySelectorAll('.section').forEach(el => el.style.display = 'none');
    document.getElementById('edit-skill-form').style.display = 'none';

    // Remove active class from all nav items
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));

    // Show selected section and highlight nav item
    document.getElementById(`${section}-section`).style.display = 'block';
    document.querySelector(`.nav-item[onclick="showSection('${section}')"]`).classList.add('active');

    if (section === 'dashboard') {
        updateCounters();
    }
    // IMPORTANT: Always reload skills list when showing skills section
    if (section === 'skills') {
        loadSkillsList();
    }
    // Load users management when showing users section
    if (section === 'users') {
        loadUsersManagement();
    }
    // Load settings content when showing settings section
    if (section === 'settings') {
        // Load signup settings by default or the active tab
        const activeTabButton = document.querySelector('.tab-button.active');
        const activeTabId = activeTabButton ? activeTabButton.getAttribute('data-tab') : 'signupSettings';

        if (activeTabId === 'signupSettings') {
            loadSignupSettings();
        } else if (activeTabId === 'adminAccess') {
            loadAdminList(); // Call loadAdminList when Admin Access tab is active
        }
    }
}

// Load skills list in admin panel
function loadSkillsList() {
const skillsList = document.getElementById('skillsList');
skillsList.innerHTML = '';

if (skillsData.length === 0) {
skillsList.innerHTML = '<p>No skills available.</p>';
return;
}

skillsData.forEach(skill => {
const skillCard = document.createElement('div');
skillCard.className = 'skill-card';
skillCard.innerHTML = `
<h4>${skill.name}</h4>
<p>${skill.description.substring(0, 100)}...</p>
<div class="skill-actions">
<button class="action-btn edit-btn" onclick="editSkill('${skill.id}')">Edit</button>
<button class="action-btn delete-btn" onclick="deleteSkill('${skill.id}')">Delete</button>
</div>
`;
skillsList.appendChild(skillCard);
});
}

// Load users management in admin panel
function loadUsersManagement() {
    const usersContent = document.getElementById('usersContent');
    usersContent.innerHTML = '';

    // Group users by course
    const courses = {};
    usersData.forEach(user => {
        if (!courses[user.course]) {
            courses[user.course] = [];
        }
        courses[user.course].push(user);
    });

    // Render each course group
    Object.keys(courses).forEach(course => {
        const courseGroup = document.createElement('div');
        courseGroup.className = 'course-group';
        courseGroup.innerHTML = `
            <h3 class="course-title">${course}</h3>
            <div class="user-list" id="course-${course.replace(/\s+/g, '-')}">
                <!-- Users will be added here -->
            </div>
        `;
        usersContent.appendChild(courseGroup);

        // Add users to this course
        const userList = document.getElementById(`course-${course.replace(/\s+/g, '-')}`);
        courses[course].forEach(user => {
            const userCard = document.createElement('div');
            userCard.className = 'user-card';
            // --- MODIFICATION STARTS HERE ---
            userCard.innerHTML = `
                <div class="user-details">
                    <div class="user-name">${user.name}</div>
                    <div class="user-rank">${user.rank}</div>
                    <div class="user-course">${user.course}</div>
                    <div class="user-email">${user.email}</div> <!-- Optional: Display email -->
                </div>
                <div> <!-- Wrap buttons in a div -->
                    <button class="edit-user-btn" onclick="editUser('${user.id}')">Edit</button>
                    <button class="action-btn delete-btn" onclick="deleteUser('${user.id}', '${user.name}')">Delete</button> <!-- Add Delete Button -->
                </div>
            `;
            // --- MODIFICATION ENDS HERE ---
            userList.appendChild(userCard);
        });
    });
}

// Edit user function
function editUser(userId) {
editingUserId = userId;
const user = usersData.find(u => u.id === userId);
if (!user) return;

document.getElementById('edit-user-name').value = user.name;
document.getElementById('edit-user-rank').value = user.rank;
document.getElementById('edit-user-course').value = user.course;

document.getElementById('editUserModal').style.display = 'flex';
}

// Save edited user
async function saveEditedUser() {
const name = document.getElementById('edit-user-name').value.toUpperCase();
const rank = document.getElementById('edit-user-rank').value;
const course = document.getElementById('edit-user-course').value;

if (!name || !rank || !course) {
alert('Please fill in all fields');
return;
}

try {
await db.collection("users").doc(editingUserId).update({
name: name,
rank: rank,
course: course
});
document.getElementById('editUserModal').style.display = 'none';
alert('User updated successfully!');
} catch (error) {
console.error("Error updating user: ", error);
alert('Error updating user: ' + error.message);
}
}

// Close edit user modal
function closeEditUserModal() {
document.getElementById('editUserModal').style.display = 'none';
}
// Close edit user modal
function closeEditUserModal() {
    document.getElementById('editUserModal').style.display = 'none';
}

// --- ADD THIS NEW FUNCTION ---
// Delete a user
async function deleteUser(userId, userName) {
    if (!confirm(`Are you sure you want to delete the user "${userName}"? This action cannot be undone.`)) {
        return;
    }

    try {
        // Delete user document from 'users' collection
        await db.collection("users").doc(userId).delete();

        // Also remove from 'admins' collection if they were an admin
        await db.collection("admins").doc(userId).delete().catch(error => {
             // Ignore error if the user wasn't an admin
             if (error.code !== 'not-found') {
                 console.error("Error removing user from admins during deletion: ", error);
             }
        });

        alert(`User "${userName}" has been deleted successfully.`);
        // Optionally, refresh the user list to reflect the deletion
        if (document.getElementById('users-section').style.display === 'block') {
             loadUsersManagement(); // Reload the user list if currently viewing
        }
    } catch (error) {
        console.error("Error deleting user: ", error);
        alert('Error deleting user: ' + error.message);
    }
}
// --- END OF NEW FUNCTION ---
// Update dashboard counters
function updateCounters() {
document.getElementById('total-skills').textContent = skillsData.length;
}

// Add new skill
function addNewSkill() {
currentEditingSkill = {
id: null,
name: '',
icon: '',
description: '',
tools: [],
steps: [],
theory: '',
quiz: []
};
originalEditingSkill = JSON.parse(JSON.stringify(currentEditingSkill)); // Store original data
showEditForm();
}

// Edit existing skill
function editSkill(skillId) {
currentEditingSkill = skillsData.find(skill => skill.id === skillId);
originalEditingSkill = JSON.parse(JSON.stringify(currentEditingSkill)); // Store original data
if (currentEditingSkill) {
showEditForm();
}
}

// Show edit form
function showEditForm() {
document.getElementById('edit-skill-name').value = currentEditingSkill.name || '';
document.getElementById('edit-skill-icon').value = currentEditingSkill.icon || '';
document.getElementById('edit-skill-description').value = currentEditingSkill.description || '';
document.getElementById('edit-tools').value = Array.isArray(currentEditingSkill.tools) ? currentEditingSkill.tools.join(', ') : '';
document.getElementById('edit-theory').value = currentEditingSkill.theory || '';

// Clear and populate steps
const stepsContainer = document.getElementById('steps-container');
stepsContainer.innerHTML = '';
if (Array.isArray(currentEditingSkill.steps)) {
currentEditingSkill.steps.forEach((step, index) => {
addStepToForm(index, step);
});
}

// Clear and populate quiz
const quizContainer = document.getElementById('quiz-container');
quizContainer.innerHTML = '';
if (Array.isArray(currentEditingSkill.quiz)) {
currentEditingSkill.quiz.forEach((question, index) => {
addQuizQuestionToForm(index, question);
});
}

// Show form
document.getElementById('skills-section').style.display = 'none';
document.getElementById('edit-skill-form').style.display = 'block';
}

// Cancel edit and restore original data
function cancelEdit() {
// Restore original skill data
currentEditingSkill = JSON.parse(JSON.stringify(originalEditingSkill));

// Return to skills list
document.getElementById('edit-skill-form').style.display = 'none';
document.getElementById('skills-section').style.display = 'block';
}

// Add step to form
function addStepToForm(index, step = null) {
const stepsContainer = document.getElementById('steps-container');
const stepId = index !== undefined ? index : (currentEditingSkill.steps ? currentEditingSkill.steps.length : 0);
const stepObj = step || { title: '', description: '', image: '' };

const stepElement = document.createElement('div');
stepElement.className = 'step-item';
stepElement.id = `step-${stepId}`;
stepElement.innerHTML = `
<div class="step-header">
<h4>Step ${stepId + 1}</h4>
<button class="action-btn delete-btn" onclick="removeStep(${stepId})">Remove</button>
</div>
<div class="step-content">
<div>
<label>Title</label>
<input type="text" value="${stepObj.title}" onchange="updateStepField(${stepId}, 'title', this.value)" placeholder="Step title">
</div>
<div>
<label>Description</label>
<textarea onchange="updateStepField(${stepId}, 'description', this.value)" placeholder="Step description">${stepObj.description}</textarea>
</div>
<div>
<label>Image URL</label>
<input type="text" value="${stepObj.image}" onchange="updateStepField(${stepId}, 'image', this.value)" placeholder="Image URL">
</div>
</div>
`;
stepsContainer.appendChild(stepElement);
}

// Add new step
function addStep() {
if (!currentEditingSkill.steps) currentEditingSkill.steps = [];
currentEditingSkill.steps.push({ title: '', description: '', image: '' });
addStepToForm();
}

// Update step field
function updateStepField(index, field, value) {
if (currentEditingSkill.steps && currentEditingSkill.steps[index]) {
currentEditingSkill.steps[index][field] = value;
}
}

// Remove step
function removeStep(index) {
if (currentEditingSkill.steps && currentEditingSkill.steps[index]) {
currentEditingSkill.steps.splice(index, 1);
// Re-render all steps
const stepsContainer = document.getElementById('steps-container');
stepsContainer.innerHTML = '';
currentEditingSkill.steps.forEach((step, idx) => {
addStepToForm(idx, step);
});
}
}

// Add quiz question to form
function addQuizQuestionToForm(index, question = null) {
const quizContainer = document.getElementById('quiz-container');
const questionId = index !== undefined ? index : (currentEditingSkill.quiz ? currentEditingSkill.quiz.length : 0);
const q = question || { question: '', options: ['', '', '', ''], answer: 0 };

const questionElement = document.createElement('div');
questionElement.className = 'quiz-question';
questionElement.id = `question-${questionId}`;
questionElement.innerHTML = `
<div class="quiz-header">
<h4>Question ${questionId + 1}</h4>
<button class="action-btn delete-btn" onclick="removeQuizQuestion(${questionId})">Remove</button>
</div>
<div class="quiz-content">
<div>
<label>Question Text</label>
<input type="text" value="${q.question}" onchange="updateQuizField(${questionId}, 'question', this.value)" placeholder="Question text">
</div>
<div class="quiz-options">
<div>
<label>Option A</label>
<input type="text" value="${q.options[0]}" onchange="updateQuizOption(${questionId}, 0, this.value)" placeholder="Option A">
</div>
<div>
<label>Option B</label>
<input type="text" value="${q.options[1]}" onchange="updateQuizOption(${questionId}, 1, this.value)" placeholder="Option B">
</div>
<div>
<label>Option C</label>
<input type="text" value="${q.options[2]}" onchange="updateQuizOption(${questionId}, 2, this.value)" placeholder="Option C">
</div>
<div>
<label>Option D</label>
<input type="text" value="${q.options[3]}" onchange="updateQuizOption(${questionId}, 3, this.value)" placeholder="Option D">
</div>
</div>
<div>
<label>Correct Answer (0=A, 1=B, 2=C, 3=D)</label>
<input type="number" min="0" max="3" value="${q.answer}" onchange="updateQuizField(${questionId}, 'answer', parseInt(this.value))">
</div>
</div>
`;
quizContainer.appendChild(questionElement);
}

// Add new quiz question
function addQuizQuestion() {
if (!currentEditingSkill.quiz) currentEditingSkill.quiz = [];
currentEditingSkill.quiz.push({ question: '', options: ['', '', '', ''], answer: 0 });
addQuizQuestionToForm();
}

// Update quiz field
function updateQuizField(questionId, field, value) {
if (currentEditingSkill.quiz && currentEditingSkill.quiz[questionId]) {
currentEditingSkill.quiz[questionId][field] = value;
}
}

// Update quiz option
function updateQuizOption(questionId, optionIndex, value) {
if (currentEditingSkill.quiz && 
currentEditingSkill.quiz[questionId] && 
currentEditingSkill.quiz[questionId].options[optionIndex] !== undefined) {
currentEditingSkill.quiz[questionId].options[optionIndex] = value;
}
}

// Remove quiz question
function removeQuizQuestion(index) {
if (currentEditingSkill.quiz && currentEditingSkill.quiz[index]) {
currentEditingSkill.quiz.splice(index, 1);
// Re-render all questions with correct numbering
const quizContainer = document.getElementById('quiz-container');
quizContainer.innerHTML = '';
currentEditingSkill.quiz.forEach((question, idx) => {
addQuizQuestionToForm(idx, question);
});
}
}

// Save skill
function saveSkill() {
// Update current skill with form values
currentEditingSkill.name = document.getElementById('edit-skill-name').value;
currentEditingSkill.icon = document.getElementById('edit-skill-icon').value;
currentEditingSkill.description = document.getElementById('edit-skill-description').value;
currentEditingSkill.tools = document.getElementById('edit-tools').value.split(',').map(t => t.trim()).filter(t => t);
currentEditingSkill.theory = document.getElementById('edit-theory').value;

// If it's a new skill, add to Firestore
if (!currentEditingSkill.id) {
db.collection("skills").add(currentEditingSkill)
.then((docRef) => {
alert('Skill saved successfully!');
document.getElementById('edit-skill-form').style.display = 'none';
document.getElementById('skills-section').style.display = 'block';
showSection('skills'); // This will trigger loadSkillsList
})
.catch((error) => {
console.error("Error adding skill: ", error);
alert('Error saving skill');
});
} else {
// Update existing skill in Firestore
db.collection("skills").doc(currentEditingSkill.id).set(currentEditingSkill)
.then(() => {
alert('Skill updated successfully!');
document.getElementById('edit-skill-form').style.display = 'none';
document.getElementById('skills-section').style.display = 'block';
showSection('skills'); // This will trigger loadSkillsList
})
.catch((error) => {
console.error("Error updating skill: ", error);
alert('Error saving skill');
});
}
}

// Delete skill
function deleteSkill(skillId) {
if (!skillId) {
console.warn("Attempted to delete a skill with an invalid or empty ID:", skillId);
alert("Cannot delete skill: Invalid ID.");
return;
}

if (confirm('Are you sure you want to delete this skill?')) {
db.collection("skills").doc(skillId).delete()
.then(() => {
console.log("Skill deleted successfully with ID:", skillId);
})
.catch((error) => {
console.error("Error removing skill with ID '" + skillId + "': ", error);
});
}
}

// Load skills from Firebase
async function loadSkillsFromFirebase() {
try {
const snapshot = await db.collection("skills").get();
skillsData = [];
snapshot.forEach(doc => {
skillsData.push({ id: doc.id, ...doc.data() });
});
loadSkillGrid();
} catch (error) {
console.error("Error loading skills: ", error);
}
}

// Load skill grid for user interface
function loadSkillGrid() {
const gridElement = document.getElementById('skill-grid');
let html = '';
skillsData.forEach(skill => {
// Check if user has completed this skill
const isCompleted = currentUser && currentUser.completedSkills && currentUser.completedSkills.includes(skill.id);
html += `
<div class="skill-card-ui" onclick="loadSkillDetail('${skill.id}')">
<div class="skill-icon">
<i class="${skill.icon}"></i>
</div>
<div class="skill-content">
<h3 class="skill-name">${skill.name}</h3>
<p class="skill-desc">${skill.description}</p>
<button class="skill-btn">
${isCompleted ? 'Review' : 'Start'} Learning
</button>
</div>
</div>
`;
});
gridElement.innerHTML = html;
}

// Load detail view for a specific skill
function loadSkillDetail(skillId) {
document.getElementById('skill-grid').style.display = 'none';
document.getElementById('skill-detail').style.display = 'block';
const skill = skillsData.find(s => s.id === skillId);
if (!skill) return;
let html = `
<div class="skill-header">
<i class="${skill.icon}"></i>
<h2>${skill.name}</h2>
</div>
<div class="skill-section">
<h3 class="section-title-ui">Required Tools</h3>
<div class="tools-grid">
`;
skill.tools.forEach(tool => {
html += `
<div class="tool-item">
<i class="fas fa-toolbox"></i>
<div>${tool}</div>
</div>
`;
});
html += `
</div>
</div>
<div class="skill-section">
<h3 class="section-title-ui">Step-by-Step Guide</h3>
<div class="steps-container">
`;
skill.steps.forEach(step => {
html += `
<div class="step-card">
<img src="${step.image}" alt="${step.title}" class="step-image">
<div class="step-content">
<h4 class="step-title">${step.title}</h4>
<p>${step.description}</p>
</div>
</div>
`;
});
html += `
</div>
</div>
<div class="skill-section">
<h3 class="section-title-ui">Theory & Principles</h3>
<div class="theory-content">
<p>${skill.theory}</p>
</div>
</div>
<div class="skill-section">
<h3 class="section-title-ui">Knowledge Check</h3>
<div class="quiz-container" id="quiz-container">
`;
skill.quiz.forEach((q, index) => {
html += `
<div class="question">
<div class="question-text">${q.question}</div>
<div class="options">
`;
q.options.forEach((opt, optIndex) => {
html += `
<div class="option" data-question="${index}" data-option="${optIndex}">
<input type="radio" name="q${index}" id="q${index}o${optIndex}">
<label for="q${index}o${optIndex}">${String.fromCharCode(65 + optIndex)}. ${opt}</label>
</div>
`;
});
html += `
</div>
<div class="quiz-result" id="result-${index}" style="display:none;"></div>
</div>
`;
});
html += `
</div>
<div class="quiz-nav">
<button class="back-btn" onclick="goBackToGrid()">← Back to Skills</button>
<button class="skill-btn" onclick="checkQuiz('${skillId}')">Check Answers</button>
</div>
</div>
`;
document.getElementById('skill-detail').innerHTML = html;
// Add event listeners for quiz options
document.querySelectorAll('.option').forEach(option => {
option.addEventListener('click', function() {
const questionIndex = this.dataset.question;
const optionIndex = this.dataset.option;
// Remove selected class from all options in this question
document.querySelectorAll(`.option[data-question="${questionIndex}"]`).forEach(opt => {
opt.classList.remove('selected');
});
// Add selected class to clicked option
this.classList.add('selected');
});
});
}

// Check quiz answers
function checkQuiz(skillId) {
const skill = skillsData.find(s => s.id === skillId);
if (!skill) return;
let score = 0;
let allAnswered = true;
skill.quiz.forEach((q, index) => {
const selectedOption = document.querySelector(`.option[data-question="${index}"].selected`);
if (!selectedOption) {
allAnswered = false;
return;
}
const selectedValue = parseInt(selectedOption.dataset.option);
const resultDiv = document.getElementById(`result-${index}`);
if (selectedValue === q.answer) {
resultDiv.textContent = 'Correct!';
resultDiv.className = 'quiz-result correct';
score++;
} else {
resultDiv.textContent = `Incorrect. Correct answer: ${String.fromCharCode(65 + q.answer)}`;
resultDiv.className = 'quiz-result incorrect';
}
resultDiv.style.display = 'block';
});
if (!allAnswered) {
alert('Please answer all questions before checking your answers.');
return;
}
// Show overall score
const totalQuestions = skill.quiz.length;
const percentage = Math.round((score / totalQuestions) * 100);
// Mark skill as completed if passed
if (percentage >= 70 && currentUser) {
if (!currentUser.completedSkills.includes(skillId)) {
// Update user's completed skills in Firestore
currentUser.completedSkills.push(skillId);
db.collection("users").doc(currentUser.id).update({
completedSkills: firebase.firestore.FieldValue.arrayUnion(skillId)
}).then(() => {
localStorage.setItem('currentUser', JSON.stringify(currentUser));
alert(`Quiz completed!
Score: ${score}/${totalQuestions} (${percentage}%)
Congratulations! You've completed this skill.`);
});
} else {
alert(`Quiz completed!
Score: ${score}/${totalQuestions} (${percentage}%)`);
}
} else {
alert(`Quiz completed!
Score: ${score}/${totalQuestions} (${percentage}%)
You need at least 70% to pass. Try again!`);
}
}

// Settings tab functionality
document.querySelectorAll('.tab-button').forEach(button => {
    button.addEventListener('click', function() {
        const tabName = this.getAttribute('data-tab');

        // Remove active class from all buttons and tabs
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));

        // Add active class to clicked button and corresponding tab
        this.classList.add('active');
        document.getElementById(`${tabName}Tab`).classList.add('active');

        // --- ADD THIS CONDITIONAL CALL ---
        if (tabName === 'adminAccess') {
            loadAdminList(); // Load admin list specifically when the Admin Access tab is clicked
        }
        // --- END OF ADDITION ---
    });
});
</script>
</body>
</html>


