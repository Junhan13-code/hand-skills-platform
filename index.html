<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hand Skills Learning Platform - Admin & User System</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="styles.css"> <!-- Link to your external CSS file -->
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
</head>
<body>

  <!-- Login Popup -->
  <div class="login-popup" id="loginPopup">
    <div class="login-box">
      <span class="close-btn" onclick="closeLoginPopup()">&times;</span>
      <h2>Login</h2>
      <div id="auth-container">
        <div id="loginForm">
          <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" required>
          </div>
          <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" required>
          </div>
          <button class="btn primary-btn" onclick="login()">Login</button> <!-- Added class -->
          <button class="btn secondary-btn" onclick="showForgotPassword()">Forgot Password?</button> <!-- Added class -->
          <button class="btn secondary-btn" onclick="showSignupForm()">Sign Up</button> <!-- Added class -->
          <hr style="margin: 1.5rem 0; border: 0; border-top: 1px solid #eee;"> <!-- Visual separator -->
          <button class="btn google-btn" onclick="googleLogin()"> <!-- Added class -->
            <i class="fab fa-google"></i> Sign in with Google
          </button>
        </div>
        <div id="signupForm" style="display: none;">
          <div class="form-group">
            <label for="signup-email">Email</label>
            <input type="email" id="signup-email" required>
          </div>
          <div class="form-group">
            <label for="signup-password">Password (min 6 characters)</label>
            <input type="password" id="signup-password" required>
          </div>
          <div class="form-group">
            <label for="signup-confirm-password">Confirm Password</label>
            <input type="password" id="signup-confirm-password" required>
          </div>
          <button class="btn primary-btn" onclick="signup()">Sign Up</button> <!-- Added class -->
          <button class="btn secondary-btn" onclick="showLoginForm()">Back to Login</button> <!-- Added class -->
        </div>
        <div id="forgotPasswordForm" style="display: none;">
          <div class="form-group">
            <label for="forgot-email">Enter your Email</label>
            <input type="email" id="forgot-email" required>
          </div>
          <button class="btn primary-btn" onclick="sendPasswordReset()">Send Reset Email</button> <!-- Added class -->
          <button class="btn secondary-btn" onclick="showLoginForm()">Back to Login</button> <!-- Added class -->
        </div>
        <div id="profileForm" style="display: none;">
          <h3>Complete Your Profile</h3>
          <div class="form-group">
            <label for="profile-rank">Rank</label>
            <select id="profile-rank"><!-- Options will be loaded dynamically --></select>
          </div>
          <div class="form-group">
            <label for="profile-course">Course</label>
            <select id="profile-course"><!-- Options will be loaded dynamically --></select>
          </div>
          <div class="form-group">
            <label for="profile-name">Full Name</label>
            <input type="text" id="profile-name" placeholder="Enter your full name">
          </div>
          <button class="btn primary-btn" onclick="completeProfile()">Save Profile</button> <!-- Added class -->
        </div>
        <div class="error-message" id="auth-error"></div>
      </div>
    </div>
  </div>

  <!-- Admin Dashboard -->
  <div class="admin-dashboard" id="adminDashboard">
    <div class="admin-header">
      <div class="container">
        <h1><i class="fas fa-cogs"></i> Admin Control Panel</h1>
        <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
      </div>
    </div>
    <div class="admin-content">
      <div class="nav-panel">
        <h3>Navigation</h3>
        <div class="nav-item active" onclick="showSection('dashboard')"><i class="fas fa-tachometer-alt"></i> Dashboard</div>
        <div class="nav-item" onclick="showSection('skills')"><i class="fas fa-tools"></i> Manage Skills</div>
        <div class="nav-item" onclick="showSection('users')"><i class="fas fa-users"></i> Manage Users</div>
        <div class="nav-item" onclick="showSection('settings')"><i class="fas fa-cog"></i> Settings</div>
      </div>
      <div class="main-content-area">
        <!-- Dashboard Section -->
        <div id="dashboard-section" class="section">
          <h2 class="section-title">Dashboard Overview</h2>
          <div class="stats-grid">
            <div style="background: linear-gradient(135deg, var(--admin-bg), var(--admin-sidebar)); padding: 2rem; border-radius: 16px; text-align: center; border: 1px solid var(--admin-border); box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
              <i class="fas fa-tools" style="font-size: 3rem; color: var(--accent); margin-bottom: 1rem; display: block;"></i>
              <h3 id="total-skills" style="font-size: 2.5rem; color: white; margin-bottom: 0.5rem; font-weight: 700;">0</h3>
              <p style="color: var(--admin-text); font-size: 1rem;">Total Skills</p>
            </div>
            <div style="background: linear-gradient(135deg, var(--admin-bg), var(--admin-sidebar)); padding: 2rem; border-radius: 16px; text-align: center; border: 1px solid var(--admin-border); box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
              <i class="fas fa-users" style="font-size: 3rem; color: var(--accent); margin-bottom: 1rem; display: block;"></i>
              <h3 id="total-users" style="font-size: 2.5rem; color: white; margin-bottom: 0.5rem; font-weight: 700;">0</h3>
              <p style="color: var(--admin-text); font-size: 1rem;">Total Users</p>
            </div>
            <div style="background: linear-gradient(135deg, var(--admin-bg), var(--admin-sidebar)); padding: 2rem; border-radius: 16px; text-align: center; border: 1px solid var(--admin-border); box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
              <i class="fas fa-check-circle" style="font-size: 3rem; color: var(--accent); margin-bottom: 1rem; display: block;"></i>
              <h3 id="completed-skills" style="font-size: 2.5rem; color: white; margin-bottom: 0.5rem; font-weight: 700;">0</h3>
              <p style="color: var(--admin-text); font-size: 1rem;">Completed Skills</p>
            </div>
            <div style="background: linear-gradient(135deg, var(--admin-bg), var(--admin-sidebar)); padding: 2rem; border-radius: 16px; text-align: center; border: 1px solid var(--admin-border); box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
              <i class="fas fa-user-shield" style="font-size: 3rem; color: var(--accent); margin-bottom: 1rem; display: block;"></i>
              <h3 id="admin-count" style="font-size: 2.5rem; color: white; margin-bottom: 0.5rem; font-weight: 700;">0</h3>
              <p style="color: var(--admin-text); font-size: 1rem;">Admin Count</p>
            </div>
          </div>
        </div>

        <!-- Skills Management Section -->
        <div id="skills-section" class="section" style="display: none;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 class="section-title">Manage Skills</h2>
            <button class="btn" onclick="addNewSkill()">Add New Skill</button>
          </div>
          <div class="skill-list" id="skillsList"><!-- Skills will be loaded here --></div>
        </div>

        <!-- Users Management Section -->
        <div id="users-section" class="section users-section" style="display: none;">
          <h2 class="section-title">Manage Users</h2>
          <div id="usersContent"><!-- User groups will be loaded here --></div>
        </div>

        <!-- Settings Section -->
        <div id="settings-section" class="section" style="display: none;">
          <h2 class="section-title">System Settings</h2>
          <div class="settings-tabs">
            <button class="tab-button active" data-tab="signupSettings">Signup Settings</button>
            <button class="tab-button" data-tab="adminAccess">Admin Access</button>
          </div>
          <div class="tab-content active" id="signupSettingsTab">
            <div class="settings-controls">
              <div class="settings-column">
                <h3 class="setting-title"><i class="fas fa-star"></i> Manage Ranks</h3>
                <div id="ranksList"></div>
                <div class="add-item-input">
                  <input type="text" id="newRankInput" placeholder="Enter new rank">
                  <button onclick="addRank()">Add Rank</button>
                </div>
                <div id="rankMessage" class="operation-message" style="display: none;"></div>
              </div>
              <div class="settings-column">
                <h3 class="setting-title"><i class="fas fa-book"></i> Manage Courses</h3>
                <div id="coursesList"></div>
                <div class="add-item-input">
                  <input type="text" id="newCourseInput" placeholder="Enter new course">
                  <button onclick="addCourse()">Add Course</button>
                </div>
                <div id="courseMessage" class="operation-message" style="display: none;"></div>
              </div>
            </div>
          </div>
          <div class="tab-content" id="adminAccessTab">
            <h3 class="setting-title"><i class="fas fa-user-shield"></i> Admin Access Management</h3>
            <div class="form-group">
              <label for="admin-email">Grant Admin Access (Enter Email)</label>
              <input type="email" id="admin-email" placeholder="user@example.com">
              <button onclick="grantAdminAccess()">Grant Access</button>
            </div>
            <div id="adminList">
              <!-- Admin list will be loaded here -->
            </div>
          </div>

        </div>

        <!-- Edit Skill Form -->
        <div id="edit-skill-form" class="edit-form">
          <div class="section-title">Edit Skill</div>
          <!-- Tabs -->
          <div class="tabs">
            <button class="tab-btn active" data-tab="info">üìå Skill Info</button>
            <button class="tab-btn" data-tab="tools">üõ†Ô∏è Tools</button>
            <button class="tab-btn" data-tab="steps">üìã Steps</button>
            <button class="tab-btn" data-tab="quiz">‚ùì Quiz</button>
            <button class="tab-btn" data-tab="theory">üìñ Theory</button>
          </div>
          <!-- Tab Content -->
          <div id="tab-info" class="tab-content active">
            <div class="form-row">
              <div class="form-col">
                <div class="form-group">
                  <label for="skill-name">Skill Name</label>
                  <input type="text" id="skill-name" onchange="updateSkillField('name', this.value)">
                </div>
                <div class="form-group">
                  <label for="skill-description">Description</label>
                  <textarea id="skill-description" rows="3" onchange="updateSkillField('description', this.value)"></textarea>
                </div>
              </div>
              <div class="form-col">
                <div class="form-group">
                  <label for="skill-image">Upload Image</label>
                  <input type="file" id="skill-image" accept="image/*" onchange="previewSkillImage(this)">
                </div>
                <div class="image-upload-preview" id="skill-image-preview"></div>
              </div>
            </div>
          </div>
          <div id="tab-tools" class="tab-content">
            <div id="tools-container"></div>
            <button class="btn add-step-btn" onclick="addToolInput()">Add Tool</button>
          </div>
          <div id="tab-steps" class="tab-content">
            <div id="steps-container"></div>
            <button class="btn add-step-btn" onclick="addStep()">Add Step</button>
          </div>
          <div id="tab-theory" class="tab-content">
            <div class="form-group">
              <label for="skill-theory">Theory</label>
              <textarea id="skill-theory" rows="6" onchange="updateSkillField('theory', this.value)"></textarea>
            </div>
          </div>
          <div id="tab-quiz" class="tab-content">
            <div id="quiz-container"></div>
            <button class="btn add-quiz-btn" onclick="addQuizQuestion()">Add Question</button>
          </div>
          <!-- Action Buttons -->
          <div style="margin-top: 2rem; display: flex; gap: 1rem;">
            <button class="btn btn-primary" onclick="saveSkill()">Save Changes</button>
            <button class="btn btn-secondary" onclick="cancelEdit()">Cancel</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit User Modal -->
  <div class="edit-user-modal" id="editUserModal">
    <div class="edit-user-box">
      <span class="close-btn" onclick="closeEditUserModal()">&times;</span>
      <h3>Edit User</h3>
      <div class="form-group">
        <label for="edit-user-name">Name</label>
        <input type="text" id="edit-user-name">
      </div>
      <div class="form-group">
        <label for="edit-user-rank">Rank</label>
        <select id="edit-user-rank">
          <!-- Populated dynamically -->
        </select>
      </div>
      <div class="form-group">
        <label for="edit-user-course">Course</label>
        <select id="edit-user-course">
          <!-- Populated dynamically -->
        </select>
      </div>
      <button class="btn primary-btn" onclick="saveEditedUser()">Save Changes</button> <!-- Added class -->
    </div>
  </div>

  <!-- User Interface -->
  <div class="user-interface" id="userInterface">
    <header>
      <div class="container">
        <h1><i class="fas fa-graduation-cap"></i> Hand Skills Learning Platform</h1>
        <p>Master Essential Hands-On Skills</p>
        <!-- CHANGED: Profile button now uses the correct ID and function -->
        <button class="profile-btn" id="profileBtn" onclick="toggleProfilePopup()">
          <i class="fas fa-user"></i> <span id="userDisplayName">Guest</span>
        </button>
        <div class="admin-switch">
          <!-- CHANGED: Swapped button visibility logic -->
          <!-- This button shows "Admin View" and switches TO admin if user is admin -->
          <button class="admin-switch-btn" id="adminSwitchBtn" onclick="switchToAdminInterface()">Admin View</button>
          <!-- This button shows "User View" and switches BACK from admin -->
          <button class="admin-switch-btn" id="adminBackBtn" onclick="switchToUserInterface()" style="display: none;">User View</button>
        </div>
      </div>
    </header>

    <main class="container">
      <div id="main-content">
        <div class="skill-grid" id="skill-grid"><!-- Skills will be loaded here --></div>
        <div id="skill-detail" class="skill-detail"><!-- Skill details will be loaded here --></div>
      </div>
    </main>

    <footer>
      <div class="container">
        <p>&copy; 2026 Hand Skills Learning Platform | Master Essential Hands-On Skills</p>
      </div>
    </footer>
  </div>

  <!-- Profile Popup -->
  <!-- CHANGED: Moved profile popup outside header and added proper structure -->
  <div class="profile-popup" id="profilePopup">
    <div class="profile-header">
      <i class="fas fa-user-circle"></i>
      <h3>User Profile</h3>
    </div>
    <div class="profile-content">
      <div class="profile-info">
        <div class="info-item">
          <span class="info-label">Name:</span>
          <span class="info-value" id="popup-name-display">N/A</span>
        </div>
        <div class="info-item">
          <span class="info-label">Rank:</span>
          <span class="info-value" id="popup-rank-display">N/A</span>
        </div>
        <div class="info-item">
          <span class="info-label">Course:</span>
          <span class="info-value" id="popup-course-display">N/A</span>
        </div>
        <div class="info-item">
          <span class="info-label">Email:</span>
          <span class="info-value" id="popup-email-display">N/A</span>
        </div>
      </div>
      <div style="margin-top: 1rem;">
        <!-- Optional: Add a button to change rank directly from the popup -->
        <!-- Example: <button class="update-rank-btn" onclick="updateProfileRank()">Change Rank</button> -->
        <button class="logout-btn-popup" onclick="logout()">Logout</button>
      </div>
    </div>
  </div>

  <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyA6ZdINHlRF583T3HL5RsA4q2fmHeBcB_g",
      authDomain: "hand-skills-platform.firebaseapp.com",
      projectId: "hand-skills-platform",
      storageBucket: "hand-skills-platform.appspot.com",
      messagingSenderId: "1008403876815",
      appId: "1:1008403876815:web:0158630312970342d8d08a"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // Global Variables
    let currentUser = null;
    let skillsData = []; // Centralized skills data array
    let ranksData = [];
    let coursesData = [];
    let currentEditingSkill = null;
    let originalEditingSkill = null; // Store original state for cancel
    let editingSkillId = null; // Track the ID of the skill being edited
    let wasInAdminView = false; // Track previous view state
    let firestoreListenersSetup = false; // Guard to prevent duplicate listeners
    // Define a global variable to hold users data fetched in loadUsersManagement
    let usersData = [];

    // Function to update dashboard counters
    function updateCounters() {
        // Total Skills is updated via the skills listener
        document.getElementById('total-skills').textContent = skillsData.length;

        // Fetch other counts separately
        db.collection("users").get().then(snapshot => {
            document.getElementById('total-users').textContent = snapshot.size;
        }).catch(console.error);

        // Calculate completed skills count (example logic)
        let completedCount = 0;
        if (currentUser && currentUser.completedSkills) {
            completedCount = currentUser.completedSkills.length;
        }
        document.getElementById('completed-skills').textContent = completedCount;

         // Fetch admin count
         db.collection("admins").get().then(snapshot => {
             document.getElementById('admin-count').textContent = snapshot.size;
         }).catch(console.error);
    }


    // --- FIRESTORE LISTENERS ---
    function startSkillsListener() {
      db.collection("skills").onSnapshot((snapshot) => {
        skillsData = [];
        snapshot.forEach(doc => {
          skillsData.push({ id: doc.id, ...doc.data() });
        });
        // Sort by order
        skillsData.sort((a, b) => {
          const orderA = a.order !== undefined && a.order !== null ? a.order : Infinity;
          const orderB = b.order !== undefined && b.order !== null ? b.order : Infinity;
          return orderA - orderB;
        });

        // Update UIs if visible
        if (document.getElementById('skills-section').style.display === 'block') {
          loadSkillsList(); // Update admin skills list
        }
        if (document.getElementById('userInterface').style.display === 'block' &&
            document.getElementById('adminDashboard').style.display === 'none') { // Only update user view if not in admin
          loadSkillGrid(); // Update user skills grid
        }
        updateCounters(); // Update dashboard counter
      }, (error) => {
        console.error("Error in skills listener: ", error);
      });
    }

    function setupFirestoreListeners() {
      if (firestoreListenersSetup) return; // Prevent duplicate setup

      // Start the skills listener (handles both admin and user)
      startSkillsListener();

      // Listen for changes in ranks and courses collections
      db.collection("ranks").orderBy("order").onSnapshot((snapshot) => {
        ranksData = [];
        snapshot.forEach(doc => {
          ranksData.push({ id: doc.id, ...doc.data() });
        });
        // Reload dropdowns and settings if needed
        updateDropdowns();
        if (document.getElementById('settings-section').style.display === 'block') {
          loadSignupSettings();
        }
      }, (error) => {
        console.error("Error in ranks listener: ", error);
      });

      db.collection("courses").orderBy("order").onSnapshot((snapshot) => {
        coursesData = [];
        snapshot.forEach(doc => {
          coursesData.push({ id: doc.id, ...doc.data() });
        });
        // Reload dropdowns and settings if needed
        updateDropdowns();
        if (document.getElementById('settings-section').style.display === 'block') {
          loadSignupSettings();
        }
      }, (error) => {
        console.error("Error in courses listener: ", error);
      });

      firestoreListenersSetup = true;
    }


    // --- AUTHENTICATION ---
    window.onload = function() {
      auth.onAuthStateChanged(user => {
        if (user) {
          loadUserData(user.uid);
        } else {
          showLoginPopup();
          // Still start the skills listener for public view
          startSkillsListener();
        }
      });
    };

    function showLoginPopup() {
      document.getElementById('loginPopup').style.display = 'flex';
      document.getElementById('loginForm').style.display = 'block';
      document.getElementById('signupForm').style.display = 'none';
      document.getElementById('forgotPasswordForm').style.display = 'none';
      document.getElementById('profileForm').style.display = 'none';
    }

    function closeLoginPopup() {
      document.getElementById('loginPopup').style.display = 'none';
    }

    function showSignupForm() {
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('signupForm').style.display = 'block';
      document.getElementById('forgotPasswordForm').style.display = 'none';
      document.getElementById('profileForm').style.display = 'none';
      document.getElementById('auth-error').textContent = '';
    }

    function showLoginForm() {
      document.getElementById('loginForm').style.display = 'block';
      document.getElementById('signupForm').style.display = 'none';
      document.getElementById('forgotPasswordForm').style.display = 'none';
      document.getElementById('profileForm').style.display = 'none';
      document.getElementById('auth-error').textContent = '';
    }

    function showForgotPassword() {
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('signupForm').style.display = 'none';
      document.getElementById('forgotPasswordForm').style.display = 'block';
      document.getElementById('profileForm').style.display = 'none';
      document.getElementById('auth-error').textContent = '';
    }

    function sendPasswordReset() {
      const email = document.getElementById('forgot-email').value;
      if (!email) {
        document.getElementById('auth-error').textContent = 'Please enter your email address';
        return;
      }
      auth.sendPasswordResetEmail(email)
        .then(() => {
          alert('Password reset email sent!');
          showLoginForm();
        })
        .catch(error => {
          document.getElementById('auth-error').textContent = error.message;
        });
    }

    function login() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      if (!email || !password) {
        document.getElementById('auth-error').textContent = 'Please enter both email and password';
        return;
      }
      auth.signInWithEmailAndPassword(email, password)
        .then(userCredential => {
          loadUserData(userCredential.user.uid);
        })
        .catch(error => {
          document.getElementById('auth-error').textContent = error.message;
        });
    }

    function signup() {
      const email = document.getElementById('signup-email').value;
      const password = document.getElementById('signup-password').value;
      const confirmPassword = document.getElementById('signup-confirm-password').value;

      if (password !== confirmPassword) {
        document.getElementById('auth-error').textContent = 'Passwords do not match';
        return;
      }
      if (password.length < 6) {
        document.getElementById('auth-error').textContent = 'Password must be at least 6 characters';
        return;
      }

      auth.createUserWithEmailAndPassword(email, password)
        .then(userCredential => {
          // Add user to Firestore with default data
          db.collection("users").doc(userCredential.user.uid).set({
            email: email,
            name: "", // Will be filled later
            rank: "",
            course: "",
            completedSkills: [],
            lastLogin: new Date()
          }).then(() => {
             loadUserData(userCredential.user.uid);
          }).catch(error => {
              document.getElementById('auth-error').textContent = error.message;
          });
        })
        .catch(error => {
          document.getElementById('auth-error').textContent = error.message;
        });
    }

    function googleLogin() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .then(result => {
          const user = result.user;
          // Check if user exists in Firestore
          db.collection("users").doc(user.uid).get().then(doc => {
            if (doc.exists) {
              // User already exists, load data
              loadUserData(user.uid);
            } else {
              // New user via Google, prompt for profile completion
              showProfileCompletion();
            }
          }).catch(error => {
            console.error("Error fetching user  ", error);
            document.getElementById('auth-error').textContent = 'Error logging in.';
          });
        })
        .catch(error => {
          console.error("Google login error: ", error);
          document.getElementById('auth-error').textContent = error.message;
        });
    }

    function logout() {
      auth.signOut().then(() => {
        currentUser = null;
        document.getElementById('adminDashboard').style.display = 'none';
        document.getElementById('userInterface').style.display = 'block';
        document.getElementById('adminSwitchBtn').style.display = 'none';
        document.getElementById('adminBackBtn').style.display = 'none';
        closeProfilePopup(); // Close profile popup on logout
        showLoginPopup();
        // Reset UI states
        document.querySelectorAll('.section').forEach(el => el.style.display = 'none');
        document.getElementById('dashboard-section').style.display = 'block';
        document.querySelector('.nav-item.active').classList.remove('active');
        document.querySelector('.nav-item').classList.add('active');
        // Stop listeners if needed (optional, depends on desired behavior)
        // firestoreListenersSetup = false; // This might require more complex cleanup
      }).catch(error => {
        console.error("Logout error: ", error);
      });
    }


    // --- USER DATA AND PROFILE ---
    async function loadUserData(userId) {
      try {
        const userDoc = await db.collection("users").doc(userId).get();
        if (userDoc.exists) {
          currentUser = { id: userDoc.id, ...userDoc.data() };
          document.getElementById('userDisplayName').textContent = currentUser.name || currentUser.email.split('@')[0];
          document.getElementById('loginPopup').style.display = 'none';
          document.getElementById('profileForm').style.display = 'none'; // Hide profile form if shown

          // Check if user is admin
          const adminDoc = await db.collection("admins").doc(userId).get();
          if (adminDoc.exists) {
            document.getElementById('adminDashboard').style.display = 'block';
            document.getElementById('userInterface').style.display = 'none';
            document.getElementById('adminSwitchBtn').style.display = 'none'; // Hide switch btn in admin view initially
            document.getElementById('adminBackBtn').style.display = 'inline-block'; // Show back btn
            setupFirestoreListeners(); // Set up listeners for admin
            showSection('dashboard'); // Default admin view
          } else {
            document.getElementById('adminDashboard').style.display = 'none';
            document.getElementById('userInterface').style.display = 'block';
            document.getElementById('adminSwitchBtn').style.display = 'inline-block'; // Show switch btn in user view
            document.getElementById('adminBackBtn').style.display = 'none'; // Hide back btn
            // Skills listener already started in window.onload or login flow
            loadSkillGrid(); // Explicitly load user skills grid after user data is loaded
          }
        } else {
          // This shouldn't happen if user exists in Auth, but handle it
          console.error("User document does not exist in Firestore!");
          alert("User data error. Please contact support.");
        }
      } catch (error) {
        console.error("Error loading user  ", error);
      }
    }

    function showProfileCompletion() {
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('signupForm').style.display = 'none';
      document.getElementById('forgotPasswordForm').style.display = 'none';
      document.getElementById('profileForm').style.display = 'block';
      document.getElementById('auth-error').textContent = '';
      updateDropdowns(); // Populate rank/course dropdowns for completion
    }

    async function completeProfile() {
      const rank = document.getElementById('profile-rank').value;
      const course = document.getElementById('profile-course').value;
      const name = document.getElementById('profile-name').value.toUpperCase(); // Auto-convert to uppercase

      if (!rank || !course || !name) {
        document.getElementById('auth-error').textContent = 'Please fill in all fields';
        return;
      }

      try {
        // Get current user UID
        const user = auth.currentUser;
        if (!user) throw new Error("No authenticated user found");

        // Update user document in Firestore
        await db.collection("users").doc(user.uid).update({
          name: name,
          rank: rank,
          course: course
        });

        // Reload user data to reflect changes
        loadUserData(user.uid);
      } catch (error) {
        console.error("Error completing profile: ", error);
        document.getElementById('auth-error').textContent = error.message;
      }
    }


    // --- UI MANAGEMENT ---
    function showSection(section) {
      // Hide all sections
      document.querySelectorAll('.section').forEach(el => el.style.display = 'none');
      // Remove active class from all nav items
      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));

      // Show the requested section and highlight its nav item
      document.getElementById(section + '-section').style.display = 'block';
      document.querySelector(`.nav-item[onclick="showSection('${section}')"]`).classList.add('active');

      // Specific logic for each section
      if (section === 'skills') {
        // Skills listener handles loading now
        loadSkillsList(); // Trigger the load explicitly if needed after listener setup
      } else if (section === 'users') {
        loadUsersManagement();
      } else if (section === 'settings') {
        // Load signup settings by default or the active tab
        const activeTabButton = document.querySelector('.tab-button.active');
        const activeTabId = activeTabButton ? activeTabButton.getAttribute('data-tab') : 'signupSettings';
        if (activeTabId === 'signupSettings') {
          loadSignupSettings();
        } else if (activeTabButton && activeTabId === 'adminAccess') { // Added check for activeTabButton
          loadAdminList(); // Call loadAdminList when Admin Access tab is active
        }
      } else if (section === 'dashboard') {
        updateCounters(); // Update dashboard stats when shown
      }
    }

    // CHANGED: Function to toggle profile popup
    function toggleProfilePopup() {
      const popup = document.getElementById('profilePopup');
      if (popup.style.display === 'block') {
        popup.style.display = 'none';
      } else {
        popup.style.display = 'block';
        // Update profile info in popup
        document.getElementById('popup-name-display').textContent = currentUser?.name || 'N/A';
        document.getElementById('popup-rank-display').textContent = currentUser?.rank || 'N/A';
        document.getElementById('popup-course-display').textContent = currentUser?.course || 'N/A';
        document.getElementById('popup-email-display').textContent = currentUser?.email || 'N/A';
        // Update rank dropdown in popup if needed (e.g., for changing rank)
        // updateDropdowns(); // Uncomment if you add a rank change feature in the popup
      }
    }

    // CHANGED: Function to close profile popup
    function closeProfilePopup() {
      document.getElementById('profilePopup').style.display = 'none';
    }

    // CHANGED: Function to switch to admin interface
    function switchToAdminInterface() {
      if (currentUser && currentUser.id) {
        db.collection("admins").doc(currentUser.id).get().then(adminDoc => {
          if (adminDoc.exists) {
            wasInAdminView = true;
            document.getElementById('userInterface').style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'block';
            document.getElementById('adminSwitchBtn').style.display = 'none';
            document.getElementById('adminBackBtn').style.display = 'inline-block';
            showSection('dashboard'); // Default to dashboard
          } else {
            alert("You do not have admin privileges.");
          }
        }).catch(error => {
          console.error("Error checking admin status: ", error);
        });
      }
    }

    // CHANGED: Function to switch back to user interface
    function switchToUserInterface() {
      wasInAdminView = true;
      document.getElementById('adminDashboard').style.display = 'none';
      document.getElementById('userInterface').style.display = 'block';
      document.getElementById('adminSwitchBtn').style.display = 'inline-block';
      document.getElementById('adminBackBtn').style.display = 'none';
      // Ensure user view is updated
      if (document.getElementById('userInterface').style.display === 'block') {
         loadSkillGrid(); // Reload skills grid for user
      }
    }


    // --- SKILLS MANAGEMENT (ADMIN) ---
    function loadSkillsList() {
      const container = document.getElementById('skillsList');
      if (!container) return; // Guard clause

      container.innerHTML = ''; // Clear existing content
      skillsData.forEach(skill => {
        const skillCard = document.createElement('div');
        skillCard.className = 'skill-card';
        skillCard.onclick = () => editSkill(skill.id); // Pass the ID

        let iconHtml = '<i class="fas fa-toolbox" style="font-size: 3rem; color: var(--primary); margin-bottom: 1rem;"></i>';
        if (skill.imageUrl) {
          iconHtml = `<img src="${skill.imageUrl}" alt="${skill.name}" style="width: 100%; height: 150px; object-fit: cover;">`;
        }

        skillCard.innerHTML = `
          <div style="padding: 1.5rem; text-align: center;">
            ${iconHtml}
            <h4>${skill.name}</h4>
            <p>${skill.description.substring(0, 100)}...</p>
            <div class="skill-actions">
              <button class="action-btn" onclick="event.stopPropagation(); moveSkillUp('${skill.id}', ${skill.order || 0})"><i class="fas fa-arrow-up"></i> Up</button>
              <button class="action-btn" onclick="event.stopPropagation(); moveSkillDown('${skill.id}', ${skill.order || 0})"><i class="fas fa-arrow-down"></i> Down</button>
              <button class="action-btn" onclick="event.stopPropagation(); deleteSkill('${skill.id}', '${skill.name}')"><i class="fas fa-trash"></i> Delete</button>
            </div>
          </div>
        `;
        container.appendChild(skillCard);
      });
    }

    // Safely find skill by ID
    function findSkillById(id) {
        return skillsData.find(skill => skill.id === id);
    }

    function editSkill(skillId) {
      const skill = findSkillById(skillId); // Use the helper function
      if (!skill) {
        alert("Skill not found. Please refresh and try again.");
        console.warn("Skill not found for ID:", skillId);
        return;
      }

      currentEditingSkill = skill;
      editingSkillId = skill.id; // Store the ID being edited
      originalEditingSkill = JSON.parse(JSON.stringify(currentEditingSkill)); // Deep copy for cancel

      // Populate the edit form fields
      document.getElementById('skill-name').value = currentEditingSkill.name || '';
      document.getElementById('skill-description').value = currentEditingSkill.description || '';
      document.getElementById('skill-theory').value = currentEditingSkill.theory || '';

      // Clear and populate tools
      const toolsContainer = document.getElementById('tools-container');
      toolsContainer.innerHTML = '';
      (currentEditingSkill.tools || []).forEach((tool, index) => {
        addToolInput(index, tool.name, tool.imageUrl);
      });

      // Clear and populate steps
      const stepsContainer = document.getElementById('steps-container');
      stepsContainer.innerHTML = '';
      (currentEditingSkill.steps || []).forEach((step, index) => {
        addStep(index, step.title, step.description, step.imageUrl);
      });

      // Clear and populate quiz
      const quizContainer = document.getElementById('quiz-container');
      quizContainer.innerHTML = '';
      (currentEditingSkill.quiz || []).forEach((question, index) => {
        addQuizQuestion(index, question);
      });

      // Show image preview if exists
      const preview = document.getElementById('skill-image-preview');
      if (currentEditingSkill.imageUrl) {
        preview.innerHTML = `<img src="${currentEditingSkill.imageUrl}" alt="Current Image">`;
      } else {
        preview.innerHTML = '';
      }

      // Show the edit form
      document.getElementById('skills-section').style.display = 'none';
      document.getElementById('edit-skill-form').style.display = 'block';
      document.querySelectorAll('.section').forEach(el => el.style.display = 'none'); // Hide other sections
    }

    function cancelEdit() {
      // Restore original state if editing an existing skill
      if (editingSkillId && originalEditingSkill) {
        currentEditingSkill = JSON.parse(JSON.stringify(originalEditingSkill));
      }
      // Clear editing state
      currentEditingSkill = null;
      originalEditingSkill = null;
      editingSkillId = null; // Reset ID
      // Hide edit form and show skills list
      document.getElementById('edit-skill-form').style.display = 'none';
      document.getElementById('skills-section').style.display = 'block';
    }

    function saveSkill() {
      if (!currentEditingSkill) {
        console.error("No skill is currently being edited.");
        return;
      }

      // Validate required fields
      if (!currentEditingSkill.name.trim()) {
        alert("Please enter a skill name.");
        return;
      }

      const skillId = editingSkillId; // Use the stored ID
      const skillRef = db.collection("skills").doc(skillId);

      // Prepare the data to save (omit ID)
      const { id, ...skillData } = currentEditingSkill;

      // Upload image if a new one was selected
      const fileInput = document.getElementById('skill-image');
      if (fileInput.files[0]) {
        const storageRef = storage.ref();
        const fileRef = storageRef.child(`skill_images/${Date.now()}_${fileInput.files[0].name}`);
        fileRef.put(fileInput.files[0]).then(snapshot => {
          return snapshot.ref.getDownloadURL();
        }).then(downloadURL => {
          skillData.imageUrl = downloadURL;
          return skillRef.set(skillData); // Save to Firestore with image URL
        }).then(() => {
          alert("Skill updated successfully!");
          cancelEdit(); // Return to skills list
        }).catch(error => {
          console.error("Error uploading image or saving skill: ", error);
          alert("Error saving skill: " + error.message);
        });
      } else {
        // No new image, save directly
        skillRef.set(skillData).then(() => {
          alert("Skill updated successfully!");
          cancelEdit(); // Return to skills list
        }).catch(error => {
          console.error("Error saving skill: ", error);
          alert("Error saving skill: " + error.message);
        });
      }
    }

    function addNewSkill() {
      // Calculate the new order value based on the *maximum* existing order in the CURRENTLY KNOWN skillsData + 1
      // Ensure skillsData is sorted first to get the latest max
      // Use the same sorting logic as elsewhere to find the max order
      const sortedSkillsForOrderCalc = [...skillsData].sort((a, b) => {
        const orderA = a.order !== undefined && a.order !== null ? a.order : -1; // Use -1 or 0 if missing for calculation
        const orderB = b.order !== undefined && b.order !== null ? b.order : -1;
        return orderA - orderB;
      });
      const maxExistingOrder = sortedSkillsForOrderCalc.length > 0 ? (sortedSkillsForOrderCalc[sortedSkillsForOrderCalc.length - 1].order || 0) : -1;
      const newOrder = maxExistingOrder + 1;

      currentEditingSkill = {
        id: null, // Will be assigned by Firestore on add
        name: '',
        imageUrl: '', // Changed from 'icon'
        description: '',
        tools: [], // Structure changed to hold objects with name and imageUrl
        theory: '',
        quiz: [],
        steps: [], // Added steps array
        order: newOrder // Assign the calculated new order
      };
      editingSkillId = null; // Indicate this is a new skill
      originalEditingSkill = JSON.parse(JSON.stringify(currentEditingSkill)); // Initial state for cancel

      // Clear the form fields
      document.getElementById('skill-name').value = '';
      document.getElementById('skill-description').value = '';
      document.getElementById('skill-theory').value = '';
      document.getElementById('tools-container').innerHTML = '';
      document.getElementById('steps-container').innerHTML = '';
      document.getElementById('quiz-container').innerHTML = '';
      document.getElementById('skill-image-preview').innerHTML = '';

      // Show the edit form
      document.getElementById('skills-section').style.display = 'none';
      document.getElementById('edit-skill-form').style.display = 'block';
      document.querySelectorAll('.section').forEach(el => el.style.display = 'none'); // Hide other sections
    }

    // Utility functions for edit form
    function updateSkillField(field, value) {
      if (currentEditingSkill) {
        currentEditingSkill[field] = value;
      }
    }

    function addToolInput(index = null, name = '', imageUrl = '') {
      const toolsContainer = document.getElementById('tools-container');
      const toolIndex = index !== null ? index : (currentEditingSkill.tools ? currentEditingSkill.tools.length : 0);
      const toolId = `tool-${toolIndex}`;
      const toolDiv = document.createElement('div');
      toolDiv.className = 'step-item';
      toolDiv.id = toolId;
      toolDiv.innerHTML = `
        <div class="step-header">
          <h4>Tool ${toolIndex + 1}</h4>
          <button class="action-btn delete-btn" onclick="removeTool(${toolIndex})"><i class="fas fa-trash"></i></button>
        </div>
        <div class="step-content">
          <div>
            <label>Name</label>
            <input type="text" value="${name}" onchange="updateToolField(${toolIndex}, 'name', this.value)">
          </div>
          <div>
            <label>Image URL (or upload below)</label>
            <input type="text" value="${imageUrl}" onchange="updateToolField(${toolIndex}, 'imageUrl', this.value)">
            <input type="file" accept="image/*" onchange="uploadToolImage(this, ${toolIndex})">
          </div>
        </div>
        <div class="image-upload-preview" id="tool-image-preview-${toolIndex}">${imageUrl ? `<img src="${imageUrl}" alt="Tool ${toolIndex+1} Preview">` : ''}</div>
      `;
      toolsContainer.appendChild(toolDiv);

      if (!currentEditingSkill.tools) currentEditingSkill.tools = [];
      if (index === null) { // Adding new tool
          currentEditingSkill.tools.push({ name: '', imageUrl: '' });
      }
    }

    function updateToolField(index, field, value) {
      if (currentEditingSkill && currentEditingSkill.tools && currentEditingSkill.tools[index]) {
        currentEditingSkill.tools[index][field] = value;
      }
    }

    function removeTool(index) {
      if (currentEditingSkill && currentEditingSkill.tools) {
        currentEditingSkill.tools.splice(index, 1);
        // Re-render the tools section to update indices correctly
        const toolsContainer = document.getElementById('tools-container');
        toolsContainer.innerHTML = '';
        (currentEditingSkill.tools || []).forEach((tool, idx) => {
          addToolInput(idx, tool.name, tool.imageUrl);
        });
      }
    }

    function addStep(index = null, title = '', description = '', imageUrl = '') {
      const stepsContainer = document.getElementById('steps-container');
      const stepIndex = index !== null ? index : (currentEditingSkill.steps ? currentEditingSkill.steps.length : 0);
      const stepId = `step-${stepIndex}`;
      const stepDiv = document.createElement('div');
      stepDiv.className = 'step-item';
      stepDiv.id = stepId;
      stepDiv.innerHTML = `
        <div class="step-header">
          <h4>Step ${stepIndex + 1}</h4>
          <button class="action-btn delete-btn" onclick="removeStep(${stepIndex})"><i class="fas fa-trash"></i></button>
        </div>
        <div class="step-content">
          <div>
            <label>Title</label>
            <input type="text" value="${title}" onchange="updateStepField(${stepIndex}, 'title', this.value)">
          </div>
          <div>
            <label>Description</label>
            <textarea onchange="updateStepField(${stepIndex}, 'description', this.value)">${description}</textarea>
          </div>
          <div>
            <label>Image URL (or upload below)</label>
            <input type="text" value="${imageUrl}" onchange="updateStepField(${stepIndex}, 'imageUrl', this.value)">
            <input type="file" accept="image/*" onchange="uploadStepImage(this, ${stepIndex})">
          </div>
        </div>
        <div class="image-upload-preview" id="step-image-preview-${stepIndex}">${imageUrl ? `<img src="${imageUrl}" alt="Step ${stepIndex+1} Preview">` : ''}</div>
      `;
      stepsContainer.appendChild(stepDiv);

      if (!currentEditingSkill.steps) currentEditingSkill.steps = [];
      if (index === null) { // Adding new step
          currentEditingSkill.steps.push({ title: '', description: '', imageUrl: '' });
      }
    }

    function updateStepField(index, field, value) {
      if (currentEditingSkill && currentEditingSkill.steps && currentEditingSkill.steps[index]) {
        currentEditingSkill.steps[index][field] = value;
      }
    }

    function removeStep(index) {
      if (currentEditingSkill && currentEditingSkill.steps) {
        currentEditingSkill.steps.splice(index, 1);
        // Re-render the steps section to update indices correctly
        const stepsContainer = document.getElementById('steps-container');
        stepsContainer.innerHTML = '';
        (currentEditingSkill.steps || []).forEach((step, idx) => {
          addStep(idx, step.title, step.description, step.imageUrl);
        });
      }
    }

    function addQuizQuestion(index = null, questionObj = null) {
      const quizContainer = document.getElementById('quiz-container');
      const qIndex = index !== null ? index : (currentEditingSkill.quiz ? currentEditingSkill.quiz.length : 0);
      const questionId = `question-${qIndex}`;
      const question = questionObj || { question: '', options: ['', '', '', ''], answer: 0 }; // Default structure

      const questionDiv = document.createElement('div');
      questionDiv.className = 'quiz-question';
      questionDiv.id = questionId;
      questionDiv.innerHTML = `
        <div class="quiz-header">
          <h4>Question ${qIndex + 1}</h4>
          <button class="action-btn delete-btn" onclick="removeQuizQuestion(${qIndex})"><i class="fas fa-trash"></i></button>
        </div>
        <div class="quiz-content">
          <div>
            <label>Question Text</label>
            <input type="text" value="${question.question}" onchange="updateQuizField(${qIndex}, 'question', this.value)" placeholder="Question text">
          </div>
          <div class="quiz-options">
            <div>
              <label>Option A</label>
              <input type="text" value="${question.options[0]}" onchange="updateQuizOption(${qIndex}, 0, this.value)" placeholder="Option A">
            </div>
            <div>
              <label>Option B</label>
              <input type="text" value="${question.options[1]}" onchange="updateQuizOption(${qIndex}, 1, this.value)" placeholder="Option B">
            </div>
            <div>
              <label>Option C</label>
              <input type="text" value="${question.options[2]}" onchange="updateQuizOption(${qIndex}, 2, this.value)" placeholder="Option C">
            </div>
            <div>
              <label>Option D</label>
              <input type="text" value="${question.options[3]}" onchange="updateQuizOption(${qIndex}, 3, this.value)" placeholder="Option D">
            </div>
          </div>
          <div>
            <label>Correct Answer (0=A, 1=B, 2=C, 3=D)</label>
            <input type="number" min="0" max="3" value="${question.answer}" onchange="updateQuizField(${qIndex}, 'answer', parseInt(this.value))">
          </div>
        </div>
      `;
      quizContainer.appendChild(questionDiv);

      if (!currentEditingSkill.quiz) currentEditingSkill.quiz = [];
      if (index === null) { // Adding new question
          currentEditingSkill.quiz.push({ question: '', options: ['', '', '', ''], answer: 0 });
      }
    }

    function updateQuizField(index, field, value) {
      if (currentEditingSkill && currentEditingSkill.quiz && currentEditingSkill.quiz[index]) {
        currentEditingSkill.quiz[index][field] = value;
      }
    }

    function updateQuizOption(index, optionIndex, value) {
      if (currentEditingSkill && currentEditingSkill.quiz && currentEditingSkill.quiz[index] && currentEditingSkill.quiz[index].options) {
        currentEditingSkill.quiz[index].options[optionIndex] = value;
      }
    }

    function removeQuizQuestion(index) {
      if (currentEditingSkill && currentEditingSkill.quiz) {
        currentEditingSkill.quiz.splice(index, 1);
        // Re-render the quiz section to update indices correctly
        const quizContainer = document.getElementById('quiz-container');
        quizContainer.innerHTML = '';
        (currentEditingSkill.quiz || []).forEach((q, idx) => {
          addQuizQuestion(idx, q);
        });
      }
    }

    // Image Upload Helpers
    async function uploadToolImage(input, index) {
      const file = input.files[0];
      if (!file) return;
      const storageRef = storage.ref();
      const fileRef = storageRef.child(`tool_images/${Date.now()}_${file.name}`);
      try {
        await fileRef.put(file);
        const downloadURL = await fileRef.getDownloadURL();
        updateToolField(index, 'imageUrl', downloadURL);
        // Update preview
        document.getElementById(`tool-image-preview-${index}`).innerHTML = `<img src="${downloadURL}" alt="Preview">`;
      } catch (error) {
        console.error("Error uploading tool image: ", error);
      }
    }

    async function uploadStepImage(input, index) {
      const file = input.files[0];
      if (!file) return;
      const storageRef = storage.ref();
      const fileRef = storageRef.child(`step_images/${Date.now()}_${file.name}`);
      try {
        await fileRef.put(file);
        const downloadURL = await fileRef.getDownloadURL();
        updateStepField(index, 'imageUrl', downloadURL);
        // Update preview
        document.getElementById(`step-image-preview-${index}`).innerHTML = `<img src="${downloadURL}" alt="Preview">`;
      } catch (error) {
        console.error("Error uploading step image: ", error);
      }
    }

    function previewSkillImage(input) {
      const preview = document.getElementById('skill-image-preview');
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          preview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
        };
        reader.readAsDataURL(input.files[0]);
      } else {
        preview.innerHTML = '';
      }
    }

    function previewToolImage(input, index) {
      const previewId = `tool-image-preview-${index}`;
      const preview = document.getElementById(previewId);
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          preview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
        };
        reader.readAsDataURL(input.files[0]);
      } else {
        preview.innerHTML = '';
      }
    }

    // Reordering functions (Admin Skills)
    async function moveSkillUp(skillId, currentOrder) {
        const minOrder = Math.min(...skillsData.map(s => s.order !== undefined && s.order !== null ? s.order : Infinity));
        if (currentOrder <= minOrder) {
            console.log("Skill is already at the top or not found, cannot move up.");
            return; // Already at the top
        }
        const targetOrder = currentOrder - 1;

        try {
            // Find the skill that currently has the target order
            const targetSkillSnapshot = await db.collection("skills").where("order", "==", targetOrder).limit(1).get();
            if (targetSkillSnapshot.empty) {
                 console.error("Target skill for swap not found for order:", targetOrder);
                 return;
            }
            const targetSkillDoc = targetSkillSnapshot.docs[0];
            const targetSkillId = targetSkillDoc.id;

            // Perform a batch write to swap orders atomically
            const batch = db.batch();
            batch.update(db.collection("skills").doc(skillId), { order: targetOrder });
            batch.update(db.collection("skills").doc(targetSkillId), { order: currentOrder });
            await batch.commit();

            console.log("Orders swapped successfully.");
            // The listener will automatically update the UI
        } catch (error) {
            console.error("Error moving skill up: ", error);
        }
    }

    async function moveSkillDown(skillId, currentOrder) {
        const maxOrder = Math.max(...skillsData.map(s => s.order !== undefined && s.order !== null ? s.order : -Infinity));
        if (currentOrder >= maxOrder) {
            console.log("Skill is already at the bottom or not found, cannot move down.");
            return; // Already at the bottom
        }
        const targetOrder = currentOrder + 1;

        try {
            // Find the skill that currently has the target order
            const targetSkillSnapshot = await db.collection("skills").where("order", "==", targetOrder).limit(1).get();
            if (targetSkillSnapshot.empty) {
                 console.error("Target skill for swap not found for order:", targetOrder);
                 return;
            }
            const targetSkillDoc = targetSkillSnapshot.docs[0];
            const targetSkillId = targetSkillDoc.id;

            // Perform a batch write to swap orders atomically
            const batch = db.batch();
            batch.update(db.collection("skills").doc(skillId), { order: targetOrder });
            batch.update(db.collection("skills").doc(targetSkillId), { order: currentOrder });
            await batch.commit();

            console.log("Orders swapped successfully.");
            // The listener will automatically update the UI
        } catch (error) {
            console.error("Error moving skill down: ", error);
        }
    }

    // Delete Skill (Admin)
    async function deleteSkill(skillId, skillName) {
        if (!confirm(`Are you sure you want to delete the skill "${skillName}"?`)) {
            return;
        }
        try {
            await db.collection("skills").doc(skillId).delete();
            alert(`Skill "${skillName}" has been deleted successfully.`);
            // The listener will automatically update the UI
        } catch (error) {
            console.error("Error deleting skill: ", error);
            alert('Error deleting skill: ' + error.message);
        }
    }


    // --- USERS MANAGEMENT (ADMIN) ---
    async function loadUsersManagement() {
      try {
        const usersSnapshot = await db.collection("users").get();
        usersData = []; // Reset the global array
        usersSnapshot.forEach(doc => {
          usersData.push({ id: doc.id, ...doc.data() });
        });

        // Group users by course
        const groupedUsers = {};
        usersData.forEach(user => {
          if (!groupedUsers[user.course]) {
            groupedUsers[user.course] = [];
          }
          groupedUsers[user.course].push(user);
        });

        const usersContent = document.getElementById('usersContent');
        usersContent.innerHTML = '';

        // Sort courses alphabetically
        const sortedCourses = Object.keys(groupedUsers).sort();

        sortedCourses.forEach(course => {
          const courseGroup = document.createElement('div');
          courseGroup.className = 'course-group';
          courseGroup.innerHTML = `<h3 class="course-title">${course}</h3>`;
          const userList = document.createElement('div');
          userList.className = 'user-list';

          // Sort users within each course by name
          groupedUsers[course].sort((a, b) => a.name.localeCompare(b.name)).forEach(user => {
            const userCard = document.createElement('div');
            userCard.className = 'user-card';
            userCard.innerHTML = `
              <div class="user-details">
                <div class="user-name">${user.name || user.email}</div>
                <div class="user-rank">${user.rank}</div>
                <div class="user-course">${user.course}</div>
                <div class="user-email">${user.email}</div>
              </div>
              <div>
                <button class="edit-user-btn" onclick="openEditUserModal('${user.id}')">Edit</button>
                <button class="action-btn delete-btn" onclick="deleteUser('${user.id}', '${user.name || user.email}')">Delete</button>
              </div>
            `;
            userList.appendChild(userCard);
          });

          courseGroup.appendChild(userList);
          usersContent.appendChild(courseGroup);
        });

      } catch (error) {
        console.error("Error loading users: ", error);
      }
    }

    function openEditUserModal(userId) {
      // Add a check for userId validity
      if (!userId) {
          console.error("Invalid user ID provided to openEditUserModal:", userId);
          alert("Cannot edit user: Invalid user ID.");
          return;
      }
      // Find user by the passed ID, not relying on potentially stale usersData lookup
      // Although usersData should be fresh if loadUsersManagement ran recently
      const user = usersData.find(u => u.id === userId);
      if (!user) {
          console.error("User not found for editing:", userId);
          alert("User not found.");
          return; // Exit if user not found
      }
      document.getElementById('edit-user-name').value = user.name;
      document.getElementById('edit-user-rank').value = user.rank;
      document.getElementById('edit-user-course').value = user.course;
      document.getElementById('editUserModal').style.display = 'flex';
      // Store the ID of the user being edited
      document.getElementById('editUserModal').setAttribute('data-editing-id', userId);
    }

    function closeEditUserModal() {
      document.getElementById('editUserModal').style.display = 'none';
    }

    async function saveEditedUser() {
      const userId = document.getElementById('editUserModal').getAttribute('data-editing-id');
      if (!userId) {
          console.error("No user ID found for editing.");
          return;
      }
      const name = document.getElementById('edit-user-name').value.toUpperCase(); // Auto-convert to uppercase
      const rank = document.getElementById('edit-user-rank').value;
      const course = document.getElementById('edit-user-course').value;

      if (!name || !rank || !course) {
        alert('Please fill in all fields');
        return;
      }

      try {
        await db.collection("users").doc(userId).update({
          name: name,
          rank: rank,
          course: course
        });
        alert('User updated successfully!');
        closeEditUserModal();
        loadUsersManagement(); // Refresh the user list
      } catch (error) {
        console.error("Error updating user: ", error);
        alert('Error updating user: ' + error.message);
      }
    }

    // Delete User (Admin) - NEW FUNCTION ADDED
    async function deleteUser(userId, userName) {
        if (!confirm(`Are you sure you want to delete the user "${userName}"? This action cannot be undone.`)) {
            return;
        }
        try {
            // First, attempt to remove the user from the admins collection if they are an admin
            await db.collection("admins").doc(userId).delete().catch(error => {
                // It's okay if the user wasn't an admin, just log the specific error
                if (error.code !== 'not-found') {
                    console.error("Error removing user from admins during deletion: ", error);
                }
            });

            // Then, delete the user document from the users collection
            await db.collection("users").doc(userId).delete();

            alert(`User "${userName}" has been deleted successfully.`);
            // Optionally, refresh the user list to reflect the deletion
            if (document.getElementById('users-section').style.display === 'block') {
                loadUsersManagement(); // Reload the user list if currently viewing
            }
        } catch (error) {
            console.error("Error deleting user: ", error);
            alert('Error deleting user: ' + error.message);
        }
    }


    // --- SETTINGS (ADMIN) ---
    async function loadSignupSettings() {
      try {
        // Load Ranks
        const ranksSnapshot = await db.collection("ranks").orderBy("order").get();
        let ranksHTML = '';
        ranksSnapshot.forEach((doc, index) => {
          const rank = doc.data();
          const isTop = index === 0;
          const isBottom = index === ranksSnapshot.size - 1;
          ranksHTML += `
            <div class="setting-item">
              <span>${rank.name}</span>
              <div class="setting-actions">
                <button class="move-up-btn" ${isTop ? 'disabled' : ''} onclick="moveRankUp('${doc.id}', ${rank.order})" title="Move Up"><i class="fas fa-arrow-up"></i></button>
                <button class="move-down-btn" ${isBottom ? 'disabled' : ''} onclick="moveRankDown('${doc.id}', ${rank.order})" title="Move Down"><i class="fas fa-arrow-down"></i></button>
                <button class="delete-btn-setting" onclick="deleteRank('${doc.id}', '${rank.name}')" title="Delete"><i class="fas fa-trash"></i></button>
              </div>
            </div>
          `;
        });
        document.getElementById('ranksList').innerHTML = ranksHTML;

        // Load Courses
        const coursesSnapshot = await db.collection("courses").orderBy("order").get();
        let coursesHTML = '';
        coursesSnapshot.forEach((doc, index) => {
          const course = doc.data();
          const isTop = index === 0;
          const isBottom = index === coursesSnapshot.size - 1;
          coursesHTML += `
            <div class="setting-item">
              <span>${course.name}</span>
              <div class="setting-actions">
                <button class="move-up-btn" ${isTop ? 'disabled' : ''} onclick="moveCourseUp('${doc.id}', ${course.order})" title="Move Up"><i class="fas fa-arrow-up"></i></button>
                <button class="move-down-btn" ${isBottom ? 'disabled' : ''} onclick="moveCourseDown('${doc.id}', ${course.order})" title="Move Down"><i class="fas fa-arrow-down"></i></button>
                <button class="delete-btn-setting" onclick="deleteCourse('${doc.id}', '${course.name}')" title="Delete"><i class="fas fa-trash"></i></button>
              </div>
            </div>
          `;
        });
        document.getElementById('coursesList').innerHTML = coursesHTML;

      } catch (error) {
        console.error("Error loading signup settings: ", error);
      }
    }

    // Rank Management
    async function addRank() {
      const newName = document.getElementById('newRankInput').value.trim();
      if (!newName) {
        document.getElementById('rankMessage').textContent = 'Rank name cannot be empty!';
        document.getElementById('rankMessage').style.display = 'block';
        setTimeout(() => { document.getElementById('rankMessage').style.display = 'none'; }, 3000);
        return;
      }

      try {
        // Calculate new order
        const ranksSnapshot = await db.collection("ranks").orderBy("order").get();
        const newOrder = ranksSnapshot.size; // Order starts from 0

        await db.collection("ranks").add({
          name: newName,
          order: newOrder
        });
        document.getElementById('newRankInput').value = '';
        document.getElementById('rankMessage').textContent = 'Rank added successfully!';
        document.getElementById('rankMessage').style.display = 'block';
        setTimeout(() => { document.getElementById('rankMessage').style.display = 'none'; }, 3000);
      } catch (error) {
        console.error("Error adding rank: ", error);
        document.getElementById('rankMessage').textContent = 'Error adding rank: ' + error.message;
        document.getElementById('rankMessage').style.display = 'block';
        setTimeout(() => { document.getElementById('rankMessage').style.display = 'none'; }, 3000);
      }
    }

    async function deleteRank(rankId, rankName) {
        if (!confirm(`Are you sure you want to delete the rank "${rankName}"?`)) {
            return;
        }
        try {
            await db.collection("ranks").doc(rankId).delete();
            // Optionally, update users who had this rank (e.g., set to default or prompt)
            // db.collection("users").where("rank", "==", rankName).get().then(...)
        } catch (error) {
            console.error("Error deleting rank: ", error);
            alert('Error deleting rank: ' + error.message);
        }
    }

    async function moveRankUp(rankId, currentOrder) {
        if (currentOrder <= 0) return; // Already at the top
        const targetOrder = currentOrder - 1;

        try {
            const targetRankSnapshot = await db.collection("ranks").where("order", "==", targetOrder).limit(1).get();
            if (targetRankSnapshot.empty) return; // Should not happen if data is consistent
            const targetRankId = targetRankSnapshot.docs[0].id;

            const batch = db.batch();
            batch.update(db.collection("ranks").doc(rankId), { order: targetOrder });
            batch.update(db.collection("ranks").doc(targetRankId), { order: currentOrder });
            await batch.commit();
        } catch (error) {
            console.error("Error moving rank up: ", error);
        }
    }

    async function moveRankDown(rankId, currentOrder) {
        const allRanksSnapshot = await db.collection("ranks").orderBy("order").get();
        const maxOrder = allRanksSnapshot.size - 1;
        if (currentOrder >= maxOrder) return; // Already at the bottom
        const targetOrder = currentOrder + 1;

        try {
            const targetRankSnapshot = await db.collection("ranks").where("order", "==", targetOrder).limit(1).get();
            if (targetRankSnapshot.empty) return; // Should not happen if data is consistent
            const targetRankId = targetRankSnapshot.docs[0].id;

            const batch = db.batch();
            batch.update(db.collection("ranks").doc(rankId), { order: targetOrder });
            batch.update(db.collection("ranks").doc(targetRankId), { order: currentOrder });
            await batch.commit();
        } catch (error) {
            console.error("Error moving rank down: ", error);
        }
    }

    // Course Management
    async function addCourse() {
      const newName = document.getElementById('newCourseInput').value.trim();
      if (!newName) {
        document.getElementById('courseMessage').textContent = 'Course name cannot be empty!';
        document.getElementById('courseMessage').style.display = 'block';
        setTimeout(() => { document.getElementById('courseMessage').style.display = 'none'; }, 3000);
        return;
      }

      try {
        // Calculate new order
        const coursesSnapshot = await db.collection("courses").orderBy("order").get();
        const newOrder = coursesSnapshot.size; // Order starts from 0

        await db.collection("courses").add({
          name: newName,
          order: newOrder
        });
        document.getElementById('newCourseInput').value = '';
        document.getElementById('courseMessage').textContent = 'Course added successfully!';
        document.getElementById('courseMessage').style.display = 'block';
        setTimeout(() => { document.getElementById('courseMessage').style.display = 'none'; }, 3000);
      } catch (error) {
        console.error("Error adding course: ", error);
        document.getElementById('courseMessage').textContent = 'Error adding course: ' + error.message;
        document.getElementById('courseMessage').style.display = 'block';
        setTimeout(() => { document.getElementById('courseMessage').style.display = 'none'; }, 3000);
      }
    }

    async function deleteCourse(courseId, courseName) {
        if (!confirm(`Are you sure you want to delete the course "${courseName}"?`)) {
            return;
        }
        try {
            await db.collection("courses").doc(courseId).delete();
            // Optionally, update users who had this course (e.g., set to default or prompt)
            // db.collection("users").where("course", "==", courseName).get().then(...)
        } catch (error) {
            console.error("Error deleting course: ", error);
            alert('Error deleting course: ' + error.message);
        }
    }

    async function moveCourseUp(courseId, currentOrder) {
        if (currentOrder <= 0) return; // Already at the top
        const targetOrder = currentOrder - 1;

        try {
            const targetCourseSnapshot = await db.collection("courses").where("order", "==", targetOrder).limit(1).get();
            if (targetCourseSnapshot.empty) return; // Should not happen if data is consistent
            const targetCourseId = targetCourseSnapshot.docs[0].id;

            const batch = db.batch();
            batch.update(db.collection("courses").doc(courseId), { order: targetOrder });
            batch.update(db.collection("courses").doc(targetCourseId), { order: currentOrder });
            await batch.commit();
        } catch (error) {
            console.error("Error moving course up: ", error);
        }
    }

    async function moveCourseDown(courseId, currentOrder) {
        const allCoursesSnapshot = await db.collection("courses").orderBy("order").get();
        const maxOrder = allCoursesSnapshot.size - 1;
        if (currentOrder >= maxOrder) return; // Already at the bottom
        const targetOrder = currentOrder + 1;

        try {
            const targetCourseSnapshot = await db.collection("courses").where("order", "==", targetOrder).limit(1).get();
            if (targetCourseSnapshot.empty) return; // Should not happen if data is consistent
            const targetCourseId = targetCourseSnapshot.docs[0].id;

            const batch = db.batch();
            batch.update(db.collection("courses").doc(courseId), { order: targetOrder });
            batch.update(db.collection("courses").doc(targetCourseId), { order: currentOrder });
            await batch.commit();
        } catch (error) {
            console.error("Error moving course down: ", error);
        }
    }

    // Admin Access Management
    async function loadAdminList() {
        try {
            const adminSnapshot = await db.collection("admins").get();
            const adminListDiv = document.getElementById('adminList');
            adminListDiv.innerHTML = ''; // Clear existing list

            adminSnapshot.forEach(doc => {
                const adminData = doc.data();
                const adminEmail = adminData.email; // Assuming email is stored in the admin doc
                const adminId = doc.id; // Use the document ID for revocation

                const adminItem = document.createElement('div');
                adminItem.className = 'setting-item';
                adminItem.innerHTML = `
                    <span>${adminEmail}</span>
                    <button class="btn" onclick="revokeAdminAccess('${adminId}', '${adminEmail}')">Revoke Access</button>
                `;
                adminListDiv.appendChild(adminItem);
            });
        } catch (error) {
            console.error("Error loading admin list: ", error);
            // Consider displaying an error message in the UI
        }
    }

    async function grantAdminAccess() {
        const email = document.getElementById('admin-email').value;
        if (!email) {
            alert('Please enter an email address');
            return;
        }

        try {
            // Find user by email
            const userQuery = await db.collection("users").where("email", "==", email).limit(1).get();
            if (userQuery.empty) {
                alert('No user found with that email address.');
                return;
            }
            const userDoc = userQuery.docs[0];
            const userId = userDoc.id;

            // Add user to admins collection
            await db.collection("admins").doc(userId).set({
                email: email,
                grantedBy: currentUser.email, // Optional: track who granted access
                grantedAt: new Date()
            });

            alert(`Admin access granted to ${email}`);
            document.getElementById('admin-email').value = ''; // Clear input
            loadAdminList(); // Refresh the list
        } catch (error) {
            console.error("Error granting admin access: ", error);
            alert('Error granting admin access: ' + error.message);
        }
    }

    async function revokeAdminAccess(adminId, adminEmail) {
        if (!confirm(`Are you sure you want to revoke admin access for ${adminEmail}?`)) {
            return;
        }

        try {
            // Remove user from admins collection using the document ID
            await db.collection("admins").doc(adminId).delete();
            alert(`Admin access revoked for ${adminEmail}`);
            loadAdminList(); // Refresh the list
        } catch (error) {
            console.error("Error revoking admin access: ", error);
            alert('Error revoking admin access: ' + error.message);
        }
    }


    // --- USER INTERFACE (SKILLS GRID & DETAIL) ---
    function loadSkillGrid() {
      const grid = document.getElementById('skill-grid');
      if (!grid) return; // Guard clause

      grid.innerHTML = ''; // Clear existing content
      skillsData.forEach(skill => {
        const skillCard = document.createElement('div');
        skillCard.className = 'skill-card-ui';
        skillCard.onclick = () => loadSkillDetail(skill.id); // Pass the ID

        let iconHtml = '<i class="fas fa-toolbox"></i>';
        if (skill.imageUrl) {
          iconHtml = `<img src="${skill.imageUrl}" alt="${skill.name}">`;
        }

        skillCard.innerHTML = `
          <div class="skill-icon">
            ${iconHtml}
          </div>
          <div class="skill-content">
            <h3 class="skill-name">${skill.name}</h3>
            <p class="skill-desc">${skill.description.substring(0, 100)}...</p>
            <button class="skill-btn">View Details</button>
          </div>
        `;
        grid.appendChild(skillCard);
      });
    }

    function loadSkillDetail(skillId) {
      const skill = findSkillById(skillId); // Use the helper function
      if (!skill) {
        console.error("Skill not found:", skillId);
        document.getElementById('skill-detail').innerHTML = '<p>Skill details not available.</p>';
        document.getElementById('skill-detail').style.display = 'block';
        return;
      }

      let html = `<div class="skill-header">
                    ${skill.imageUrl ? `<img src="${skill.imageUrl}" alt="${skill.name}">` : '<i class="fas fa-toolbox" style="font-size: 3rem;"></i>'}
                    <h2>${skill.name}</h2>
                  </div>
                  <div class="skill-section">
                    <h3 class="section-title-ui">Description</h3>
                    <p>${skill.description}</p>
                  </div>`;

      if (skill.tools && skill.tools.length > 0) {
        html += `<div class="skill-section">
                   <h3 class="section-title-ui">Required Tools</h3>
                   <div class="tools-grid">`;
        skill.tools.forEach(tool => {
          html += `<div class="tool-item">
                     ${tool.imageUrl ? `<img src="${tool.imageUrl}" alt="${tool.name}">` : '<i class="fas fa-wrench"></i>'}
                     <span>${tool.name}</span>
                   </div>`;
        });
        html += `</div></div>`;
      }

      if (skill.steps && skill.steps.length > 0) {
        html += `<div class="skill-section">
                   <h3 class="section-title-ui">Steps</h3>
                   <div class="steps-container">`;
        skill.steps.forEach(step => {
          html += `<div class="step-card">
                     ${step.imageUrl ? `<img src="${step.imageUrl}" alt="${step.title}" class="step-image">` : ''}
                     <div class="step-content">
                       <h4 class="step-title">${step.title}</h4>
                       <p>${step.description}</p>
                     </div>
                   </div>`;
        });
        html += `</div></div>`;
      }

      if (skill.theory) {
        html += `<div class="skill-section">
                   <h3 class="section-title-ui">Theory</h3>
                   <div class="theory-content">${skill.theory}</div>
                 </div>`;
      }

      if (skill.quiz && skill.quiz.length > 0) {
        html += `<div class="skill-section">
                   <h3 class="section-title-ui">Quiz</h3>
                   <div class="quiz-container">`;
        skill.quiz.forEach((q, index) => {
          html += `<div class="question">
                     <div class="question-text">${q.question}</div>
                     <div class="options">`;
          q.options.forEach((opt, optIndex) => {
            html += `<div class="option" data-question="${index}" data-option="${optIndex}">
                       <input type="radio" name="q${index}" id="q${index}o${optIndex}">
                       <label for="q${index}o${optIndex}">${String.fromCharCode(65 + optIndex)}. ${opt}</label>
                     </div>`;
          });
          html += `</div>
                     <div class="quiz-result" id="result-${index}" style="display:none;"></div>
                   </div>`;
        });
        html += `</div>
                 <button class="back-btn" onclick="checkQuizAnswers('${skill.id}')">Check Answers</button>`;
      }

      html += `<button class="back-btn" onclick="goBackToGrid()">‚Üê Back to Skills</button>`;

      document.getElementById('skill-detail').innerHTML = html;
      document.getElementById('skill-grid').style.display = 'grid';
      document.getElementById('skill-detail').style.display = 'block';

      // Add event listeners for quiz options
      document.querySelectorAll('.option').forEach(optionEl => {
        optionEl.addEventListener('click', function() {
          // Deselect other options in the same question
          const questionIndex = this.getAttribute('data-question');
          document.querySelectorAll(`.option[data-question="${questionIndex}"]`).forEach(opt => {
            opt.classList.remove('selected');
          });
          // Select this option
          this.classList.add('selected');
        });
      });
    }

    function goBackToGrid() {
      document.getElementById('skill-grid').style.display = 'grid';
      document.getElementById('skill-detail').style.display = 'none';
    }

    function checkQuizAnswers(skillId) {
      const skill = findSkillById(skillId);
      if (!skill || !skill.quiz) return;

      let score = 0;
      let allAnswered = true;

      skill.quiz.forEach((q, index) => {
        const selectedOption = document.querySelector(`.option[data-question="${index}"].selected`);
        if (!selectedOption) {
          allAnswered = false;
          return;
        }
        const selectedValue = parseInt(selectedOption.getAttribute('data-option'));
        const resultDiv = document.getElementById(`result-${index}`);

        if (selectedValue === q.answer) {
          resultDiv.textContent = 'Correct!';
          resultDiv.className = 'quiz-result correct';
          score++;
        } else {
          resultDiv.textContent = `Incorrect. Correct answer: ${String.fromCharCode(65 + q.answer)}`;
          resultDiv.className = 'quiz-result incorrect';
        }
        resultDiv.style.display = 'block';
      });

      if (!allAnswered) {
        alert('Please answer all questions before checking your answers.');
        return;
      }

      // Show overall score
      const totalQuestions = skill.quiz.length;
      const percentage = Math.round((score / totalQuestions) * 100);

      // Mark skill as completed if passed
      if (percentage >= 70 && currentUser) {
        if (!currentUser.completedSkills.includes(skillId)) {
          db.collection("users").doc(currentUser.id).update({
            completedSkills: firebase.firestore.FieldValue.arrayUnion(skillId)
          }).then(() => {
            // Update local user data
            if (!currentUser.completedSkills) currentUser.completedSkills = [];
            currentUser.completedSkills.push(skillId);
            localStorage.setItem('currentUser', JSON.stringify(currentUser)); // Optional: persist locally
            alert(`Quiz completed! Score: ${score}/${totalQuestions} (${percentage}%) Congratulations! You've completed this skill.`);
          }).catch(console.error);
        } else {
           alert(`Quiz completed! Score: ${score}/${totalQuestions} (${percentage}%) You had already completed this skill.`);
        }
      } else {
        alert(`Quiz completed! Score: ${score}/${totalQuestions} (${percentage}%) You need at least 70% to pass. Try again!`);
      }
    }


    // --- PROFILE POPUP (User View) ---
    function updateDropdowns() {
      // Populate rank dropdowns (Profile Completion, Profile Popup, Edit User Modal)
      const rankSelects = [
        document.getElementById('profile-rank'),
        document.getElementById('popup-rank-select'), // Assuming you have this in popup HTML
        document.getElementById('edit-user-rank')    // In edit modal
      ];
      rankSelects.forEach(select => {
        if (select) {
          select.innerHTML = '<option value="">Select Rank</option>'; // Clear
          ranksData.forEach(rank => {
            const option = document.createElement('option');
            option.value = rank.name;
            option.textContent = rank.name;
            select.appendChild(option);
          });
          // Set the selected value if currentUser exists
          if (currentUser && select.id !== 'edit-user-rank') { // Don't set for edit modal here
            select.value = currentUser.rank;
          }
        }
      });

      // Populate course dropdowns (Profile Completion, Profile Popup, Edit User Modal)
      const courseSelects = [
        document.getElementById('profile-course'),
        document.getElementById('popup-course-select'), // Assuming you have this in popup HTML
        document.getElementById('edit-user-course')    // In edit modal
      ];
      courseSelects.forEach(select => {
        if (select) {
          select.innerHTML = '<option value="">Select Course</option>'; // Clear
          coursesData.forEach(course => {
            const option = document.createElement('option');
            option.value = course.name;
            option.textContent = course.name;
            select.appendChild(option);
          });
          // Set the selected value if currentUser exists
          if (currentUser && select.id !== 'edit-user-course') { // Don't set for edit modal here
            select.value = currentUser.course;
          }
        }
      });
    }

    async function updateProfileRank() {
      const newRank = document.getElementById('popup-rank-select').value;
      if (!newRank) {
        alert('Please select a rank');
        return;
      }
      try {
        await db.collection("users").doc(currentUser.id).update({ rank: newRank });
        currentUser.rank = newRank; // Update local data
        document.getElementById('popup-rank-display').textContent = newRank; // Update display
        alert('Rank updated successfully!');
      } catch (error) {
        console.error("Error updating rank: ", error);
        alert('Error updating rank: ' + error.message);
      }
    }

    // --- TAB FUNCTIONALITY (Settings) ---
    document.querySelectorAll('.tab-button').forEach(button => {
      button.addEventListener('click', function() {
        const tabName = this.getAttribute('data-tab');

        // Remove active class from all buttons and tabs
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));

        // Add active class to clicked button and corresponding tab
        this.classList.add('active');
        document.getElementById(`${tabName}Tab`).classList.add('active');

        // - ADD THIS CONDITIONAL CALL -
        if (tabName === 'adminAccess') {
          loadAdminList(); // Load admin list when the tab becomes active
        }
      });
    })


    // --- INITIALIZE DROPDOWNS ON LOAD (After Firestore listeners populate ranksData/coursesData) ---
    // We call updateDropdowns inside loadSignupSettings which is called by the listeners,
    // so it should update when data arrives. We also call it after profile completion/login.
    // A direct call here might fail if listeners haven't run yet.
    // The best place is still within the auth state change flow or after listeners populate data.
    // Since loadSignupSettings calls it, and loadSignupSettings is called when the settings tab is shown,
    // and ranks/courses listeners trigger loadSignupSettings, it should be fine.
    // However, for profile completion, we call it explicitly in showProfileCompletion.

  </script>
</body>
</html>
